{% extends 'hod_template/base_template.html' %}
{% load customfilter %}
{% block title %}
In Stock Medicines Inventory
{% endblock title %}

{% block breadcrumb %}
{% include "hod_template/modal_form.html" %}
{% endblock breadcrumb %}

{% load static %}
{% block main_content %}
<style>
    /* Premium styling with unique class names */
    .resa-stock-gradient {
        background: linear-gradient(120deg, #0B6623, #0A4D2E);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 15px 35px rgba(11, 102, 35, 0.15);
        border: none;
    }
    
    .resa-stock-gradient .card-header {
        background: rgba(0,0,0,0.1);
        border-bottom: 1px solid rgba(255,255,255,0.2);
        padding: 1.2rem 1.5rem;
    }
    
    .resa-stock-table-container {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.06);
    }
    
    .resa-stock-table th {
        background: linear-gradient(120deg, #e8f5e9, #c8e6c9);
        color: #0A4D2E;
        font-weight: 600;
        padding: 1rem 0.75rem;
        border: none;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .resa-stock-table td {
        padding: 1.1rem 0.75rem;
        vertical-align: middle;
        border-color: #f1f8e9;
    }
    
    .resa-stock-table tbody tr {
        transition: all 0.3s ease;
        background: white;
    }
    
    .resa-stock-table tbody tr:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(11, 102, 35, 0.1);
        background: #f9fdf7;
    }
    
    .resa-stock-badge {
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .resa-stock-badge-high {
        background: linear-gradient(120deg, #43a047, #2e7d32);
        color: white;
    }
    
    .resa-stock-badge-medium {
        background: linear-gradient(120deg, #ff9800, #f57c00);
        color: white;
    }
    
    .resa-stock-badge-low {
        background: linear-gradient(120deg, #e53935, #b71c1c);
        color: white;
    }
    
    .resa-stock-stock-indicator {
        height: 8px;
        border-radius: 4px;
        margin-top: 5px;
        background: #e9ecef;
        overflow: hidden;
    }
    
    .resa-stock-stock-progress {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s ease;
    }
    
    /* Three dot menu styling */
    .resa-stock-dropdown-menu {
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        border: none;
        padding: 0.5rem 0;
        overflow: hidden;
    }
    
    .resa-stock-dropdown-item {
        padding: 0.7rem 1.2rem;
        transition: all 0.2s ease;
    }
    
    .resa-stock-dropdown-item:hover {
        background: #f9fdf7;
    }
    
    .resa-stock-three-dots {
        color: #0A4D2E;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .resa-stock-three-dots:hover {
        color: #0B6623;
        transform: rotate(90deg);
    }
    
    .resa-stock-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(120deg, #0B6623, #0A4D2E);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 12px;
    }
    
    .resa-stock-summary-card {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        border: none;
        margin-bottom: 20px;
        transition: all 0.3s ease;
    }
    
    .resa-stock-summary-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    
    .resa-stock-summary-card .card-header {
        background: linear-gradient(120deg, #f5f7fa, #e4edf9);
        color: #0A4D2E;
        font-weight: 600;
        padding: 1rem 1.2rem;
        border-bottom: 1px solid #e3e6f0;
    }
    
    .resa-stock-summary-card .card-body {
        padding: 1.5rem;
    }
    
    .resa-stock-summary-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: #0A4D2E;
        margin-bottom: 0.5rem;
    }
    
    .resa-stock-summary-label {
        font-size: 0.9rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* Action buttons */
    .resa-stock-action-btn {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-restock {
        background: linear-gradient(120deg, #0B6623, #0A4D2E);
        color: white;
        border: none;
    }
    
    .btn-restock:hover {
        background: linear-gradient(120deg, #0A4D2E, #083c24);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(11, 102, 35, 0.3);
    }
    
    .btn-view-batches {
        background: linear-gradient(120deg, #2196F3, #1976D2);
        color: white;
        border: none;
    }
    
    .btn-view-batches:hover {
        background: linear-gradient(120deg, #1976D2, #0D47A1);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(33, 150, 243, 0.3);
    }
    
    /* Premium Modal Styling */
    .modal-premium .modal-content {
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        border: none;
    }
    
    .modal-premium .modal-header {
        background: linear-gradient(120deg, #0B6623, #0A4D2E);
        color: white;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .modal-premium .close {
        color: white;
        text-shadow: none;
        opacity: 0.8;
    }
    
    .modal-premium .close:hover {
        opacity: 1;
        color: white;
    }
    
    .modal-premium .form-control {
        border-radius: 8px;
        padding: 12px 15px;
        border: 1px solid #e0e0e0;
        transition: all 0.3s;
    }
    
    .modal-premium .form-control:focus {
        border-color: #0B6623;
        box-shadow: 0 0 0 0.2rem rgba(11, 102, 35, 0.25);
    }
    
    .modal-premium .form-label {
        font-weight: 600;
        color: #0A4D2E;
        margin-bottom: 8px;
    }
    
    .modal-premium .btn-primary {
        background: linear-gradient(120deg, #0B6623, #0A4D2E);
        border: none;
        border-radius: 8px;
        padding: 10px 20px;
        font-weight: 600;
    }
    
    .modal-premium .btn-primary:hover {
        background: linear-gradient(120deg, #0A4D2E, #083c24);
    }
    
    .medicine-detail-card {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .medicine-detail-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .medicine-detail-item:last-child {
        border-bottom: none;
    }
    
    .medicine-detail-label {
        font-weight: 600;
        color: #0A4D2E;
    }
    
    /* Toast notification */
    .toast-premium {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    
    .toast-header-premium {
        background: linear-gradient(120deg, #0B6623, #0A4D2E);
        color: white;
        padding: 10px 15px;
        font-weight: 600;
    }
    
    .toast-body-premium {
        padding: 15px;
        background: white;
    }
    
    /* Batch table styling */
    .batch-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .batch-table th {
        background: linear-gradient(120deg, #e3f2fd, #bbdefb);
        color: #1565C0;
        padding: 12px 15px;
        text-align: left;
        font-weight: 600;
    }
    
    .batch-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #e3f2fd;
    }
    
    .batch-table tr:hover {
        background-color: #f5f9ff;
    }
    
    .batch-status-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .batch-active {
        background: linear-gradient(120deg, #4CAF50, #2E7D32);
        color: white;
    }
    
    .batch-expired {
        background: linear-gradient(120deg, #F44336, #C62828);
        color: white;
    }
    
    .batch-warning {
        background: linear-gradient(120deg, #FF9800, #EF6C00);
        color: white;
    }
    
    .batch-empty {
        background: linear-gradient(120deg, #9E9E9E, #616161);
        color: white;
    }
    
    .batch-table-container {
        max-height: 400px;
        overflow-y: auto;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
    }
</style>

<div class="container-fluid">
    <!-- Toast Notification -->
    <div id="restockToast" class="toast-premium" role="alert" aria-live="assertive" aria-atomic="true" style="display: none;">
        <div class="toast-header-premium">
            <strong class="mr-auto" id="toastTitle">Notification</strong>
            <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="toast-body-premium" id="toastMessage">
            <!-- Message will be inserted here -->
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card resa-stock-gradient shadow-lg">
                <div class="card-header py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0 text-white"><i class="fas fa-pills mr-2"></i>In Stock Medicines Inventory</h5>
                        <div class="dropdown">
                            <span class="resa-stock-three-dots dropdown-toggle" id="moreStockOptions" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <i class="fas fa-ellipsis-v"></i>
                            </span>
                            <div class="dropdown-menu resa-stock-dropdown-menu" aria-labelledby="moreStockOptions">
                                <a class="dropdown-item resa-stock-dropdown-item" href="#"><i class="fas fa-file-export mr-2"></i> Export Data</a>
                                <a class="dropdown-item resa-stock-dropdown-item" href="#"><i class="fas fa-filter mr-2"></i> Filter Results</a>
                                <a class="dropdown-item resa-stock-dropdown-item" href="#"><i class="fas fa-cog mr-2"></i> Settings</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Summary Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card resa-stock-summary-card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-boxes mr-2"></i>Total Medicines</h6>
                                </div>
                                <div class="card-body text-center">
                                    <div class="resa-stock-summary-value">{{ in_stock_medicines|length }}</div>
                                    <div class="resa-stock-summary-label">Available Medicines</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card resa-stock-summary-card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-cubes mr-2"></i>High Stock Items</h6>
                                </div>
                                <div class="card-body text-center">
                                    <div class="resa-stock-summary-value">
                                        {% with high_stock=in_stock_medicines|length|multiply:0.7|floatformat:0 %}
                                            {{ high_stock }}
                                        {% endwith %}
                                    </div>
                                    <div class="resa-stock-summary-label">> 70% Stock Level</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card resa-stock-summary-card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-exclamation-triangle mr-2"></i>Low Stock Items</h6>
                                </div>
                                <div class="card-body text-center">
                                    <div class="resa-stock-summary-value">
                                        {% with low_stock=in_stock_medicines|length|multiply:0.1|floatformat:0 %}
                                            {{ low_stock }}
                                        {% endwith %}
                                    </div>
                                    <div class="resa-stock-summary-label">< 30% Stock Level</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card resa-stock-summary-card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-sync-alt mr-2"></i>Need Restock</h6>
                                </div>
                                <div class="card-body text-center">
                                    <div class="resa-stock-summary-value">
                                        {% with restock_count=in_stock_medicines|length|multiply:0.15|floatformat:0 %}
                                            {{ restock_count }}
                                        {% endwith %}
                                    </div>
                                    <div class="resa-stock-summary-label">Items to Restock</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive resa-stock-table-container">
                        <table class="table table-hover resa-stock-table" id="stockTable">
                            <thead>
                                <tr>
                                    <th><i class="fas fa-pills mr-2"></i>Medicine Name</th>
                                    <th><i class="fas fa-box-open mr-2"></i>Original Stock Level</th>              
                                    <th><i class="fas fa-box mr-2"></i>Remaining Quantity</th>              
                                    <th><i class="fas fa-chart-line mr-2"></i>Stock Level</th>
                                    <th><i class="fas fa-calendar-alt mr-2"></i>Last Updated</th>
                                    <th><i class="fas fa-cog mr-2"></i>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for inventory in in_stock_medicines %}                               
                                
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="resa-stock-avatar">
                                                <i class="fas fa-pills"></i>
                                            </div>
                                            <div>
                                                <strong>{{ inventory.drug_name }}</strong>
                                                <div class="text-muted small">{{ inventory.drug_type }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ inventory.quantity }}</td>   
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <span class="font-weight-bold mr-2">{{ inventory.remain_quantity }}</span>
                                            {% if inventory.remain_quantity <= inventory.quantity|add:"0"|multiply:0.2 %}
                                                <span class="resa-stock-badge resa-stock-badge-low">Low Stock</span>
                                            {% elif inventory.remain_quantity <= inventory.quantity|add:"0"|multiply:0.5 %}
                                                <span class="resa-stock-badge resa-stock-badge-medium">Medium Stock</span>
                                            {% else %}
                                                <span class="resa-stock-badge resa-stock-badge-high">High Stock</span>
                                            {% endif %}
                                        </div>
                                    </td>                
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="mr-2" style="min-width: 40px;">
                                                {% widthratio inventory.remain_quantity inventory.quantity 100 %}%
                                            </div>
                                            <div class="resa-stock-stock-indicator" style="flex-grow: 1;">
                                                <div class="resa-stock-stock-progress bg-success" style="width: {% widthratio inventory.remain_quantity inventory.quantity 100 %}%"></div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {{ inventory.updated_at|date:'d/m/Y' }}
                                        <div class="text-muted small">{{ inventory.updated_at|timesince }} ago</div>
                                    </td>
                                    <td>
                                        <div class="d-flex">
                                            <button class="btn btn-view-batches resa-stock-action-btn mr-2" 
                                                    data-toggle="modal" 
                                                    data-target="#batchModal{{ inventory.id }}">
                                                <i class="fas fa-list mr-1"></i> Batches
                                            </button>
                                            <button class="btn btn-restock resa-stock-action-btn" 
                                                    data-toggle="modal" 
                                                    data-target="#restockModal{{ inventory.id }}">
                                                <i class="fas fa-plus-circle mr-1"></i> Restock
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% for inventory in in_stock_medicines %}   
    <!-- Restock Modal for each medicine -->
    <div class="modal fade modal-premium" id="restockModal{{ inventory.id }}" tabindex="-1" role="dialog" aria-labelledby="restockModalLabel{{ inventory.id }}" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="restockModalLabel{{ inventory.id }}">Restock {{ inventory.drug_name }}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form class="restock-form" method="post" action="{% url 'resa_admin_restock_medicine' %}" data-medicine-id="{{ inventory.id }}">
                    {% csrf_token %}
                    <div class="modal-body">
                        <input type="hidden" name="medicine_id" value="{{ inventory.id }}">
                        
                        <!-- Medicine Details Card -->
                        <div class="medicine-detail-card">
                            <h6 class="mb-3"><i class="fas fa-info-circle mr-2"></i>Medicine Details</h6>
                            <div class="medicine-detail-item">
                                <span class="medicine-detail-label">Drug Name:</span>
                                <span>{{ inventory.drug_name }}</span>
                            </div>
                            <div class="medicine-detail-item">
                                <span class="medicine-detail-label">Drug Type:</span>
                                <span>{{ inventory.drug_type|default:"N/A" }}</span>
                            </div>
                            <div class="medicine-detail-item">
                                <span class="medicine-detail-label">Formulation:</span>
                                <span>{{ inventory.formulation_value }}{{ inventory.formulation_unit.short_name }}</span>
                            </div>
                            <div class="medicine-detail-item">
                                <span class="medicine-detail-label">Manufacturer:</span>
                                <span>{{ inventory.manufacturer }}</span>
                            </div>
                            <div class="medicine-detail-item">
                                <span class="medicine-detail-label">Current Batch:</span>
                                <span>{{ inventory.batch_number }}</span>
                            </div>
                            <div class="medicine-detail-item">
                                <span class="medicine-detail-label">Expiration Date:</span>
                                <span>{{ inventory.expiration_date|date:"M d, Y" }}</span>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="currentStock{{ inventory.id }}" class="form-label">Current Stock</label>
                                    <input type="text" class="form-control" id="currentStock{{ inventory.id }}" value="{{ inventory.remain_quantity }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="addQuantity{{ inventory.id }}" class="form-label">Quantity to Add *</label>
                                    <input type="number" class="form-control" id="addQuantity{{ inventory.id }}" name="add_quantity" min="1" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="newBatchNumber{{ inventory.id }}" class="form-label">New Batch Number *</label>
                                    <input type="text" class="form-control" id="newBatchNumber{{ inventory.id }}" name="batch_number" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="expirationDate{{ inventory.id }}" class="form-label">New Expiration Date *</label>
                                    <input type="date" class="form-control" id="expirationDate{{ inventory.id }}" name="expiration_date" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="buyingPrice{{ inventory.id }}" class="form-label">Buying Price (per unit)</label>
                                    <input type="number" step="0.01" class="form-control" id="buyingPrice{{ inventory.id }}" name="buying_price" value="{{ inventory.buying_price|default:0 }}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="totalPrice{{ inventory.id }}" class="form-label">Estimated Total Price</label>
                                    <input type="text" class="form-control" id="totalPrice{{ inventory.id }}" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Restock</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Batch Details Modal for each medicine -->
    <div class="modal fade modal-premium" id="batchModal{{ inventory.id }}" tabindex="-1" role="dialog" aria-labelledby="batchModalLabel{{ inventory.id }}" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="batchModalLabel{{ inventory.id }}"><i class="fas fa-list mr-2"></i>Batch Details for {{ inventory.drug_name }}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Medicine Summary -->
                    <div class="medicine-detail-card mb-4">
                        <h6 class="mb-3"><i class="fas fa-info-circle mr-2"></i>Medicine Summary</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="medicine-detail-item">
                                    <span class="medicine-detail-label">Drug Name:</span>
                                    <span>{{ inventory.drug_name }}</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="medicine-detail-item">
                                    <span class="medicine-detail-label">Drug Type:</span>
                                    <span>{{ inventory.drug_type|default:"N/A" }}</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="medicine-detail-item">
                                    <span class="medicine-detail-label">Formulation:</span>
                                    <span>{{ inventory.formulation_value }}{{ inventory.formulation_unit.short_name }}</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="medicine-detail-item">
                                    <span class="medicine-detail-label">Total Quantity:</span>
                                    <span>{{ inventory.quantity }}</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="medicine-detail-item">
                                    <span class="medicine-detail-label">Remaining Quantity:</span>
                                    <span>{{ inventory.remain_quantity }}</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="medicine-detail-item">
                                    <span class="medicine-detail-label">Stock Level:</span>
                                    <span>{% widthratio inventory.remain_quantity inventory.quantity 100 %}%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Batch Details Table -->
                    <h6 class="mb-3"><i class="fas fa-boxes mr-2"></i>Batch Information</h6>
                    <div class="batch-table-container">
                        <table class="batch-table">
                            <thead>
                                <tr>
                                    <th>Batch Number</th>
                                    <th>Expiration Date</th>
                                    <th>Initial Quantity</th>
                                    <th>Remaining Quantity</th>
                                    <th>Buying Price</th>
                                    <th>Created Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for batch in inventory.batches.all %}
                                <tr>
                                    <td>{{ batch.batch_number }}</td>
                                    <td>{{ batch.expiration_date|date:"M d, Y" }}</td>
                                    <td>{{ batch.quantity }}</td>
                                    <td>{{ batch.remain_quantity }}</td>
                                    <td>Tsh{{ batch.buying_price|floatformat:2|default:"0.00" }}</td>
                                    <td>{{ batch.created_at|date:"M d, Y" }}</td>
                                    <td>
                                        {% now "Y-m-d" as current_date %}
                                        {% if batch.remain_quantity == 0 %}
                                            <span class="batch-status-badge batch-empty">Empty</span>
                                        {% elif batch.expiration_date|date:"Y-m-d" < current_date %}
                                            <span class="batch-status-badge batch-expired">Expired</span>
                                        {% elif batch.expiration_date|date:"Y-m-d" <= current_date|add:30 %}
                                            <span class="batch-status-badge batch-warning">Expiring Soon</span>
                                        {% else %}
                                            <span class="batch-status-badge batch-active">Active</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center py-4">No batch information available for this medicine.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
{% endfor %}
{% include 'hod_template/datatable.html' %}
<script>
    new DataTable('#stockTable', {
        dom: 'Bfrtip',
        buttons: ['excel', 'pdf', 'print'],
        responsive: true,
        pageLength: 10,
        order: [[4, 'desc']],
        language: {
            search: "_INPUT_",
            searchPlaceholder: "Search medicines...",
            lengthMenu: "Show _MENU_ entries"
        },
        columnDefs: [
            { orderable: false, targets: 5 } // Disable sorting on the Actions column
        ]
    });

    // Calculate total price when buying price or quantity changes
    $(document).on('input', 'input[name="buying_price"], input[name="add_quantity"]', function() {
        var form = $(this).closest('form');
        var buyingPrice = parseFloat(form.find('input[name="buying_price"]').val()) || 0;
        var quantity = parseInt(form.find('input[name="add_quantity"]').val()) || 0;
        var totalPrice = buyingPrice * quantity;
        
        form.find('input[id^="totalPrice"]').val(totalPrice.toFixed(2));
    });

    // Set today's date as default for expiration date in all modals
    $('.modal').on('show.bs.modal', function() {
        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
        var mm = String(today.getMonth() + 1).padStart(2, '0');
        var yyyy = today.getFullYear();
        today = yyyy + '-' + mm + '-' + dd;
        
        $(this).find('input[type="date"]').val(today);
    });

    // Handle form submission with AJAX
    $('.restock-form').on('submit', function(e) {
        e.preventDefault();
        var form = $(this);
        var url = form.attr('action');
        var formData = form.serialize();
        var medicineId = form.data('medicine-id');
        
        $.ajax({
            type: 'POST',
            url: url,
            data: formData,
            beforeSend: function() {
                // Show loading state
                form.find('button[type="submit"]').html('<i class="fas fa-spinner fa-spin"></i> Processing...').prop('disabled', true);
            },
            success: function(response) {
                if (response.success) {
                    // Show success message
                    showToast('Success', response.message, 'success');
                    
                    // Close the modal
                    $('#restockModal' + medicineId).modal('hide');
                    
                    // Reload the page after a short delay to show the changes
                    setTimeout(function() {
                        location.reload();
                    }, 5000);
                } else {
                    // Show error message
                    showToast('Error', response.message, 'error');
                    form.find('button[type="submit"]').html('Restock').prop('disabled', false);
                }
            },
            error: function(xhr, status, error) {
                var errorMessage = 'An error occurred: ' + error;
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                }
                showToast('Error', errorMessage, 'error');
                form.find('button[type="submit"]').html('Restock').prop('disabled', false);
            }
        });
    });

    // Function to show toast notifications
    function showToast(title, message, type) {
        $('#toastTitle').text(title);
        $('#toastMessage').text(message);
        
        // Set different header colors based on type
        var toastHeader = $('.toast-header-premium');
        if (type === 'success') {
            toastHeader.css('background', 'linear-gradient(120deg, #0B6623, #0A4D2E)');
        } else if (type === 'error') {
            toastHeader.css('background', 'linear-gradient(120deg, #e53935, #b71c1c)');
        }
        
        $('#restockToast').fadeIn();
        
        // Auto hide after 5 seconds
        setTimeout(function() {
            $('#restockToast').fadeOut();
        }, 5000);
    }

    // Allow closing the toast manually
    $('[data-dismiss="toast"]').on('click', function() {
        $('#restockToast').fadeOut();
    });
</script>
{% endblock main_content %}