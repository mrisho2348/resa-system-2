{% extends 'hod_template/base_template.html' %}
{% load static %}

{% block title %}
Ambulance Orders Management
{% endblock title %}

{% block breadcrumb %}
{% include "hod_template/modal_form.html" %}
{% endblock breadcrumb %}

{% block main_content %}
<style>
    .card-gradient {
        background: linear-gradient(120deg, #1e88e5, #0d47a1);
        color: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    .card-gradient .card-header {
        background: rgba(0,0,0,0.1);
        border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    .badge-condition {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    .badge-emergency {
        background: linear-gradient(120deg, #e53935, #b71c1c);
        color: white;
    }
    .badge-stable {
        background: linear-gradient(120deg, #43a047, #1b5e20);
        color: white;
    }
    .badge-critical {
        background: linear-gradient(120deg, #ff9800, #e65100);
        color: white;
    }
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 6px;
    }
    .status-yes {
        background-color: #28a745;
    }
    .status-no {
        background-color: #dc3545;
    }
    .action-btn {
        transition: all 0.3s ease;
        border-radius: 8px;
        padding: 8px 15px;
        font-size: 0.85rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    .modal-header-gradient {
        background: linear-gradient(120deg, #1e88e5, #0d47a1);
        color: white;
        border-radius: 0;
    }
    .modal-header-danger {
        background: linear-gradient(120deg, #e53935, #b71c1c);
        color: white;
        border-radius: 0;
    }
    .ambulance-table th {
        background: linear-gradient(120deg, #e3f2fd, #bbdefb);
        color: #0d47a1;
        font-weight: 600;
    }
    .summary-card {
        background: linear-gradient(120deg, #e8f5e9, #c8e6c9);
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    .map-container {
        height: 200px;
        background: #f5f5f5;
        border-radius: 10px;
        overflow: hidden;
        position: relative;
    }
    .map-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(rgba(30, 136, 229, 0.2), rgba(13, 71, 161, 0.3));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        font-weight: 600;
    }
    .detail-row {
        border-bottom: 1px solid #eee;
        padding: 10px 0;
    }
    .detail-row:last-child {
        border-bottom: none;
    }
    .map-marker {
        position: absolute;
        width: 20px;
        height: 20px;
        background: #e53935;
        border-radius: 50% 50% 50% 0;
        transform: rotate(-45deg);
        top: 50%;
        left: 40%;
    }
    .map-marker::after {
        content: '';
        position: absolute;
        width: 8px;
        height: 8px;
        background: white;
        border-radius: 50%;
        top: 6px;
        left: 6px;
    }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card card-gradient shadow-lg">
                <div class="card-header py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0 text-white"><i class="fas fa-ambulance mr-2"></i>Ambulance Orders Management</h5>
                        <div class="d-flex">
                            <button class="btn btn-light btn-sm mr-2">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            <button class="btn btn-light btn-sm">
                                <i class="fas fa-filter"></i> Filter
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover ambulance-table" id="ambulanceTable">
                            <thead class="bg-light">
                                <tr>
                                    <th><i class="fas fa-ambulance mr-2"></i>Ambulance</th>
                                    <th><i class="fas fa-user-injured mr-2"></i>Patient</th>
                                    <th><i class="fas fa-first-aid mr-2"></i>Service</th>
                                    <th><i class="fas fa-map-marker-alt mr-2"></i>From</th>
                                    <th><i class="fas fa-map-marker-alt mr-2"></i>To</th>
                                    <th><i class="fas fa-heartbeat mr-2"></i>Condition</th>
                                    <th class="text-center"><i class="fas fa-cogs mr-2"></i>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in ambulance_orders %}
                                <tr>
                                    <td>
                                        <div class="font-weight-bold">#{{ order.ambulance_number }}</div>
                                        <small class="text-muted">{{ order.ambulance_type }}</small>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm mr-2 bg-light-primary rounded-circle d-flex align-items-center justify-content-center">
                                                <i class="fas fa-user text-primary"></i>
                                            </div>
                                            <div>
                                                <div class="font-weight-bold">{{ order.patient }}</div>
                                                <small class="text-muted">{{ order.age }} years</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ order.service }}</td>
                                    <td>
                                        <div class="text-truncate" style="max-width: 150px;">
                                            {{ order.from_location }}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="text-truncate" style="max-width: 150px;">
                                            {{ order.to_location }}
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge-condition 
                                            {% if order.condition == 'Critical' %}badge-critical
                                            {% elif order.condition == 'Emergency' %}badge-emergency
                                            {% else %}badge-stable{% endif %}">
                                            {{ order.condition }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <div class="d-flex justify-content-center">
                                            <button class="btn btn-outline-primary action-btn mx-1" 
                                                    data-toggle="modal" 
                                                    data-target="#orderDetailModal{{ order.id }}">
                                                <i class="fas fa-eye mr-1"></i> View
                                            </button>

                                            <button class="btn btn-outline-danger action-btn mx-1" 
                                                    data-toggle="modal" 
                                                    data-target="#deleteAmbulanceModal{{ order.id }}">
                                                <i class="fas fa-trash mr-1"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>                        
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% for order in ambulance_orders %}
<!-- Order Detail Modal -->
<div class="modal fade" id="orderDetailModal{{ order.id }}" tabindex="-1" role="dialog" aria-labelledby="orderDetailModalLabel{{ order.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header modal-header-gradient py-3">
                <h5 class="modal-title text-white">
                    <i class="fas fa-ambulance mr-2"></i>Ambulance Order Details
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body p-4">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card shadow-sm mb-4">
                                <div class="card-header bg-light py-2">
                                    <h6 class="mb-0"><i class="fas fa-user-injured mr-2"></i>Patient Information</h6>
                                </div>
                                <div class="card-body">
                                    <div class="detail-row">
                                        <div class="font-weight-bold text-secondary">Patient Name</div>
                                        <div>{{ order.patient }}</div>
                                    </div>
                                    <div class="detail-row">
                                        <div class="font-weight-bold text-secondary">Age</div>
                                        <div>{{ order.age }} years</div>
                                    </div>
                                    <div class="detail-row">
                                        <div class="font-weight-bold text-secondary">Condition</div>
                                        <span class="badge-condition 
                                            {% if order.condition == 'Critical' %}badge-critical
                                            {% elif order.condition == 'Emergency' %}badge-emergency
                                            {% else %}badge-stable{% endif %}">
                                            {{ order.condition }}
                                        </span>
                                    </div>
                                    <div class="detail-row">
                                        <div class="font-weight-bold text-secondary">Special Requirements</div>
                                        <div class="d-flex">
                                            <div class="mr-3">
                                                <span class="status-indicator {% if order.intubation == 'Yes' %}status-yes{% else %}status-no{% endif %}"></span>
                                                Intubation: {{ order.intubation }}
                                            </div>
                                            <div class="mr-3">
                                                <span class="status-indicator {% if order.pregnancy == 'Yes' %}status-yes{% else %}status-no{% endif %}"></span>
                                                Pregnancy: {{ order.pregnancy }}
                                            </div>
                                            <div>
                                                <span class="status-indicator {% if order.oxygen == 'Yes' %}status-yes{% else %}status-no{% endif %}"></span>
                                                Oxygen: {{ order.oxygen }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card shadow-sm">
                                <div class="card-header bg-light py-2">
                                    <h6 class="mb-0"><i class="fas fa-file-invoice-dollar mr-2"></i>Billing Information</h6>
                                </div>
                                <div class="card-body">
                                    <div class="detail-row">
                                        <div class="font-weight-bold text-secondary">Service</div>
                                        <div>{{ order.service }}</div>
                                    </div>
                                    <div class="detail-row">
                                        <div class="font-weight-bold text-secondary">Ambulance Type</div>
                                        <div>{{ order.ambulance_type }}</div>
                                    </div>
                                    <div class="detail-row">
                                        <div class="font-weight-bold text-secondary">Duration</div>
                                        <div>
                                            {% if order.duration_days > 0 %}
                                                {{ order.duration_days }} days
                                            {% endif %}
                                            {% if order.duration_hours > 0 %}
                                                {{ order.duration_hours }} hours
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="detail-row">
                                        <div class="font-weight-bold text-secondary">Payment Mode</div>
                                        <div>{{ order.payment_mode }}</div>
                                    </div>
                                    <div class="detail-row">
                                        <div class="font-weight-bold text-secondary">Total Cost</div>
                                        <div class="h5 text-primary">${{ order.cost }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card shadow-sm h-100">
                                <div class="card-header bg-light py-2">
                                    <h6 class="mb-0"><i class="fas fa-route mr-2"></i>Transport Details</h6>
                                </div>
                                <div class="card-body">
                                    <div class="map-container mb-4">
                                        <div class="map-overlay">
                                            <div class="text-center">
                                                <div class="map-marker"></div>
                                                <div class="mt-5">
                                                    <i class="fas fa-ambulance fa-2x mb-2"></i>
                                                    <div>Route Visualization</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="font-weight-bold text-secondary">Pickup Location</div>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-map-marker-alt text-danger mr-2"></i>
                                            <div>{{ order.from_location }}</div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="font-weight-bold text-secondary">Destination</div>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-map-marker-alt text-success mr-2"></i>
                                            <div>{{ order.to_location }}</div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="font-weight-bold text-secondary">Distance</div>
                                        <div>Approx. 18.5 km</div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="font-weight-bold text-secondary">Estimated Time</div>
                                        <div>35-45 minutes</div>
                                    </div>

                                    <div class="text-center mt-4">
                                        <button class="btn btn-primary">
                                            <i class="fas fa-map-marked-alt mr-2"></i>Track Ambulance
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteAmbulanceModal{{ order.id }}" tabindex="-1" role="dialog" aria-labelledby="deleteAmbulanceModalLabel{{ order.id }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header modal-header-danger py-3">
                <h5 class="modal-title text-white">
                    <i class="fas fa-trash-alt mr-2"></i>Confirm Deletion
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                    <h4 class="font-weight-bold">Delete Ambulance Order</h4>
                </div>
                
                <div class="alert alert-warning">
                    <p class="mb-0">This action will permanently remove this ambulance order record.</p>
                </div>
                
                <div class="card mb-3 border-danger">
                    <div class="card-body">
                        <h5 class="font-weight-bold text-danger">Order #{{ order.id }}</h5>
                        <p class="mb-1"><strong>Patient:</strong> {{ order.patient }}</p>
                        <p class="mb-1"><strong>Service:</strong> {{ order.service }}</p>
                        <p class="mb-0"><strong>Date:</strong> {{ order.created_at|date:"d/m/Y" }}</p>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-danger px-4" onclick="deleteAmbulanceOrder({{ order.id }})">
                        <i class="fas fa-trash mr-2"></i>Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<script>
    $(document).ready(function() {
        $('#ambulanceTable').DataTable({
            "order": [[0, "desc"]],
            "responsive": true,
            "autoWidth": false,
            "language": {
                "paginate": {
                    "previous": "<i class='fas fa-chevron-left'></i>",
                    "next": "<i class='fas fa-chevron-right'></i>"
                }
            },
            "columnDefs": [
                { "orderable": false, "targets": [6] }
            ]
        });
        
        // Add hover effect to table rows
        $('#ambulanceTable tbody tr').hover(
            function() {
                $(this).css('background-color', '#f8f9fa');
                $(this).css('transform', 'translateY(-2px)');
                $(this).css('box-shadow', '0 4px 8px rgba(0,0,0,0.05)');
            },
            function() {
                $(this).css('background-color', '');
                $(this).css('transform', '');
                $(this).css('box-shadow', '');
            }
        );
    });
    
    function deleteAmbulanceOrder(order_id) {
        $.ajax({
            type: 'POST',
            url: '{% url "resa_admin_delete_ambulance_order" %}',
            data: { 
                order_id: order_id,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function (data) {
                if (data.success) {
                    $('#deleteAmbulanceModal' + order_id).modal('hide');
                    // Show success message
                    alert('Ambulance order deleted successfully!');
                    // Reload after 1 second
                    setTimeout(function() {
                        location.reload(true);
                    }, 1000);
                } else {
                    alert('Error: ' + data.message);
                }
            },
            error: function (error) {
                alert('Error occurred: ' + error.statusText);
            }
        });
    }
</script>

{% include 'hod_template/datatable.html' %}
{% endblock main_content %}