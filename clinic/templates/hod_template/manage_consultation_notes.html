{% extends 'hod_template/base_template.html' %}
{% block title %}
   List of all consultation
{% endblock title %}
{% block breadcrumb %}
{% include "hod_template/modal_form.html" %} 

{% endblock breadcrumb %}
{% block main_content %}
<style>
    /* Premium styling with unique class names */
    .resa-consultation-gradient {
        background: linear-gradient(120deg, #FF8C00, #FF5722);
       
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 15px 35px rgba(255, 140, 0, 0.15);
        border: none;
    }
    
    .resa-consultation-gradient .card-header {
        background: rgba(0,0,0,0.1);
        border-bottom: 1px solid rgba(255,255,255,0.2);
        padding: 1.2rem 1.5rem;
    }
    
    .resa-consultation-table-container {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.06);
    }
    
    .resa-consultation-table th {
        background: linear-gradient(120deg, #fff3e0, #ffe0b2);
        color: #FF5722;
        font-weight: 600;
        padding: 1rem 0.75rem;
        border: none;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .resa-consultation-table td {
        padding: 1.1rem 0.75rem;
        vertical-align: middle;
        border-color: #fff8e1;
    }
    
    .resa-consultation-table tbody tr {
        transition: all 0.3s ease;
        background: white;
    }
    
    .resa-consultation-table tbody tr:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(255, 140, 0, 0.1);
        background: #fffaf0;
    }
    
    .resa-consultation-badge {
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .resa-consultation-badge-discharged {
        background: linear-gradient(120deg, #43a047, #2e7d32);
        color: white;
    }
    
    .resa-consultation-badge-referral {
        background: linear-gradient(120deg, #ff9800, #f57c00);
        color: white;
    }
    
    .resa-consultation-badge-progress {
        background: linear-gradient(120deg, #03a9f4, #0288d1);
        color: white;
    }
    
    .resa-consultation-btn-view {
        background: linear-gradient(120deg, #FF8C00, #FF5722);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 8px 16px;
        font-size: 0.85rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(255, 140, 0, 0.2);
    }
    
    .resa-consultation-btn-view:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(255, 140, 0, 0.3);
        color: white;
    }
    
    .resa-consultation-modal-header {
        background: linear-gradient(120deg, #FF8C00, #FF5722);
        color: white;
        border-radius: 0;
        padding: 1.2rem 1.5rem;
    }
    
    .resa-consultation-patient-card {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.06);
        border: 1px solid #fff3e0;
        margin-bottom: 20px;
    }
    
    .resa-consultation-patient-card .card-header {
        background: linear-gradient(120deg, #fffaf0, #fff3e0);
        color: #FF5722;
        font-weight: 600;
        padding: 1rem 1.2rem;
    }
    
    .resa-consultation-download-btn {
        background: linear-gradient(120deg, #43a047, #2e7d32);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 20px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(67, 160, 71, 0.2);
    }
    
    .resa-consultation-download-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(67, 160, 71, 0.3);
        color: white;
    }
    
    .resa-consultation-table-details {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    
    .resa-consultation-table-details th {
        background: linear-gradient(120deg, #fffaf0, #fff3e0);
        color: #FF5722;
        padding: 0.9rem 0.75rem;
        font-weight: 600;
    }
    
    .resa-consultation-table-details td {
        padding: 0.9rem 0.75rem;
        border-color: #fff8e1;
    }
    
    /* Three dot menu styling */
    .resa-consultation-dropdown-menu {
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        border: none;
        padding: 0.5rem 0;
        overflow: hidden;
    }
    
    .resa-consultation-dropdown-item {
        padding: 0.7rem 1.2rem;
        transition: all 0.2s ease;
    }
    
    .resa-consultation-dropdown-item:hover {
        background: #fffaf0;
    }
    
    .resa-consultation-three-dots {
        color: #FF5722;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .resa-consultation-three-dots:hover {
        color: #FF8C00;
        transform: rotate(90deg);
    }
    
    /* Floating action button */
    .resa-consultation-fab {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(120deg, #FF8C00, #FF5722);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 8px 25px rgba(255, 140, 0, 0.3);
        z-index: 1000;
        transition: all 0.3s ease;
    }
    
    .resa-consultation-fab:hover {
        transform: translateY(-5px) rotate(90deg);
        box-shadow: 0 12px 30px rgba(255, 140, 0, 0.4);
        color: white;
    }
    
    .resa-consultation-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(120deg, #FF8C00, #FF5722);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 12px;
    }
    
    .resa-consultation-section {
        margin-bottom: 25px;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    
    .resa-consultation-section-header {
        background: linear-gradient(120deg, #fffaf0, #fff3e0);
        color: #FF5722;
        font-weight: 600;
        padding: 1rem 1.2rem;
        border-bottom: 1px solid #ffe0b2;
    }
    
    .resa-consultation-status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .modal-xl-custom {
        max-width: 95%;
    }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card resa-consultation-gradient shadow-lg">
                <div class="card-header py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0 text-white"><i class="fas fa-stethoscope mr-2"></i>Consultation Management</h5>
                        <div class="dropdown">
                            <span class="resa-consultation-three-dots dropdown-toggle" id="moreConsultationOptions" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <i class="fas fa-ellipsis-v"></i>
                            </span>                     
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive resa-consultation-table-container">
                        <table class="table table-hover resa-consultation-table" id="consultationTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th><i class="fas fa-id-card mr-2"></i>MRN</th>
                                    <th><i class="fas fa-user mr-2"></i>Name</th>
                                    <th><i class="fas fa-birthday-cake mr-2"></i>Age</th>
                                    <th><i class="fas fa-venus-mars mr-2"></i>Gender</th>
                                    <th><i class="fas fa-credit-card mr-2"></i>Payment Form</th>
                                    <th><i class="fas fa-phone mr-2"></i>Phone</th>
                                    <th><i class="fas fa-tasks mr-2"></i>Status</th>
                                    <th><i class="fas fa-calendar mr-2"></i>Added At</th>
                                    <th class="text-center"><i class="fas fa-cogs mr-2"></i>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for patient in patient_records %}
                                <tr>
                                    <td>{{ patient.id }}</td>
                                    <td>{{ patient.mrn }}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="resa-consultation-avatar">
                                                {{ patient.first_name|first }}{{ patient.last_name|first }}
                                            </div>
                                            <div>
                                                <h6 class="mb-0 text-uppercase">{{ patient.first_name }} {{ patient.middle_name }} {{ patient.last_name }}</h6>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if patient.dob %}
                                            <script>
                                                var dob = new Date("{{ patient.dob|date:'Y-m-d' }}");
                                                var now = new Date();
                                                var ageMilliseconds = now - dob;
                                                var ageSeconds = ageMilliseconds / 1000;
                                                var ageYears = Math.floor(ageSeconds / (365.25 * 24 * 60 * 60));
                                                document.write(ageYears + ' years');
                                            </script>
                                        {% else %}
                                            {{ patient.age }}
                                        {% endif %}
                                    </td>
                                    <td>{{ patient.gender }}</td>
                                    <td>
                                        {% if patient.payment_form == "Insurance" %}
                                            {{ patient.payment_form }} - {{ patient.insurance_name }}
                                        {% else %}
                                            {{ patient.payment_form }}
                                        {% endif %}
                                    </td>
                                    <td>{{ patient.phone }}</td>
                                    <td>
                                        {% if patient.consultationnotes.doctor_plan == "Discharge" %}
                                            <span class="resa-consultation-badge resa-consultation-badge-discharged">Discharged</span>
                                        {% elif patient.consultationnotes.doctor_plan == "Referral" %}
                                            <span class="resa-consultation-badge resa-consultation-badge-referral">Referral</span>
                                        {% else %}
                                            <span class="resa-consultation-badge resa-consultation-badge-progress">In Progress</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ patient.created_at|date:"d-m-Y" }}</td>
                                    <td class="text-center">
                                        <button type="button" class="btn resa-consultation-btn-view mx-1" data-toggle="modal" data-target="#patientVisitsModal{{ patient.id }}">
                                            <i class="fa fa-eye mr-1"></i> Profile
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




{% for patient in patient_records %}
<!-- Modal: List of All Patient Visits -->
<div class="modal fade" id="patientVisitsModal{{ patient.id }}" tabindex="-1" role="dialog" aria-labelledby="patientVisitsModalLabel{{ patient.id }}" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header resa-consultation-modal-header py-3">
                <h5 class="modal-title text-white">
                    <i class="fas fa-history mr-2"></i>Visit History for {{ patient.first_name }} {{ patient.last_name }}
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-4">
                <div class="table-responsive resa-consultation-table-container">
                    <table class="table table-hover resa-consultation-table-details">
                        <thead>
                            <tr>
                                <th><i class="fas fa-hashtag mr-2"></i>Visit Number</th>
                                <th><i class="fas fa-stethoscope mr-2"></i>Visit Type</th>
                                <th><i class="fas fa-calendar-day mr-2"></i>Date</th>
                                <th><i class="fas fa-calendar-week mr-2"></i>Day</th>
                                <th class="text-center"><i class="fas fa-cogs mr-2"></i>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for visit in patient.patientvisits_set.all %}
                            <tr>
                                <td><span class="resa-consultation-badge resa-consultation-badge-progress">{{ visit.vst }}</span></td>
                                <td>{{ visit.get_visit_type_display }}</td>
                                <td>{{ visit.created_at|date:"Y-m-d" }}</td>
                                <td>{{ visit.created_at|date:"l" }}</td>
                                <td class="text-center">
                                    <button type="button" class="btn resa-consultation-btn-view mx-1" data-toggle="modal" data-target="#visitDetailModal_{{ visit.id }}">
                                        <i class="fa fa-eye mr-1"></i> Summary
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-4">No previous visits found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endfor %}

{% for patient in patient_records %}
{% for visit in patient.patientvisits_set.all %}
<!-- Visit Detail Modal -->
<div class="modal fade" id="visitDetailModal_{{ visit.id }}" tabindex="-1" role="dialog" aria-labelledby="visitDetailModalLabel_{{ visit.id }}" aria-hidden="true">
    <div class="modal-dialog modal-xl-custom modal-dialog-scrollable" role="document">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header resa-consultation-modal-header py-3">
                <div class="d-flex justify-content-between align-items-center w-100">
                    <h5 class="modal-title text-white mb-0">
                        <i class="fas fa-file-medical-alt mr-2"></i>Consultation Summary - Visit {{ visit.vst }}
                    </h5>
                    <div>
                        <a href="{% url 'resa_admin_download_consultation_summary' patient.id visit.id %}" class="btn resa-consultation-download-btn mr-2">
                            <i class="fa fa-download mr-1"></i> PDF
                        </a>
                        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-body p-4">
                <!-- Patient Details Section -->
                <div class="resa-consultation-section">
                    <div class="resa-consultation-section-header">
                        <h6 class="mb-0"><i class="fas fa-user-injured mr-2"></i>Patient Details</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="resa-consultation-avatar mr-3">
                                        {{ patient.first_name|first }}{{ patient.last_name|first }}
                                    </div>
                                    <div>
                                        <p class="mb-0 font-weight-bold">{{ patient.full_name|default:"-" }}</p>
                                        <small class="text-muted">MRN: {{ patient.mrn|default:"-" }}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="row">
                                    <div class="col-md-3 mb-2">
                                        <p class="mb-0"><strong><i class="fas fa-hashtag mr-1"></i>Visit:</strong></p>
                                        <p class="mb-0">{{ visit.vst|default:"-" }}</p>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <p class="mb-0"><strong><i class="fas fa-birthday-cake mr-1"></i>Age:</strong></p>
                                        <p class="mb-0">{{ patient.age|default:"-" }}</p>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <p class="mb-0"><strong><i class="fas fa-venus-mars mr-1"></i>Gender:</strong></p>
                                        <p class="mb-0">{{ patient.gender|default:"-" }}</p>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <p class="mb-0"><strong><i class="fas fa-clock mr-1"></i>Time:</strong></p>
                                        <p class="mb-0">{{ visit.created_at|default:"-"|time:"H:i" }}</p>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <p class="mb-0"><strong><i class="fas fa-credit-card mr-1"></i>Payment:</strong></p>
                                        <p class="mb-0">
                                            {% if patient.payment_form == "Insurance" %}
                                                {{ patient.payment_form|default:"-" }} - {{ patient.insurance_name|default:"-" }}
                                            {% else %}
                                                {{ patient.payment_form|default:"-" }}
                                            {% endif %}
                                        </p>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <p class="mb-0"><strong><i class="fas fa-phone mr-1"></i>Phone:</strong></p>
                                        <p class="mb-0">{{ patient.phone|default:"-" }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {% if visit.patientvital_set.exists %}
                <!-- Vital Signs Section -->
                <div class="resa-consultation-section mt-4">
                    <div class="resa-consultation-section-header">
                        <h6 class="mb-0"><i class="fas fa-heartbeat mr-2"></i>Vital Signs/Assessment Data</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover resa-consultation-table-details">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Resp Rate</th>
                                        <th>Pulse</th>
                                        <th>BP</th>
                                        <th>SPO2</th>
                                        <th>Temp (°C)</th>
                                        <th>GCS</th>
                                        <th>AVPU</th>
                                        <th>Weight</th>
                                        <th>Recorded By</th>
                                        <th>Recorded At</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for vitals in visit.patientvital_set.all %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ vitals.respiratory_rate|default:"-" }}</td>
                                        <td>{{ vitals.pulse_rate|default:"-" }}</td>
                                        <td>{{ vitals.blood_pressure|default:"-" }}</td>
                                        <td>{{ vitals.spo2|default:"-" }}%</td>
                                        <td>{{ vitals.temperature|default:"-" }}</td>
                                        <td>{{ vitals.gcs|default:"-" }}</td>
                                        <td>{{ vitals.avpu|default:"-" }}</td>
                                        <td>{{ vitals.weight|default:"-" }}</td>
                                        <td>{{ vitals.recorded_by.get_full_name|default:"System" }}</td>
                                        <td>{{ vitals.recorded_at|date:"d-m-Y" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% with consultation_note=visit.consultationnotes_set.first diagnosis_record=visit.patientdiagnosisrecord_set.first %}
                {% if consultation_note %}
                <!-- Clinical Notes Section -->
                <div class="resa-consultation-section mt-4">
                    <div class="resa-consultation-section-header">
                        <h6 class="mb-0"><i class="fas fa-file-medical mr-2"></i>Clinical Notes</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% if visit.clinicchiefcomplaint_set.exists %}
                            <div class="col-md-6 mb-3">
                                <h6><i class="fas fa-comment-medical mr-2"></i>Chief Complaints:</h6>
                                <div class="bg-light p-3 rounded">
                                    <ul class="mb-0">
                                        {% for complaint in visit.clinicchiefcomplaint_set.all %}
                                            <li>{{ complaint.health_record }} - Duration: {{ complaint.duration }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if consultation_note.history_of_presenting_illness %}
                            <div class="col-md-6 mb-3">
                                <h6><i class="fas fa-stethoscope mr-2"></i>History of Presenting Illness:</h6>
                                <div class="bg-light p-3 rounded">
                                    {{ consultation_note.history_of_presenting_illness }}
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if consultation_note.review_of_systems %}
                            <div class="col-md-6 mb-3">
                                <h6><i class="fas fa-search mr-2"></i>Review of Systems:</h6>
                                <div class="bg-light p-3 rounded">
                                    {{ consultation_note.review_of_systems }}
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if consultation_note.physical_examination %}
                            <div class="col-md-6 mb-3">
                                <h6><i class="fas fa-user-md mr-2"></i>Physical Examination:</h6>
                                <div class="bg-light p-3 rounded">
                                    {{ consultation_note.physical_examination }}
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if consultation_note.doctor_plan %}
                            <div class="col-md-6 mb-3">
                                <h6><i class="fas fa-tasks mr-2"></i>Doctor's Plan:</h6>
                                <div class="bg-light p-3 rounded">
                                    {{ consultation_note.doctor_plan }}
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if consultation_note.doctor_plan_note %}
                            <div class="col-md-6 mb-3">
                                <h6><i class="fas fa-clipboard-list mr-2"></i>Doctor's Plan Notes:</h6>
                                <div class="bg-light p-3 rounded">
                                    {{ consultation_note.doctor_plan_note }}
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if consultation_note.allergy_summary %}
                            <div class="col-md-6 mb-3">
                                <h6><i class="fas fa-allergies mr-2"></i>Allergy Summary:</h6>
                                <div class="bg-light p-3 rounded">
                                    {{ consultation_note.allergy_summary }}
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if consultation_note.known_comorbidities_summary %}
                            <div class="col-md-6 mb-3">
                                <h6><i class="fas fa-disease mr-2"></i>Known Comorbidities:</h6>
                                <div class="bg-light p-3 rounded">
                                    {{ consultation_note.known_comorbidities_summary }}
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if diagnosis_record %}
                            {% if diagnosis_record.provisional_diagnosis.exists %}
                            <div class="col-md-6 mb-3">
                                <h6><i class="fas fa-diagnoses mr-2"></i>Provisional Diagnosis:</h6>
                                <div class="bg-light p-3 rounded">
                                    <ul class="mb-0">
                                        {% for pdx in diagnosis_record.provisional_diagnosis.all %}
                                            <li>{{ pdx.diagnosis_name }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if diagnosis_record.final_diagnosis.exists %}
                            <div class="col-md-6 mb-3">
                                <h6><i class="fas fa-diagnoses mr-2"></i>Final Diagnosis:</h6>
                                <div class="bg-light p-3 rounded">
                                    <ul class="mb-0">
                                        {% for fdx in diagnosis_record.final_diagnosis.all %}
                                            <li>{{ fdx.diagnosis_name }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endwith %}

                {% if visit.laboratoryorder_set.exists %}
                <!-- Laboratory Orders Section -->
                <div class="resa-consultation-section mt-4">
                    <div class="resa-consultation-section-header">
                        <h6 class="mb-0"><i class="fas fa-flask mr-2"></i>Laboratory Orders</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover resa-consultation-table-details">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Lab No.</th>
                                        <th>Test</th>
                                        <th>Description</th>
                                        <th>Doctor</th>
                                        <th>Order Date</th>
                                        <th>Result</th>
                                        <th>Cost</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for lab in visit.laboratoryorder_set.all %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ lab.lab_number }}</td>
                                        <td>{{ lab.name.name|default:"-" }}</td>
                                        <td>{{ lab.description|default:"-" }}</td>
                                        <td>{{ lab.doctor.get_full_name|default:"-" }}</td>
                                        <td>{{ lab.order_date|date:"d-m-Y" }}</td>
                                        <td>
                                            {% if lab.result %}
                                                <button class="btn btn-sm resa-consultation-btn-view" data-toggle="modal" data-target="#resultModal{{ lab.id }}">
                                                    <i class="fa fa-eye mr-1"></i> View Result
                                                </button>
                                            {% else %}
                                                <span class="text-muted">No result</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ lab.cost }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if visit.procedure_set.exists %}
                <!-- Procedures Section -->
                <div class="resa-consultation-section mt-4">
                    <div class="resa-consultation-section-header">
                        <h6 class="mb-0"><i class="fas fa-procedures mr-2"></i>Procedure Records</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover resa-consultation-table-details">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Procedure No.</th>
                                        <th>Procedure</th>
                                        <th>Description</th>
                                        <th>Doctor</th>
                                        <th>Order Date</th>
                                        <th>Result</th>
                                        <th>Cost</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for procedure in visit.procedure_set.all %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ procedure.procedure_number }}</td>
                                        <td>{{ procedure.name.name|default:"-" }}</td>
                                        <td>{{ procedure.description|default:"-" }}</td>
                                        <td>{{ procedure.doctor.get_full_name|default:"-" }}</td>
                                        <td>{{ procedure.order_date|date:"d-m-Y" }}</td>
                                        <td>
                                            {% if procedure.result %}
                                                <button class="btn btn-sm resa-consultation-btn-view" data-toggle="modal" data-target="#procedureResultModal{{ procedure.id }}">
                                                    <i class="fa fa-eye mr-1"></i> View Result
                                                </button>
                                            {% else %}
                                                <span class="text-muted">No result</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ procedure.cost }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if visit.imagingrecord_set.exists %}
                <!-- Imaging Records Section -->
                <div class="resa-consultation-section mt-4">
                    <div class="resa-consultation-section-header">
                        <h6 class="mb-0"><i class="fas fa-x-ray mr-2"></i>Imaging Records</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover resa-consultation-table-details">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Imaging</th>
                                        <th>Description</th>
                                        <th>Result</th>
                                        <th>Image</th>
                                        <th>Doctor</th>
                                        <th>Order Date</th>
                                        <th>Cost</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for record in visit.imagingrecord_set.all %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ record.imaging.name|default:"-" }}</td>
                                        <td>{{ record.description|default:"-" }}</td>
                                        <td>
                                            {% if record.result %}
                                                <button class="btn btn-sm resa-consultation-btn-view" data-toggle="modal" data-target="#imagingResultModal{{ record.id }}">
                                                    <i class="fa fa-eye mr-1"></i> View Result
                                                </button>
                                            {% else %}
                                                <span class="text-muted">No result</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if record.image %}
                                                <a href="{{ record.image.url }}" target="_blank" class="btn btn-sm resa-consultation-btn-view">
                                                    <i class="fa fa-image mr-1"></i> View Image
                                                </a>
                                            {% else %}
                                                <span class="text-muted">No Image</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ record.doctor.get_full_name|default:"-" }}</td>
                                        <td>{{ record.order_date|date:"d-m-Y" }}</td>
                                        <td>{{ record.cost }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if visit.observationrecord_set.exists %}
                <!-- Observation Records Section -->
                <div class="resa-consultation-section mt-4">
                    <div class="resa-consultation-section-header">
                        <h6 class="mb-0"><i class="fas fa-clipboard-check mr-2"></i>Observation Records</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover resa-consultation-table-details">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Observation Notes</th>
                                        <th>Recorded By</th>
                                        <th>Created At</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for observation in visit.observationrecord_set.all %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>
                                            <div class="observation-notes-container">
                                                {{ observation.observation_notes|safe|default:"-" }}
                                            </div>
                                        </td>
                                        <td>{{ observation.data_recorder.get_full_name|default:"System" }}</td>
                                        <td>{{ observation.created_at|date:"d-m-Y" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if visit.prescription_set.exists %}
                <!-- Prescription Records Section -->
                <div class="resa-consultation-section mt-4">
                    <div class="resa-consultation-section-header">
                        <h6 class="mb-0"><i class="fas fa-prescription mr-2"></i>Prescription Records</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover resa-consultation-table-details">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Medicine</th>
                                        <th>Dose</th>
                                        <th>Frequency</th>
                                        <th>Duration</th>
                                        <th>Quantity</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for prescription in visit.prescription_set.all %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ prescription.medicine.drug_name }}</td>
                                        <td>{{ prescription.dose }}</td>
                                        <td>{{ prescription.frequency_obj.name }}</td>
                                        <td>{{ prescription.duration }}</td>
                                        <td>{{ prescription.quantity_used }}</td>
                                        <td>
                                            <span class="badge {% if prescription.status == 'Completed' %}badge-success{% else %}badge-warning{% endif %}">
                                                {{ prescription.status }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if visit.counseling_set.exists %}
                <!-- Counseling Notes Section -->
                <div class="resa-consultation-section mt-4">
                    <div class="resa-consultation-section-header">
                        <h6 class="mb-0"><i class="fas fa-comments mr-2"></i>Counseling Notes</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover resa-consultation-table-details">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Recorder</th>
                                        <th>Notes</th>
                                        <th>Created</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for session in visit.counseling_set.all %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ session.data_recorder.get_full_name|default:"System" }}</td>
                                        <td>
                                            <div class="counseling-notes-container">
                                                {{ session.counselling_notes|safe|default:"No notes recorded." }}
                                            </div>
                                        </td>
                                        <td>{{ session.created_at|date:"d-m-Y" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if visit.referral_set.exists %}
                <!-- Referral Details Section -->
                <div class="resa-consultation-section mt-4">
                    <div class="resa-consultation-section-header">
                        <h6 class="mb-0"><i class="fas fa-hospital mr-2"></i>Referral Details</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover resa-consultation-table-details">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>From</th>
                                        <th>To</th>
                                        <th>Nature</th>
                                        <th>Transport</th>
                                        <th>Status</th>
                                        <th>Recorded By</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for referral in visit.referral_set.all %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ referral.source_location|default:"-" }}</td>
                                        <td>{{ referral.destination_location|default:"-" }}</td>
                                        <td>{{ referral.get_nature_of_referral_display|default:"-" }}</td>
                                        <td>{{ referral.get_transport_model_display|default:"-" }}</td>
                                        <td>
                                            <span class="badge badge-{{ referral.get_status_color }}">
                                                {{ referral.get_status_display }}
                                            </span>
                                        </td>
                                        <td>{{ referral.data_recorder.get_full_name|default:"System" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if visit.dischargesnotes_set.exists %}
                <!-- Discharge Notes Section -->
                <div class="resa-consultation-section mt-4">
                    <div class="resa-consultation-section-header">
                        <h6 class="mb-0"><i class="fas fa-sign-out-alt mr-2"></i>Discharge Notes</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover resa-consultation-table-details">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Condition</th>
                                        <th>Notes</th>
                                        <th>Recorded By</th>
                                        <th>Discharge Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for discharge in visit.dischargesnotes_set.all %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ discharge.discharge_condition|default:"-" }}</td>
                                        <td>
                                            <div class="discharge-notes-container">
                                                {{ discharge.discharge_notes|safe|default:"-" }}
                                            </div>
                                        </td>
                                        <td>{{ discharge.data_recorder.get_full_name|default:"System" }}</td>
                                        <td>{{ discharge.discharge_date|date:"d-m-Y" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}

            </div>
        </div>
    </div>
</div>
{% endfor %}
{% endfor %}

<style>
    .observation-notes-container,
    .counseling-notes-container,
    .discharge-notes-container {
        max-height: 150px;
        overflow-y: auto;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 4px;
        border: 1px solid #e9ecef;
    }
    
    .modal-xl-custom {
        max-width: 95%;
    }
    
    /* Ensure proper styling for nested content */
    .observation-notes-container p,
    .counseling-notes-container p,
    .discharge-notes-container p {
        margin-bottom: 0.5rem;
    }
    
    .observation-notes-container ul,
    .counseling-notes-container ul,
    .discharge-notes-container ul {
        padding-left: 1.5rem;
        margin-bottom: 0.5rem;
    }
</style>

{# =============================== #}
{# 🧪 Lab Result Modals           #}
{# =============================== #}
{% for patient in patient_records %}
  {% for visit in patient.patientvisits_set.all %}
    {% for lab in visit.laboratoryorder_set.all %}
      {% if lab.result %}
        <div class="modal fade" id="resultModal{{ lab.id }}" tabindex="-1" role="dialog" aria-labelledby="resultModalLabel{{ lab.id }}" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
            <div class="modal-content border-0 shadow-lg">
              <div class="modal-header resa-consultation-modal-header py-3">
                <h5 class="modal-title text-white">
                  <i class="fas fa-flask mr-2"></i>Lab Result: {{ lab.name.name|default:"Test" }}
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body p-4">
                <div class="bg-light p-4 rounded">
                    {{ lab.result|safe }}
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">
                    <i class="fas fa-times mr-2"></i>Close
                </button>
              </div>
            </div>
          </div>
        </div>
      {% endif %}
    {% endfor %}
  {% endfor %}
{% endfor %}

{# =============================== #}
{# 🩺 Procedure Result Modals     #}
{# =============================== #}
{% for patient in patient_records %}
  {% for visit in patient.patientvisits_set.all %}
    {% for procedure in visit.procedure_set.all %}
      {% if procedure.result %}
        <div class="modal fade" id="procedureResultModal{{ procedure.id }}" tabindex="-1" role="dialog" aria-labelledby="procedureResultModalLabel{{ procedure.id }}" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
            <div class="modal-content border-0 shadow-lg">
              <div class="modal-header resa-consultation-modal-header py-3">
                <h5 class="modal-title text-white">
                  <i class="fas fa-procedures mr-2"></i>Procedure Result: {{ procedure.name.name|default:"Procedure" }}
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body p-4">
                <div class="bg-light p-4 rounded">
                    {{ procedure.result|safe }}
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">
                    <i class="fas fa-times mr-2"></i>Close
                </button>
              </div>
            </div>
          </div>
        </div>
      {% endif %}
    {% endfor %}
  {% endfor %}
{% endfor %}

{# =============================== #}
{# 🖼️ Imaging Result Modals       #}
{# =============================== #}
{% for patient in patient_records %}
  {% for visit in patient.patientvisits_set.all %}
    {% for record in visit.imagingrecord_set.all %}
      {% if record.result %}
        <div class="modal fade" id="imagingResultModal{{ record.id }}" tabindex="-1" role="dialog" aria-labelledby="imagingResultModalLabel{{ record.id }}" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
            <div class="modal-content border-0 shadow-lg">
              <div class="modal-header resa-consultation-modal-header py-3">
                <h5 class="modal-title text-white">
                  <i class="fas fa-x-ray mr-2"></i>Imaging Result: {{ record.imaging.name|default:"Imaging" }}
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body p-4">
                <div class="bg-light p-4 rounded">
                    {{ record.result|safe }}
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">
                    <i class="fas fa-times mr-2"></i>Close
                </button>
              </div>
            </div>
          </div>
        </div>
      {% endif %}
    {% endfor %}
  {% endfor %}
{% endfor %}


{% include 'hod_template/datatable.html' %}
<script>
    new DataTable('#consultationTable', {
        dom: 'Bfrtip',
        buttons: ['excel', 'pdf', 'print'],
        responsive: true,
        pageLength: 10,
        order: [[0, 'desc']]
    });
</script>

    

{% endblock main_content %}
