{% extends 'hod_template/base_template.html' %}
{% load static %}
{% block title %}
ADMIN DASHBOARD
{% endblock title %}
{% block main_content %}
{% include "hod_template/modal_form.html" %}
<style>
    :root {
        --primary: #1a2980;
        --secondary: #26d0ce;
        --accent: #3498db;
        --success: #2ecc71;
        --warning: #f39c12;
        --danger: #e74c3c;
        --dark: #2c3e50;
        --light: #f8f9fa;
        --card-gradient: linear-gradient(135deg, #1a2980, #26d0ce);
    }
    
    body {
        background-color: #f5f7fb;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .content-header {
        background: transparent;
        padding: 15px 0;
    }
    
    .card {
        border-radius: 12px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        border: none;
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        margin-bottom: 25px;
        background: white;
    }
    
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
    }
    
    .card-header {
        background: linear-gradient(135deg, #1a2980, #26d0ce);
        color: white;
        border-radius: 12px 12px 0 0 !important;
        padding: 15px 20px;
        font-weight: 600;
        border: none;
    }
    
    .card-body {
        padding: 20px;
    }
    
    .small-box {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        position: relative;
        color: white;
        margin-bottom: 20px;
        height: 140px;
    }
    
    .small-box:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }
    
    .small-box .inner {
        padding: 20px;
        position: relative;
        z-index: 2;
    }
    
    .small-box h3 {
        font-size: 2.2rem;
        font-weight: 700;
        margin: 0 0 10px 0;
        text-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    
    .small-box p {
        font-size: 1.1rem;
        margin: 0;
    }
    
    .small-box .icon {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 1;
        font-size: 70px;
        opacity: 0.2;
        transition: all 0.3s ease;
    }
    
    .small-box:hover .icon {
        transform: scale(1.1);
        opacity: 0.3;
    }
    
    .bg-success { background: linear-gradient(135deg, #2ecc71, #27ae60); }
    .bg-warning { background: linear-gradient(135deg, #f39c12, #d35400); }
    .bg-secondary { background: linear-gradient(135deg, #7f8c8d, #34495e); }
    .bg-info { background: linear-gradient(135deg, #3498db, #2980b9); }
    
    .earnings-card {
        border-radius: 12px;
        overflow: hidden;
        position: relative;
        background: white;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        height: 100%;
    }
    
    .earnings-header {
        padding: 15px 20px;
        font-weight: 600;
        color: white;
        position: relative;
    }
    
    .hospital-header { background: linear-gradient(135deg, #3498db, #2980b9); }
    .prescription-header { background: linear-gradient(135deg, #2ecc71, #27ae60); }
    .total-header { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
    
    .earnings-body {
        padding: 20px;
    }
    
    .earnings-body p {
        margin: 0 0 10px 0;
        font-size: 0.95rem;
        display: flex;
        justify-content: space-between;
    }
    
    .earnings-body p strong {
        font-weight: 500;
    }
    
    .earnings-body hr {
        margin: 15px 0;
        border-top: 1px dashed #e0e0e0;
    }
    
    .total-amount {
        font-size: 1.3rem;
        font-weight: 700;
        color: #2c3e50;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
    }
    
    .apexchart-wrapper {
        position: relative;
        height: 250px;
    }
    
    .data-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .data-table th {
        background-color: #f1f5fd;
        color: #1a2980;
        font-weight: 600;
        padding: 12px 15px;
        text-align: left;
    }
    
    .data-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #eef1f6;
    }
    
    .data-table tr:hover td {
        background-color: #f8faff;
    }
    
    .section-title {
        color: #2c3e50;
        font-weight: 700;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #eef1f6;
        position: relative;
    }
    
    .section-title::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 60px;
        height: 2px;
        background: linear-gradient(90deg, #1a2980, #26d0ce);
    }
    
    .badge-notification {
        position: absolute;
        top: -8px;
        right: -8px;
        font-size: 0.7rem;
        padding: 4px 7px;
        border-radius: 10px;
    }
    
    .view-all-btn {
        background: linear-gradient(135deg, #1a2980, #26d0ce);
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .view-all-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(26, 41, 128, 0.3);
    }
    
    .nav-tabs .nav-link {
        border: none;
        color: #7f8c8d;
        font-weight: 500;
        padding: 10px 20px;
        border-radius: 8px 8px 0 0;
    }
    
    .nav-tabs .nav-link.active {
        background: linear-gradient(135deg, #1a2980, #26d0ce);
        color: white;
        border: none;
    }
    
    .tab-content {
        padding: 20px;
        border: 1px solid #eef1f6;
        border-top: none;
        border-radius: 0 0 12px 12px;
        background: white;
    }
    
    .card-stats {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }
    
    .stats-header {
        padding: 15px 20px;
        background: linear-gradient(135deg, #1a2980, #26d0ce);
        color: white;
        font-weight: 600;
    }
    
    .stats-body {
        padding: 20px;
    }
    
    .progress-container {
        margin: 20px 0;
    }
    
    .progress {
        height: 10px;
        border-radius: 5px;
        background-color: #e9ecef;
        overflow: visible;
    }
    
    .progress-bar {
        border-radius: 5px;
    }
    
    .gender-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .gender-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #f1f5fd;
    }
    
    .gender-list li:last-child {
        border-bottom: none;
    }
    
    .gender-icon {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 10px;
    }
    
    .icon-female { background: #3498db; }
    .icon-male { background: #2ecc71; }
    
    .dashboard-section {
        margin-bottom: 30px;
    }
    
    .dashboard-section:last-child {
        margin-bottom: 0;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .earnings-tabs {
        margin-bottom: 30px;
    }
    
    .chart-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .data-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .earnings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 15px;
    }
    
    @media (max-width: 768px) {
        .chart-grid,
        .data-grid {
            grid-template-columns: 1fr;
        }
        
        .earnings-grid {
            grid-template-columns: 1fr;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<section class="content">
    <div class="container-fluid">
        <!-- Stats Section -->
        <div class="dashboard-section">
            <h3 class="section-title">System Overview</h3>
            <div class="stats-grid">
                <!-- Total Patients -->
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3>{{ total_patients_count }}</h3>
                        <p>ALL PATIENTS</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
                
                <!-- Lab Orders -->
                <div class="small-box bg-warning">
                    <div class="inner">
                        <h3>{{ total_lab_orders_count }}</h3>
                        <p>LAB ORDERS</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-vial"></i>
                    </div>
                </div>
                
                <!-- Doctors -->
                <div class="small-box bg-secondary">
                    <div class="inner">
                        <h3>{{ total_doctors_count }}</h3>
                        <p>DOCTORS</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-user-md"></i>
                    </div>
                </div>
                
                <!-- Lab Technicians -->
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3>{{ total_lab_technicians_count }}</h3>
                        <p>LAB TECHNICIANS</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-microscope"></i>
                    </div>
                </div>
                
                <!-- Pharmacists -->
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3>{{ total_pharmacists_count }}</h3>
                        <p>PHARMACISTS</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-prescription-bottle-alt"></i>
                    </div>
                </div>
                
                <!-- Receptionists -->
                <div class="small-box bg-warning">
                    <div class="inner">
                        <h3>{{ total_receptionists_count }}</h3>
                        <p>RECEPTIONISTS</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-headset"></i>
                    </div>
                </div>
            </div>
        </div>
        
       <div class="dashboard-section">
            <h2 class="section-title">Financial Analytics Dashboard</h2>
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="btn-group">
                    <button id="refresh-data" class="btn btn-primary">
                        <i class="fas fa-sync me-2"></i> Refresh Data
                    </button>
                </div>
                <div class="text-end">
                    <span id="last-updated" class="text-muted">Last updated: Just now</span>
                </div>
            </div>

            <!-- Tabs Navigation -->
            <ul class="nav nav-tabs" id="earningsTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="daily-tab" data-bs-toggle="tab" data-bs-target="#daily" type="button" role="tab">
                        <i class="fas fa-sun me-2"></i>Daily Earnings
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="monthly-tab" data-bs-toggle="tab" data-bs-target="#monthly" type="button" role="tab">
                        <i class="fas fa-calendar-alt me-2"></i>Monthly Earnings
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="yearly-tab" data-bs-toggle="tab" data-bs-target="#yearly" type="button" role="tab">
                        <i class="fas fa-chart-line me-2"></i>Yearly Earnings
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="alltime-tab" data-bs-toggle="tab" data-bs-target="#alltime" type="button" role="tab">
                        <i class="fas fa-history me-2"></i>All-Time Earnings
                    </button>
                </li>
            </ul>
            
            <!-- Tabs Content -->
            <div class="tab-content" id="earningsTabContent">
                <!-- Daily Earnings -->
                <div class="tab-pane fade show active" id="daily" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="card-title mb-0"><i class="fas fa-sun me-2 text-warning"></i>Daily Earnings Summary</h5>
                                <span class="badge bg-primary">Today: <span id="current-date"></span></span>
                            </div>
                            
                            <div class="earnings-grid">
                                <!-- Hospital -->
                                <div class="earnings-card">
                                    <div class="earnings-header hospital-header">
                                        <h5 class="mb-0"><i class="fas fa-hospital me-2"></i>Hospital</h5>
                                    </div>
                                    <div class="earnings-body">
                                        <p><strong>NHIF:</strong> <span id="daily_hospital_nhif">0.00</span> TZS</p>
                                        <p><strong>Cash:</strong> <span id="daily_hospital_cash">0.00</span> TZS</p>
                                        <p><strong>Other Insurance:</strong> <span id="daily_hospital_other">0.00</span> TZS</p>
                                        <p><strong>Walk-In Prescription:</strong> <span id="daily_hospital_walkin">0.00</span> TZS</p>
                                        <hr>
                                        <p><strong>Total:</strong> <span id="daily_hospital_total" class="total-amount">0.00</span> TZS</p>
                                    </div>
                                </div>
                                
                                <!-- Prescription -->
                                <div class="earnings-card">
                                    <div class="earnings-header prescription-header">
                                        <h5 class="mb-0"><i class="fas fa-prescription-bottle-alt me-2"></i>Prescription</h5>
                                    </div>
                                    <div class="earnings-body">
                                        <p><strong>NHIF:</strong> <span id="daily_prescription_nhif">0.00</span> TZS</p>
                                        <p><strong>Cash:</strong> <span id="daily_prescription_cash">0.00</span> TZS</p>
                                        <p><strong>Other Insurance:</strong> <span id="daily_prescription_other">0.00</span> TZS</p>                                        
                                        <hr>
                                        <p><strong>Total:</strong> <span id="daily_prescription_total" class="total-amount">0.00</span> TZS</p>
                                    </div>
                                </div>
                                
                                <!-- Grand Total -->
                                <div class="earnings-card">
                                    <div class="earnings-header total-header">
                                        <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Grand Total</h5>
                                    </div>
                                    <div class="earnings-body">
                                        <p><strong>Total Earnings:</strong> <span id="daily_grand_total" class="total-amount">0.00</span> TZS</p>
                                    </div>
                                </div>
                            </div>                            
                        </div>
                    </div>
                </div>
                
                <!-- Monthly Earnings -->
                <div class="tab-pane fade" id="monthly" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="card-title mb-0"><i class="fas fa-calendar-alt me-2 text-info"></i>Monthly Earnings Summary</h5>
                                <span class="badge bg-primary">Current Month</span>
                            </div>
                            
                            <div class="earnings-grid">
                                <!-- Hospital -->
                                <div class="earnings-card">
                                    <div class="earnings-header hospital-header">
                                        <h5 class="mb-0"><i class="fas fa-hospital me-2"></i>Hospital</h5>
                                    </div>
                                    <div class="earnings-body">
                                        <p><strong>NHIF:</strong> <span id="monthly_hospital_nhif">0.00</span> TZS</p>
                                        <p><strong>Cash:</strong> <span id="monthly_hospital_cash">0.00</span> TZS</p>
                                        <p><strong>Other Insurance:</strong> <span id="monthly_hospital_other">0.00</span> TZS</p>
                                        <p><strong>Walk-In Prescription:</strong> <span id="monthly_hospital_walkin">0.00</span> TZS</p>
                                        <hr>
                                        <p><strong>Total:</strong> <span id="monthly_hospital_total" class="total-amount">0.00</span> TZS</p>
                                    </div>
                                </div>
                                
                                <!-- Prescription -->
                                <div class="earnings-card">
                                    <div class="earnings-header prescription-header">
                                        <h5 class="mb-0"><i class="fas fa-prescription-bottle-alt me-2"></i>Prescription</h5>
                                    </div>
                                    <div class="earnings-body">
                                        <p><strong>NHIF:</strong> <span id="monthly_prescription_nhif">0.00</span> TZS</p>
                                        <p><strong>Cash:</strong> <span id="monthly_prescription_cash">0.00</span> TZS</p>
                                        <p><strong>Other Insurance:</strong> <span id="monthly_prescription_other">0.00</span> TZS</p>
                                        <hr>
                                        <p><strong>Total:</strong> <span id="monthly_prescription_total" class="total-amount">0.00</span> TZS</p>
                                    </div>
                                </div>
                                
                                <!-- Grand Total -->
                                <div class="earnings-card">
                                    <div class="earnings-header total-header">
                                        <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Grand Total</h5>
                                    </div>
                                    <div class="earnings-body">
                                        <p><strong>Total Earnings:</strong> <span id="monthly_grand_total" class="total-amount">0.00</span> TZS</p>
                                    </div>
                                </div>
                            </div>                            
                        </div>
                    </div>
                </div>
                
                <!-- Yearly Earnings -->
                <div class="tab-pane fade" id="yearly" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="card-title mb-0"><i class="fas fa-chart-line me-2 text-success"></i>Yearly Earnings Summary</h5>
                                <span class="badge bg-primary">Current Year</span>
                            </div>
                            
                            <div class="earnings-grid">
                                <!-- Hospital -->
                                <div class="earnings-card">
                                    <div class="earnings-header hospital-header">
                                        <h5 class="mb-0"><i class="fas fa-hospital me-2"></i>Hospital</h5>
                                    </div>
                                    <div class="earnings-body">
                                        <p><strong>NHIF:</strong> <span id="yearly_hospital_nhif">0.00</span> TZS</p>
                                        <p><strong>Cash:</strong> <span id="yearly_hospital_cash">0.00</span> TZS</p>
                                        <p><strong>Other Insurance:</strong> <span id="yearly_hospital_other">0.00</span> TZS</p>
                                         <p><strong>Walk-In Prescription:</strong> <span id="yearly_hospital_walkin">0.00</span> TZS</p>
                                        <hr>
                                        <p><strong>Total:</strong> <span id="yearly_hospital_total" class="total-amount">0.00</span> TZS</p>
                                    </div>
                                </div>
                                
                                <!-- Prescription -->
                                <div class="earnings-card">
                                    <div class="earnings-header prescription-header">
                                        <h5 class="mb-0"><i class="fas fa-prescription-bottle-alt me-2"></i>Prescription</h5>
                                    </div>
                                    <div class="earnings-body">
                                        <p><strong>NHIF:</strong> <span id="yearly_prescription_nhif">0.00</span> TZS</p>
                                        <p><strong>Cash:</strong> <span id="yearly_prescription_cash">0.00</span> TZS</p>
                                        <p><strong>Other Insurance:</strong> <span id="yearly_prescription_other">0.00</span> TZS</p>
                                        <hr>
                                        <p><strong>Total:</strong> <span id="yearly_prescription_total" class="total-amount">0.00</span> TZS</p>
                                    </div>
                                </div>
                                
                                <!-- Grand Total -->
                                <div class="earnings-card">
                                    <div class="earnings-header total-header">
                                        <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Grand Total</h5>
                                    </div>
                                    <div class="earnings-body">
                                        <p><strong>Total Earnings:</strong> <span id="yearly_grand_total" class="total-amount">0.00</span> TZS</p>
                                    </div>
                                </div>
                            </div>                            
                        </div>
                    </div>
                </div>
                
                <!-- All-Time Earnings -->
                <div class="tab-pane fade" id="alltime" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                              <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="card-title mb-0"><i class="fas fa-chart-line me-2 text-purple"></i>All-Time Earnings Summary</h5>                              
                            </div>                            
                            
                            <div class="earnings-grid">
                                <!-- Hospital -->
                                <div class="earnings-card">
                                    <div class="earnings-header hospital-header">
                                        <h5 class="mb-0"><i class="fas fa-hospital me-2"></i>Hospital</h5>
                                    </div>
                                    <div class="earnings-body">
                                        <p><strong>NHIF:</strong> <span id="alltime_hospital_nhif">0.00</span> TZS</p>
                                        <p><strong>Cash:</strong> <span id="alltime_hospital_cash">0.00</span> TZS</p>
                                        <p><strong>Other Insurance:</strong> <span id="alltime_hospital_other">0.00</span> TZS</p>
                                         <p><strong>Walk-In Prescription:</strong> <span id="alltime_hospital_walkin">0.00</span> TZS</p>
                                        <hr>
                                        <p><strong>Total:</strong> <span id="alltime_hospital_total" class="total-amount">0.00</span> TZS</p>
                                    </div>
                                </div>
                                
                                <!-- Prescription -->
                                <div class="earnings-card">
                                    <div class="earnings-header prescription-header">
                                        <h5 class="mb-0"><i class="fas fa-prescription-bottle-alt me-2"></i>Prescription</h5>
                                    </div>
                                    <div class="earnings-body">
                                        <p><strong>NHIF:</strong> <span id="alltime_prescription_nhif">0.00</span> TZS</p>
                                        <p><strong>Cash:</strong> <span id="alltime_prescription_cash">0.00</span> TZS</p>
                                        <p><strong>Other Insurance:</strong> <span id="alltime_prescription_other">0.00</span> TZS</p>
                                        <hr>
                                        <p><strong>Total:</strong> <span id="alltime_prescription_total" class="total-amount">0.00</span> TZS</p>
                                    </div>
                                </div>
                                
                                <!-- Grand Total -->
                                <div class="earnings-card">
                                    <div class="earnings-header total-header">
                                        <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Grand Total</h5>
                                    </div>
                                    <div class="earnings-body">
                                        <p><strong>Total Earnings:</strong> <span id="alltime_grand_total" class="total-amount">0.00</span> TZS</p>
                                    </div>
                                </div>
                            </div>                            
                        </div>
                    </div>
                </div>
            </div>       
        </div>
        
        <!-- Charts Section -->
        <div class="dashboard-section">
            <div class="chart-grid">
                <!-- Patient Survey Chart -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Patient Survey</h5>
                        <form>
                            <div class="input-group">
                                <label class="input-group-text" for="yearSelect">Year:</label>
                                <select class="form-select" id="yearSelect">
                                    <option value="2022">2022</option>
                                    <option value="2023">2023</option>
                                    <option value="2024" selected>2024</option>
                                    <option value="2025">2025</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="genderChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Patient Demographics -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Patient Demographics</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4 class="fw-bold" id="totalPatients">0</h4>
                            <span>Total Patients</span>
                        </div>
                        
                        <div class="progress mb-3" style="height: 12px;">
                            <div class="progress-bar bg-primary" role="progressbar" id="maleProgress"></div>
                            <div class="progress-bar bg-info" role="progressbar" id="femaleProgress"></div>
                        </div>
                        
                        <ul class="gender-list">
                            <li>
                                <span>
                                    <span class="gender-icon icon-male"></span>
                                    Male
                                </span>
                                <span class="fw-bold" id="malePatients">0</span>
                            </li>
                            <li>
                                <span>
                                    <span class="gender-icon icon-female"></span>
                                    Female
                                </span>
                                <span class="fw-bold" id="femalePatients">0</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Data Tables Section -->
        <div class="dashboard-section">
            <div class="data-grid">
                <!-- Recent Patients -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">New Patients</h5>
                        <a href="{% url 'resa_admin_manage_patient' %}" class="view-all-btn">
                            <i class="fas fa-eye me-1"></i> View All
                        </a>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id='patientsTable' class='data-table'>
                                <thead>
                                    <tr>
                                        <th>MRN</th>
                                        <th>Name</th>
                                        <th>Age</th>
                                        <th>Gender</th>
                                        <th>Phone</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for patient in recently_added_patients %}
                                    <tr>
                                        <td>{{ patient.mrn }}</td>
                                        <td>{{ patient }}</td>
                                        <td>
                                            <script>
                                                var dob = new Date("{{ patient.dob|date:'Y-m-d' }}");
                                                var now = new Date();
                                                var ageMilliseconds = now - dob;
                                                var ageSeconds = ageMilliseconds / 1000;
                                                var ageYears = Math.floor(ageSeconds / (365.25 * 24 * 60 * 60));
                                                document.write(ageYears + ' years');
                                            </script>
                                        </td>
                                        <td>{{ patient.gender }}</td>
                                        <td>{{ patient.phone }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Monthly Earnings Chart -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Monthly Earnings Overview</h5>
                        <select id="yearSelect1" class="form-select form-select-sm w-auto">
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>
                    <div class="card-body">
                        <div id="chartWrapper" style="position: relative; height: 350px; display: none;">
                            <canvas id="monthlyEarningsChart" style="height: 100%; width: 100%;"></canvas>
                        </div>
                        <div id="chartSpinner" class="d-flex justify-content-center align-items-center" style="height: 350px;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

{% include 'hod_template/datatable.html' %}
 <style>
        :root {
            --primary: #1a2980;
            --secondary: #26d0ce;
            --accent: #3498db;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --dark: #2c3e50;
            --light: #f8f9fa;
            --card-gradient: linear-gradient(135deg, #1a2980, #26d0ce);
        }
        
        body {
            background-color: #f5f7fb;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
        }
        
        .dashboard-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            color: #2c3e50;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eef1f6;
            position: relative;
        }
        
        .section-title::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 60px;
            height: 2px;
            background: linear-gradient(90deg, #1a2980, #26d0ce);
        }
        
        .card {
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            border: none;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 25px;
            background: white;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }
        
        .card-header {
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            color: white;
            border-radius: 12px 12px 0 0 !important;
            padding: 15px 20px;
            font-weight: 600;
            border: none;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .nav-tabs {
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: #7f8c8d;
            font-weight: 500;
            padding: 12px 24px;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s ease;
            position: relative;
            margin-right: 5px;
        }
        
        .nav-tabs .nav-link:hover {
            background-color: #f1f5fd;
        }
        
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            color: white;
            border: none;
            box-shadow: 0 -3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .nav-tabs .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background: white;
        }
        
        .tab-content {
            border-radius: 0 0 12px 12px;
            background: white;
        }
        
        .earnings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .earnings-card {
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            background: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            height: 100%;
            border: 1px solid #eef1f6;
        }
        
        .earnings-header {
            padding: 15px 20px;
            font-weight: 600;
            color: white;
            position: relative;
        }
        
        .hospital-header { background: linear-gradient(135deg, #3498db, #2980b9); }
        .prescription-header { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .total-header { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        
        .earnings-body {
            padding: 20px;
        }
        
        .earnings-body p {
            margin: 0 0 12px 0;
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
        }
        
        .earnings-body p strong {
            font-weight: 500;
            color: #2c3e50;
        }
        
        .earnings-body span {
            color: #2c3e50;
            font-weight: 500;
        }
        
        .earnings-body hr {
            margin: 15px 0;
            border-top: 1px dashed #e0e0e0;
        }
        
        .total-amount {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1a2980;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .tab-indicator {
            position: absolute;
            bottom: -1px;
            left: 0;
            height: 3px;
            background: linear-gradient(90deg, #1a2980, #26d0ce);
            width: 100%;
            display: none;
        }
        
        .active .tab-indicator {
            display: block;
        }
        
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .stats-summary {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            text-align: center;
        }
        
        .stat-item {
            padding: 10px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1a2980;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        .data-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }
        
        .data-loading .spinner {
            width: 3rem;
            height: 3rem;
        }
        
        @media (max-width: 768px) {
            .earnings-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs .nav-link {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
        }
    </style>
  <script>
        // Function to format currency values
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        // Function to update last updated timestamp
        function updateLastUpdated() {
            const now = new Date();
            const formattedTime = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const formattedDate = now.toLocaleDateString();
            $('#last-updated').text(`Last updated: ${formattedDate} ${formattedTime}`);
        }

        // Function to fetch earnings data from the server
        function fetchEarningsData() {
            return $.ajax({
                url: '{% url "resa_admin_earnings_data" %}',
                method: 'GET'
            });
        }

        // Function to fetch chart data
        function fetchChartData(timeframe) {
            return $.ajax({
                url: '{% url "resa_financial_chart_data" %}',
                method: 'GET',
                data: { timeframe: timeframe }
            });
        }

        // Function to update earnings data
        function updateEarningsData() {
            // Show loading indicator
            $('.tab-pane.active .card-body').addClass('data-loading');
            
            fetchEarningsData()
                .done(function(earningsData) {
                    // Process the data for each period
                    processEarningsData('daily', earningsData.daily);
                    processEarningsData('monthly', earningsData.monthly);
                    processEarningsData('yearly', earningsData.yearly);
                    processEarningsData('alltime', earningsData.alltime);
                    
                    // Update last updated time
                    updateLastUpdated();
                    
                   
                    
                    // Update the current date display
                    const now = new Date();
                    $('#current-date').text(now.toLocaleDateString());
                    
                    // Fetch and update chart data for the active tab
                    const activeTab = $('.nav-tabs .nav-link.active').attr('id');
                    let timeframe = 'daily';
                    
                    if (activeTab === 'monthly-tab') timeframe = 'monthly';
                    else if (activeTab === 'yearly-tab') timeframe = 'yearly';
                    else if (activeTab === 'alltime-tab') timeframe = 'alltime';                    
                    
                })
                .fail(function(jqXHR, textStatus, errorThrown) {
                    console.error('Error fetching earnings data:', textStatus, errorThrown);
                    showNotification('danger', 'Failed to load financial data. Please try again.');
                })
                .always(function() {
                    // Hide loading state
                    $('.card-body').removeClass('data-loading');
                });
        }

        function processEarningsData(period, data) {
            // Hospital data
            $(`#${period}_hospital_nhif`).text(formatCurrency(data.hospital.nhif));
            $(`#${period}_hospital_cash`).text(formatCurrency(data.hospital.cash));
            $(`#${period}_hospital_other`).text(formatCurrency(data.hospital.other));
            $(`#${period}_hospital_walkin`).text(formatCurrency(data.hospital.walkin));
            $(`#${period}_hospital_total`).text(formatCurrency(data.hospital.total));
            
            // Prescription data
            $(`#${period}_prescription_nhif`).text(formatCurrency(data.prescription.nhif));
            $(`#${period}_prescription_cash`).text(formatCurrency(data.prescription.cash));
            $(`#${period}_prescription_other`).text(formatCurrency(data.prescription.other));
            $(`#${period}_prescription_total`).text(formatCurrency(data.prescription.total));
            
            // Grand total
            $(`#${period}_grand_total`).text(formatCurrency(data.grand_total));
        }
        
      

        // Tab switching functionality
        $(document).ready(function() {
            // Set current date
            const now = new Date();
            $('#current-date').text(now.toLocaleDateString());
            updateLastUpdated();
            
            // Initialize with data
            updateEarningsData();
            
            // Handle tab clicks
            $('.nav-tabs .nav-link').on('click', function() {
                // Remove active class from all tabs
                $('.nav-tabs .nav-link').removeClass('active');
                
                // Add active class to clicked tab
                $(this).addClass('active');
                
                // Hide all tab panes
                $('.tab-pane').removeClass('show active');
                
                // Show the target tab pane
                const target = $(this).data('bs-target');
                $(target).addClass('show active');
                
                // Update data for the active tab
                updateEarningsData();
            });
            
            // Refresh data button
            $('#refresh-data').on('click', function() {
                const btn = $(this);
                btn.html('<i class="fas fa-sync fa-spin me-2"></i> Refreshing...');
                btn.prop('disabled', true);
                
                updateEarningsData();
                
                setTimeout(() => {
                    btn.html('<i class="fas fa-sync me-2"></i> Refresh Data');
                    btn.prop('disabled', false);
                    showNotification('success', 'Data refreshed successfully!');
                }, 1000);
            });
        });
        
        function showNotification(type, message) {
            // Create notification element
            const notification = $('<div>', {
                class: `alert alert-${type} alert-dismissible fade show`,
                role: 'alert',
                style: 'position: fixed; top: 20px; right: 20px; z-index: 10000;',
                html: `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `
            });
            
            // Add to DOM
            $('body').append(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.alert('close');
            }, 5000);
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Patient Demographics Script -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    function updateCardContent(selectedYear) {
        $.ajax({
            url: '{% url "resa_admin_gender_yearly_data" %}',
            method: 'GET',
            data: { 'year': selectedYear },
            success: function (data) {
                var totalFemalePatients = data['Female'] || 0;
                var totalMalePatients = data['Male'] || 0;
                var totalPatients = totalFemalePatients + totalMalePatients;

                // Update the total patients
                $('#totalPatients').text(totalPatients);
                
                // Update progress bars
                const malePercentage = totalPatients ? (totalMalePatients / totalPatients * 100) : 0;
                const femalePercentage = totalPatients ? (totalFemalePatients / totalPatients * 100) : 0;
                
                $('#maleProgress').css('width', malePercentage + '%').attr('aria-valuenow', malePercentage);
                $('#femaleProgress').css('width', femalePercentage + '%').attr('aria-valuenow', femalePercentage);
                
                // Update counts
                $('#femalePatients').text(totalFemalePatients);
                $('#malePatients').text(totalMalePatients);
            },
            error: function (xhr, status, error) {
                console.error('Error fetching data:', error);
            }
        });
    }

    // Event listener for year select
    $('#yearSelect').on('change', function () {
        updateCardContent(this.value);
    });

    // Initial update
    updateCardContent($('#yearSelect').val());
});
</script>

<!-- Monthly Earnings Chart Script -->
<script>
$(document).ready(function () {
    const ctx = document.getElementById('monthlyEarningsChart').getContext('2d');
    let earningsChart = null;

    function populateYearSelector() {
        const currentYear = new Date().getFullYear();
        for (let y = currentYear; y >= currentYear - 5; y--) {
            $('#yearSelect1').append(`<option value="${y}">${y}</option>`);
        }
        $('#yearSelect1').val(currentYear);
    }

    function loadMonthlyEarnings(year) {
        $('#chartWrapper').hide();
        $('#chartSpinner').show();

        $.ajax({
            url: "{% url 'resa_admin_monthly_earnings' %}",
            method: 'GET',
            data: { year },
            success: function (response) {
                const labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                                'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

                const {
                    hospital_nhif, hospital_cash, hospital_other,
                    prescription_nhif, prescription_cash, prescription_other
                } = response;

                const combinedTotal = labels.map((_, i) => {
                    const values = [
                        hospital_nhif[i],
                        hospital_cash[i],
                        hospital_other[i],
                        prescription_nhif[i],
                        prescription_cash[i],
                        prescription_other[i]
                    ];
                    return values.reduce((sum, val) => sum + (Number(val) || 0), 0);
                });

                const chartData = {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Hospital - NHIF',
                            data: hospital_nhif,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        },
                        {
                            label: 'Hospital - Cash',
                            data: hospital_cash,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        },
                        {
                            label: 'Hospital - Other Insurance',
                            data: hospital_other,
                            backgroundColor: 'rgba(153, 102, 255, 0.6)',
                        },
                        {
                            label: 'Prescription - NHIF',
                            data: prescription_nhif,
                            backgroundColor: 'rgba(255, 206, 86, 0.6)',
                        },
                        {
                            label: 'Prescription - Cash',
                            data: prescription_cash,
                            backgroundColor: 'rgba(255, 99, 132, 0.6)',
                        },
                        {
                            label: 'Prescription - Other Insurance',
                            data: prescription_other,
                            backgroundColor: 'rgba(255, 159, 64, 0.6)',
                        },
                        {
                            label: 'Combined Total',
                            data: combinedTotal,
                            backgroundColor: 'rgba(0, 0, 0, 0.6)',
                        }
                    ]
                };

                if (earningsChart) earningsChart.destroy();

                // Show the wrapper
                $('#chartSpinner').hide();
                $('#chartWrapper').show();

                setTimeout(() => {
                    earningsChart = new Chart(ctx, {
                        type: 'bar',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: `Monthly Earnings Breakdown - ${year}`
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Amount (TZS)'
                                    }
                                }
                            }
                        }
                    });
                }, 10);
            },
            error: function (xhr) {
                $('#chartSpinner').hide();
                alert("Failed to load earnings data. Please try again.");
                console.error(xhr.responseText);
            }
        });
    }

    populateYearSelector();
    const initialYear = $('#yearSelect1').val();
    loadMonthlyEarnings(initialYear);

    $('#yearSelect1').on('change', function () {
        loadMonthlyEarnings(this.value);
    });
});
</script>

<!-- Patient Survey Chart Script -->
<script>
var genderChart;

function fetchGenderMonthlyData(year) {
    $.ajax({
        url: '{% url "resa_admin_gender_monthly_data" %}',
        method: 'GET',
        data: { 'year': year },
        success: function(data) {
            createGenderChart(data);
        },
        error: function(xhr, status, error) {
            console.error('Error fetching data:', error);
        }
    });
}

function createGenderChart(data) {
    var ctx = document.getElementById('genderChart').getContext('2d');
    const months = Object.keys(data);
    const maleData = months.map(month => data[month]['Male'] || 0);
    const femaleData = months.map(month => data[month]['Female'] || 0);

    if (genderChart) {
        genderChart.data.labels = months;
        genderChart.data.datasets[0].data = maleData;
        genderChart.data.datasets[1].data = femaleData;
        genderChart.update();
    } else {
        genderChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: months,
                datasets: [{
                    label: 'Male',
                    data: maleData,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 3,
                    tension: 0.3,
                    fill: false,
                    pointBackgroundColor: 'white',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }, {
                    label: 'Female',
                    data: femaleData,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 3,
                    tension: 0.3,
                    fill: false,
                    pointBackgroundColor: 'white',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: {
                                size: 13
                            },
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.7)',
                        padding: 10,
                        titleFont: {
                            size: 14
                        },
                        bodyFont: {
                            size: 13
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0, 0, 0, 0.03)'
                        }
                    }
                }
            }
        });
    }
}

// Initial chart load
var selectedYear = $('#yearSelect').val();
fetchGenderMonthlyData(selectedYear);

// Update chart when year changes
$('#yearSelect').on('change', function() {
    fetchGenderMonthlyData($(this).val());
});
</script>

<!-- DataTable Script -->
<script>
$(document).ready(function () {
    // Activate DataTable on the patientsTable
    new DataTable('#patientsTable', {
        dom: 'Bfrtip',
        buttons: [''],
        paging: true,
        pageLength: 5,
        lengthChange: false,
        searching: true,
        ordering: true,
        info: true,
        autoWidth: false,
        language: {
            search: "Search Patients:",
            paginate: {
                next: '<i class="fas fa-chevron-right"></i>',
                previous: '<i class="fas fa-chevron-left"></i>'
            }
        }
    });
});
</script>
{% endblock main_content %}
