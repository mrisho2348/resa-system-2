<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="icon" type="image/png" href="{% static 'img/resalogo_square.png' %}">
  <title>{% block title %}RESA | Dashboard{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="{% static 'plugins/fontawesome-free/css/all.min.css' %}">
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <!-- Select2 -->
  <link href="{% static 'plugins/select2/css/select2.min.css' %}" rel="stylesheet" />
  <link rel="stylesheet" href="{% static 'plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css' %}">
  <!-- Tempusdominus Bootstrap 4 -->
  <link rel="stylesheet" href="{% static 'plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css' %}">
  <!-- iCheck -->
  <link rel="stylesheet" href="{% static 'plugins/icheck-bootstrap/icheck-bootstrap.min.css' %}">
  <!-- JQVMap -->
  <link rel="stylesheet" href="{% static 'plugins/jqvmap/jqvmap.min.css' %}">
  <!-- AdminLTE App -->
  <link href="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap-switch-button@1.1.0/css/bootstrap-switch-button.min.css" rel="stylesheet">
  <!-- Theme style -->
  <link rel="stylesheet" href="{% static 'dist/css/adminlte.min.css' %}">
  <!-- overlayScrollbars -->
  <link rel="stylesheet" href="{% static 'plugins/overlayScrollbars/css/OverlayScrollbars.min.css' %}">
  <!-- Daterange picker -->
  <link rel="stylesheet" href="{% static 'plugins/daterangepicker/daterangepicker.css' %}">
  <!-- Summernote -->
  <link rel="stylesheet" href="{% static 'plugins/summernote/summernote-bs4.css' %}">
  <!-- DataTables -->
  <link rel="stylesheet" href="{% static 'assets/DataTables/datatables.min.css' %}">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
  <!-- Google Font: Source Sans Pro -->
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700" rel="stylesheet">
  

  {% block customer_css %}{% endblock %}
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">

  <!-- Top Bar -->
  {% include "doctor_template/topbar.html" %}
  
  <!-- Sidebar -->
  {% include "doctor_template/sidebar_template.html" %}

  <!-- Content Wrapper -->
  <div class="content-wrapper">
    <!-- Content Header -->
    <div class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 class="page-title">{% block page_title %}{% endblock %}</h1>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item">
                {% block breadcrumb %}{% endblock %}
              </li>
            </ol>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Main Content -->
    <section class="content">
      <div class="container-fluid">
        {% block main_content %}{% endblock %}
      </div>
    </section>
  </div>

  <!-- Footer -->
  {% include "doctor_template/footer.html" %}
</div>

<!-- JavaScript Libraries -->
<script src="{% static 'plugins/jquery/jquery.min.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.4/jspdf.debug.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.4/jspdf.min.js"></script>
<script src="{% static 'plugins/jquery-ui/jquery-ui.min.js' %}"></script>
<script>
  $.widget.bridge('uibutton', $.ui.button);
</script>
<script src="{% static 'plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'plugins/select2/js/select2.full.min.js' %}"></script>
<script src="{% static 'plugins/chart.js/Chart.min.js' %}"></script>
<script src="{% static 'plugins/sparklines/sparkline.js' %}"></script>
<script src="{% static 'plugins/jqvmap/jquery.vmap.min.js' %}"></script>
<script src="{% static 'plugins/jqvmap/maps/jquery.vmap.usa.js' %}"></script>
<script src="{% static 'plugins/jquery-knob/jquery.knob.min.js' %}"></script>
<script src="{% static 'plugins/moment/moment.min.js' %}"></script>
<script src="{% static 'plugins/daterangepicker/daterangepicker.js' %}"></script>
<script src="{% static 'plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js' %}"></script>
<script src="{% static 'plugins/summernote/summernote-bs4.min.js' %}"></script>
<script src="{% static 'plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js' %}"></script>
<script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap-switch-button@1.1.0/dist/bootstrap-switch-button.min.js"></script>
<script src="{% static 'dist/js/adminlte.js' %}"></script>
<script src="{% static 'dist/js/pages/dashboard.js' %}"></script>
<script src="{% static 'dist/js/demo.js' %}"></script>

<!-- Premium Custom Script -->
<script>
  $(function () {
    // Initialize Select2
    $('.select2').select2()
    $('.select2bs4').select2({ theme: 'bootstrap4' })
    
    // Initialize tooltips
    $('[data-toggle="tooltip"]').tooltip() 
 
 
    
  
  });
</script>


<script>
  // Update date and time in real-time
  function updateDateTime() {
    const now = new Date();
    
    // Format date
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const formattedDate = now.toLocaleDateString('en-US', options);
    
    // Format time
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().toString().padStart(2, '0');
    const seconds = now.getSeconds().toString().padStart(2, '0');
    const formattedTime = `${hours}:${minutes}:${seconds}`;
    
    // Update elements
    document.getElementById('current-date').textContent = formattedDate;
    document.getElementById('current-time').textContent = formattedTime;
  }
  
  // Initialize and update every second
  updateDateTime();
  setInterval(updateDateTime, 1000);
  
  // Fullscreen toggle function
  function toggleFullScreen() {
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen().catch(err => {
        console.error(`Error attempting to enable fullscreen: ${err.message}`);
      });
    } else {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      }
    }
  }
  
  // Initialize tooltips
  $(function () {
    $('[data-toggle="tooltip"]').tooltip();
  });  
  
</script>

<script>
  // Initialize the calendar
  function initDoctorCalendar() {
    const now = new Date();
    const monthNames = ["January", "February", "March", "April", "May", "June",
      "July", "August", "September", "October", "November", "December"
    ];
    const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    
    document.getElementById('doctor-calendar-month').textContent = monthNames[now.getMonth()];
    document.getElementById('doctor-calendar-year').textContent = now.getFullYear();
    document.getElementById('doctor-calendar-date').textContent = now.getDate();
    document.getElementById('doctor-calendar-day').textContent = dayNames[now.getDay()];
  }
  
// Update doctor stats from API
function updateDoctorStats() {
    fetch("{% url 'doctor_dashboard_stats_api' %}")
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Update dashboard stats (top bar)
                document.getElementById('today-appointments').textContent = data.today_appointments;
                document.getElementById('pending-consultations').textContent = data.pending_consultations;
                
                // Update sidebar stats
                document.getElementById('doctor-patient-count').textContent = data.total_patients;
                document.getElementById('doctor-appointment-count').textContent = data.upcoming_appointments;
                
                // Update consultation orders
                document.getElementById('doctor-consultation-orders-today').textContent = data.consultation_orders_today;
                document.getElementById('doctor-consultation-orders-total').textContent = data.consultation_orders_total;
                document.getElementById('doctor-consultation-orders-history').textContent = data.consultation_orders_total - data.consultation_orders_today;
                
                // Update radiology orders
                document.getElementById('doctor-radiology-orders-today').textContent = data.radiology_orders_today;
                document.getElementById('doctor-radiology-orders-total').textContent = data.radiology_orders_total;
                document.getElementById('doctor-radiology-orders-history').textContent = data.radiology_orders_total - data.radiology_orders_today;
                
                // Update procedure orders
                document.getElementById('doctor-procedure-orders-today').textContent = data.procedure_orders_today;
                document.getElementById('doctor-procedure-orders-total').textContent = data.procedure_orders_total;
                document.getElementById('doctor-procedure-orders-history').textContent = data.procedure_orders_total - data.procedure_orders_today;
                
                // Update appointments section
                document.getElementById('today-appointments-sidebar').textContent = data.today_appointments;
                document.getElementById('upcoming-appointments-sidebar').textContent = data.upcoming_appointments;
                document.getElementById('appointments-total').textContent = data.today_appointments + data.upcoming_appointments;
                
            } else {
                console.error('Failed to fetch doctor stats:', data.error);
            }
        })
        .catch(err => console.error('Failed to fetch doctor stats:', err));
}

// Function to format time relative to now (e.g., "15 mins ago")
function formatTimeAgo(timestamp) {
  const now = new Date();
  const diffMs = now - new Date(timestamp);
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);
  
  if (diffMins < 1) return "Just now";
  if (diffMins < 60) return `${diffMins} mins ago`;
  if (diffHours < 24) return `${diffHours} hours ago`;
  return `${diffDays} days ago`;
}

// Load notifications from API
function loadNotifications() {
  // Show loading state
  document.getElementById('notifications-container').innerHTML = `
    <div class="text-center py-3 notification-loader">
      <div class="spinner-border text-primary spinner-border-sm" role="status">
        <span class="sr-only">Loading...</span>
      </div>
      <p class="text-muted mt-2">Loading notifications...</p>
    </div>
  `;
  
  fetch("{% url 'doctor_notifications_api' %}")
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      if (data.status === 'success') {
        const notifications = data.notifications;
        const notificationCount = notifications.length;
        
        document.getElementById('notification-count').textContent = notificationCount;
        document.getElementById('notification-header').textContent = 
          `${notificationCount} Notification${notificationCount !== 1 ? 's' : ''}`;
        
        let notificationsHTML = '';
        
        if (notificationCount === 0) {
          notificationsHTML = `
            <div class="text-center py-3">
              <i class="far fa-bell-slash text-muted fa-2x mb-2"></i>
              <p class="text-muted">No notifications</p>
            </div>
          `;
        } else {
          notifications.forEach(notif => {
            notificationsHTML += `
              <a href="${notif.url || '#'}" class="dropdown-item notification-item">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="mr-2">
                    <i class="${notif.icon} ${notif.iconColor} mr-2"></i> 
                  </div>
                  <div class="flex-grow-1">
                    <div class="font-weight-bold">${notif.title}</div>
                    <small class="text-muted">${notif.details}</small>
                  </div>
                  <div class="notification-time ml-2 text-right">
                    <small class="text-muted">${notif.time}</small>
                  </div>
                </div>
              </a>
              <div class="dropdown-divider"></div>
            `;
          });
        }
        
        document.getElementById('notifications-container').innerHTML = notificationsHTML;
      } else {
        console.error('Failed to load notifications:', data.error);
        document.getElementById('notifications-container').innerHTML = `
          <div class="text-center py-3">
            <i class="fas fa-exclamation-triangle text-warning mb-2"></i>
            <p class="text-muted">Failed to load notifications</p>
          </div>
        `;
      }
    })
    .catch(err => {
      console.error('Error loading notifications:', err);
      document.getElementById('notifications-container').innerHTML = `
        <div class="text-center py-3">
          <i class="fas fa-exclamation-triangle text-warning mb-2"></i>
          <p class="text-muted">Error loading notifications</p>
        </div>
      `;
    });
}


// Initialize on page load
$(document).ready(function() {   
    initDoctorCalendar();
    updateDoctorStats();
    loadNotifications();
    
    // Update stats every minute
    setInterval(updateDoctorStats, 60000);
    
    // Update notifications every 2 minutes
    setInterval(loadNotifications, 120000);
    
    // Add sidebar toggle animation
    $('.doctor-nav-link > .fas.fa-angle-left').parent().on('click', function() {
        $(this).find('.fa-angle-left').toggleClass('fa-rotate-90');
    });

     // Add click handler to refresh notifications when dropdown is opened
  $('.notifications-dropdown').on('shown.bs.dropdown', function() {
    loadNotifications();
  });

});

</script>
{% block customer_js %}{% endblock %}
</body>
</html>