{% extends 'doctor_template/base_template.html' %}

{% block title %}
{{ patient.first_name }} {{ patient.middle_name }} {{ patient.last_name }} Consultation Notes
{% endblock title %}

{% block page_title %}
<div class="d-flex align-items-center">
    <!-- Back Button -->
    {% if consultation_note.doctor == request.user.staff %}
        {% if final_provisional_diagnosis %}
        <a class="btn pat-prem-btn-action mr-2" href="
            {% if consultation_note.doctor_plan == 'Prescription' %}
                {% url 'doctor_save_prescription' patient.id visit.id %}
            {% elif consultation_note.doctor_plan == 'Laboratory' %}
                {% url 'doctor_save_remotesconsultation_notes_next' patient.id visit.id %}
            {% elif consultation_note.doctor_plan == 'Referral' %}
                {% url 'doctor_save_remotereferral' patient.id visit.id %}
            {% elif consultation_note.doctor_plan == 'Counselling' %}
                {% url 'doctor_save_remote_counseling' patient.id visit.id %}
            {% elif consultation_note.doctor_plan == 'Procedure' %}
                {% url 'doctor_save_remoteprocedure' patient.id visit.id %}
            {% elif patient.remoteconsultationnotes_set.last.doctor_plan == 'Observation' %}
                {% url 'doctor_save_observation' patient.id visit.id %}
            {% elif consultation_note.doctor_plan == 'Discharge' %}
                {% url 'doctor_save_remote_discharges_notes' patient.id visit.id %}
            {% endif %}">
            <i class="fas fa-arrow-left mr-1"></i> Back
        </a>
        {% endif %}
    {% endif %}
    
    <a class="btn pat-prem-btn-action mr-2" href="{% url 'doctor_patient_visit_history_view' patient.id %}">
        <i class="fas fa-arrow-left mr-1"></i> Visit History
    </a>
    
    <!-- Forward Button -->
    {% if consultation_note.doctor == request.user.staff %}
        {% if consultation_note %}
        <a class="btn pat-prem-btn-success mr-2" href="
            {% if consultation_note.doctor_plan == 'Laboratory' %}
                {% url 'doctor_save_laboratory' patient.id visit.id %}
            {% else %}
                {% url 'doctor_save_remotesconsultation_notes_next' patient.id visit.id %}
            {% endif %}">
            Next <i class="fas fa-arrow-right mr-1"></i>
        </a>
        {% endif %}
    {% endif %}
    
    <h5 class="mb-0">Consultation Notes</h5>
</div>
{% endblock page_title %}

{% block breadcrumb %}
{% include "doctor_template/modal_form.html" %}
<div class="d-flex align-items-center">
    <span class="mr-2">Add Consultation Notes</span>
    <button type="button" class="btn pat-prem-btn-action btn-sm" data-toggle="modal" data-target="#patientVisitsModal">
        View Result
    </button>
</div>
{% endblock breadcrumb %}

{% block main_content %}
<style>
    /* Consistent premium styling */
    .pat-prem-gradient {
        background: linear-gradient(120deg, #1a2a6c, #2C3E50);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 15px 35px rgba(26, 42, 108, 0.15);
        border: none;
    }
    
    .pat-prem-gradient .card-header {
        background: rgba(0,0,0,0.1);
        border-bottom: 1px solid rgba(255,255,255,0.2);
        padding: 1.2rem 1.5rem;
    }
    
    .pat-prem-btn-action {
        background: linear-gradient(120deg, #1a2a6c, #2C3E50);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 8px 16px;
        font-size: 0.85rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(26, 42, 108, 0.2);
    }
    
    .pat-prem-btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(26, 42, 108, 0.3);
        color: white;
    }
    
    .pat-prem-btn-success {
        background: linear-gradient(120deg, #308829, #4CAF50);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 8px 16px;
        font-size: 0.85rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(48, 136, 41, 0.2);
    }
    
    .pat-prem-btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(48, 136, 41, 0.3);
        color: white;
    }
    
    .pat-prem-patient-header {
        background: linear-gradient(120deg, rgba(26, 42, 108, 0.1), rgba(44, 62, 80, 0.1));
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    
    .pat-prem-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(120deg, #1a2a6c, #2C3E50);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.5rem;
        margin-right: 15px;
    }
    
    .pat-prem-table th {
        background: linear-gradient(120deg, #E3F2FD, #BBDEFB);
        color: #0d47a1;
        font-weight: 600;
        padding: 1rem 0.75rem;
        border: none;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .pat-prem-table td {
        padding: 1.1rem 0.75rem;
        vertical-align: middle;
        border-color: #E3F2FD;
    }
    
    .pat-prem-table tbody tr {
        transition: all 0.3s ease;
        background: white;
    }
    
    .pat-prem-table tbody tr:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(13, 71, 161, 0.1);
        background: #f0f8ff;
    }
    
    .pat-prem-table-container {
        border-radius: 10px;
        overflow: auto;
        box-shadow: 0 5px 15px rgba(0,0,0,0.06);
    }
    
    .pat-prem-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .pat-prem-badge-cost {
        background: linear-gradient(120deg, #1a2a6c, #2C3E50);
        color: white;
    }
    
    .pat-prem-form-card {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        border: none;
        margin-bottom: 20px;
    }
    
    .pat-prem-form-card .card-header {
        background: linear-gradient(120deg, #e3f2fd, #E3F2FD);
        color: #0d47a1;
        font-weight: 600;
        padding: 1rem 1.2rem;
        border-bottom: 1px solid #BBDEFB;
    }
    
    .pat-prem-form-card .card-body {
        padding: 1.5rem;
    }
    
    .select2-container--bootstrap4 .select2-selection--single {
        height: calc(2.25rem + 2px) !important;
        border-radius: 8px !important;
    }
    
    .form-control {
        border-radius: 8px;
        border: 1px solid #ced4da;
    }
    
    .pat-prem-total-cost {
        font-size: 1.2rem;
        font-weight: 700;
        color: #0d47a1;
        background: #E3F2FD;
        padding: 0.5rem 1rem;
        border-radius: 8px;
    }
    
    .diagnosis-list {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        border: 1px solid #dee2e6;
    }
    
    .diagnosis-list ol {
        margin-bottom: 0;
        padding-left: 1.5rem;
    }
    
    .diagnosis-list li {
        padding: 0.5rem 0;
        font-weight: 500;
    }
    
    .nav-tabs .nav-link {
        border-radius: 8px 8px 0 0;
        padding: 0.5rem 1rem;
    }
    
    .tab-content {
        border-radius: 0 0 8px 8px;
        padding: 1rem;
        border: 1px solid #dee2e6;
        border-top: none;
    }
    
    .btn-outline-primary, .btn-outline-secondary, .btn-outline-success, 
    .btn-outline-danger, .btn-outline-warning, .btn-outline-info {
        border-radius: 8px;
    }
</style>

<div class="container-fluid">
    <!-- Patient Header -->
    <div class="row">
        <div class="col-md-12">
            <div class="pat-prem-patient-header">
                <div class="d-flex align-items-center">
                    <div class="pat-prem-avatar">
                        {{ patient.first_name|slice:":1" }}{{ patient.last_name|slice:":1" }}
                    </div>
                    <div>
                        <h3 class="mb-1">{{ patient.first_name }} {{ patient.middle_name }} {{ patient.last_name }}</h3>
                        <div class="d-flex flex-wrap">
                            <div class="mr-3"><strong>MRN:</strong> {{ patient.mrn }}</div>
                            <div class="mr-3"><strong>DOB:</strong> {{ patient.dob|date:'d-m-Y' }} 
                                [Age: {% if patient.dob %}
                                <script>
                                    var dob = new Date("{{ patient.dob|date:'Y-m-d' }}");
                                    var now = new Date();
                                    var ageMilliseconds = now - dob;
                                    var ageSeconds = ageMilliseconds / 1000;
                                    var ageYears = Math.floor(ageSeconds / (365.25 * 24 * 60 * 60));
                                    document.write(ageYears + ' years');
                                </script>
                                {% else %}
                                {{ patient.age }}
                                {% endif %}]
                            </div>
                            <div class="mr-3"><strong>Gender:</strong> {{ patient.gender }}</div>
                            <div><strong>Payment:</strong> {{ patient.payment_form }}</div>
                        </div>
                        <div class="d-flex flex-wrap mt-2">
                            <div class="mr-3"><strong>Visit Number:</strong> {{ visit.vst }}</div>
                            <div><strong>Payment Mode:</strong> 
                                {% if patient.payment_form == "Insurance" %}
                                    {{ patient.payment_form }} - {{ patient.insurance_name }}   
                                {% else %}   
                                    {{ patient.payment_form }}                  
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vitals Card -->
    <div class="row">
        <div class="col-md-12">
            <div class="card pat-prem-form-card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="fas fa-heartbeat mr-2"></i>Vital Signs</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive pat-prem-table-container">
                        <table class="table table-bordered pat-prem-table">
                            <thead>
                                <tr>                                          
                                    <th>Time</th>
                                    <th>BP</th>
                                    <th>HR</th>
                                    <th>RR</th>
                                    <th>SPO2</th>                                         
                                    <th>TEMP</th>
                                    <th>GCS</th>
                                    <th>Weight</th>
                                    <th>AVPU</th>                                                       
                                </tr>
                            </thead>
                            <tbody>
                                {% for vital in patient_vitals %}
                                    <tr>
                                        <td>{{ vital.updated_at|time:"H:i:s" }}</td>
                                        <td>{{ vital.blood_pressure }}</td>
                                        <td>{{ vital.pulse_rate }}</td>
                                        <td>{{ vital.respiratory_rate }}</td>
                                        <td>{{ vital.spo2 }}</td>                                            
                                        <td>{{ vital.temperature }}</td>
                                        <td>{{ vital.gcs }}</td>
                                        <td>{{ vital.weight }}</td>
                                        <td>{{ vital.avpu }}</td>                                                       
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chief Complaints Card -->
    <div class="row">
        <div class="col-md-12">
            <div class="card pat-prem-form-card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="fas fa-comment-medical mr-2"></i>Chief Complaints</h5>
                </div>
                <div class="card-body">
                    <div id="savedChiefComplaints">
                        <div id="popupContainer" class="popup-container"></div>
                        <!-- Chief Complaints List -->
                        <div id="chiefComplaintsList" class="mt-3">
                            <table class="table table-borderless">                                       
                                <tbody id="chiefComplaintsDisplayBody">
                                    <!-- Existing saved complaints inserted here -->
                                </tbody>
                            </table>
                        </div>
                        <!-- Full Edit Table (Initially hidden) -->
                        <div id="chiefComplaintsEditTableContainer" class="mt-3 d-none">
                            <table class="table table-bordered pat-prem-table" id="chiefComplaintsTable">
                                <thead>
                                    <tr>
                                        <th>Chief Complaint</th>
                                        <th>Duration</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Populated dynamically -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Add/Edit Complaint Row (Initially hidden) -->
                        <div id="chiefComplaintFormRow" class="mt-3 d-none">
                            <table class="table table-borderless">
                                <tbody id="chiefComplaintInputRowBody">
                                    <!-- Row gets injected here dynamically -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Action Buttons -->
                        <div class="mt-2">
                            <button type="button" id="addChiefComplaintButton" class="btn pat-prem-btn-action btn-sm">
                                <i class="fa fa-plus-square mr-1"></i> Add Chief Complaint
                            </button>
                            <button type="button" id="toggleEditChiefComplaints" class="btn pat-prem-btn-action btn-sm">
                                <i class="fa fa-edit mr-1"></i> Edit
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Consultation Form -->
    <div class="row justify-content-center">
        <div class="col-md-12">
            <div class="card pat-prem-form-card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="fas fa-notes-medical mr-2"></i>Consultation Notes</h5>
                </div>
                <div class="card-body">
                    <form id="addConsultationForm" action="{% url 'doctor_save_remotesconsultation_notes' patient.id visit.id %}" method="post">
                        {% csrf_token %}
                        <div class="container-fluid">
                            <!-- Known Comorbidities -->
                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <div class="card pat-prem-form-card">
                                        <div class="card-header">
                                            <h6 class="mb-0 text-center text-uppercase"><i class="fas fa-file-medical-alt mr-2"></i>Known Comorbidities</h6>
                                        </div>
                                        <div class="card-body">
                                            <!-- Comorbidity Toggle -->
                                            <div class="form-group">
                                                <label>Does the patient have any known comorbidities?</label>
                                                <select class="form-control" id="comorbidityToggle">
                                                    <option value="">-- Select --</option>
                                                    <option value="yes">Yes</option>
                                                    <option value="no">No</option>
                                                </select>
                                            </div>

                                            <!-- Comorbidity Selection Section -->
                                            <div id="comorbiditySection" style="display: none;">
                                                <label>Select Comorbidities and Medication Status:</label>
                                                <div class="row">
                                                    <!-- Hypertension -->
                                                    <div class="col-md-3">
                                                        <label>
                                                            <input type="checkbox" class="comorbidity-checkbox" data-condition="Hypertension"> Hypertension
                                                        </label>
                                                        <select class="form-control mt-1 comorbidity-status" data-condition="Hypertension" disabled>
                                                            <option value="">-- Select Status --</option>
                                                            <option value="regularly">regularly</option>
                                                            <option value="irregularly">irregularly</option>
                                                            <option value="not on">not on</option>
                                                        </select>
                                                    </div>

                                                    <!-- Diabetes -->
                                                    <div class="col-md-3">
                                                        <label>
                                                            <input type="checkbox" class="comorbidity-checkbox" data-condition="Diabetes"> Diabetes
                                                        </label>
                                                        <select class="form-control mt-1 comorbidity-status" data-condition="Diabetes" disabled>
                                                            <option value="">-- Select Status --</option>
                                                            <option value="regularly">regularly</option>
                                                            <option value="irregularly">irregularly</option>
                                                            <option value="not on">not on</option>
                                                        </select>
                                                    </div>

                                                    <!-- IMC -->
                                                    <div class="col-md-3">
                                                        <label>
                                                            <input type="checkbox" class="comorbidity-checkbox" data-condition="IMC"> IMC
                                                        </label>
                                                        <select class="form-control mt-1 comorbidity-status" data-condition="IMC" disabled>
                                                            <option value="">-- Select Status --</option>
                                                            <option value="regularly">regularly</option>
                                                            <option value="irregularly">irregularly</option>
                                                            <option value="not on">not on</option>
                                                        </select>
                                                    </div>

                                                    <!-- Asthma -->
                                                    <div class="col-md-3">
                                                        <label>
                                                            <input type="checkbox" class="comorbidity-checkbox" data-condition="Asthma"> Asthma
                                                        </label>
                                                        <select class="form-control mt-1 comorbidity-status" data-condition="Asthma" disabled>
                                                            <option value="">-- Select Status --</option>
                                                            <option value="regularly">regularly</option>
                                                            <option value="irregularly">irregularly</option>
                                                            <option value="not on">not on</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- No Comorbidities Section -->
                                            <div class="form-check mt-3" id="noComorbiditySection" style="display: none;">
                                                <input class="form-check-input" type="checkbox" id="noComorbidities">
                                                <label class="form-check-label" for="noComorbidities">Patient has no pre-existing comorbidities</label>
                                            </div>

                                            <!-- Summary Display -->
                                            <div class="form-group mt-3">
                                                <label>Comorbidity Summary:</label>
                                                <textarea class="form-control" id="comorbiditySummaryDisplay" rows="3" readonly>{{ consultation_note.known_comorbidities_summary }}</textarea>
                                                <input type="hidden" id="known_comorbidities_summary" name="known_comorbidities_summary" value="{{ consultation_note.known_comorbidities_summary }}">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Allergy Information -->
                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <div class="card pat-prem-form-card mt-4">
                                        <div class="card-header">
                                            <strong><i class="fas fa-allergies mr-2"></i>Allergy Information</strong>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-group">
                                                <label>Does the patient have any allergies?</label><br>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="has_allergy" id="hasAllergyYes" value="yes">
                                                    <label class="form-check-label" for="hasAllergyYes">Yes</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="has_allergy" id="hasAllergyNo" value="no">
                                                    <label class="form-check-label" for="hasAllergyNo">No</label>
                                                </div>
                                            </div>

                                            <div id="allergyDetails" class="mt-3" style="display: none;">
                                                <!-- Food Allergy -->
                                                <div class="form-check mb-2">
                                                    <input class="form-check-input allergy-checkbox" type="checkbox" id="chkFoodAllergy">
                                                    <label class="form-check-label" for="chkFoodAllergy">Food Allergy</label>
                                                </div>
                                                <div class="form-group d-none" id="foodAllergyGroup">
                                                    <input type="text" class="form-control" id="foodAllergy" placeholder="E.g. Fish">
                                                </div>

                                                <!-- Medicine Allergy -->
                                                <div class="form-check mb-2">
                                                    <input class="form-check-input allergy-checkbox" type="checkbox" id="chkMedicineAllergy">
                                                    <label class="form-check-label" for="chkMedicineAllergy">Medicine Allergy</label>
                                                </div>
                                                <div class="form-group d-none" id="medicineAllergyGroup">
                                                    <input type="text" class="form-control" id="medicineAllergy" placeholder="E.g. Penicillin">
                                                </div>

                                                <!-- Other Allergy -->
                                                <div class="form-check mb-2">
                                                    <input class="form-check-input allergy-checkbox" type="checkbox" id="chkOtherAllergy">
                                                    <label class="form-check-label" for="chkOtherAllergy">Other Allergy</label>
                                                </div>
                                                <div class="form-group d-none" id="otherAllergyGroup">
                                                    <input type="text" class="form-control" id="otherAllergy" placeholder="E.g. Dust">
                                                </div>
                                            </div>

                                            <div class="form-group mt-3">
                                                <label>Allergy Summary:</label>
                                                <textarea class="form-control" id="allergySummaryDisplay" rows="3" readonly></textarea>
                                                <input type="hidden" name="allergy_summary" id="allergySummary">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Consultation Text Areas -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="hpi"><i class="fas fa-stethoscope mr-2"></i>History of Presenting Illness (HPI):</label>
                                        <textarea class="form-control" id="hpi" name="history_of_presenting_illness" rows="10">{{ consultation_note.history_of_presenting_illness }}</textarea>

                                        <!-- Tabs Navigation -->
                                        <ul class="nav nav-tabs mt-3" id="hpiTab" role="tablist">
                                            <li class="nav-item">
                                                <a class="nav-link active" id="general-tab" data-toggle="tab" href="#general" role="tab">General</a>
                                            </li>
                                            <li class="nav-item">
                                                <a class="nav-link" id="resp-tab" data-toggle="tab" href="#resp" role="tab">Respiratory</a>
                                            </li>
                                            <li class="nav-item">
                                                <a class="nav-link" id="abd-tab" data-toggle="tab" href="#abd" role="tab">Abdomen & GI</a>
                                            </li>
                                            <li class="nav-item">
                                                <a class="nav-link" id="uro-tab" data-toggle="tab" href="#uro" role="tab">Urogenital</a>
                                            </li>
                                            <li class="nav-item">
                                                <a class="nav-link" id="msk-tab" data-toggle="tab" href="#msk" role="tab">Musculoskeletal</a>
                                            </li>
                                            <li class="nav-item">
                                                <a class="nav-link" id="derma-tab" data-toggle="tab" href="#derma" role="tab">Dermatology</a>
                                            </li>
                                        </ul>

                                        <!-- Tabs Content -->
                                        <div class="tab-content border border-top-0 p-3" id="hpiTabContent">
                                            <!-- General -->
                                            <div class="tab-pane fade show active" id="general" role="tabpanel">
                                                <button type="button" class="btn btn-sm btn-outline-danger ml-2 mb-2" data-toggle="modal" data-target="#feverModal">Fever</button>
                                                <button type="button"  class="btn btn-sm btn-outline-warning ml-2 mb-2" data-toggle="modal" data-target="#headacheModal">Headache</button>
                                                <button type="button"  class="btn btn-sm btn-outline-success ml-2 mb-2" data-toggle="modal" data-target="#gbmModal">Generalized Malaise</button>
                                            </div>

                                            <!-- Respiratory -->
                                            <div class="tab-pane fade" id="resp" role="tabpanel">
                                                <button type="button"  class="btn btn-sm btn-outline-info ml-2 mb-2" data-toggle="modal" data-target="#fluModal">Flu</button>
                                                <button type="button"  class="btn btn-sm btn-outline-warning ml-2 mb-2" data-toggle="modal" data-target="#coughModal">Cough</button>
                                                <button type="button"  class="btn btn-sm btn-outline-danger ml-2 mb-2" data-toggle="modal" data-target="#dibModal">Difficulty in Breathing</button>
                                                <button type="button"  class="btn btn-sm btn-outline-warning ml-2 mb-2" data-toggle="modal" data-target="#chestPainModal">Chest Pain</button>
                                            </div>

                                            <!-- Abdomen & GI -->
                                            <div class="tab-pane fade" id="abd" role="tabpanel">
                                                <button type="button"  class="btn btn-sm btn-outline-success ml-2 mb-2" data-toggle="modal" data-target="#gaseousDiscomfortModal">Gaseous Discomfort</button>
                                                <button type="button"  class="btn btn-sm btn-outline-primary ml-2 mb-2" data-toggle="modal" data-target="#abdominalPainModal">Abdominal Pain</button>
                                                <button type="button"  class="btn btn-sm btn-outline-primary ml-2 mb-2" data-toggle="modal" data-target="#lowerAbdPainModal">Lower Abdominal Pain</button>
                                                <button type="button"  class="btn btn-sm btn-outline-primary ml-2 mb-2" data-toggle="modal" data-target="#constipationModal">Constipation</button>
                                            </div>

                                            <!-- Urogenital -->
                                            <div class="tab-pane fade" id="uro" role="tabpanel">
                                                <button type="button"  class="btn btn-sm btn-outline-primary ml-2 mb-2" data-toggle="modal" data-target="#pvDischargeModal">PV Discharge</button>
                                                <button type="button"  class="btn btn-sm btn-outline-danger ml-2 mb-2" data-toggle="modal" data-target="#painfulMicturitionModal">Painful Micturition</button>
                                            </div>

                                            <!-- Musculoskeletal -->
                                            <div class="tab-pane fade" id="msk" role="tabpanel">
                                                <button type="button"  class="btn btn-sm btn-outline-warning ml-2 mb-2" data-toggle="modal" data-target="#backPainModal">Back Pain</button>
                                                <button type="button"   class="btn btn-sm btn-outline-info ml-2 mb-2" data-toggle="modal" data-target="#jointPainModal">Joint Pain</button>
                                            </div>

                                            <!-- Dermatology -->
                                            <div class="tab-pane fade" id="derma" role="tabpanel">
                                                <button type="button"   class="btn btn-sm btn-outline-danger ml-2 mb-2" data-toggle="modal" data-target="#rashesModal">Rashes</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- ROS -->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="ros"><i class="fas fa-clipboard-list mr-2"></i>Review of Other Systems (ROS):</label>
                                        <textarea class="form-control" id="ros" name="review_of_systems" rows="10">{{ consultation_note.review_of_systems }}</textarea>
                                        <button type="button" class="btn pat-prem-btn-action mt-2" data-toggle="modal" data-target="#rosModal">
                                            <i class="fas fa-edit mr-1"></i> Edit in Modal
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Physical Examination -->
                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <div class="card pat-prem-form-card">
                                        <div class="card-header">
                                            <h6 class="mb-0 text-center text-uppercase"><i class="fas fa-user-md mr-2"></i>Physical Examination</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-group">
                                                <label for="physical_examination">Physical Examination Notes:</label>
                                                <textarea class="form-control" id="physical_examination" name="physical_examination" rows="10">{{ consultation_note.physical_examination }}</textarea>
                                                <button type="button" class="btn pat-prem-btn-action mt-2" data-toggle="modal" data-target="#physicalExamModal">
                                                    <i class="fas fa-edit mr-1"></i> Edit in Modal
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Provisional Diagnosis -->
                            <div class="form-group mt-4">
                                <label for="provisional_diagnosis_{{ consultation_note.id }}"><i class="fas fa-diagnoses mr-2"></i>Provisional Diagnosis:</label>
                                <select class="form-control select2bs4" id="provisional_diagnosis_{{ consultation_note.id }}" name="provisional_diagnosis[]" multiple required>
                                    {% for diagnosis in provisional_diagnoses %}
                                        <option value="{{ diagnosis.id }}" {% if diagnosis.id in provisional_diagnosis_ids %}selected{% endif %}>{{ diagnosis }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Doctor Plan Note -->
                            <div class="form-group mt-4">
                                <label for="doctor_plan_note"><i class="fas fa-clipboard-check mr-2"></i>Doctor Plan Note:</label>
                                <textarea class="form-control" id="doctor_plan_note" name="doctor_plan_note" rows="2">{{ consultation_note.doctor_plan_note }}</textarea>
                            </div>

                            <!-- Doctor's Plan -->
                            <div class="form-group mt-3">
                                <label for="doctor_plan"><i class="fas fa-tasks mr-2"></i>Doctor Plan:</label>
                                <select class="form-control select2bs4" style="width: 100%;" id="doctor_plan" name="doctor_plan" 
                                    {% if consultation_note.doctor_plan == 'Referral' and previous_referrals %} disabled 
                                    {% elif consultation_note.doctor_plan == 'Discharge' and previous_discharges %} disabled 
                                    {% endif %} required>
                                    <option value="">Select Doctor Plan</option>
                                    <option value="Prescription" {% if consultation_note.doctor_plan == 'Prescription' %} selected {% endif %}>Prescription</option>
                                    <option value="Laboratory" {% if consultation_note.doctor_plan == 'Laboratory' %} selected {% endif %}>Laboratory</option>                                          
                                    <option value="Procedure" {% if consultation_note.doctor_plan == 'Procedure' %} selected {% endif %}>Procedure</option>
                                    <option value="Observation" {% if consultation_note.doctor_plan == 'Observation' %} selected {% endif %}>Observation</option>
                                    <option value="Referral" {% if consultation_note.doctor_plan == 'Referral' %} selected {% endif %}>Referral</option>
                                    <option value="Counselling" {% if consultation_note.doctor_plan == 'Counselling' %} selected {% endif %}>Counselling</option>
                                    <option value="Discharge" {% if consultation_note.doctor_plan == 'Discharge' %} selected {% endif %}>Discharge</option>
                                </select>
                            </div>

                            {% if consultation_note.doctor_plan == 'Referral' and previous_referrals %}
                                <input type="hidden" name="doctor_plan" value="{{ consultation_note.doctor_plan }}">
                            {% elif consultation_note.doctor_plan == 'Discharge' and previous_discharges %}
                                <input type="hidden" name="doctor_plan" value="{{ consultation_note.doctor_plan }}">
                            {% endif %}

                            <!-- Submit Button -->
                            <div class="form-row mt-4">
                                <div class="col-md-12">
                                    <button type="submit" class="btn pat-prem-btn-success btn-block">
                                        <i class="fas fa-save mr-1"></i> Save & Continue
                                    </button>
                                </div>
                            </div>

                            <!-- Messages -->
                            <div class="card-footer p-0 mt-3">
                                {% if messages %}
                                    <div class="row">
                                        <div class="col-12">
                                            {% for message in messages %}
                                                {% if message.tags == 'error' %}
                                                    <div class="alert alert-danger alert-message">{{ message }}</div>
                                                {% elif message.tags == 'success' %}
                                                    <div class="alert alert-primary alert-message">{{ message }}</div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% include 'doctor_template/doctor_consultation_modals.html' %}

<script>
    // Fade out alerts after 5 seconds (5000ms)
    setTimeout(function() {
        document.querySelectorAll('.alert-message').forEach(function(el) {
            el.style.transition = 'opacity 0.5s ease-out';
            el.style.opacity = '0';
            setTimeout(() => el.style.display = 'none', 500);
        });
    }, 5000);
</script>

{% include 'doctor_template/datatable.html' %}     
{% endblock main_content %}

{% block customer_js %}

<script>
function generateAbdPain() {
  const days = document.getElementById("abdPainDuration").value;
  const painType = document.getElementById("painType").value;
  const painTiming = document.getElementById("painTiming").value;
  const painRelief = document.getElementById("painRelief").value;
  const diarrhoeaType = document.getElementById("diarrhoeaType").value;
  const diarrhoeaBlood = document.getElementById("diarrhoeaBlood").value;
  const constipation = document.getElementById("constipationAssociated").value;

  let timingText = "";
  if (painTiming === "none") timingText = "has no specific periodicity";
  else if (painTiming === "during") timingText = "is more during meals";
  else if (painTiming === "after") timingText = "is more after meals";
  else if (painTiming === "empty") timingText = "is more when on empty stomach";

  let reliefText = "";
  if (painRelief === "food") reliefText = "The pain is relieved by intake of food.";
  else if (painRelief === "empty") reliefText = "The pain is relieved when on an empty stomach.";
  else if (painRelief === "both") reliefText = "The pain is relieved by both food intake and when on empty stomach.";
  else reliefText = "The pain is not relieved by either food or posture.";

  let diarrhoeaText = "";
  if (diarrhoeaType === "none") {
    diarrhoeaText = "There is no history of diarrhoea.";
  } else {
    const bloodText = diarrhoeaBlood === "yes" ? "and is associated with blood" : "and is not associated with blood";
    diarrhoeaText = `There is also history of diarrhoea that is nonspecific in periodicity and is ${diarrhoeaType} in nature ${bloodText}.`;
  }

  const constipationText = constipation === "yes"
    ? "The abdominal pain is associated with constipation."
    : "The abdominal pain is not associated with constipation.";

  const sentence = `The patient has had abdominal pain that has been there for ${days} days, and this has been more generalised and non-radiating. The pain is described as ${painType} in nature and ${timingText}. ${reliefText} ${diarrhoeaText} ${constipationText}`;

  appendToHPI(sentence);
  $('#abdominalPainModal').modal('hide');
}

function appendToHPI(text) {
  const hpiField = document.getElementById("hpi");
  hpiField.value += (hpiField.value ? "\n" : "") + text;
}
</script>

<script>
  function generateLowerAbdPain() {
  const days = document.getElementById("lowerAbdDuration").value;
  const discharge = document.getElementById("dischargePresence").value;
  const smell = document.getElementById("foulSmell").value;
  const pessary = document.getElementById("pessaryUsed").value;
  const cream = document.getElementById("creamUsed").value;
  const improvement = document.getElementById("improvement").value;

  let dischargeText = discharge === "yes"
    ? "She has also been experiencing discharge"
    : "She has not been experiencing discharge";

  let smellText = smell === "yes"
    ? "this has resulted in foul smell"
    : "there is no foul smell";

  let pessaryText = pessary === "yes"
    ? "She has used vaginal pessary"
    : "She has not used vaginal pessary";

  let creamText = cream === "yes"
    ? "and has also used vaginal cream"
    : "and has not used vaginal cream";

  let improvementText = improvement === "yes"
    ? "that has resulted in improvement."
    : "that has not resulted in improvement.";

  const sentence = `She has been experiencing lower abdominal pain that has been there for the past ${days} days, and this has resulted in pain at all times when moving and when not moving. ${dischargeText} and ${smellText}. ${pessaryText} ${creamText} ${improvementText}`;

  appendToHPI(sentence);
  $('#lowerAbdPainModal').modal('hide');
}

function appendToHPI(text) {
  const hpiField = document.getElementById("hpi");
  hpiField.value += (hpiField.value ? "\n" : "") + text;
}

</script>

<script>
  function generateConstipation() {
  const days = document.getElementById("constipationDuration").value;
  const stool = document.getElementById("constipationStool").value;
  const pain = document.getElementById("constipationAbdominalPain").value;

  let painText = pain === "yes" 
    ? "There is a history of abdominal pain." 
    : "There is no history of abdominal pain.";

  const sentence = `Patient has had constipation that has been there for the past ${days} days, and this is associated with ${stool} stool. ${painText}`;

  appendToHPI(sentence);
  $('#constipationModal').modal('hide');
}

function appendToHPI(text) {
  const hpiField = document.getElementById("hpi");
  hpiField.value += (hpiField.value ? "\n" : "") + text;
}

</script>


<script>
function generatePVDischarge() {
  const duration = document.getElementById("pvDuration").value;
  const nature = document.getElementById("pvNature").value;
  const itchingDays = document.getElementById("pvItchingDuration").value;
  const lap = document.getElementById("pvLap").value;
  const meds = document.getElementById("pvMedUsed").value;

  const lapText = lap === "yes" ? "associated with LAP" : "not associated with LAP";
  const medText = meds === "yes" ? "has been on topical medication" : "has not been on topical medication";

  const sentence = `She has been experiencing PV discharge that has been there for the past ${duration} days. The PV discharge is ${nature.toLowerCase()} in nature and also associated with PV itching for ${itchingDays} days. The PV itching is ${lapText} and not associated with severe scratching. She ${medText}, and has had no relief since the start of symptoms.`;

  appendToHPI(sentence);
  $('#pvDischargeModal').modal('hide');
}

</script>




<script>
  function generateMicturitionHPI() {
    const days = document.getElementById('micturitionDays').value.trim();
    const blood = document.getElementById('micturitionBlood').value;
    const pus = document.getElementById('micturitionPus').value;
    const fever = document.getElementById('micturitionFever').value;

    let sentence = `The patient has been experiencing painful micturition that has been there over the past ${days} day(s), and this is mostly when passing urine, and not relieved by posture. There is ${blood} and also ${pus}. The patient has ${fever}.`;

    const hpiTextarea = document.getElementById('hpi');
    hpiTextarea.value = hpiTextarea.value.trim()
      ? `${hpiTextarea.value.trim()}\n\n${sentence}`
      : sentence;

    $('#painfulMicturitionModal').modal('hide');
  }
</script>



<script>
  function toggleJointLocationInput() {
    const dist = document.getElementById("jointPainDistribution").value;
    const locGroup = document.getElementById("jointPainLocationGroup");
    locGroup.style.display = dist === "localized" ? "block" : "none";
  }
</script>



<script>
  document.getElementById('jointPainDistribution').addEventListener('change', function () {
    document.getElementById('jointPainLocationGroup').style.display = this.value === 'localized' ? 'block' : 'none';
  });

  function generateJointPainHPI() {
    const onset = document.getElementById('jointPainOnset').value;
    const distribution = document.getElementById('jointPainDistribution').value;
    const location = document.getElementById('jointPainLocation').value.trim();
    const movement = document.getElementById('jointPainMovement').value;
    const relief = document.getElementById('jointPainRelief').value;
    const medication = document.getElementById('jointPainMedication').value;
    const topical = document.getElementById('jointPainTopical').value;

    let sentence = `The patient has joint pain that started ${onset} and is more ${distribution}`;
    if (distribution === 'localized' && location) {
      sentence += ` at the ${location}`;
    }
    sentence += `. The pain ${movement}, and ${relief}. There is ${medication} to relieve the pain, and this has been ${topical}.`;

    const hpiTextarea = document.getElementById('hpi');
    hpiTextarea.value = hpiTextarea.value.trim()
      ? `${hpiTextarea.value.trim()}\n\n${sentence}`
      : sentence;

    $('#jointPainModal').modal('hide');
  }
</script>


<script>
  function toggleBackLocationInput() {
    const dist = document.getElementById("backPainDistribution").value;
    const locGroup = document.getElementById("backPainLocationGroup");
    locGroup.style.display = dist === "localized" ? "block" : "none";
  }
</script>

<script>
  document.getElementById('backPainDistribution').addEventListener('change', function () {
    document.getElementById('backPainLocationGroup').style.display = this.value === 'localized' ? 'block' : 'none';
  });

  function generateBackPainHPI() {
    const onset = document.getElementById('backPainOnset').value;
    const distribution = document.getElementById('backPainDistribution').value;
    const location = document.getElementById('backPainLocation').value.trim();
    const movement = document.getElementById('backPainMovement').value;
    const relief = document.getElementById('backPainRelief').value;
    const medication = document.getElementById('backPainMedication').value;
    const topical = document.getElementById('backPainTopical').value;

    let sentence = `The patient has back pain that started ${onset} and is more ${distribution}`;
    if (distribution === 'localized' && location) {
      sentence += ` at the ${location}`;
    }
    sentence += `. The back pain ${movement}, and ${relief}. There is ${medication} to relieve the pain, and this has been ${topical}.`;

    const hpiTextarea = document.getElementById('hpi');
    hpiTextarea.value = hpiTextarea.value.trim()
      ? `${hpiTextarea.value.trim()}\n\n${sentence}`
      : sentence;

    $('#backPainModal').modal('hide');
  }
</script>

<script>
  function toggleRashLocationInput() {
    const dist = document.getElementById("rashesDistribution").value;
    const locGroup = document.getElementById("rashesLocationGroup");
    locGroup.style.display = dist === "localized" ? "block" : "none";
  }
</script>


<script>
  document.getElementById('rashesDistribution').addEventListener('change', function () {
    const locGroup = document.getElementById('rashesLocationGroup');
    locGroup.style.display = this.value === 'localized' ? 'block' : 'none';
  });

  function generateRashesHPI() {
    const duration = document.getElementById('rashesDuration').value.trim();
    const itching = document.getElementById('rashesItching').value;
    const distribution = document.getElementById('rashesDistribution').value;
    const location = document.getElementById('rashesLocation').value.trim();
    const medication = document.getElementById('rashesMedication').value;

    let sentence = `The patient has been having rashes that have been there for the past ${duration}, and this has resulted in discomfort. `;
    sentence += `The rashes ${itching} that has accompanied the rashes, and these are ${distribution}`;
    if (distribution === 'localized' && location) {
      sentence += ` in ${location}`;
    }
    sentence += `. The patient ${medication} on any medication lately and this has resulted in no improvement to the condition.`;

    const hpiTextarea = document.getElementById('hpi');
    hpiTextarea.value = hpiTextarea.value.trim()
      ? `${hpiTextarea.value.trim()}\n\n${sentence}`
      : sentence;

    $('#rashesModal').modal('hide');
  }
</script>


<script>
  function generateGBMHPI() {
    const onset = document.getElementById('gbmOnset').value;
    const relation = document.getElementById('gbmRelation').value;
    const associated = document.getElementById('gbmAssociatedFactors').value.trim();

    let sentence = `Patient has been having generalized malaise that ${onset} and has been ${relation}.`;
    if (associated) {
      sentence += ` The GBM has been associated with ${associated}.`;
    }

    const hpiTextarea = document.getElementById('hpi');
    hpiTextarea.value = hpiTextarea.value.trim()
      ? `${hpiTextarea.value.trim()}\n\n${sentence}`
      : sentence;

    $('#gbmModal').modal('hide');
  }
</script>

<script>
  function generateGaseousDiscomfortHPI() {
    const days = document.getElementById('gaseousDiscomfortDays').value || 'several';
    const medication = document.getElementById('gaseousDiscomfortMedication').value;
    const bloodStool = document.getElementById('gaseousDiscomfortBloodStool').value;
    const diarrhea = document.getElementById('gaseousDiscomfortDiarrhea').value;

    const sentence = `Patient has been experiencing gaseous discomfort that started ${days} days ago and this has resulted in severe inability to consume enough food and also associated with inability to have a comfortable daily routine. The patient ${medication}. ${bloodStool}, and also ${diarrhea}.`;

    const hpiTextarea = document.getElementById('hpi');
    hpiTextarea.value = hpiTextarea.value.trim()
      ? `${hpiTextarea.value.trim()}\n\n${sentence}`
      : sentence;

    $('#gaseousDiscomfortModal').modal('hide');
  }
</script>


<script>
  function generateChestPainHPI() {
    const days = document.getElementById('chestPainDaysAgo').value || 'a few';
    const location = document.getElementById('chestPainLocation').value;
    const radiation = document.getElementById('chestPainRadiation').value;
    const cough = document.getElementById('chestPainCough').value;
    const fever = document.getElementById('chestPainFever').value;

    const sentence = `Patient has chest pain that has been there for ${days} days and is mostly ${location} and is ${radiation} pain. Chest pain is ${cough}, and is ${fever}.`;

    const hpiTextarea = document.getElementById('hpi');
    hpiTextarea.value = hpiTextarea.value.trim()
      ? `${hpiTextarea.value.trim()}\n\n${sentence}`
      : sentence;

    $('#chestPainModal').modal('hide');
  }
</script>


<script>
  function generateDibHPI() {
    const days = document.getElementById('dibDaysAgo').value || 'a few';
    const location = document.getElementById('dibLocation').value;
    const radiation = document.getElementById('dibRadiation').value;
    const cough = document.getElementById('dibCough').value;
    const fever = document.getElementById('dibFever').value;

    const sentence = `Patient has difficulty in breathing that has been there for ${days} days and is mostly ${location} and is ${radiation} pain. DIB is ${cough}, and is ${fever}.`;

    const hpiTextarea = document.getElementById('hpi');
    hpiTextarea.value = hpiTextarea.value.trim()
      ? `${hpiTextarea.value.trim()}\n\n${sentence}`
      : sentence;

    $('#dibModal').modal('hide');
  }
</script>



<script>
  function generateCoughHPI() {
    const days = document.getElementById('coughDaysAgo').value || 'a few';
    const periodicity = document.getElementById('coughPeriodicity').value;
    const sputum = document.getElementById('coughSputum').value;
    const blood = document.getElementById('coughBlood').value;
    const breathing = document.getElementById('coughBreathing').value;
    const pain = document.getElementById('coughPain').value;

    const sentence = `Patient has cough that started ${days} days ago and this is mostly ${periodicity} in periodicity. The cough is ${sputum} in nature, ${blood}. Cough is ${breathing}, and is ${pain}.`;

    const hpiTextarea = document.getElementById('hpi');
    hpiTextarea.value = hpiTextarea.value.trim()
      ? `${hpiTextarea.value.trim()}\n\n${sentence}`
      : sentence;

    $('#coughModal').modal('hide');
  }
</script>


<script>
  function generateFluHPI() {
    const days = document.getElementById('fluDaysAgo').value || 'a few';
    const symptom = document.getElementById('fluPrimarySymptom').value;
    const malaise = document.getElementById('fluMalaise').value;
    const unease = document.getElementById('fluUnease').value;

    const sentence = `Patient has flu that started about ${days} days ago and this has resulted in ${symptom}, and ${malaise}, ${unease}.`;

    const hpiTextarea = document.getElementById('hpi');
    hpiTextarea.value = hpiTextarea.value.trim()
      ? `${hpiTextarea.value.trim()}\n\n${sentence}`
      : sentence;

    $('#fluModal').modal('hide');
  }
</script>

<script>
  function generateHeadacheHPI() {
    const location = document.getElementById('headacheLocation').value;
    const severity = document.getElementById('headacheSeverity').value;
    const runningNose = document.getElementById('headacheRunningNose').value;
    const congestion = document.getElementById('headacheNoseCongestion').value;
    const feverHistory = document.getElementById('headacheFeverHistory').value;
    const injury = document.getElementById('headacheInjury').value;

    const sentence = `Patient presents with headache that is ${location} and has been ${severity}. Headache is ${runningNose} and is also ${congestion}. ${feverHistory}. ${injury}.`;

    const hpiTextarea = document.getElementById('hpi');
    hpiTextarea.value = hpiTextarea.value.trim()
      ? `${hpiTextarea.value.trim()}\n\n${sentence}`
      : sentence;

    $('#headacheModal').modal('hide');
  }
</script>

<script>
  function generateFeverHPI() {
  const grade = document.getElementById('feverGrade').value;
  const pattern = document.getElementById('feverPattern').value;
  const onset = document.getElementById('feverOnset').value;
  const duration = document.getElementById('feverDuration').value;
  const med = document.getElementById('feverMed').value;

  if (!grade || !pattern || !onset || !duration || !med) {
    alert("Please fill all the fields to generate the HPI.");
    return;
  }

  const medText = med === 'yes'
    ? "The patient has been on medication related to relieving fever."
    : "The patient has not been on any medication related to relieving fever.";

  const feverHPI = `Patient presents with fever that is of ${grade} and is ${pattern}, started ${duration} day(s) ago and was ${onset} in onset. ${medText}`;

  const hpiTextarea = document.getElementById('hpi');
  hpiTextarea.value = hpiTextarea.value.trim()
    ? `${hpiTextarea.value.trim()}\n\n${feverHPI}`
    : feverHPI;

  $('#feverModal').modal('hide');
}

</script>


<script>
$(document).ready(function () {

  // Show/hide ROS options based on status
  $('#rosStatus').on('change', function () {
    const status = $(this).val();
    if (status === 'abnormal') {
      $('#rosOptionsSection').show();
    } else {
      $('#rosOptionsSection').hide();
    }
  });

  // Enable/disable textarea with checkbox
  $('.ros-option').on('change', function () {
    const label = $(this).data('label');
    $(`.ros-note[data-label="${label}"]`).prop('disabled', !this.checked);
  });

  // Select all toggle
  $('#rosSelectAll').on('change', function () {
    const checked = this.checked;
    $('.ros-option').prop('checked', checked).trigger('change');
  });

  // Generate ROS summary
  $('#generateRosSummary').on('click', function () {
    const status = $('#rosStatus').val();
    let summary = '';

    if (status === 'normal') {
      summary = `Review of systems is normal. The patient denies symptoms in all systems.`;
    } else if (status === 'abnormal') {
      let abnormal = [];
      let normal = [];

      $('.ros-option').each(function () {
        const label = $(this).data('label');
        const isChecked = $(this).is(':checked');
        const note = $(`.ros-note[data-label="${label}"]`).val().trim();

        if (isChecked) {
          if (note) {
            abnormal.push(`${label}: ${note}`);
          } else {
            abnormal.push(`${label}: abnormal findings noted`);
          }
        } else {
          normal.push(label);
        }
      });

      summary = '';

      if (abnormal.length > 0) {
        summary += "Review of systems reveals the following abnormalities:\n" + abnormal.join("\n") + "\n\n";
      }

      if (normal.length > 0) {
        summary += "Other systems reviewed and found normal: " + normal.join(", ") + ".";
      }

      if (summary.trim() === '') {
        summary = "Review of systems abnormal, but no details provided.";
      }
    } else {
      summary = '';
    }

    $('#ros').val(summary.trim());
    $('#rosModal').modal('hide');
  });

});
</script>





<script>
  const defaultFindings = {
    "HEENT": "Normocephalic, atraumatic head; neck supple; PERRL.",
    "Cardiovascular": "Regular rate and rhythm; no murmurs, rubs, or gallops.",
    "Respiratory": "Clear to auscultation bilaterally; no wheezes, rales, or crackles.",
    "Abdomen": "Soft, non-tender, non-distended; normal bowel sounds; no masses or organomegaly.",
    "Musculoskeletal": "No deformities or scoliosis; atraumatic extremities.",
    "Neurological": "Normal strength, tone, ROM and gait; no focal deficits.",
    "Skin": "Warm, well-perfused; no rashes or lesions."
  };

  const allSections = Object.keys(defaultFindings);

  $(document).ready(function () {
    // Show/hide textareas on checkbox toggle
    $('.system-check').on('change', function () {
      const system = $(this).val();
      const textarea = $('#txt' + system);
      if (this.checked) {
        textarea.removeClass('d-none');
      } else {
        textarea.addClass('d-none').val('');
      }
    });

    // Generate and fill summary on save
    $('#generatePhysicalExam').on('click', function () {
      let summary = 'Physical Examination:\n\n';
      allSections.forEach(system => {
        const isChecked = $('#chk' + system).is(':checked');
        const findings = $('#txt' + system).val().trim();
        if (isChecked && findings) {
          summary += `${system}: ${findings}\n`;
        } else if (!isChecked) {
          summary += `${system}: ${defaultFindings[system]}\n`;
        }
      });
      $('#physical_examination').val(summary.trim());
      $('#physicalExamModal').modal('hide');
    });
  });
</script>




<script>
    $(document).ready(function () {
        // HPI
        $('#hpiModal').on('show.bs.modal', function () {
            $('#modalHpiText').val($('#hpi').val());
        });
        $('#saveHpiModal').on('click', function () {
            $('#hpi').val($('#modalHpiText').val());
            $('#hpiModal').modal('hide');
        });

        // ROS
        $('#rosModal').on('show.bs.modal', function () {
            $('#modalRosText').val($('#ros').val());
        });
        $('#saveRosModal').on('click', function () {
            $('#ros').val($('#modalRosText').val());
            $('#rosModal').modal('hide');
        });

        // Physical Examination
        $('#physicalExamModal').on('show.bs.modal', function () {
            $('#modalPhysicalExamText').val($('#physical_examination').val());
        });
        $('#savePhysicalExamModal').on('click', function () {
            $('#physical_examination').val($('#modalPhysicalExamText').val());
            $('#physicalExamModal').modal('hide');
        });
    });
</script>
                     
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const summaryField = document.getElementById('known_comorbidities_summary');
    const displayField = document.getElementById('comorbiditySummaryDisplay');

    const comorbidityToggle = document.getElementById('comorbidityToggle');
    const comorbiditySection = document.getElementById('comorbiditySection');
    const noComorbiditySection = document.getElementById('noComorbiditySection');
    const noComorbiditiesCheckbox = document.getElementById('noComorbidities');

    // Create "Others" checkbox and input field
    const othersContainer = document.createElement('div');
    othersContainer.classList.add('col-md-3');
    othersContainer.innerHTML = `
      <label>
        <input type="checkbox" class="comorbidity-checkbox" data-condition="Others" id="chkOthers"> Others
      </label>
      <input type="text" class="form-control mt-1 d-none" id="txtOthers" placeholder="Specify other comorbidities">
    `;
    // Append to the comorbiditySection
    const row = comorbiditySection.querySelector('.row');
    row.appendChild(othersContainer);

    const othersCheckbox = document.getElementById('chkOthers');
    const othersInput = document.getElementById('txtOthers');

    comorbidityToggle.addEventListener('change', function () {
      const value = this.value;

      if (value === 'yes') {
        comorbiditySection.style.display = 'block';
        noComorbiditySection.style.display = 'none';
        noComorbiditiesCheckbox.checked = false;
        noComorbiditiesCheckbox.dispatchEvent(new Event('change')); // clear any effects
      } else if (value === 'no') {
        comorbiditySection.style.display = 'none';
        noComorbiditySection.style.display = 'block';
        noComorbiditiesCheckbox.checked = true;
        noComorbiditiesCheckbox.dispatchEvent(new Event('change'));
      } else {
        comorbiditySection.style.display = 'none';
        noComorbiditySection.style.display = 'none';
      }
    });

    function updateComorbiditySummary() {
      let summary = '';
      const phrases = [];

      document.querySelectorAll('.comorbidity-checkbox').forEach(cb => {
        const condition = cb.dataset.condition;
        const select = document.querySelector(`.comorbidity-status[data-condition="${condition}"]`);

        if (cb.checked && select && select.value) {
          phrases.push(`${condition.toLowerCase()} on ${select.value} medication`);
        }
      });

      // Handle "Others" input
      if (othersCheckbox.checked) {
        const otherText = othersInput.value.trim();
        if (otherText) {
          phrases.push(`other comorbidities: ${otherText}`);
        }
      }

      if (noComorbiditiesCheckbox.checked) {
        summary = "Patient has no pre-existing comorbidities.";
      } else if (phrases.length > 0) {
        const joined = phrases.length === 1
          ? phrases[0]
          : phrases.slice(0, -1).join(', ') + ' and ' + phrases.slice(-1);
        summary = `This is a known patient with ${joined}.`;
      } else {
        summary = '';
      }

      summaryField.value = summary;
      displayField.value = summary;
    }

    document.querySelectorAll('.comorbidity-checkbox').forEach(cb => {
      cb.addEventListener('change', function () {
        const condition = this.dataset.condition;
        const statusSelect = document.querySelector(`.comorbidity-status[data-condition="${condition}"]`);
        if (statusSelect) statusSelect.disabled = !this.checked;
        updateComorbiditySummary();
      });
    });

    document.querySelectorAll('.comorbidity-status').forEach(select => {
      select.addEventListener('change', updateComorbiditySummary);
    });

    noComorbiditiesCheckbox.addEventListener('change', function () {
      const isChecked = this.checked;

      document.querySelectorAll('.comorbidity-checkbox').forEach(cb => {
        cb.checked = false;
        cb.disabled = isChecked;
        const select = document.querySelector(`.comorbidity-status[data-condition="${cb.dataset.condition}"]`);
        if (select) {
          select.disabled = true;
          select.value = '';
        }
      });

      othersInput.classList.add('d-none');
      othersInput.value = '';
      updateComorbiditySummary();
    });

    othersCheckbox.addEventListener('change', function () {
      if (this.checked) {
        othersInput.classList.remove('d-none');
      } else {
        othersInput.classList.add('d-none');
        othersInput.value = '';
      }
      updateComorbiditySummary();
    });

    othersInput.addEventListener('input', updateComorbiditySummary);
  });
</script>
  <script>
  const hasAllergyYes = document.getElementById("hasAllergyYes");
  const hasAllergyNo = document.getElementById("hasAllergyNo");
  const allergyDetails = document.getElementById("allergyDetails");
  const foodAllergy = document.getElementById("foodAllergy");
  const medicineAllergy = document.getElementById("medicineAllergy");
  const otherAllergy = document.getElementById("otherAllergy");
  const allergySummaryDisplay = document.getElementById("allergySummaryDisplay");
  const allergySummary = document.getElementById("allergySummary");

  const chkFoodAllergy = document.getElementById("chkFoodAllergy");
  const chkMedicineAllergy = document.getElementById("chkMedicineAllergy");
  const chkOtherAllergy = document.getElementById("chkOtherAllergy");

  const foodAllergyGroup = document.getElementById("foodAllergyGroup");
  const medicineAllergyGroup = document.getElementById("medicineAllergyGroup");
  const otherAllergyGroup = document.getElementById("otherAllergyGroup");

  const initialSummary = `{{ consultation_note.allergy_summary|default:"" }}`.trim();

  function generateAllergySummary() {
    let summary = '';

    if (hasAllergyNo.checked) {
      summary = "Patient has no known allergies.";
    } else {
      let parts = [];

      if (chkFoodAllergy.checked && foodAllergy.value.trim()) {
        parts.push(`food: ${foodAllergy.value.trim()}`);
      }
      if (chkMedicineAllergy.checked && medicineAllergy.value.trim()) {
        parts.push(`medicine: ${medicineAllergy.value.trim()}`);
      }
      if (chkOtherAllergy.checked && otherAllergy.value.trim()) {
        parts.push(`other: ${otherAllergy.value.trim()}`);
      }

      if (parts.length > 0) {
        summary = `This patient has allergy to ${parts.join(", ")}.`;
      } else {
        summary = "This patient reports allergies, but no specific substances were provided.";
      }
    }

    allergySummaryDisplay.value = summary;
    allergySummary.value = summary;
  }

  function toggleInputField(checkbox, groupDiv) {
    groupDiv.classList.toggle("d-none", !checkbox.checked);
    if (!checkbox.checked) {
      groupDiv.querySelector("input").value = '';
    }
    generateAllergySummary();
  }

  chkFoodAllergy.addEventListener("change", () => toggleInputField(chkFoodAllergy, foodAllergyGroup));
  chkMedicineAllergy.addEventListener("change", () => toggleInputField(chkMedicineAllergy, medicineAllergyGroup));
  chkOtherAllergy.addEventListener("change", () => toggleInputField(chkOtherAllergy, otherAllergyGroup));

  hasAllergyYes.addEventListener("change", () => {
    allergyDetails.style.display = "block";
    generateAllergySummary();
  });

  hasAllergyNo.addEventListener("change", () => {
    allergyDetails.style.display = "none";
    [chkFoodAllergy, chkMedicineAllergy, chkOtherAllergy].forEach(chk => chk.checked = false);
    [foodAllergyGroup, medicineAllergyGroup, otherAllergyGroup].forEach(group => {
      group.classList.add("d-none");
      group.querySelector("input").value = '';
    });
    generateAllergySummary();
  });

  [foodAllergy, medicineAllergy, otherAllergy].forEach(input => {
    input.addEventListener("input", generateAllergySummary);
  });

  function prepopulateAllergyFields() {
    if (!initialSummary) {
      hasAllergyNo.checked = true;
      allergyDetails.style.display = "none";
      generateAllergySummary();
      return;
    }

    allergySummaryDisplay.value = initialSummary;
    allergySummary.value = initialSummary;

    if (initialSummary.toLowerCase().includes("no known allergies")) {
      hasAllergyNo.checked = true;
      allergyDetails.style.display = "none";
    } else {
      hasAllergyYes.checked = true;
      allergyDetails.style.display = "block";

      const foodMatch = initialSummary.match(/food:\s*([^,]+)/i);
      const medicineMatch = initialSummary.match(/medicine:\s*([^,]+)/i);
      const otherMatch = initialSummary.match(/other:\s*([^,]+)/i);

      if (foodMatch) {
        chkFoodAllergy.checked = true;
        foodAllergyGroup.classList.remove("d-none");
        foodAllergy.value = foodMatch[1].trim();
      }

      if (medicineMatch) {
        chkMedicineAllergy.checked = true;
        medicineAllergyGroup.classList.remove("d-none");
        medicineAllergy.value = medicineMatch[1].trim();
      }

      if (otherMatch) {
        chkOtherAllergy.checked = true;
        otherAllergyGroup.classList.remove("d-none");
        otherAllergy.value = otherMatch[1].trim();
      }
    }

    generateAllergySummary();
  }

  window.addEventListener("DOMContentLoaded", prepopulateAllergyFields);
</script>
                                  
 <!-- Hidden Inputs -->
<input type="hidden" id="patient_id" value="{{ patient.id }}">
<input type="hidden" id="visit_id" value="{{ visit.id }}">                       
<script>
      $(document).ready(function () {
          const patientId = $('#patient_id').val();
          const visitId = $('#visit_id').val();
        $('#chiefComplaintsList').show();
          // Function to initialize Select2 dynamically
          function initializeSelect2(selector) {
              $(selector).select2({
                  theme: 'bootstrap4',
                  width: '100%',
              });
          }
  
        let editingMode = false;
          let rowCounter = 0;

          $('#toggleEditChiefComplaints').on('click', function () {
              editingMode = !editingMode;

              if (editingMode) {
                  $('#chiefComplaintsList').hide();
                  $('#chiefComplaintFormRow').addClass('d-none'); // hide input row
                  $('#addChiefComplaintButton').addClass('d-none'); // hide add button
                  $('#chiefComplaintsEditTableContainer').removeClass('d-none'); // show editable table
                  $(this).html('<i class="fa fa-eye"></i> View');
              } else {
                  $('#chiefComplaintFormRow').addClass('d-none');
                  $('#chiefComplaintsList').show();                                
                  $('#addChiefComplaintButton').removeClass('d-none');
                  $('#chiefComplaintsEditTableContainer').addClass('d-none');
                  $(this).html('<i class="fa fa-edit"></i> Edit');
              }
          });



          $('#addChiefComplaintButton').on('click', function () {
              $('#chiefComplaintFormRow').removeClass('d-none');

              const rowId = `chiefComplaintRow${rowCounter}`;
              const inputRow = `
                  <tr id="${rowId}" class="temporary-row">
                      <td>
                          <label>Chief Complaint</label>
                          <select class="form-control select2bs4" name="chief_complain_name" required>
                              {% for health_record in health_records %}
                                  <option value="{{ health_record.id }}">{{ health_record.name }}</option>
                              {% endfor %}
                              <option value="other">Other</option>
                          </select>
                      </td>
                      <td>
                          <label>Duration</label>
                          <input type="text" class="form-control" name="chief_complain_duration" placeholder="Duration (days)" required>
                      </td>
                      <td>
                          <label>Actions</label><br>
                          <button type="button" class="btn btn-danger btn-sm delete-row">Delete</button>
                          <button type="button" class="btn btn-success btn-sm save-row">Save</button>
                      </td>
                  </tr>`;

              $('#chiefComplaintInputRowBody').append(inputRow);

              initializeSelect2(`#${rowId} .select2bs4`);
              bindEventListener(rowId);

              rowCounter++; // Increase after appending
          });

          function bindEventListener(rowId) {
          const row = $(`#${rowId}`);

          // Save button
          row.find('.save-row').on('click', function () {
              saveChiefComplaint(rowId);
          });

          // Delete button
          row.find('.delete-row').on('click', function () {
              $(`#${rowId}`).remove();
          });

          // Handle "Other" selection in dropdown
          row.find('select[name="chief_complain_name"]').on('change', function () {
              const selectedValue = $(this).val();
              handleOtherOption(selectedValue, rowId);
          });
      }

  
            
          function handleOtherOption(value, rowId) {
          const row = $(`#${rowId}`);
          
          // Check if the "Other" input already exists
          const existingOtherInput = row.find('input[name="other_complaint"]').closest('td');

          if (value === 'other') {
              if (existingOtherInput.length === 0) {
                  // Add "Other" input after the select field (1st td)
                  row.find('td:first').after(`
                      <td>
                          <label>Other Complaint</label>
                          <input type="text" class="form-control" name="other_complaint" placeholder="Enter Other Chief Complaint" required>
                      </td>`);
              }
          } else {
              existingOtherInput.remove();
          }
      }

      

      // Fetch and display existing chief complaints (table and list)
      function fetchAndDisplayChiefComplaints() {
          const url = `{% url 'doctor_endpoint_to_fetch_existing_data' %}`;

          const requestData = {
              patient_id: patientId,
              visit_id: visitId
          };

          $.getJSON(url, requestData)
              .done(function (data) {
                  // Populate both table view and list view
                  populateChiefComplaintsTable(data);
                  populateChiefComplaintsList(data);
              })
              .fail(function () {
                  // Show error message on failure
                  displayPopupMessage('Error fetching chief complaints.', 'alert-danger');
              });
      }

  
          // Populate the table with chief complaints     
          function populateChiefComplaintsTable(data) {
              const container = $('#chiefComplaintsTable tbody');

              container.empty(); // Clear the table before populating
        
              if (!Array.isArray(data) || data.length === 0) {
                  container.append('<tr><td colspan="3" class="text-center">No Chief Complaints Found</td></tr>');
                  return;
              }
          
              data.forEach(item => {
                  const row = `
                          <tr id="chiefComplaintRow${item.id}" data-id="${item.id}">
                              <td>
                                  <span class="display-text">${item.health_record || item.other_complaint || 'N/A'}</span>
                              </td>
                              <td>
                                  <span class="display-text">${item.duration || 'N/A'}</span>
                                  <input type="text" class="form-control editable-field d-none" name="chief_complain_duration" value="${item.duration || ''}" placeholder="Duration (days)">
                              </td>
                              <td>
                                  {% if item.data_recorder_id == item.staff_id %}
                                  <button type="button" class="btn btn-danger btn-sm delete-chief-complaint" data-id="${item.id}">Delete</button>
                                  <button type="button" class="btn btn-primary btn-sm edit-chief-complaint" data-row-id="chiefComplaintRow${item.id}" data-id="${item.id}">Edit</button>
                                  <button type="button" class="btn btn-success btn-sm save-changes d-none" data-id="${item.id}" data-row-id="chiefComplaintRow${item.id}">Save Changes</button>
                                  <button type="button" class="btn btn-secondary btn-sm cancel-edit d-none" data-id="${item.id}" data-row-id="chiefComplaintRow${item.id}">Cancel</button>
                                  {% endif %}
                              </td>
                          </tr>`;
                  container.append(row);
                  
              });
          
              data.forEach(item => {
                  bindEventListeners(item.id);
              });
          }
          

          function populateChiefComplaintsList(data) {
          const container = $('#chiefComplaintsList');
          container.empty(); // Clear previous content

          if (!Array.isArray(data) || data.length === 0) {
              container.append('<p class="text-muted text-center">No Chief Complaints Found</p>');
              return;
          }

          const list = $('<div class="list-group list-group-flush"></div>');

          data.forEach(item => {
              const complaint = item.health_record || item.other_complaint || 'N/A';
              const duration = item.duration ? `${item.duration}` : 'N/A';

              const listItem = $(`
                  <div class="list-group-item py-2 px-3">
                      <strong>${complaint}</strong> &ndash; <span class="text-muted">${duration}</span>
                  </div>
              `);

              list.append(listItem);
          });

          container.append(list);
      }



          function bindEventListeners(rowId) {
              const row = $(`#chiefComplaintRow${rowId}`);

              row.find('.edit-chief-complaint').on('click', function () {
                  // Hide the display version and show only the duration input
                  row.find('[name="chief_complain_duration"]').removeClass('d-none');
                  row.find('[name="chief_complain_duration"]').prev('.display-text').addClass('d-none');

                  row.find('.edit-chief-complaint, .delete-chief-complaint').addClass('d-none');
                  row.find('.save-changes, .cancel-edit').removeClass('d-none');
              });

              row.find('.cancel-edit').on('click', function () {
                  // Hide input and show display again
                  row.find('[name="chief_complain_duration"]').addClass('d-none');
                  row.find('[name="chief_complain_duration"]').prev('.display-text').removeClass('d-none');

                  row.find('.edit-chief-complaint, .delete-chief-complaint').removeClass('d-none');
                  row.find('.save-changes, .cancel-edit').addClass('d-none');
              });

              row.find('.save-changes').on('click', function () {
                  const id = $(this).data('id');
                  const rowId = $(this).data('row-id');
                  saveChangeChiefComplaint(rowId, id);
              });

              row.find('.delete-chief-complaint').on('click', function () {
                  const id = $(this).data('id');
                  deleteChiefComplaint(id);
              });
          }

          
        // Function to retrieve CSRF token from cookies
              function getCSRFToken() {
                  var csrfToken = null;
                  document.cookie.split(';').forEach(function(cookie) {
                      if (cookie.trim().startsWith('csrftoken=')) {
                          csrfToken = cookie.trim().substring('csrftoken='.length);
                      }
                  });
                  return csrfToken;
              }
              

              function saveChangeChiefComplaint(rowId, id) {
                  const row = $(`#${rowId}`);

                  if (row.length === 0) {
                      displayPopupMessage(`Row with ID "${rowId}" not found.`, 'alert-warning');
                      return;
                  }

                  const durationField = row.find('[name="chief_complain_duration"]');
                  const chief_complain_duration = durationField.val();

                  if (!chief_complain_duration) {
                      displayPopupMessage('Please provide a valid duration.', 'alert-warning');
                      return;
                  }

                  const formData = {
                      chief_complain_duration: chief_complain_duration,
                  };

                  const url = "{% url 'doctor_update_chief_complaint' chief_complaint_id=0 %}".replace('0', id);

                  $.ajax({
                      url: url,
                      method: 'POST',
                      data: JSON.stringify(formData),
                      contentType: 'application/json',
                      headers: {
                          'X-CSRFToken': getCSRFToken(),
                      },
                      success: function (response) {
                          if (response.status) {
                              displayPopupMessage(response.message, 'alert-success');
                              fetchAndDisplayChiefComplaints();
                          } else {
                              displayPopupMessage(response.message, 'alert-danger');
                          }
                      },
                      error: function () {
                          displayPopupMessage('Error saving changes.', 'alert-danger');
                      },
                  });
              }


  
          // Delete a chief complaint
          function deleteChiefComplaint(id) {
              const url = `{% url 'doctor_delete_chief_complaint' chief_complaint_id=0 %}`.replace('0', id);
          
              $.ajax({
                  url: url,
                  type: 'POST', // Use POST to support _method simulation
                  data: { _method: 'DELETE' }, // Simulate DELETE request
                  headers: {
                      'X-CSRFToken': '{{ csrf_token }}', // Include CSRF token
                  },
                  success: function () {
                      fetchAndDisplayChiefComplaints(); // Refresh the list on success
                  },
                  error: function (xhr) {
                      const response = JSON.parse(xhr.responseText); // Parse JSON error response
                      const errorMessage = response.error || 'Unknown error occurred';
                      displayPopupMessage(`Error: ${errorMessage}`, 'alert-danger');
                  },
              });
          }
    
          // Save a chief complaint
          function saveChiefComplaint(rowId) {
              const row = $(`#${rowId}`);
              const formData = {
                  patient_id: patientId,
                  visit_id: visitId,
                  chief_complain_name: row.find('[name="chief_complain_name"]').val(),
                  chief_complain_duration: row.find('[name="chief_complain_duration"]').val(),
                  other_complaint: row.find('[name="other_complaint"]').val() || null,
              };
  
              if (!formData.chief_complain_name || !formData.chief_complain_duration) {
                  displayPopupMessage('Please complete all required fields.', 'alert-danger');
                  return;
              }
  
              console.log('Submitting data:', formData); // Debugging
  
              const url = "{% url 'doctor_save_chief_complaint' %}";
  
              $.post(url, formData, function (response) {
                  console.log('Response received:', response); // Debugging
  
                  if (response.status) {
                      row.remove(); // Remove the saved row from the form
                      fetchAndDisplayChiefComplaints(); // Refresh the table to display the saved data
                  } else {
                      displayPopupMessage(response.message || 'Failed to save chief complaint.', 'alert-danger');
                  }
              }).fail(function (xhr, status, error) {
                  console.error('Error saving chief complaint:', status, error); // Debugging
                  displayPopupMessage('Error saving chief complaint.', 'alert-danger');
              });
          }

  
          // Display popup messages
          function displayPopupMessage(message, alertType) {
              const popup = `<div class="alert ${alertType}">${message}</div>`;
              $('#popupContainer').html(popup);

              // Set timer to remove the popup after 5 seconds (5000ms)
              setTimeout(function() {
                  $('#popupContainer').html(''); // Clears the popup
              }, 5000);
          }

  
          // Delete a row in the form
          function deleteChiefComplaintRow(rowId) {
              $(`#${rowId}`).remove();
          }
  
          // Event bindings
          $('#addChiefComplaintButton').click(function () {
              addChiefComplaintRow(); // Only add a new row
          });                    
          fetchAndDisplayChiefComplaints();
      });

    
      
  </script>
                        

{% endblock customer_js %}