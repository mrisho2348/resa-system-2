<!-- patient_visits_modal.html -->
<div class="modal fade pat-prem-modal" id="patientVisitsModal" tabindex="-1" role="dialog" aria-labelledby="patientVisitsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content pat-prem-modal-content">
            <!-- Modal Header -->
            <div class="modal-header pat-prem-modal-header">
                <h5 class="modal-title text-white" id="patientVisitsModalLabel">
                    <i class="fas fa-history mr-2"></i>Visit History for {{ patient.first_name }} {{ patient.last_name }}
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
                <div class="table-responsive pat-prem-table-container">
                    <table class="table table-bordered pat-prem-table">
                        <thead>
                            <tr>
                                <th>Visit Number</th>
                                <th>Visit Type</th>
                                <th>Date</th>
                                <th>Day</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for visit in patient_visits %}
                            <tr>
                                <td>{{ visit.vst }}</td>
                                <td>{{ visit.get_visit_type_display }}</td>
                                <td>{{ visit.created_at|date:"d-m-Y" }}</td>
                                <td>{{ visit.created_at|date:"l" }}</td>
                                <td>
                                    <button type="button" class="btn pat-prem-btn-action btn-sm" data-toggle="modal" data-target="#visitDetailModal_{{ visit.id }}">
                                        <i class="fas fa-file-medical-alt mr-1"></i> Summary
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center">No previous visits found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% for visit in patient_visits %}
<!-- Visit Detail Modal -->
<div class="modal fade pat-prem-modal" id="visitDetailModal_{{ visit.id }}" tabindex="-1" role="dialog" aria-labelledby="visitDetailModalLabel_{{ visit.id }}" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
        <div class="modal-content pat-prem-modal-content">
            <div class="modal-header pat-prem-modal-header">
                <h5 class="modal-title text-white" id="visitDetailModalLabel_{{ visit.id }}">
                    <i class="fas fa-file-medical-alt mr-2"></i>Visit Details: {{ visit.vst }} - {{ patient.first_name }} {{ patient.last_name }}
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Patient Details Card -->
                <div class="card pat-prem-form-card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-user-injured mr-2"></i>Patient Details</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered pat-prem-table">
                                <tbody>
                                    <tr>
                                        <th width="15%">Patient:</th>
                                        <td width="35%">{{ patient.first_name }} {{ patient.middle_name }} {{ patient.last_name }}</td>
                                        <th width="15%">MRN:</th>
                                        <td width="35%">{{ patient.mrn }}</td>
                                    </tr>
                                    <tr>
                                        <th>Age:</th>
                                        <td>
                                            {% if patient.dob %}
                                                <script>
                                                    var dob = new Date("{{ patient.dob|date:'Y-m-d' }}");
                                                    var now = new Date();
                                                    var ageMilliseconds = now - dob;
                                                    var ageSeconds = ageMilliseconds / 1000;
                                                    var ageYears = Math.floor(ageSeconds / (365.25 * 24 * 60 * 60));
                                                    document.write(ageYears + ' years');
                                                </script>
                                            {% else %}
                                                {{ patient.age }}
                                            {% endif %}
                                        </td>
                                        <th>Gender:</th>
                                        <td>{{ patient.gender }}</td>
                                    </tr>
                                    <tr>
                                        <th>Phone:</th>
                                        <td>{{ patient.phone|default:"-" }}</td>
                                        <th>Payment:</th>
                                        <td>
                                            {% if patient.payment_form == "Insurance" %}
                                                {{ patient.payment_form }} - {{ patient.insurance_name }}   
                                            {% else %}   
                                                {{ patient.payment_form }}                  
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Visit Date:</th>
                                        <td>{{ visit.created_at|date:"d-m-Y" }}</td>
                                        <th>Visit Time:</th>
                                        <td>{{ visit.created_at|time:"H:i" }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Accordion for Visit Details -->
                <div class="pat-prem-accordion" id="visitAccordion{{ visit.id }}">
                    <!-- Vitals Section -->
                    {% if visit.patientvital_set.exists %}
                    <div class="card pat-prem-form-card mb-2">
                        <div class="card-header" id="vitalsHeading{{ visit.id }}" data-toggle="collapse" data-target="#vitalsCollapse{{ visit.id }}" aria-expanded="true" aria-controls="vitalsCollapse{{ visit.id }}">
                            <h6 class="mb-0">
                                <i class="fas fa-heartbeat mr-2"></i>Vital Signs/Assessment Data
                            </h6>
                        </div>
                        <div id="vitalsCollapse{{ visit.id }}" class="collapse show" aria-labelledby="vitalsHeading{{ visit.id }}" data-parent="#visitAccordion{{ visit.id }}">
                            <div class="card-body">
                                <div class="table-responsive pat-prem-table-container">
                                    <table class="table table-bordered pat-prem-table">
                                        <thead>
                                            <tr>
                                                <th>Resp Rate</th>
                                                <th>Pulse</th>
                                                <th>BP</th>
                                                <th>SBP</th>
                                                <th>DBP</th>
                                                <th>SPO2</th>
                                                <th>Temp (Â°C)</th>
                                                <th>GCS</th>
                                                <th>AVPU</th>
                                                <th>Weight</th>
                                                <th>Recorded By</th>
                                                <th>Recorded At</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for vitals in visit.patientvital_set.all %}
                                            <tr>
                                                <td>{{ vitals.respiratory_rate|default:"-" }}</td>
                                                <td>{{ vitals.pulse_rate|default:"-" }}</td>
                                                <td>{{ vitals.blood_pressure|default:"-" }}</td>
                                                <td>{{ vitals.sbp|default:"-" }}</td>
                                                <td>{{ vitals.dbp|default:"-" }}</td>
                                                <td>{{ vitals.spo2|default:"-" }}%</td>
                                                <td>{{ vitals.temperature|default:"-" }}</td>
                                                <td>{{ vitals.gcs|default:"-" }}</td>
                                                <td>{{ vitals.avpu|default:"-" }}</td>
                                                <td>{{ vitals.weight|default:"-" }}</td>
                                                <td>{{ vitals.recorded_by.get_full_name|default:"System" }}</td>
                                                <td>{{ vitals.recorded_at|date:"d-m-Y" }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Clinical Notes Section -->
                    {% with consultation_note=visit.consultationnotes_set.first diagnosis_record=visit.patientdiagnosisrecord_set.first %}
                    {% if consultation_note %}
                    <div class="card pat-prem-form-card mb-2">
                        <div class="card-header" id="clinicalHeading{{ visit.id }}" data-toggle="collapse" data-target="#clinicalCollapse{{ visit.id }}" aria-expanded="false" aria-controls="clinicalCollapse{{ visit.id }}">
                            <h6 class="mb-0">
                                <i class="fas fa-notes-medical mr-2"></i>Clinical Notes
                            </h6>
                        </div>
                        <div id="clinicalCollapse{{ visit.id }}" class="collapse" aria-labelledby="clinicalHeading{{ visit.id }}" data-parent="#visitAccordion{{ visit.id }}">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered">
                                        <tbody>
                                            <tr>
                                                <th width="20%">Chief Complaints:</th>
                                                <td width="80%">
                                                    <ul>
                                                    {% for complaint in visit.clinicchiefcomplaint_set.all %}
                                                        <li>{{ complaint.health_record }} - Duration: {{ complaint.duration }}</li>
                                                    {% endfor %}
                                                    </ul>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>History of Presenting Illness:</th>
                                                <td>{{ consultation_note.history_of_presenting_illness }}</td>
                                            </tr>
                                            <tr>
                                                <th>Review of Systems:</th>
                                                <td>{{ consultation_note.review_of_systems }}</td>
                                            </tr>
                                            <tr>
                                                <th>Physical Examination:</th>
                                                <td>{{ consultation_note.physical_examination }}</td>
                                            </tr>
                                            <tr>
                                                <th>Doctor's Plan:</th>
                                                <td>{{ consultation_note.doctor_plan }}</td>
                                            </tr>
                                            <tr>
                                                <th>Doctor's Plan Notes:</th>
                                                <td>{{ consultation_note.doctor_plan_note }}</td>
                                            </tr>
                                            <tr>
                                                <th>Allergy Summary:</th>
                                                <td>{{ consultation_note.allergy_summary }}</td>
                                            </tr>
                                            <tr>
                                                <th>Known Comorbidities:</th>
                                                <td>{{ consultation_note.known_comorbidities_summary }}</td>
                                            </tr>
                                            
                                            {% if diagnosis_record %}
                                            <tr>
                                                <th>Provisional Diagnosis:</th>
                                                <td>
                                                    <ul class="list-group">
                                                    {% for pdx in diagnosis_record.provisional_diagnosis.all %}
                                                        <li class="list-group-item">{{ pdx.diagnosis_name }}</li>
                                                    {% endfor %}
                                                    </ul>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>Final Diagnosis:</th>
                                                <td>
                                                    <ul class="list-group">
                                                    {% for fdx in diagnosis_record.final_diagnosis.all %}
                                                        <li class="list-group-item">{{ fdx.diagnosis_name }}</li>
                                                    {% endfor %}
                                                    </ul>
                                                </td>
                                            </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endwith %}

                    <!-- Laboratory Section -->
                    {% if visit.laboratoryorder_set.exists %}
                    <div class="card pat-prem-form-card mb-2">
                        <div class="card-header" id="labHeading{{ visit.id }}" data-toggle="collapse" data-target="#labCollapse{{ visit.id }}" aria-expanded="false" aria-controls="labCollapse{{ visit.id }}">
                            <h6 class="mb-0">
                                <i class="fas fa-vial mr-2"></i>Laboratory Data
                            </h6>
                        </div>
                        <div id="labCollapse{{ visit.id }}" class="collapse" aria-labelledby="labHeading{{ visit.id }}" data-parent="#visitAccordion{{ visit.id }}">
                            <div class="card-body">
                                <div class="table-responsive pat-prem-table-container">
                                    <table class="table table-bordered pat-prem-table">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Lab No.</th>
                                                <th>Test</th>
                                                <th>Description</th>
                                                <th>Doctor</th>
                                                <th>Ordered By</th>
                                                <th>Order Date</th>
                                                <th>Result</th>
                                                <th>Cost</th>
                                                <th>Created</th>
                                                <th>Updated</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for lab in visit.laboratoryorder_set.all %}
                                            <tr>
                                                <td>{{ forloop.counter }}</td>
                                                <td>{{ lab.lab_number }}</td>
                                                <td>{{ lab.name.name|default:"-" }}</td>
                                                <td>{{ lab.description|default:"-" }}</td>
                                                <td>{{ lab.doctor.get_full_name|default:"-" }}</td>
                                                <td>{{ lab.data_recorder.get_full_name|default:"System" }}</td>
                                                <td>{{ lab.order_date|date:"d-m-Y" }}</td>
                                                <td>
                                                    {% if lab.result %}
                                                        <button class="btn pat-prem-btn-action btn-sm" data-toggle="modal" data-target="#resultModal{{ lab.id }}">
                                                            View Result
                                                        </button>
                                                    {% else %}
                                                        <em>No result</em>
                                                    {% endif %}
                                                </td>
                                                <td>{{ lab.cost }}</td>
                                                <td>{{ lab.created_at|date:"d-m-Y" }}</td>
                                                <td>{{ lab.updated_at|date:"d-m-Y" }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Procedures Section -->
                    {% if visit.procedure_set.exists %}
                    <div class="card pat-prem-form-card mb-2">
                        <div class="card-header" id="procedureHeading{{ visit.id }}" data-toggle="collapse" data-target="#procedureCollapse{{ visit.id }}" aria-expanded="false" aria-controls="procedureCollapse{{ visit.id }}">
                            <h6 class="mb-0">
                                <i class="fas fa-procedures mr-2"></i>Procedure Records
                            </h6>
                        </div>
                        <div id="procedureCollapse{{ visit.id }}" class="collapse" aria-labelledby="procedureHeading{{ visit.id }}" data-parent="#visitAccordion{{ visit.id }}">
                            <div class="card-body">
                                <div class="table-responsive pat-prem-table-container">
                                    <table class="table table-bordered pat-prem-table">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Procedure No.</th>
                                                <th>Procedure</th>
                                                <th>Description</th>
                                                <th>Doctor</th>
                                                <th>Ordered By</th>
                                                <th>Order Date</th>
                                                <th>Equipments Used</th>
                                                <th>Result</th>
                                                <th>Cost</th>
                                                <th>Created</th>
                                                <th>Updated</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for procedure in visit.procedure_set.all %}
                                            <tr>
                                                <td>{{ forloop.counter }}</td>
                                                <td>{{ procedure.procedure_number }}</td>
                                                <td>{{ procedure.name.name|default:"-" }}</td>
                                                <td>{{ procedure.description|default:"-" }}</td>
                                                <td>{{ procedure.doctor.get_full_name|default:"-" }}</td>
                                                <td>{{ procedure.data_recorder.get_full_name|default:"System" }}</td>
                                                <td>{{ procedure.order_date|date:"d-m-Y" }}</td>
                                                <td>{{ procedure.equipments_used }}</td>
                                                <td>
                                                    {% if procedure.result %}
                                                        <button class="btn pat-prem-btn-action btn-sm" data-toggle="modal" data-target="#procedureResultModal{{ procedure.id }}">
                                                            View Result
                                                        </button>
                                                    {% else %}
                                                        <em>No result</em>
                                                    {% endif %}
                                                </td>
                                                <td>{{ procedure.cost }}</td>
                                                <td>{{ procedure.created_at|date:"d-m-Y" }}</td>
                                                <td>{{ procedure.updated_at|date:"d-m-Y" }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Observation Section -->
                    {% if visit.observationrecord_set.exists %}
                    <div class="card pat-prem-form-card mb-2">
                        <div class="card-header" id="observationHeading{{ visit.id }}" data-toggle="collapse" data-target="#observationCollapse{{ visit.id }}" aria-expanded="false" aria-controls="observationCollapse{{ visit.id }}">
                            <h6 class="mb-0">
                                <i class="fas fa-clipboard-check mr-2"></i>Observation Records
                            </h6>
                        </div>
                        <div id="observationCollapse{{ visit.id }}" class="collapse" aria-labelledby="observationHeading{{ visit.id }}" data-parent="#visitAccordion{{ visit.id }}">
                            <div class="card-body">
                                <div class="table-responsive pat-prem-table-container">
                                    <table class="table table-bordered pat-prem-table">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Observation Notes</th>
                                                <th>Recorded By</th>
                                                <th>Created At</th>
                                                <th>Updated At</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for observation in visit.observationrecord_set.all %}
                                            <tr>
                                                <td>{{ forloop.counter }}</td>
                                                <td>{{ observation.observation_notes|safe }}</td>
                                                <td>{{ observation.data_recorder.get_full_name|default:"System" }}</td>
                                                <td>{{ observation.created_at|date:"d-m-Y" }}</td>
                                                <td>{{ observation.updated_at|date:"d-m-Y" }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Prescription Section -->
                    {% if visit.prescription_set.exists %}
                    <div class="card pat-prem-form-card mb-2">
                        <div class="card-header" id="prescriptionHeading{{ visit.id }}" data-toggle="collapse" data-target="#prescriptionCollapse{{ visit.id }}" aria-expanded="false" aria-controls="prescriptionCollapse{{ visit.id }}">
                            <h6 class="mb-0">
                                <i class="fas fa-prescription mr-2"></i>Prescription Records
                            </h6>
                        </div>
                        <div id="prescriptionCollapse{{ visit.id }}" class="collapse" aria-labelledby="prescriptionHeading{{ visit.id }}" data-parent="#visitAccordion{{ visit.id }}">
                            <div class="card-body">
                                <div class="table-responsive pat-prem-table-container">
                                    <table class="table table-bordered pat-prem-table">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Medicine</th>
                                                <th>Dose</th>
                                                <th>Frequency</th>
                                                <th>Duration</th>
                                                <th>Quantity Used</th>
                                                <th>Total Price</th>
                                                <th>Verified</th>
                                                <th>Issued</th>
                                                <th>Status</th>
                                                <th>Entered By</th>
                                                <th>Created At</th>
                                                <th>Updated At</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for prescription in visit.prescription_set.all %}
                                            <tr>
                                                <td>{{ forloop.counter }}</td>
                                                <td>{{ prescription.medicine.name }}</td>
                                                <td>{{ prescription.dose }}</td>
                                                <td>{{ prescription.frequency }}</td>
                                                <td>{{ prescription.duration }}</td>
                                                <td>{{ prescription.quantity_used }}</td>
                                                <td>{{ prescription.total_price|default:"-" }}</td>
                                                <td>{{ prescription.get_verified_display }}</td>
                                                <td>{{ prescription.get_issued_display }}</td>
                                                <td>{{ prescription.status }}</td>
                                                <td>{{ prescription.entered_by.get_full_name|default:"System" }}</td>
                                                <td>{{ prescription.created_at|date:"d-m-Y" }}</td>
                                                <td>{{ prescription.updated_at|date:"d-m-Y" }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Counseling Section -->
                    {% if visit.counseling_set.exists %}
                    <div class="card pat-prem-form-card mb-2">
                        <div class="card-header" id="counselingHeading{{ visit.id }}" data-toggle="collapse" data-target="#counselingCollapse{{ visit.id }}" aria-expanded="false" aria-controls="counselingCollapse{{ visit.id }}">
                            <h6 class="mb-0">
                                <i class="fas fa-comments mr-2"></i>Counseling Notes
                            </h6>
                        </div>
                        <div id="counselingCollapse{{ visit.id }}" class="collapse" aria-labelledby="counselingHeading{{ visit.id }}" data-parent="#visitAccordion{{ visit.id }}">
                            <div class="card-body">
                                <div class="table-responsive pat-prem-table-container">
                                    <table class="table table-bordered pat-prem-table">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Recorder</th>
                                                <th>Notes</th>
                                                <th>Created</th>
                                                <th>Updated</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for session in visit.counseling_set.all %}
                                            <tr>
                                                <td>{{ forloop.counter }}</td>
                                                <td>{{ session.data_recorder.get_full_name|default:"System" }}</td>
                                                <td>
                                                    {% if session.counselling_notes %}
                                                    <div style="max-width: 400px; max-height: 200px; overflow:auto;">
                                                        {{ session.counselling_notes|safe }}
                                                    </div>
                                                    {% else %}
                                                    <em>No notes recorded.</em>
                                                    {% endif %}
                                                </td>
                                                <td>{{ session.created_at|date:"d-m-Y" }}</td>
                                                <td>{{ session.updated_at|date:"d-m-Y" }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Referral Section -->
                    {% if visit.referral_set.exists %}
                    <div class="card pat-prem-form-card mb-2">
                        <div class="card-header" id="referralHeading{{ visit.id }}" data-toggle="collapse" data-target="#referralCollapse{{ visit.id }}" aria-expanded="false" aria-controls="referralCollapse{{ visit.id }}">
                            <h6 class="mb-0">
                                <i class="fas fa-exchange-alt mr-2"></i>Referral Details
                            </h6>
                        </div>
                        <div id="referralCollapse{{ visit.id }}" class="collapse" aria-labelledby="referralHeading{{ visit.id }}" data-parent="#visitAccordion{{ visit.id }}">
                            <div class="card-body">
                                <div class="table-responsive pat-prem-table-container">
                                    <table class="table table-bordered pat-prem-table">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Source Location</th>
                                                <th>Destination Location</th>
                                                <th>Nature of Referral</th>
                                                <th>Transport Model</th>
                                                <th>Notes</th>
                                                <th>Status</th>
                                                <th>Recorded By</th>
                                                <th>Created At</th>
                                                <th>Updated At</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for referral in visit.referral_set.all %}
                                            <tr>
                                                <td>{{ forloop.counter }}</td>
                                                <td>{{ referral.source_location|default:"-" }}</td>
                                                <td>{{ referral.destination_location|default:"-" }}</td>
                                                <td>{{ referral.get_nature_of_referral_display|default:"-" }}</td>
                                                <td>{{ referral.get_transport_model_display|default:"-" }}</td>
                                                <td>{{ referral.notes|safe|default:"-" }}</td>
                                                <td>
                                                    <span class="badge badge-{{ referral.get_status_color }}">
                                                    {{ referral.get_status_display }}
                                                    </span>
                                                </td>
                                                <td>{{ referral.data_recorder.get_full_name|default:"System" }}</td>
                                                <td>{{ referral.created_at|date:"d-m-Y" }}</td>
                                                <td>{{ referral.updated_at|date:"d-m-Y" }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Discharge Section -->
                    {% if visit.dischargesnotes_set.exists %}
                    <div class="card pat-prem-form-card mb-2">
                        <div class="card-header" id="dischargeHeading{{ visit.id }}" data-toggle="collapse" data-target="#dischargeCollapse{{ visit.id }}" aria-expanded="false" aria-controls="dischargeCollapse{{ visit.id }}">
                            <h6 class="mb-0">
                                <i class="fas fa-sign-out-alt mr-2"></i>Discharge Notes
                            </h6>
                        </div>
                        <div id="dischargeCollapse{{ visit.id }}" class="collapse" aria-labelledby="dischargeHeading{{ visit.id }}" data-parent="#visitAccordion{{ visit.id }}">
                            <div class="card-body">
                                <div class="table-responsive pat-prem-table-container">
                                    <table class="table table-bordered pat-prem-table">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Discharge Condition</th>
                                                <th>Discharge Notes</th>
                                                <th>Recorded By</th>
                                                <th>Discharge Date</th>
                                                <th>Last Updated</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for discharge in visit.dischargesnotes_set.all %}
                                            <tr>
                                                <td>{{ forloop.counter }}</td>
                                                <td>{{ discharge.discharge_condition|default:"-" }}</td>
                                                <td>{{ discharge.discharge_notes|safe|default:"-" }}</td>
                                                <td>{{ discharge.data_recorder.get_full_name|default:"System" }}</td>
                                                <td>{{ discharge.discharge_date|date:"d-m-Y" }}</td>
                                                <td>{{ discharge.updated_at|date:"d-m-Y" }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endfor %}

{# =============================== #}
{# ð§ª Lab Result Modals           #}
{# =============================== #}

{% for visit in patient_visits %}
    {% for lab in visit.laboratoryorder_set.all %}
        {% if lab.result %}
            <div class="modal fade pat-prem-modal" id="resultModal{{ lab.id }}" tabindex="-1" role="dialog" aria-labelledby="resultModalLabel{{ lab.id }}" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
                    <div class="modal-content pat-prem-modal-content">
                        <div class="modal-header pat-prem-modal-header">
                            <h5 class="modal-title text-white" id="resultModalLabel{{ lab.id }}">
                                Lab Result: {{ lab.name.name|default:"Test" }}
                            </h5>
                            <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            {{ lab.result|safe }}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn pat-prem-btn-action" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    {% endfor %}
{% endfor %}

{# =============================== #}
{# ð©º Procedure Result Modals     #}
{# =============================== #}

{% for visit in patient_visits %}
    {% for procedure in visit.procedure_set.all %}
        {% if procedure.result %}
            <div class="modal fade pat-prem-modal" id="procedureResultModal{{ procedure.id }}" tabindex="-1" role="dialog" aria-labelledby="procedureResultModalLabel{{ procedure.id }}" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
                    <div class="modal-content pat-prem-modal-content">
                        <div class="modal-header pat-prem-modal-header">
                            <h5 class="modal-title text-white" id="procedureResultModalLabel{{ procedure.id }}">
                                Procedure Result: {{ procedure.name.name|default:"Procedure" }}
                            </h5>
                            <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            {{ procedure.result|safe }}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn pat-prem-btn-action" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    {% endfor %}
{% endfor %}

{# =============================== #}
{# ð¼ï¸ Imaging Result Modals       #}
{# =============================== #}

{% for visit in patient_visits %}
    {% for record in visit.imagingrecord_set.all %}
        {% if record.result %}
            <div class="modal fade pat-prem-modal" id="imagingResultModal{{ record.id }}" tabindex="-1" role="dialog" aria-labelledby="imagingResultModalLabel{{ record.id }}" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
                    <div class="modal-content pat-prem-modal-content">
                        <div class="modal-header pat-prem-modal-header">
                            <h5 class="modal-title text-white" id="imagingResultModalLabel{{ record.id }}">
                                Imaging Result: {{ record.imaging.name|default:"Imaging" }}
                            </h5>
                            <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            {{ record.result|safe }}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn pat-prem-btn-action" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    {% endfor %}
{% endfor %}

<style>
    /* Premium Modal Styling */
    .pat-prem-modal .modal-content {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 15px 35px rgba(26, 42, 108, 0.25);
        border: none;
    }
    
    .pat-prem-modal-header {
        background: linear-gradient(120deg, #1a2a6c, #2C3E50);
        border-bottom: 1px solid rgba(255,255,255,0.2);
        padding: 1.2rem 1.5rem;
    }
    
    .pat-prem-accordion .card {
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .pat-prem-accordion .card-header {
        background: linear-gradient(120deg, rgba(26, 42, 108, 0.1), rgba(44, 62, 80, 0.1));
        cursor: pointer;
        padding: 1rem 1.2rem;
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    
    .pat-prem-accordion .card-header h6 {
        margin-bottom: 0;
        display: flex;
        align-items: center;
    }
    
    .pat-prem-accordion .card-body {
        padding: 1.2rem;
    }
</style>