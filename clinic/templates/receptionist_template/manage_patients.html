{% extends 'receptionist_template/base_template.html' %}
{% block title %}
    Patient Management
{% endblock title %}

{% block breadcrumb %}
{% include "receptionist_template/modal_form.html" %}
    <a class="btn btn-primary float-right" type="button" data-toggle="modal" data-target="#registerModal">
        <i class="fas fa-plus"></i> New Patient
    </a>
{% endblock breadcrumb %}

{% block main_content %}
<style>
    /*  Patient Management Styles */
    .patient-prem-gradient {
        background: linear-gradient(120deg, #0c2461, #1e3799, #4a69bd);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 15px 35px rgba(12, 36, 97, 0.15);
        border: none;
    }
    
    .patient-prem-gradient .card-header {
        background: rgba(0,0,0,0.1);
        border-bottom: 1px solid rgba(255,255,255,0.2);
        padding: 1.2rem 1.5rem;
    }
    
    .patient-prem-table-container {
        border-radius: 10px;
        overflow: auto;
        box-shadow: 0 5px 15px rgba(0,0,0,0.06);
    }
    
    .patient-prem-table th {
        background: linear-gradient(120deg, #e8eaf6, #c5cae9);
        color: #303F9F;
        font-weight: 600;
        padding: 1rem 0.75rem;
        border: none;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .patient-prem-table td {
        padding: 1.1rem 0.75rem;
        vertical-align: middle;
        border-color: #e8eaf6;
    }
    
    .patient-prem-table tbody tr {
        transition: all 0.3s ease;
        background: white;
    }
    
    .patient-prem-table tbody tr:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(48, 63, 159, 0.1);
        background: #f5f6ff;
    }
    
    .btn-patient-prem {
        background: linear-gradient(120deg, #0c2461, #1e3799);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 8px 16px;
        font-size: 0.85rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(12, 36, 97, 0.2);
    }
    
    .btn-patient-prem:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(12, 36, 97, 0.3);
        color: white;
    }
    
    .btn-patient-prem-view {
        background: linear-gradient(120deg, #0c2461, #2c3e50);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 6px 12px;
        font-size: 0.8rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(12, 36, 97, 0.2);
    }
    
    .btn-patient-prem-view:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(12, 36, 97, 0.3);
        color: white;
    }
    
    .patient-prem-summary-card {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        border: none;
        margin-bottom: 20px;
        transition: all 0.3s ease;
    }
    
    .patient-prem-summary-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    
    .patient-prem-summary-card .card-header {
        background: linear-gradient(120deg, #f5f6ff, #e8eaf6);
        color: #303F9F;
        font-weight: 600;
        padding: 1rem 1.2rem;
        border-bottom: 1px solid #c5cae9;
    }
    
    .patient-prem-summary-card .card-body {
        padding: 1.5rem;
    }
    
    .patient-prem-summary-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: #303F9F;
        margin-bottom: 0.5rem;
    }
    
    .patient-prem-summary-label {
        font-size: 0.9rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .patient-prem-modal-content {
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        border: none;
        overflow: hidden;
    }
    
    .patient-prem-modal-header {
        background: linear-gradient(120deg, #0c2461, #1e3799);
        color: white;
        border-radius: 0;
        padding: 1.2rem 1.5rem;
    }
    
    .patient-prem-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .patient-prem-badge-insurance {
        background: linear-gradient(120deg, #00C853, #64DD17);
        color: white;
    }
    
    .patient-prem-badge-cash {
        background: linear-gradient(120deg, #FF9800, #FFC107);
        color: white;
    }
    
    .patient-prem-badge-other {
        background: linear-gradient(120deg, #42A5F5, #90CAF9);
        color: white;
    }
    
    .patient-prem-filter-bar {
        background: linear-gradient(120deg, #f5f6ff, #e8eaf6);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    
    .patient-prem-status-filter {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .patient-prem-status-btn {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        border: none;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .patient-prem-status-btn.active {
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    /* Status button colors */
    .patient-prem-status-btn[data-status="all"] {
        background: linear-gradient(120deg, #0c2461, #1e3799);
        color: white;
    }
    
    .patient-prem-status-btn[data-status="Insurance"] {
        background: linear-gradient(120deg, #00C853, #64DD17);
        color: white;
    }
    
    .patient-prem-status-btn[data-status="Cash"] {
        background: linear-gradient(120deg, #FF9800, #FFC107);
        color: white;
    }
    
    .patient-prem-status-btn[data-status="Other"] {
        background: linear-gradient(120deg, #42A5F5, #90CAF9);
        color: white;
    }
    
    /* Flip card effect for premium feature */
    .patient-prem-flip-card {
        perspective: 1000px;
        height: 200px;
        margin-bottom: 20px;
    }
    
    .patient-prem-flip-card-inner {
        position: relative;
        width: 100%;
        height: 100%;
        text-align: center;
        transition: transform 0.8s;
        transform-style: preserve-3d;
    }
    
    .patient-prem-flip-card:hover .patient-prem-flip-card-inner {
        transform: rotateY(180deg);
    }
    
    .patient-prem-flip-card-front, .patient-prem-flip-card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        border-radius: 15px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .patient-prem-flip-card-front {
        background: linear-gradient(120deg, #0c2461, #1e3799);
        color: white;
    }
    
    .patient-prem-flip-card-back {
        background: linear-gradient(120deg, #1e3799, #0c2461);
        color: white;
        transform: rotateY(180deg);
    }
    
    .patient-prem-flip-icon {
        font-size: 3rem;
        margin-bottom: 15px;
    }
    
    /* Animation for view switching */
    @keyframes patientPremFadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .patient-prem-animated {
        animation: patientPremFadeIn 0.5s ease forwards;
    }
    
    /*  timeline for visit history */
    .patient-prem-timeline {
        position: relative;
        padding: 20px 0;
    }
    
    .patient-prem-timeline::before {
        content: '';
        position: absolute;
        left: 50%;
        width: 2px;
        height: 100%;
        background: linear-gradient(to bottom, #0c2461, #1e3799, #4a69bd);
        transform: translateX(-50%);
    }
    
    .patient-prem-timeline-item {
        position: relative;
        margin-bottom: 30px;
        width: 50%;
        padding: 0 40px;
        box-sizing: border-box;
    }
    
    .patient-prem-timeline-item:nth-child(odd) {
        left: 0;
        padding-right: 0;
    }
    
    .patient-prem-timeline-item:nth-child(even) {
        left: 50%;
        padding-left: 40px;
    }
    
    .patient-prem-timeline-content {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    .patient-prem-timeline-content:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    
    .patient-prem-timeline-date {
        font-weight: 600;
        color: #0c2461;
        margin-bottom: 10px;
    }
    
    /*  accordion for visit details */
    .patient-prem-accordion .card {
        border: none;
        border-radius: 10px;
        margin-bottom: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    
    .patient-prem-accordion .card-header {
        background: linear-gradient(120deg, #f5f6ff, #e8eaf6);
        border: none;
        padding: 15px 20px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .patient-prem-accordion .card-header:hover {
        background: linear-gradient(120deg, #e8eaf6, #c5cae9);
    }
    
    .patient-prem-accordion .card-header h6 {
        margin: 0;
        color: #0c2461;
        font-weight: 600;
    }
    
    .patient-prem-accordion .card-body {
        padding: 20px;
        background: white;
    }
    
    /*  table styling for details */
    .patient-prem-detail-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .patient-prem-detail-table th {
        background: linear-gradient(120deg, #f5f6ff, #e8eaf6);
        padding: 12px 15px;
        text-align: left;
        color: #0c2461;
        font-weight: 600;
    }
    
    .patient-prem-detail-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #e8eaf6;
    }
    
    .patient-prem-detail-table tr:last-child td {
        border-bottom: none;
    }
    
    /* Action button group styling */
    .patient-prem-action-group {
        display: flex;
        flex-wrap: wrap;
        gap: 0.3rem;
    }
    
    .btn-patient-prem-action {
        padding: 5px 10px;
        font-size: 0.75rem;
        border-radius: 6px;
        transition: all 0.3s ease;
    }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card patient-prem-gradient shadow-lg">
                <div class="card-header py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0 text-white"><i class="fas fa-users mr-2"></i> Patient Management</h5>                       
                    </div>
                </div>
                <div class="card-body">
                    <!-- Summary Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card patient-prem-summary-card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-users mr-2"></i>Total Patients</h6>
                                </div>
                                <div class="card-body text-center">
                                    <div class="patient-prem-summary-value" id="total-patients">{{ patient_records|length }}</div>
                                    <div class="patient-prem-summary-label">All Patients</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card patient-prem-summary-card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-file-invoice-dollar mr-2"></i>Insurance</h6>
                                </div>
                                <div class="card-body text-center">
                                    <div class="patient-prem-summary-value" id="insurance-count">0</div>
                                    <div class="patient-prem-summary-label">Insurance Patients</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card patient-prem-summary-card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-money-bill-wave mr-2"></i>Cash Payments</h6>
                                </div>
                                <div class="card-body text-center">
                                    <div class="patient-prem-summary-value" id="cash-count">0</div>
                                    <div class="patient-prem-summary-label">Cash Patients</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="patient-prem-flip-card">
                                <div class="patient-prem-flip-card-inner">
                                    <div class="patient-prem-flip-card-front">
                                        <div class="patient-prem-flip-icon">
                                            <i class="fas fa-user-plus"></i>
                                        </div>
                                        <h4>Reception Analytics</h4>
                                        <p>Hover to reveal</p>
                                    </div>
                                    <div class="patient-prem-flip-card-back">
                                        <div class="patient-prem-flip-icon">
                                            <i class="fas fa-chart-pie"></i>
                                        </div>
                                        <h4>Patient Insights</h4>
                                        <p>Advanced patient tracking</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                   <!-- Filter Bar -->
                <div class="patient-prem-filter-bar">
                    <div class="d-flex justify-content-between align-items-center flex-wrap">
                        <div class="patient-prem-status-filter">
                            <button class="patient-prem-status-btn active" data-status="all">All Patients</button>
                            <button class="patient-prem-status-btn" data-status="Insurance">Insurance</button>
                            <button class="patient-prem-status-btn" data-status="Cash">Cash</button>
                            <button class="patient-prem-status-btn" data-status="Other">Other</button>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-4">
                            <input type="date" class="form-control" id="startDate" placeholder="Start Date">
                        </div>
                        <div class="col-md-4">
                            <input type="date" class="form-control" id="endDate" placeholder="End Date">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-patient-prem btn-block" id="applyDateFilter">
                                <i class="fas fa-filter"></i> Filter
                            </button>
                        </div>
                        <!-- Add this after the filter button in the date range row -->
                      <div class="col-md-2">
                          <button class="btn btn-secondary btn-block" id="clearDateFilter">
                              <i class="fas fa-times"></i> Clear
                          </button>
                      </div>
                    </div>
                    <div class="input-group mt-2">
                        <input type="text" class="form-control" placeholder="Search patients..." id="patientPremSearch">
                        <div class="input-group-append">
                            <button class="btn btn-patient-prem" type="button" id="searchButton">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
                    
                    <!-- Table View -->
                    <div class="table-responsive patient-prem-table-container">
                        <table class="table table-hover text-nowrap patient-prem-table" id="patientTable">
                            <thead>
                                <tr>
                                    <th><i class="fas fa-hashtag mr-2"></i>ID</th>
                                    <th><i class="fas fa-id-card mr-2"></i>MRN</th>
                                    <th><i class="fas fa-user mr-2"></i>Name</th>
                                    <th><i class="fas fa-birthday-cake mr-2"></i>Age</th>
                                    <th><i class="fas fa-venus-mars mr-2"></i>Gender</th>
                                    <th><i class="fas fa-money-bill-wave mr-2"></i>Payment Form</th>
                                    <th><i class="fas fa-phone mr-2"></i>Phone</th>             
                                    <th><i class="fas fa-calendar-alt mr-2"></i>Added At</th>             
                                    <th class="text-center"><i class="fas fa-cogs mr-2"></i>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for patient in patient_records %}
                                    <tr data-status="{{ patient.payment_form }}">                                       
                                        <td>{{ patient.id }}</td>
                                        <td>{{ patient.mrn }}</td>
                                        <td class="text-uppercase">{{ patient.first_name }} {{ patient.middle_name }}  {{ patient.last_name }}</td>   
                                        <td> 
                                            {% if patient.dob %}
                                                <script>
                                                    var dob = new Date("{{ patient.dob|date:'Y-m-d' }}");
                                                    var now = new Date();
                                                    var ageMilliseconds = now - dob;
                                                    var ageSeconds = ageMilliseconds / 1000;
                                                    var ageYears = Math.floor(ageSeconds / (365.25 * 24 * 60 * 60));
                                                    document.write(ageYears + ' years');
                                                </script>
                                            {% else %}
                                                {{ patient.age }}
                                            {% endif %}
                                        </td>
                                        <td>{{ patient.gender }}</td>
                                        <td>
                                            {% if patient.payment_form == "Insurance" %}
                                                <span class="patient-prem-badge patient-prem-badge-insurance">{{ patient.payment_form }} - {{ patient.insurance_name }}</span>
                                            {% elif patient.payment_form == "Cash" %}
                                                <span class="patient-prem-badge patient-prem-badge-cash">{{ patient.payment_form }}</span>
                                            {% else %}
                                                <span class="patient-prem-badge patient-prem-badge-other">{{ patient.payment_form }}</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ patient.phone }}</td>                                   
                                        <td>{{ patient.created_at|date:"d-m-Y" }}</td>                                   
                                        <td class="text-center patient-prem-action-group">              
                                            <button class="btn btn-patient-prem-action btn-dark" data-toggle="modal" data-target="#editPatientModal{{ patient.id }}">
                                                <i class="fas fa-edit"></i> Edit
                                            </button> 
                                            <button type="button" class="btn btn-patient-prem-action btn-light border" data-toggle="modal" data-target="#consultationModal{{ patient.id }}">
                                                <i class="fas fa-calendar-check"></i> Appointment
                                            </button>                                                                 
                                            <a href="{% url 'receptionist_patient_visit_history_view' patient.id %}">
                                                <button type="button" class="btn btn-patient-prem-action btn-success">
                                                    <i class="fas fa-history"></i> Visit History
                                                </button>
                                            </a>   
                                            <button type="button" class="btn btn-patient-prem-action btn-secondary" data-toggle="modal" data-target="#patientDetailModal{{ patient.id }}" title="Open patient details">
                                                <i class="fas fa-info-circle"></i> Details
                                            </button>
                                            <button type="button" class="btn btn-patient-prem-action btn-outline-info" data-toggle="modal" data-target="#patientVisitsModal{{ patient.id }}">
                                                <i class="fas fa-eye"></i> Visits
                                            </button>  
                                        </td>              
                                 
                                </tr>               
                              
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
              </div>
            </div>
        </div>
    </div>
</div>

<!--  Modals for Patient Visits -->
{% for patient in patient_records %}
<div class="modal fade patient-prem-modal" id="patientVisitsModal{{ patient.id }}" tabindex="-1" role="dialog" aria-labelledby="patientVisitsModalLabel{{ patient.id }}" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content patient-prem-modal-content">
            <!-- Modal Header -->
            <div class="modal-header patient-prem-modal-header">
                <h5 class="modal-title text-white" id="patientVisitsModalLabel{{ patient.id }}">
                    <i class="fas fa-history mr-2"></i>Visit History for {{ patient.first_name }} {{ patient.last_name }}
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
                {% if patient.patientvisits_set.all %}
                <div class="patient-prem-timeline">
                    {% for visit in patient.patientvisits_set.all %}
                    <div class="patient-prem-timeline-item">
                        <div class="patient-prem-timeline-content">
                            <div class="patient-prem-timeline-date">
                                <i class="fas fa-calendar-alt mr-2"></i>{{ visit.created_at|date:"F j, Y" }} ({{ visit.created_at|date:"l" }})
                            </div>
                            <h6>Visit #{{ visit.vst }} - {{ visit.get_visit_type_display }}</h6>
                            <p class="mb-2">Recorded at: {{ visit.created_at|time:"H:i" }}</p>
                            <button type="button" class="btn btn-patient-prem btn-sm" data-toggle="modal" data-target="#visitDetailModal_{{ visit.id }}">
                                <i class="fas fa-file-medical-alt mr-1"></i> View Full Details
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No previous visits found</h5>
                    <p class="text-muted">This patient has no recorded visit history</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!--  Modals for Visit Details -->
{% for patient in patient_records %}
  {% for visit in patient.patientvisits_set.all %}
    <div class="modal fade patient-prem-modal" id="visitDetailModal_{{ visit.id }}" tabindex="-1" role="dialog" aria-labelledby="visitDetailModalLabel_{{ visit.id }}" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
        <div class="modal-content patient-prem-modal-content">
          <div class="modal-header patient-prem-modal-header">
            <h5 class="modal-title text-white" id="visitDetailModalLabel_{{ visit.id }}">
                <i class="fas fa-file-medical-alt mr-2"></i>Visit Details - {{ patient.first_name }} {{ patient.last_name }} (Visit #{{ visit.vst }})
            </h5>
            <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
          </div>
          <div class="modal-body">
            <!-- Patient Details Card -->
            <div class="card patient-prem-summary-card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-user-injured mr-2"></i>Patient Details</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="patient-prem-detail-table">
                            <tbody>
                                <tr>
                                    <th width="15%">Patient Name:</th>
                                    <td width="35%">{{ patient.full_name|default:"-" }}</td>
                                    <th width="15%">MRN:</th>
                                    <td width="35%">{{ patient.mrn|default:"-" }}</td>
                                </tr>
                                <tr>
                                    <th>Age:</th>
                                    <td>
                                        {% if patient.dob %}
                                            <script>
                                                var dob = new Date("{{ patient.dob|date:'Y-m-d' }}");
                                                var now = new Date();
                                                var ageMilliseconds = now - dob;
                                                var ageSeconds = ageMilliseconds / 1000;
                                                var ageYears = Math.floor(ageSeconds / (365.25 * 24 * 60 * 60));
                                                document.write(ageYears + ' years');
                                            </script>
                                        {% else %}
                                            {{ patient.age|default:"-" }}
                                        {% endif %}
                                    </td>
                                    <th>Gender:</th>
                                    <td>{{ patient.gender|default:"-" }}</td>
                                </tr>
                                <tr>
                                    <th>Phone:</th>
                                    <td>{{ patient.phone|default:"-" }}</td>
                                    <th>Payment Form:</th>
                                    <td>
                                        {% if patient.payment_form == "Insurance"  %}
                                            {{ patient.payment_form }}- {{ patient.insurance_name }}   
                                        {% else  %}   
                                            {{ patient.payment_form }}                  
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Visit Date:</th>
                                    <td>{{ visit.created_at|date:"d-m-Y" }}</td>
                                    <th>Visit Time:</th>
                                    <td>{{ visit.created_at|time:"H:i" }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Accordion for Visit Details -->
            <div class="patient-prem-accordion" id="visitAccordion{{ visit.id }}">
                <!-- Vitals Section -->
                {% if visit.patientvital_set.all %}
                <div class="card">
                    <div class="card-header" id="vitalsHeading{{ visit.id }}" data-toggle="collapse" data-target="#vitalsCollapse{{ visit.id }}" aria-expanded="true" aria-controls="vitalsCollapse{{ visit.id }}">
                        <h6 class="mb-0">
                            <i class="fas fa-heartbeat mr-2"></i>Vital Signs/Assessment Data
                        </h6>
                    </div>
                    <div id="vitalsCollapse{{ visit.id }}" class="collapse show" aria-labelledby="vitalsHeading{{ visit.id }}" data-parent="#visitAccordion{{ visit.id }}">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="patient-prem-detail-table text-nowrap">
                                    <thead>
                                        <tr>
                                            <th>Resp Rate</th>
                                            <th>Pulse</th>
                                            <th>BP</th>
                                            <th>SBP</th>
                                            <th>DBP</th>
                                            <th>SPO2</th>
                                            <th>Temp (°C)</th>
                                            <th>GCS</th>
                                            <th>AVPU</th>
                                            <th>Weight</th>
                                            <th>Recorded By</th>
                                            <th>Recorded At</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for vitals in visit.patientvital_set.all %}
                                        <tr>
                                            <td>{{ vitals.respiratory_rate|default:"-" }}</td>
                                            <td>{{ vitals.pulse_rate|default:"-" }}</td>
                                            <td>{{ vitals.blood_pressure|default:"-" }}</td>
                                            <td>{{ vitals.sbp|default:"-" }}</td>
                                            <td>{{ vitals.dbp|default:"-" }}</td>
                                            <td>{{ vitals.spo2|default:"-" }}%</td>
                                            <td>{{ vitals.temperature|default:"-" }}</td>
                                            <td>{{ vitals.gcs|default:"-" }}</td>
                                            <td>{{ vitals.avpu|default:"-" }}</td>
                                            <td>{{ vitals.weight|default:"-" }}</td>
                                            <td>{{ vitals.recorded_by.get_full_name|default:"System" }}</td>
                                            <td>{{ vitals.recorded_at|date:"d-m-Y" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Clinical Notes Section -->
                {% with consultation_note=visit.consultationnotes_set.first diagnosis_record=visit.patientdiagnosisrecord_set.first %}
                {% if consultation_note %}
                <div class="card">
                    <div class="card-header" id="clinicalHeading{{ visit.id }}" data-toggle="collapse" data-target="#clinicalCollapse{{ visit.id }}" aria-expanded="false" aria-controls="clinicalCollapse{{ visit.id }}">
                        <h6 class="mb-0">
                            <i class="fas fa-notes-medical mr-2"></i>Clinical Notes
                        </h6>
                    </div>
                    <div id="clinicalCollapse{{ visit.id }}" class="collapse" aria-labelledby="clinicalHeading{{ visit.id }}" data-parent="#visitAccordion{{ visit.id }}">
                        <div class="card-body">
                            <table class="patient-prem-detail-table">
                                <tbody>
                                    <tr>
                                        <th width="20%">Chief Complaints:</th>
                                        <td width="80%">
                                            <ul>
                                            {% for complaint in visit.clinicchiefcomplaint_set.all %}
                                                <li>{{ complaint.health_record }} - Duration: {{ complaint.duration }}</li>
                                            {% endfor %}
                                            </ul>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>History of Presenting Illness:</th>
                                        <td>{{ consultation_note.history_of_presenting_illness }}</td>
                                    </tr>
                                    <tr>
                                        <th>Review of Systems:</th>
                                        <td>{{ consultation_note.review_of_systems }}</td>
                                    </tr>
                                    <tr>
                                        <th>Physical Examination:</th>
                                        <td>{{ consultation_note.physical_examination }}</td>
                                    </tr>
                                    <tr>
                                        <th>Doctor's Plan:</th>
                                        <td>{{ consultation_note.doctor_plan }}</td>
                                    </tr>
                                    <tr>
                                        <th>Doctor's Plan Notes:</th>
                                        <td>{{ consultation_note.doctor_plan_note }}</td>
                                    </tr>
                                    <tr>
                                        <th>Allergy Summary:</th>
                                        <td>{{ consultation_note.allergy_summary }}</td>
                                    </tr>
                                    <tr>
                                        <th>Known Comorbidities:</th>
                                        <td>{{ consultation_note.known_comorbidities_summary }}</td>
                                    </tr>
                                    {% if diagnosis_record %}
                                    <tr>
                                        <th>Provisional Diagnosis:</th>
                                        <td>
                                            <ul>
                                            {% for pdx in diagnosis_record.provisional_diagnosis.all %}
                                                <li>{{ pdx.diagnosis_name }}</li>
                                            {% endfor %}
                                            </ul>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Final Diagnosis:</th>
                                        <td>
                                            <ul>
                                            {% for fdx in diagnosis_record.final_diagnosis.all %}
                                                <li>{{ fdx.diagnosis_name }}</li>
                                            {% endfor %}
                                            </ul>
                                        </td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endwith %}

                <!-- Laboratory Section -->
                {% if visit.laboratoryorder_set.all %}
                <div class="card">
                    <div class="card-header" id="labHeading{{ visit.id }}" data-toggle="collapse" data-target="#labCollapse{{ visit.id }}" aria-expanded="false" aria-controls="labCollapse{{ visit.id }}">
                        <h6 class="mb-0">
                            <i class="fas fa-vial mr-2"></i>Laboratory Data
                        </h6>
                    </div>
                    <div id="labCollapse{{ visit.id }}" class="collapse" aria-labelledby="labHeading{{ visit.id }}" data-parent="#visitAccordion{{ visit.id }}">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="patient-prem-detail-table text-nowrap">
                                    <thead>
                                        <tr>
                                            <th>Lab No.</th>
                                            <th>Test</th>
                                            <th>Description</th>
                                            <th>Doctor</th>
                                            <th>Ordered By</th>
                                            <th>Order Date</th>
                                            <th>Result</th>
                                            <th>Cost</th>
                                            <th>Created</th>
                                            <th>Updated</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for lab in visit.laboratoryorder_set.all %}
                                        <tr>
                                            <td>{{ lab.lab_number }}</td>
                                            <td>{{ lab.name.name|default:"-" }}</td>
                                            <td>{{ lab.description|default:"-" }}</td>
                                            <td>{{ lab.doctor.get_full_name|default:"-" }}</td>
                                            <td>{{ lab.data_recorder.get_full_name|default:"System" }}</td>
                                            <td>{{ lab.order_date|date:"d-m-Y" }}</td>
                                            <td>
                                                {% if lab.result %}
                                                    <button class="btn btn-patient-prem btn-sm" data-toggle="modal" data-target="#resultModal{{ lab.id }}">
                                                        View Result
                                                    </button>
                                                {% else %}
                                                    <em>No result</em>
                                                {% endif %}
                                            </td>
                                            <td>{{ lab.cost }}</td>
                                            <td>{{ lab.created_at|date:"d-m-Y" }}</td>
                                            <td>{{ lab.updated_at|date:"d-m-Y" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Procedures Section -->
                {% if visit.procedure_set.all %}
                <div class="card">
                    <div class="card-header" id="procedureHeading{{ visit.id }}" data-toggle="collapse" data-target="#procedureCollapse{{ visit.id }}" aria-expanded="false" aria-controls="procedureCollapse{{ visit.id }}">
                        <h6 class="mb-0">
                            <i class="fas fa-procedures mr-2"></i>Procedure Records
                        </h6>
                    </div>
                    <div id="procedureCollapse{{ visit.id }}" class="collapse" aria-labelledby="procedureHeading{{ visit.id }}" data-parent="#visitAccordion{{ visit.id }}">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="patient-prem-detail-table text-nowrap">
                                    <thead>
                                        <tr>
                                            <th>Procedure No.</th>
                                            <th>Procedure</th>
                                            <th>Description</th>
                                            <th>Doctor</th>
                                            <th>Ordered By</th>
                                            <th>Order Date</th>
                                            <th>Equipments Used</th>
                                            <th>Result</th>
                                            <th>Cost</th>
                                            <th>Created</th>
                                            <th>Updated</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for procedure in visit.procedure_set.all %}
                                        <tr>
                                            <td>{{ procedure.procedure_number }}</td>
                                            <td>{{ procedure.name.name|default:"-" }}</td>
                                            <td>{{ procedure.description|default:"-" }}</td>
                                            <td>{{ procedure.doctor.get_full_name|default:"-" }}</td>
                                            <td>{{ procedure.data_recorder.get_full_name|default:"System" }}</td>
                                            <td>{{ procedure.order_date|date:"d-m-Y" }}</td>
                                            <td>{{ procedure.equipments_used }}</td>
                                            <td>
                                                {% if procedure.result %}
                                                    <button class="btn btn-patient-prem btn-sm" data-toggle="modal" data-target="#procedureResultModal{{ procedure.id }}">
                                                        View Result
                                                    </button>
                                                {% else %}
                                                    <em>No result</em>
                                                {% endif %}
                                            </td>
                                            <td>{{ procedure.cost }}</td>
                                            <td>{{ procedure.created_at|date:"d-m-Y" }}</td>
                                            <td>{{ procedure.updated_at|date:"d-m-Y" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Imaging Section -->
                {% if visit.imagingrecord_set.all %}
                <div class="card">
                    <div class="card-header" id="imagingHeading{{ visit.id }}" data-toggle="collapse" data-target="#imagingCollapse{{ visit.id }}" aria-expanded="false" aria-controls="imagingCollapse{{ visit.id }}">
                        <h6 class="mb-0">
                            <i class="fas fa-x-ray mr-2"></i>Imaging Records
                        </h6>
                    </div>
                    <div id="imagingCollapse{{ visit.id }}" class="collapse" aria-labelledby="imagingHeading{{ visit.id }}" data-parent="#visitAccordion{{ visit.id }}">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="patient-prem-detail-table text-nowrap">
                                    <thead>
                                        <tr>
                                            <th>Imaging</th>
                                            <th>Description</th>
                                            <th>Result</th>
                                            <th>Image</th>
                                            <th>Doctor</th>
                                            <th>Ordered By</th>
                                            <th>Order Date</th>
                                            <th>Cost</th>
                                            <th>Created At</th>
                                            <th>Updated At</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for record in visit.imagingrecord_set.all %}
                                        <tr>
                                            <td>{{ record.imaging.name|default:"-" }}</td>
                                            <td>{{ record.description|default:"-" }}</td>
                                            <td>
                                                {% if record.result %}
                                                    <button class="btn btn-patient-prem btn-sm" data-toggle="modal" data-target="#imagingResultModal{{ record.id }}">
                                                        View Result
                                                    </button>
                                                {% else %}
                                                    <em>No result</em>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if record.image %}
                                                    <a href="{{ record.image.url }}" target="_blank" class="btn btn-patient-prem btn-sm">View Image</a>
                                                {% else %}
                                                    <span class="text-muted">No Image</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ record.doctor.get_full_name|default:"-" }}</td>
                                            <td>{{ record.data_recorder.get_full_name|default:"System" }}</td>
                                            <td>{{ record.order_date|date:"d-m-Y" }}</td>
                                            <td>{{ record.cost }}</td>
                                            <td>{{ record.created_at|date:"d-m-Y" }}</td>
                                            <td>{{ record.updated_at|date:"d-m-Y" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
               
                <!-- Observation Section -->
                {% if visit.observationrecord_set.all %}
                <div class="card">
                    <div class="card-header" id="observationHeading{{ visit.id }}" data-toggle="collapse" data-target="#observationCollapse{{ visit.id }}" aria-expanded="false" aria-controls="observationCollapse{{ visit.id }}">
                        <h6 class="mb-0">
                            <i class="fas fa-clipboard-check mr-2"></i>Observation Records
                        </h6>
                    </div>
                    <div id="observationCollapse{{ visit.id }}" class="collapse" aria-labelledby="observationHeading{{ visit.id }}" data-parent="#visitAccordion{{ visit.id }}">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="patient-prem-detail-table text-nowrap">
                                    <thead>
                                        <tr>
                                            <th>Observation Notes</th>
                                            <th>Recorded By</th>
                                            <th>Created At</th>
                                            <th>Updated At</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for observation in visit.observationrecord_set.all %}
                                        <tr>
                                            <td>{{ observation.observation_notes|safe }}</td>
                                            <td>{{ observation.data_recorder.get_full_name|default:"System" }}</td>
                                            <td>{{ observation.created_at|date:"d-m-Y" }}</td>
                                            <td>{{ observation.updated_at|date:"d-m-Y" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Prescription Section -->
                {% if visit.prescription_set.all %}
                <div class="card">
                    <div class="card-header" id="prescriptionHeading{{ visit.id }}" data-toggle="collapse" data-target="#prescriptionCollapse{{ visit.id }}" aria-expanded="false" aria-controls="prescriptionCollapse{{ visit.id }}">
                        <h6 class="mb-0">
                            <i class="fas fa-prescription mr-2"></i>Prescription Records
                        </h6>
                    </div>
                    <div id="prescriptionCollapse{{ visit.id }}" class="collapse" aria-labelledby="prescriptionHeading{{ visit.id }}" data-parent="#visitAccordion{{ visit.id }}">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="patient-prem-detail-table text-nowrap">
                                    <thead>
                                        <tr>
                                            <th>Medicine</th>
                                            <th>Dose</th>
                                            <th>Frequency</th>
                                            <th>Duration</th>
                                            <th>Route</th>
                                            <th>Quantity Used</th>
                                            <th>Total Price</th>
                                            <th>Verified</th>
                                            <th>Issued</th>
                                            <th>Status</th>
                                            <th>Entered By</th>
                                            <th>Created At</th>
                                            <th>Updated At</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for prescription in visit.prescription_set.all %}
                                        <tr>
                                            <td>{{ prescription.medicine.drug_name }}</td>
                                            <td>{{ prescription.dosage }}</td>
                                            <td>{{ prescription.frequency }}</td>
                                            <td>{{ prescription.duration }}</td>
                                            <td>{{ prescription.route }}</td>
                                            <td>{{ prescription.quantity_used }}</td>
                                            <td>{{ prescription.total_price|default:"-" }}</td>
                                            <td>{{ prescription.get_verified_display }}</td>
                                            <td>{{ prescription.get_issued_display }}</td>
                                            <td>{{ prescription.status }}</td>
                                            <td>{{ prescription.entered_by.get_full_name|default:"System" }}</td>
                                            <td>{{ prescription.created_at|date:"d-m-Y" }}</td>
                                            <td>{{ prescription.updated_at|date:"d-m-Y" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Counseling Section -->
                {% if visit.counseling_set.all %}
                <div class="card">
                    <div class="card-header" id="counselingHeading{{ visit.id }}" data-toggle="collapse" data-target="#counselingCollapse{{ visit.id }}" aria-expanded="false" aria-controls="counselingCollapse{{ visit.id }}">
                        <h6 class="mb-0">
                            <i class="fas fa-comments mr-2"></i>Counseling Notes
                        </h6>
                    </div>
                    <div id="counselingCollapse{{ visit.id }}" class="collapse" aria-labelledby="counselingHeading{{ visit.id }}" data-parent="#visitAccordion{{ visit.id }}">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="patient-prem-detail-table  text-nowrap">
                                    <thead>
                                        <tr>
                                            <th>Recorder</th>
                                            <th>Notes</th>
                                            <th>Created</th>
                                            <th>Updated</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for session in visit.counseling_set.all %}
                                        <tr>
                                            <td>{{ session.data_recorder.get_full_name|default:"System" }}</td>
                                            <td>
                                                {% if session.counselling_notes %}
                                                <div style="max-width: 400px; max-height: 200px; overflow:auto;">
                                                    {{ session.counselling_notes|safe }}
                                                </div>
                                                {% else %}
                                                <em>No notes recorded.</em>
                                                {% endif %}
                                            </td>
                                            <td>{{ session.created_at|date:"d-m-Y" }}</td>
                                            <td>{{ session.updated_at|date:"d-m-Y" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Referral Section -->
                {% if visit.referral_set.all %}
                <div class="card">
                    <div class="card-header" id="referralHeading{{ visit.id }}" data-toggle="collapse" data-target="#referralCollapse{{ visit.id }}" aria-expanded="false" aria-controls="referralCollapse{{ visit.id }}">
                        <h6 class="mb-0">
                            <i class="fas fa-exchange-alt mr-2"></i>Referral Details
                        </h6>
                    </div>
                    <div id="referralCollapse{{ visit.id }}" class="collapse" aria-labelledby="referralHeading{{ visit.id }}" data-parent="#visitAccordion{{ visit.id }}">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="patient-prem-detail-table  text-nowrap">
                                    <thead>
                                        <tr>
                                            <th>Source Location</th>
                                            <th>Destination Location</th>
                                            <th>Nature of Referral</th>
                                            <th>Transport Model</th>
                                            <th>Notes</th>
                                            <th>Status</th>
                                            <th>Recorded By</th>
                                            <th>Created At</th>
                                            <th>Updated At</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for referral in visit.referral_set.all %}
                                        <tr>
                                            <td>{{ referral.source_location|default:"-" }}</td>
                                            <td>{{ referral.destination_location|default:"-" }}</td>
                                            <td>{{ referral.get_nature_of_referral_display|default:"-" }}</td>
                                            <td>{{ referral.get_transport_model_display|default:"-" }}</td>
                                            <td>{{ referral.notes|safe|default:"-" }}</td>
                                            <td>
                                                <span class="badge badge-{{ referral.get_status_color }}">
                                                {{ referral.get_status_display }}
                                                </span>
                                            </td>
                                            <td>{{ referral.data_recorder.get_full_name|default:"System" }}</td>
                                            <td>{{ referral.created_at|date:"d-m-Y" }}</td>
                                            <td>{{ referral.updated_at|date:"d-m-Y" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Discharge Section -->
                {% if visit.dischargesnotes_set.all %}
                <div class="card">
                    <div class="card-header" id="dischargeHeading{{ visit.id }}" data-toggle="collapse" data-target="#dischargeCollapse{{ visit.id }}" aria-expanded="false" aria-controls="dischargeCollapse{{ visit.id }}">
                        <h6 class="mb-0">
                            <i class="fas fa-sign-out-alt mr-2"></i>Discharge Notes
                        </h6>
                    </div>
                    <div id="dischargeCollapse{{ visit.id }}" class="collapse" aria-labelledby="dischargeHeading{{ visit.id }}" data-parent="#visitAccordion{{ visit.id }}">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="patient-prem-detail-table">
                                    <thead>
                                        <tr>
                                            <th>Discharge Condition</th>
                                            <th>Discharge Notes</th>
                                            <th>Recorded By</th>
                                            <th>Discharge Date</th>
                                            <th>Last Updated</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for discharge in visit.dischargesnotes_set.all %}
                                        <tr>
                                            <td>{{ discharge.discharge_condition|default:"-" }}</td>
                                            <td>{{ discharge.discharge_notes|safe|default:"-" }}</td>
                                            <td>{{ discharge.data_recorder.get_full_name|default:"System" }}</td>
                                            <td>{{ discharge.discharge_date|date:"d-m-Y" }}</td>
                                            <td>{{ discharge.updated_at|date:"d-m-Y" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endfor %}
{% endfor %}

<!-- Edit Patient Modal -->
{% for patient in patient_records %}
<div class="modal fade patient-prem-modal" id="editPatientModal{{ patient.id }}" tabindex="-1" role="dialog" aria-labelledby="editPatientModalLabel{{ patient.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content patient-prem-modal-content">
            <div class="modal-header patient-prem-modal-header">
                <h5 class="modal-title text-white" id="editPatientModalLabel{{ patient.id }}">EDIT PATIENT</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="edit_messageContainer{{ patient.id }}" class="text-center mt-2"></div>
                <form id="editPatientForm{{ patient.id }}" method="post">
                    {% csrf_token %}
                    <!-- Personal Information -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="edit_first_name{{ patient.id }}">First Name:</label> <span class="error">* </span>
                                <input type="text" class="form-control" id="edit_first_name{{ patient.id }}" name="edit_first_name" value="{{ patient.first_name }}" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="edit_middle_name{{ patient.id }}">Middle Name:</label> <span class="error">* </span>
                                <input type="text" class="form-control" id="edit_middle_name{{ patient.id }}" name="edit_middle_name" value="{{ patient.middle_name }}" required>
                                <input type="hidden" class="form-control" id="patient_id" name="patient_id" value="{{ patient.id }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="edit_last_name{{ patient.id }}">Last Name:</label> <span class="error">* </span>
                                <input type="text" class="form-control" id="edit_last_name{{ patient.id }}" name="edit_last_name" value="{{ patient.last_name }}" required>
                            </div>
                        </div>
                    </div>

                    <!-- Gender, Age, DOB -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="edit_gender{{ patient.id }}">Gender:</label> <span class="error">* </span>
                                <select class="form-control select2bs4"  style="width: 100%;"   id="edit_gender{{ patient.id }}" name="edit_gender" required>
                                    <option value="Male" {% if patient.gender == 'Male' %} selected {% endif %}>Male</option>
                                    <option value="Female" {% if patient.gender == 'Female' %} selected {% endif %}>Female</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="edit_age{{ patient.id }}">Age:</label>
                                <select class="form-control select2bs4"  style="width: 100%;"   id="edit_age{{ patient.id }}" name="edit_age" required>
                                    {% for age in range_121 %}
                                        <option value="{{ age }}" {% if patient.age == age %} selected {% endif %}>{{ age }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="edit_dob{{ patient.id }}">Date of Birth:</label>
                                <input type="date" class="form-control" id="edit_dob{{ patient.id }}" name="edit_dob" min="1922-01-01" max="2024-12-31" value="{{ patient.dob|date:'Y-m-d' }}">
                            </div>
                        </div>
                    </div>

                    <!-- Additional Information -->
                    <div class="row">
                        <div class="form-group col-sm-4">
                            <label for="edit_nida_number{{ patient.id }}" class="col-form-label">NIDA Number</label>
                            <input type="text" class="form-control" id="edit_nida_number{{ patient.id }}" name="edit_nida_number" value="{{ patient.nida_number|default:'' }}">
                        </div>
                        <div class="form-group col-sm-4">
                            <label for="edit_phone{{ patient.id }}" class="col-form-label">Phone Number</label>
                            <input type="tel" class="form-control" name="edit_phone" id="edit_phone{{ patient.id }}" value="{{ patient.phone }}" pattern="0\d{9}" title="Please enter a valid phone number starting with '0' and having 10 digits" maxlength="10" required>
                            <div class="invalid-feedback">Please enter a valid phone number starting with '0' and having 10 digits.</div>
                        </div>
                        <div class="form-group col-sm-4">
                            <label for="edit_Address{{ patient.id }}" class="col-form-label">Address</label>
                            <textarea id="edit_Address{{ patient.id }}" name="edit_Address" rows="2" class="form-control">{{ patient.address }}</textarea>
                        </div>
                    </div>

                    <!-- Nationality, Payment Type -->
                    <div class="row">
                        <div class="form-group col-sm-4">
                            <label for="edit_nationality{{ patient.id }}" class="col-form-label">Nationality</label>
                            <select class="form-control select2bs4"  style="width: 100%;"   name="edit_nationality" id="edit_nationality{{ patient.id }}" required>
                                {% for country in all_country %}
                                    <option value="{{ country.id }}" {% if patient.nationality == country.id %} selected {% endif %}>{{ country.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group col-sm-4">
                            <label for="edit_payment_type{{ patient.id }}" class="col-form-label">Payment Type</label>
                            <select class="form-control select2bs4"  style="width: 100%;"   name="edit_payment_type" id="edit_payment_type{{ patient.id }}">
                                <option value="Cash" {% if patient.payment_form == 'Cash' %} selected {% endif %}>Cash</option>
                                <option value="Insurance" {% if patient.payment_form == 'Insurance' %} selected {% endif %}>Insurance</option>
                            </select>
                        </div>
                        <div class="form-group col-sm-4" id="edit_insurance_name_container{{ patient.id }}" {% if patient.payment_form == 'Insurance' %} style="display: block;" {% else %} style="display: none;" {% endif %}>
                            <label for="insurance_name{{ patient.id }}" class="col-form-label">Insurance Name</label>
                            <select class="form-control select2bs4"  style="width: 100%;"   name="insurance_name" id="insurance_name{{ patient.id }}">
                                <option value="">Select Insurance Company</option>
                                <option value="NHIF" {% if patient.insurance_name == 'NHIF' %} selected {% endif %}>NHIF</option>
                                <option value="Jubilee" {% if patient.insurance_name == 'Jubilee' %} selected {% endif %}>Jubilee</option>
                                <option value="Strategis" {% if patient.insurance_name == 'Strategis' %} selected {% endif %}>Strategis</option>
                                <option value="Assemble" {% if patient.insurance_name == 'Assemble' %} selected {% endif %}>Assemble</option>
                                <option value="Britam" {% if patient.insurance_name == 'Britam' %} selected {% endif %}>Britam</option>
                                <option value="International Insurance" {% if patient.insurance_name == 'International Insurance' %} selected {% endif %}>International Insurance</option>
                                <option value="ISOS" {% if patient.insurance_name == 'ISOS' %} selected {% endif %}>ISOS</option>
                                <option value="Other" {% if patient.insurance_name == 'Other' %} selected {% endif %}>Other</option>
                            </select>
                        </div>
                        <div class="form-group col-sm-4" id="edit_insurance_details_container{{ patient.id }}" {% if patient.payment_form == 'Insurance' %} style="display: block;" {% else %} style="display: none;" {% endif %}>
                            <label for="edit_insurance_number{{ patient.id }}" class="col-form-label">Insurance Number</label>
                            <input type="text" class="form-control" name="edit_insurance_number" id="edit_insurance_number{{ patient.id }}" value="{{ patient.insurance_number }}">
                        </div>
                    </div>

                    <!-- Emergency Contact -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="edit_emergency_contact_name{{ patient.id }}">Emergency Contact Name:</label>
                                <input type="text" class="form-control" id="edit_emergency_contact_name{{ patient.id }}" name="edit_emergency_contact_name" value="{{ patient.emergency_contact_name }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="emergency_contact_relation{{ patient.id }}">Emergency Contact Relation:</label>
                                <select class="form-control select2bs4"  style="width: 100%;"   id="emergency_contact_relation{{ patient.id }}" name="emergency_contact_relation">
                                    <option value="">-- Select --</option>
                                    <option value="Spouse" {% if patient.emergency_contact_relation == 'Spouse' %} selected {% endif %}>Spouse</option>
                                    <option value="Friend" {% if patient.emergency_contact_relation == 'Friend' %} selected {% endif %}>Friend</option>
                                    <option value="Coworker" {% if patient.emergency_contact_relation == 'Coworker' %} selected {% endif %}>Coworker</option>
                                    <option value="Child" {% if patient.emergency_contact_relation == 'Child' %} selected {% endif %}>Child</option>
                                    <option value="Father" {% if patient.emergency_contact_relation == 'Father' %} selected {% endif %}>Father</option>
                                    <option value="Mother" {% if patient.emergency_contact_relation == 'Mother' %} selected {% endif %}>Mother</option>
                                    <option value="Brother" {% if patient.emergency_contact_relation == 'Brother' %} selected {% endif %}>Brother</option>
                                    <option value="Sister" {% if patient.emergency_contact_relation == 'Sister' %} selected {% endif %}>Sister</option>
                                    <option value="Relative" {% if patient.emergency_contact_relation == 'Relative' %} selected {% endif %}>Relative</option>
                                    <option value="Other" {% if patient.emergency_contact_relation == 'Other' %} selected {% endif %}>Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="edit_emergency_contact_phone{{ patient.id }}">Emergency Contact Phone:</label>
                                <input type="tel" class="form-control" id="edit_emergency_contact_phone{{ patient.id }}" name="edit_emergency_contact_phone" value="{{ patient.emergency_contact_phone }}" pattern="0\d{9}" maxlength="10">
                                <div class="invalid-feedback">Please enter a valid phone number starting with '0' and having 10 digits.</div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit -->
                    <div class="form-group">
                        <div class="row">
                            <div class="col-md-12">
                                <button type="button" class="btn btn-md btn-patient-prem btn-block" id="editPatient{{ patient.id }}">Save Changes</button>
                            </div>
                        </div>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Appointment Modal -->
{% for patient in patient_records %}
<div class="modal fade patient-prem-modal" id="consultationModal{{ patient.id }}" tabindex="-1" aria-labelledby="consultationModalLabel{{ patient.id }}" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content patient-prem-modal-content">

      <!-- Modal Header -->
      <div class="modal-header patient-prem-modal-header">
        <h5 class="modal-title text-white" id="consultationModalLabel{{ patient.id }}">Add Appointment</h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <form id="consultationForm{{ patient.id }}">
          {% csrf_token %}
          <input type="hidden" name="patient_id" id="patient_id{{ patient.id }}" value="{{ patient.id }}">

          <div class="row g-3">
            <div class="col-md-6">
              <label for="doctor{{ patient.id }}" class="form-label">Doctor</label>
              <select class="form-control select2bs4"  style="width: 100%;"   id="doctor{{ patient.id }}" name="doctor" required>
                <option value="">Select Doctor</option>
                {% for doctor in doctors %}
                <option value="{{ doctor.id }}">{{ doctor.admin.first_name }} {{ doctor.middle_name }} {{ doctor.admin.last_name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6">
              <label for="date_of_consultation{{ patient.id }}" class="form-label">Date of Consultation</label>
              <input type="date" class="form-control" id="date_of_consultation{{ patient.id }}" name="date_of_consultation" required>
            </div>

            <div class="col-md-6">
              <label for="start_time{{ patient.id }}" class="form-label">Start Time</label>
              <input type="time" class="form-control" id="start_time{{ patient.id }}" name="start_time" required>
            </div>

            <div class="col-md-6">
              <label for="end_time{{ patient.id }}" class="form-label">End Time</label>
              <input type="time" class="form-control" id="end_time{{ patient.id }}" name="end_time" required>
            </div>

            <div class="col-md-12 mb-2">
              <label for="description{{ patient.id }}" class="form-label">Description</label>
              <textarea class="form-control" id="description{{ patient.id }}" name="description" rows="3" placeholder="Enter description..." required></textarea>
            </div>

            <div class="col-md-12 mb-2">
              <div id="successMessageContainer{{ patient.id }}"></div>
            </div>

            <div class="col-md-12">
              <button type="button" class="btn btn-patient-prem w-100" onclick="addConsultation({{ patient.id }})">Create Appointment</button>
            </div>
          </div>
        </form>
      </div>

    </div>
  </div>
</div>

{% endfor %}

<!-- Patient Details Modal -->
{% for patient in patient_records %}
<div class="modal fade patient-prem-modal" id="patientDetailModal{{ patient.id }}" tabindex="-1" aria-labelledby="patientDetailModalLabel{{ patient.id }}" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
    <div class="modal-content patient-prem-modal-content">

      <!-- Modal Header -->
      <div class="modal-header patient-prem-modal-header">
        <h5 class="modal-title text-white" id="patientDetailModalLabel{{ patient.id }}">Patient Details</h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <div class="container-fluid">
          <div class="row g-4">

            <!-- Personal Information -->
            <div class="col-md-6">
              <div class="border p-3 rounded shadow-sm h-100">
                <h6 class="mb-3 text-primary">Personal Information</h6>
                <p><strong>MRN:</strong> {{ patient.mrn }}</p>
                <p><strong>Full Name:</strong> {{ patient.first_name }} {{ patient.middle_name }} {{ patient.last_name }}</p>
                <p><strong>Gender:</strong> {{ patient.gender }}</p>
                <p><strong>Age:</strong> {{ patient.age }}</p>
                <p><strong>Date of Birth:</strong> {{ patient.dob }}</p>
                <p><strong>Phone:</strong> {{ patient.phone }}</p>
                <p><strong>Address:</strong> {{ patient.address }}</p>
                <p><strong>Nationality:</strong> {{ patient.nationality.name }}</p>
                {% if patient.nida_number %}
                  <p><strong>NIDA Number:</strong> {{ patient.nida_number }}</p>
                {% endif %}
              </div>
            </div>

            <!-- Emergency and Payment Information -->
            <div class="col-md-6">
              <div class="border p-3 rounded shadow-sm h-100">
                <h6 class="mb-3 text-danger">Emergency Contact</h6>
                <p><strong>Name:</strong> {{ patient.emergency_contact_name }}</p>
                <p><strong>Relation:</strong> {{ patient.emergency_contact_relation }}</p>
                <p><strong>Phone:</strong> {{ patient.emergency_contact_phone }}</p>

                <hr>

                <h6 class="mb-3 text-success">Payment Information</h6>
                <p><strong>Payment Form:</strong> {{ patient.payment_form }}</p>
                {% if patient.payment_form == 'Insurance' %}
                  <p><strong>Insurance Name:</strong> {{ patient.insurance_name }}</p>
                  <p><strong>Insurance Number:</strong> {{ patient.insurance_number }}</p>
                {% endif %}
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer bg-light d-block">
        <div class="row">
          <div class="col-md-12 text-md-end">
            <p class="mb-1"><strong>Created At:</strong> {{ patient.created_at|date:"d M Y, H:i" }}</p>
            <p class="mb-1"><strong>Updated At:</strong> {{ patient.updated_at|date:"d M Y, H:i" }}</p>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>
{% endfor %}

{% include 'receptionist_template/datatable.html' %}
    
<script>
    // Initialize DataTable
    new DataTable('#patientTable', {
        dom: 'Bfrtip',
        buttons: ['excel', 'pdf', 'print'],
        responsive: true,
        pageLength: 10,
        order: [[7, 'desc']], // Order by the "Added At" column (index 7)
        language: {
            search: "_INPUT_",
            searchPlaceholder: "Search patients...",
            lengthMenu: "Show _MENU_ entries"
        }
    });

    // Calculate summary statistics
    function calculateSummaryStats() {
        let insuranceCount = 0;
        let cashCount = 0;
        let otherCount = 0;
        
        document.querySelectorAll('#patientTable tbody tr').forEach(row => {
            const status = row.getAttribute('data-status');
            
            // Count by payment form
            if (status === 'Insurance') {
                insuranceCount++;
            } else if (status === 'Cash') {
                cashCount++;
            } else {
                otherCount++;
            }
        });
        
        // Update summary cards
        document.getElementById('insurance-count').textContent = insuranceCount;
        document.getElementById('cash-count').textContent = cashCount;
    }
    
    // Initialize summary stats
    calculateSummaryStats();

    // Status filter functionality
    document.querySelectorAll('.patient-prem-status-btn').forEach(button => {
        button.addEventListener('click', function() {
            // Toggle active class
            document.querySelectorAll('.patient-prem-status-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            this.classList.add('active');
            
            const status = this.getAttribute('data-status');
            filterPatients(status);
        });
    });

    // Date range filter functionality
    document.getElementById('applyDateFilter').addEventListener('click', function() {
        const startDateInput = document.getElementById('startDate').value;
        const endDateInput = document.getElementById('endDate').value;
        
        // Parse dates with proper validation
        const startDate = startDateInput ? new Date(startDateInput) : null;
        const endDate = endDateInput ? new Date(endDateInput) : null;
        
        // Adjust end date to include the entire day
        if (endDate) {
            endDate.setHours(23, 59, 59, 999);
        }
        
        // Get active status filter
        const activeStatus = document.querySelector('.patient-prem-status-btn.active').getAttribute('data-status');
        
        filterPatientsByDateAndStatus(activeStatus, startDate, endDate);
    });

    // Filter patients by payment form, date range, and search text
    function filterPatientsByDateAndStatus(status, startDate, endDate, searchText = '') {
        const rows = document.querySelectorAll('#patientTable tbody tr');
        let visibleCount = 0;
        
        rows.forEach(row => {
            const rowStatus = row.getAttribute('data-status');
            const rowText = row.textContent.toLowerCase();
            const dateCell = row.cells[7]; // "Added At" column (index 7)
            const rowDate = new Date(dateCell.textContent.split('-').reverse().join('-')); // Convert dd-mm-yyyy to yyyy-mm-dd
            
            // Determine if row should be shown
            const statusMatch = status === 'all' || rowStatus === status;
            const dateMatch = (!startDate || rowDate >= startDate) && (!endDate || rowDate <= endDate);
            const searchMatch = !searchText || rowText.includes(searchText.toLowerCase());
            
            if (statusMatch && dateMatch && searchMatch) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Update total count
        document.getElementById('total-patients').textContent = visibleCount;
    }

    // Search functionality
    document.getElementById('patientPremSearch').addEventListener('keyup', function() {
        const searchText = this.value;
        const activeStatus = document.querySelector('.patient-prem-status-btn.active').getAttribute('data-status');
        const startDateInput = document.getElementById('startDate').value;
        const endDateInput = document.getElementById('endDate').value;
        
        const startDate = startDateInput ? new Date(startDateInput) : null;
        const endDate = endDateInput ? new Date(endDateInput) : null;
        
        if (endDate) {
            endDate.setHours(23, 59, 59, 999);
        }
        
        filterPatientsByDateAndStatus(activeStatus, startDate, endDate, searchText);
    });
    
    document.getElementById('searchButton').addEventListener('click', function() {
        const searchText = document.getElementById('patientPremSearch').value;
        const activeStatus = document.querySelector('.patient-prem-status-btn.active').getAttribute('data-status');
        const startDateInput = document.getElementById('startDate').value;
        const endDateInput = document.getElementById('endDate').value;
        
        const startDate = startDateInput ? new Date(startDateInput) : null;
        const endDate = endDateInput ? new Date(endDateInput) : null;
        
        if (endDate) {
            endDate.setHours(23, 59, 59, 999);
        }
        
        filterPatientsByDateAndStatus(activeStatus, startDate, endDate, searchText);
    });

    // Clear date filter functionality
    document.getElementById('clearDateFilter').addEventListener('click', function() {
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        
        const activeStatus = document.querySelector('.patient-prem-status-btn.active').getAttribute('data-status');
        const searchText = document.getElementById('patientPremSearch').value;
        
        filterPatientsByDateAndStatus(activeStatus, null, null, searchText);
    });

    // Set default date range to last 30 days
    window.addEventListener('load', function() {
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 30);
        
        document.getElementById('startDate').valueAsDate = startDate;
        document.getElementById('endDate').valueAsDate = endDate;
        
        // Apply the default filter
        document.getElementById('applyDateFilter').click();
    });
</script>
{% endblock main_content %}

{% block customer_js %}
<!-- Edit Patient Modal -->
{% for patient in patient_records %}

<script>
  function addConsultation(patientId) {
    const doctor = $('#doctor' + patientId).val();
    const patient_id = $('#patient_id' + patientId).val();
    const date_of_consultation = $('#date_of_consultation' + patientId).val();
    const start_time = $('#start_time' + patientId).val();
    const end_time = $('#end_time' + patientId).val();
    const description = $('#description' + patientId).val();
    const csrf_token = $('[name=csrfmiddlewaretoken]').val();

    const container = '#successMessageContainer' + patientId;
    $(container).html(''); // Clear previous messages

    // --- Validation ---
    if (!doctor || !patient_id || !date_of_consultation || !start_time || !end_time) {
      $(container).html('<div class="alert alert-danger">Please fill in all required fields.</div>');
      return;
    }

    // Check that appointment date is today or later
    const today = new Date().setHours(0, 0, 0, 0);
    const selectedDate = new Date(date_of_consultation).setHours(0, 0, 0, 0);
    if (selectedDate < today) {
      $(container).html('<div class="alert alert-danger">Appointment date must be today or in the future.</div>');
      return;
    }

    // Check that start time is before end time
    const start = new Date(`1970-01-01T${start_time}:00`);
    const end = new Date(`1970-01-01T${end_time}:00`);
    if (start >= end) {
      $(container).html('<div class="alert alert-danger">Start time must be before end time.</div>');
      return;
    }

    // --- Send AJAX POST ---
    const data = {
      doctor,
      patient_id,
      date_of_consultation,
      start_time,
      end_time,
      description,
      csrfmiddlewaretoken: csrf_token
    };

    $.post("{% url 'receptionist_appointment_view' %}", data)
      .done(function(response) {
        if (response.status === 'success') {
          $(container).html('<div class="alert alert-success">' + response.message + '</div>');
          setTimeout(() => location.reload(true), 1500);
        } else {
          $(container).html('<div class="alert alert-danger">' + response.message + '</div>');
        }
      })
      .fail(function(xhr) {
        $(container).html('<div class="alert alert-danger">Failed to create appointment. Try again.</div>');
      });
  }
</script>
<script>
    $(document).ready(function () {
        $('#editPatient{{ patient.id }}').click(function (event) {
            var form = document.getElementById('editPatientForm{{ patient.id }}');
            if (form.checkValidity() === false) {
                event.preventDefault();
                event.stopPropagation();
            } else {
                var formData = $('#editPatientForm{{ patient.id }}').serialize();

                $.ajax({
                    url: '{% url "receptionist_save_edited_patient" %}', // Update with your actual URL
                    type: 'POST',
                    data: formData,
                    success: function (response) {
                        if (response.success) {
                            $('#edit_messageContainer{{ patient.id }}').html('<div class="alert alert-success">' + response.message + '</div>');
                            location.reload(true);
                        } else {
                            $('#edit_messageContainer{{ patient.id }}').html('<div class="alert alert-danger">' + response.message + '</div>');
                        }
                    },
                    error: function () {
                        console.error('AJAX request failed');
                        $('#edit_messageContainer{{ patient.id }}').html('<div class="alert alert-danger">AJAX request failed</div>');
                    }
                });
            }

            form.classList.add('was-validated');
        });
    });
</script>    
<script>
    $(document).ready(function () {
        // Set max date only for the DOB input with specific ID
        const today = new Date().toISOString().split('T')[0];
        const dobInput = $('#edit_dob{{ patient.id }}');
        dobInput.attr('max', today);

        // Function to calculate age from DOB
        function calculateAge(dob) {
            const today = new Date();
            const birthDate = new Date(dob);
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            const dayDiff = today.getDate() - birthDate.getDate();

            if (monthDiff < 0 || (monthDiff === 0 && dayDiff < 0)) {
                age--;
            }
            return age;
        }

        // Function to calculate DOB from age
        function calculateDOB(age) {
            const today = new Date();
            const birthYear = today.getFullYear() - age;
            const birthDate = new Date(birthYear, 6, 1); // July 1st as approx. DOB
            const year = birthDate.getFullYear();
            const month = String(birthDate.getMonth() + 1).padStart(2, '0');
            const day = String(birthDate.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Update age when DOB changes
        dobInput.on('change', function () {
            const dob = $(this).val();
            const age = calculateAge(dob);
            const ageId = $(this).attr('id').replace('dob', 'age');
            $('#' + ageId).val(age).trigger('change');
        });

        // Update DOB when age changes
        $('select[name="edit_age"]').on('change', function () {
            const age = $(this).val();
            const dobId = $(this).attr('id').replace('age', 'dob');
            const dob = calculateDOB(age);
            $('#' + dobId).val(dob);
        });
    });
</script>


<script>
    $(document).ready(function(){
                                // Inside the $(document).ready() function
    $('#edit_payment_type{{ patient.id }}').change(function () {
        var paymentType = $(this).val();
        if (paymentType === 'Insurance') {
            $('#edit_insurance_name_container{{ patient.id }}').show();
            $('#edit_insurance_details_container{{ patient.id }}').show();
         
        } else {
            $('#edit_insurance_name_container{{ patient.id }}').hide();
            $('#edit_insurance_details_container{{ patient.id }}').hide();
         
        }
    });
    })
</script>
{% endfor %}
<!-- JavaScript -->
<script>
    $(document).ready(function () {
    const today = new Date().toISOString().split('T')[0];
    $('#dob').attr('max', today);

    function calculateAge(dob) {
        const today = new Date();
        const birthDate = new Date(dob);
        let age = today.getFullYear() - birthDate.getFullYear();
        const m = today.getMonth() - birthDate.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
        age--;
        }
        return age;
    }

    function calculateDOB(age) {
        const today = new Date();
        const birthYear = today.getFullYear() - age;
        const birthDate = new Date(birthYear, 6, 1);
        return `${birthDate.getFullYear()}-${String(birthDate.getMonth() + 1).padStart(2, '0')}-${String(birthDate.getDate()).padStart(2, '0')}`;
    }

    $('#dob').on('change', function () {
        const dob = $(this).val();
        const age = calculateAge(dob);
        $('#age').val(age).trigger('change');
    });

    $('#age').on('change', function () {
        const age = $(this).val();
        const dob = calculateDOB(age);
        $('#dob').val(dob);
    });

    $('#payment_type').change(function () {
        const type = $(this).val();
        if (type === 'Insurance') {
        $('#insurance_name_container, #insurance_details_container').show();
        } else {
        $('#insurance_name_container, #insurance_details_container').hide();
        }
    });

    $('#addPatient').click(function (event) {
        const form = document.getElementById('patientForm');
        if (form.checkValidity() === false) {
        event.preventDefault();
        event.stopPropagation();
        } else {
        const formData = $('#patientForm').serialize();
        $.ajax({
            url: '{% url "receptionist_add_patient" %}',
            type: 'POST',
            data: formData,
            success: function (response) {
            if (response.success) {
                $('#patientmessageContainer').html('<div class="alert alert-success">' + response.message + '</div>');
                 window.location.href = "{% url 'receptionist_patient_visit_history_view' 0 %}".replace("0", response.patient_id);
            } else {
                $('#patientmessageContainer').html('<div class="alert alert-danger">' + response.message + '</div>');
            }
            },
            error: function () {
            $('#patientmessageContainer').html('<div class="alert alert-danger">AJAX request failed</div>');
            }
        });
        }
        form.classList.add('was-validated');
    });
    });
</script>
{% endblock customer_js %}