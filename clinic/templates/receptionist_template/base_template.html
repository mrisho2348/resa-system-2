<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="icon" type="image/png" href="{% static 'img/resalogo_square.png' %}">
  <title>{% block title %}RESA | Dashboard{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="{% static 'plugins/fontawesome-free/css/all.min.css' %}">
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <!-- Select2 -->
  <link href="{% static 'plugins/select2/css/select2.min.css' %}" rel="stylesheet" />
  <link rel="stylesheet" href="{% static 'plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css' %}">
  <!-- Tempusdominus Bootstrap 4 -->
  <link rel="stylesheet" href="{% static 'plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css' %}">
  <!-- iCheck -->
  <link rel="stylesheet" href="{% static 'plugins/icheck-bootstrap/icheck-bootstrap.min.css' %}">
  <!-- JQVMap -->
  <link rel="stylesheet" href="{% static 'plugins/jqvmap/jqvmap.min.css' %}">
  <!-- AdminLTE App -->
  <link href="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap-switch-button@1.1.0/css/bootstrap-switch-button.min.css" rel="stylesheet">
  <!-- Theme style -->
  <link rel="stylesheet" href="{% static 'dist/css/adminlte.min.css' %}">
  <!-- overlayScrollbars -->
  <link rel="stylesheet" href="{% static 'plugins/overlayScrollbars/css/OverlayScrollbars.min.css' %}">
  <!-- Daterange picker -->
  <link rel="stylesheet" href="{% static 'plugins/daterangepicker/daterangepicker.css' %}">
  <!-- Summernote -->
  <link rel="stylesheet" href="{% static 'plugins/summernote/summernote-bs4.css' %}">
  <!-- DataTables -->
  <link rel="stylesheet" href="{% static 'assets/DataTables/datatables.min.css' %}">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
  <!-- Google Font: Source Sans Pro -->
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

  {% block customer_css %}{% endblock %}
  
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">

  <!-- Top Bar -->
  {% include "receptionist_template/topbar.html" %}
  
  <!-- Sidebar -->
  {% include "receptionist_template/sidebar_template.html" %}

  <!-- Content Wrapper -->
  <div class="content-wrapper">
    <!-- Content Header -->
    <div class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 class="page-title">{% block page_title %}{% endblock %}</h1>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item">
                {% block breadcrumb %}{% endblock %}
              </li>
            </ol>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Main Content -->
    <section class="content">
      <div class="container-fluid">
        {% block main_content %}{% endblock %}
      </div>
    </section>
  </div>

  <!-- Footer -->
  {% include "receptionist_template/footer.html" %}
</div>

<!-- JavaScript Libraries - Consolidated and in correct order -->
<script src="{% static 'plugins/jquery/jquery.min.js' %}"></script>
<script src="{% static 'plugins/jquery-ui/jquery-ui.min.js' %}"></script>
<script>
  $.widget.bridge('uibutton', $.ui.button);
</script>
<script src="{% static 'plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'plugins/select2/js/select2.full.min.js' %}"></script>
<script src="{% static 'plugins/chart.js/Chart.min.js' %}"></script>
<script src="{% static 'plugins/sparklines/sparkline.js' %}"></script>
<script src="{% static 'plugins/jqvmap/jquery.vmap.min.js' %}"></script>
<script src="{% static 'plugins/jqvmap/maps/jquery.vmap.usa.js' %}"></script>
<script src="{% static 'plugins/jquery-knob/jquery.knob.min.js' %}"></script>
<script src="{% static 'plugins/moment/moment.min.js' %}"></script>
<script src="{% static 'plugins/daterangepicker/daterangepicker.js' %}"></script>
<script src="{% static 'plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js' %}"></script>
<script src="{% static 'plugins/summernote/summernote-bs4.min.js' %}"></script>
<script src="{% static 'plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js' %}"></script>
<script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap-switch-button@1.1.0/dist/bootstrap-switch-button.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.4/jspdf.debug.js"></script>

<!-- DataTables JS -->
<script src="{% static 'datatables/js/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'datatables/js/dataTables.bootstrap5.min.js' %}"></script>
<script src="{% static 'datatables/js/dataTables.buttons.min.js' %}"></script>
<script src="{% static 'datatables/js/jszip.min.js' %}"></script>
<script src="{% static 'datatables/js/pdfmake.min.js' %}"></script>
<script src="{% static 'datatables/js/vfs_fonts.js' %}"></script>
<script src="{% static 'datatables/js/buttons.html5.min.js' %}"></script>
<script src="{% static 'datatables/js/buttons.print.min.js' %}"></script>

<!-- AdminLTE App -->
<script src="{% static 'dist/js/adminlte.js' %}"></script>
<script src="{% static 'dist/js/pages/dashboard.js' %}"></script>
<script src="{% static 'dist/js/demo.js' %}"></script>

<!-- Premium Custom Script -->
<script>
  $(function () {
    // Initialize Select2
    $('.select2').select2()
    $('.select2bs4').select2({ theme: 'bootstrap4' })
    
    // Initialize tooltips
    $('[data-toggle="tooltip"]').tooltip()
    
    // Initialize notifications dropdown
    $('.notification-toggle').on('click', function() {
      $('.notification-menu').toggleClass('show');
    });
    
    // Notification badge update
    $('.notification-item').on('click', function() {
      let badge = $('.notification-badge');
      let count = parseInt(badge.text());
      if (count > 0) {
        badge.text(count - 1);
        if (count === 1) {
          badge.hide();
        }
      }
    });
    
    // Dark mode toggle
    $('#darkModeToggle').on('change', function() {
      $('body').toggleClass('dark-mode');
      localStorage.setItem('darkMode', $(this).prop('checked'));
    });
    
    // Check for saved dark mode preference
    if (localStorage.getItem('darkMode') === 'true') {
      $('body').addClass('dark-mode');
      $('#darkModeToggle').prop('checked', true);
    }
    
    // Initialize DataTables with proper error handling
    function initDataTable(selector, options) {
      if ($.fn.DataTable) {
        if ($(selector).length) {
          return new DataTable(selector, options);
        }
      } else {
        console.error('DataTables is not loaded');
      }
      return null;
    }
    
    // Initialize all DataTables
    initDataTable('#example', { dom: 'Bfrtip', buttons: [''] });
    initDataTable('#example1', { dom: 'Bfrtip', buttons: [''] });
    initDataTable('#example2', { dom: 'Bfrtip', buttons: [''] });
    initDataTable('#example3', { dom: 'Bfrtip', buttons: [''] });
    initDataTable('#example4', { dom: 'Bfrtip', buttons: [''] });
    initDataTable('#example5', { dom: 'Bfrtip', buttons: [''] });
    initDataTable('#example6', { dom: 'Bfrtip', buttons: [''] });
  });
</script>
<script>
  // Initialize the calendar
  function initReceptionCalendar() {
    const now = new Date();
    const monthNames = ["January", "February", "March", "April", "May", "June",
      "July", "August", "September", "October", "November", "December"
    ];
    const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    
    document.getElementById('reception-calendar-month').textContent = monthNames[now.getMonth()];
    document.getElementById('reception-calendar-year').textContent = now.getFullYear();
    document.getElementById('reception-calendar-date').textContent = now.getDate();
    document.getElementById('reception-calendar-day').textContent = dayNames[now.getDay()];
  }
  
  // Function to update reception stats
  function updateReceptionStats() {
    // Update appointment and patient counts
    fetchReceptionCounts();
  }
  
// Function to fetch reception counts
function fetchReceptionCounts() {
    $.ajax({
        url: "{% url 'reception_dashboard_counts' %}",
        type: 'GET',
        success: function(response) {
            if (response.success) {
                // Update all counts with real data
                $('#reception-appointments-count').text(response.today_appointments_count);
                $('#reception-patients-count').text(response.new_patients_count);
                $('#reception-patient-count').text(response.total_patients_count);
                $('#reception-appointment-badge').text(response.pending_appointments_count);
                $('#reception-billing-badge').text(response.pending_billing_count);
                
                // Update total patient badge
                $('#reception-patient-badge').text(response.pending_appointments_count);
            } else {
                console.error('Failed to fetch counts:', response.error);
                // Set fallback values
                setFallbackCounts();
            }
        },
        error: function(xhr, status, error) {
            console.error('Error fetching counts:', error);
            // Set fallback values
            setFallbackCounts();
        }
    });
}

// Fallback function in case the API fails
function setFallbackCounts() {
    $('#reception-appointments-count').text('0');
    $('#reception-patients-count').text('0');
    $('#reception-patient-count').text('0');
    $('#reception-appointment-badge').text('0');
    $('#reception-billing-badge').text('0');
    $('#reception-patient-badge').text('0');
}
  
  // Initialize on page load
  $(document).ready(function() {   
    initReceptionCalendar();
    updateReceptionStats();
    
    // Update stats every minute
    setInterval(updateReceptionStats, 60000);
    
    // Add sidebar toggle animation
    $('.reception-nav-link > .fas.fa-angle-left').parent().on('click', function() {
      $(this).find('.fa-angle-left').toggleClass('fa-rotate-90');
    });
  });
</script>


<script>

  
  // Initialize tooltips
  $(function () {
    $('[data-toggle="tooltip"]').tooltip();
  });
  

  
 // Function to fetch reception statistics
function fetchReceptionStats() {
    $.ajax({
        url: "{% url 'receptionist_dashboard_data' %}",
        type: 'GET',
        success: function(data) {
            if (data.success) {
                // Update the main stats
                document.getElementById('todays-appointments-count').textContent = data.todays_appointments_count;
                document.getElementById('new-patients-count').textContent = data.new_patients_count;
                document.getElementById('pending-bills-count').textContent = data.pending_bills_count;
                
                // Update the quick links counts
                document.getElementById('quick-links-appointments-count').textContent = data.todays_appointments_count;
                document.getElementById('quick-links-new-patients-count').textContent = data.new_patients_count;
                document.getElementById('quick-links-pending-bills-count').textContent = data.pending_bills_count;
                
                // Update notification count
                document.getElementById('notification-count').textContent = data.notification_count;
                document.getElementById('notification-header').textContent = `${data.notification_count} Notifications`;
            } else {
                console.error('Failed to fetch reception stats:', data.error);
            }
        },
        error: function(xhr, status, error) {
            console.error('AJAX error fetching reception stats:', error);
        }
    });
}

// Load notifications dynamically
function loadNotifications() {
    $.ajax({
        url: "{% url 'receptionist_dashboard_data' %}",
        type: 'GET',
        success: function(data) {
            let notificationsHTML = '';
            
            if (data.success && data.notifications && data.notifications.length > 0) {
                data.notifications.forEach(notif => {
                    notificationsHTML += `
                        <a href="${notif.link || '#'}" class="dropdown-item notification-item">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <i class="${notif.icon || 'fas fa-bell'} ${notif.icon_color || 'text-primary'} mr-2"></i> 
                                    ${notif.title}
                                </div>
                                <div class="notification-time">${notif.time_ago}</div>
                            </div>
                            <small class="text-muted">${notif.details}</small>
                        </a>
                        <div class="dropdown-divider"></div>
                    `;
                });
            } else {
                notificationsHTML = `
                    <div class="text-center py-3">
                        <i class="fas fa-bell-slash text-muted fa-2x mb-2"></i>
                        <p class="text-muted">No notifications</p>
                    </div>
                `;
            }
            
            document.getElementById('notifications-container').innerHTML = notificationsHTML;
        },
        error: function(xhr, status, error) {
            console.error('AJAX error loading notifications:', error);
            document.getElementById('notifications-container').innerHTML = `
                <div class="text-center py-3">
                    <i class="fas fa-exclamation-triangle text-danger fa-2x mb-2"></i>
                    <p class="text-danger">Error loading notifications</p>
                </div>
            `;
        }
    });
}

// Update date and time in real-time
function updateDateTime() {
    const now = new Date();
    
    // Format date
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const formattedDate = now.toLocaleDateString('en-US', options);
    
    // Format time
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().toString().padStart(2, '0');
    const seconds = now.getSeconds().toString().padStart(2, '0');
    const formattedTime = `${hours}:${minutes}:${seconds}`;
    
    // Update elements
    document.getElementById('current-date').textContent = formattedDate;
    document.getElementById('current-time').textContent = formattedTime;
}

// Fullscreen toggle function
function toggleFullScreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
            console.error(`Error attempting to enable fullscreen: ${err.message}`);
        });
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        }
    }
}

// Initialize on page load
$(document).ready(function() {   
    updateDateTime();
    setInterval(updateDateTime, 1000);
    
    fetchReceptionStats();
    loadNotifications();
    
    // Update stats every minute
    setInterval(fetchReceptionStats, 60000);
    
    // Update notifications every 2 minutes
    setInterval(loadNotifications, 120000);
}); 
</script>
{% block customer_js %}{% endblock %}
</body>
</html>