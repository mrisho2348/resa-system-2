{% load static %}
<aside class="main-sidebar sidebar-dark-primary elevation-4">
  <!-- Brand Logo -->
  <a href="#" class="brand-link bg-gradient-primary">
    <div class="brand-container d-flex align-items-center">
      <div class="brand-logo-container">
        <img src="{% static 'img/resalogo_square.png' %}" 
             alt="RESA LOGO" 
             class="img-circle shadow-lg"
             style="
               width: 50px; 
               height: 50px; 
               object-fit: cover; 
               border-radius: 50%; 
               border: 3px solid #ffffff;
               background-color: #ffffff;
             ">
      </div>
      <div class="brand-text-container ml-2">
        <span class="brand-text font-weight-bold">PEMBA CLINIC</span>
        <div class="brand-subtext text-xs">Healthcare Management System</div>
      </div>
    </div>
  </a>

  <!-- Sidebar -->
  <div class="sidebar"> 
    <!-- Sidebar user panel -->
    <div class="user-panel mt-3 pb-3 mb-3 d-flex">
      {% if user.staff.id %}
        <div class="image">
          {% if user.staff.profile_picture %}
            <img src="{{ user.staff.profile_picture.url }}" class="img-circle elevation-2" alt="User Image">
          {% else %}
            <img src="{% static 'dist/img/user2-160x160.jpg' %}" class="img-circle elevation-2" alt="User Image">
          {% endif %}
        </div>
        <div class="info">
          {% url 'pemba_admin_edit_staff_profile' user.staff.id as edit_staff_profile %}
          <a href="{{ edit_staff_profile }}" class="d-block font-weight-bold">{{ user.username }}</a>
          <div class="user-status text-success">
            <i class="fas fa-circle"></i> Online
          </div>
          <div class="user-role text-xs">{{ user.staff.get_role_display|default:"Staff" }}</div>
        </div>   
      {% else %}
        <div class="image">           
          <img src="{% static 'dist/img/user2-160x160.jpg' %}" class="img-circle elevation-2" alt="User Image">          
        </div>
        <div class="info">
          <span class="d-block text-white font-weight-bold">{{ user.username }}</span>
          <div class="user-status text-success">
            <i class="fas fa-circle"></i> Online
          </div>
          <div class="user-role text-xs">User</div>
        </div>
      {% endif %}
    </div>   

    
    <!-- Sidebar Menu -->
    <nav class="mt-2">
      <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
        <!-- Dashboard Section -->
        <li class="nav-header text-uppercase text-xs text-muted mb-1">Dashboard</li>
        <li class="nav-item">
          {% url 'pemba_admin_dashboard' as dashboard_url %}
          <a href="{{ dashboard_url }}" class="nav-link {% if request.path == dashboard_url %} active {% endif %}">
            <i class="nav-icon fas fa-home"></i>
            <p>Dashboard</p>
          </a>
        </li>              

        <!-- Clinic Management Section -->
        <li class="nav-header text-uppercase text-xs text-muted mb-1 mt-3">Clinic Management</li>
        <li class="nav-item has-treeview">
          <a href="#" class="nav-link">
            <i class="nav-icon fas fa-hospital text-primary"></i>
            <p>Clinic Operations</p>
            <i class="fas fa-angle-left right"></i>
          </a>
          <ul class="nav nav-treeview">
            <li class="nav-item">
              {% url 'pemba_admin_patient_list' as patients_list_url %}
              <a href="{{ patients_list_url }}" class="nav-link{% if request.path == patients_list_url %} active {% endif %}">
                <i class="nav-icon fas fa-user-injured"></i>
                <p>Patient Management</p>
              </a>
            </li>
            <li class="nav-item">
              {% url 'pemba_admin_manage_appointment' as appointment_list_url %}
              <a href="{{ appointment_list_url }}" class="nav-link{% if request.path == appointment_list_url %} active {% endif %}">
                <i class="nav-icon fas fa-calendar-check"></i>
                <p>Appointments</p>
              </a>
            </li>
            <li class="nav-item">
              {% url 'pemba_admin_manage_referral' as manage_referral_url %}
              <a href="{{ manage_referral_url }}" class="nav-link{% if request.path == manage_referral_url %} active {% endif %}">
                <i class="nav-icon fas fa-hand-holding-medical"></i>
                <p>Referral System</p>
              </a>
            </li>
            <li class="nav-item">
              {% url 'pemba_admin_manage_counselling' as counseling_list_url %}
              <a href="{{ counseling_list_url }}" class="nav-link{% if request.path == counseling_list_url %} active {% endif %}">
                <i class="nav-icon fas fa-comments"></i>
                <p>Counseling</p>
              </a>
            </li>
            <li class="nav-item">
              {% url 'pemba_admin_manage_discharge' as discharge_notes_list_url %}
              <a href="{{ discharge_notes_list_url }}" class="nav-link{% if request.path == discharge_notes_list_url %} active {% endif %}">
                <i class="nav-icon fas fa-file-medical-alt"></i>
                <p>Discharge Notes</p>
              </a>
            </li>
            <li class="nav-item">
              {% url 'pemba_admin_manage_observation_record' as observation_record_list_url %}
              <a href="{{ observation_record_list_url }}" class="nav-link{% if request.path == observation_record_list_url %} active {% endif %}">
                <i class="nav-icon fas fa-stethoscope"></i>
                <p>Observation Records</p>
              </a>
            </li>
            <li class="nav-item">
              {% url 'pemba_admin_generate_year_month_report' as generate_year_month_report_url %}
              <a href="{{ generate_year_month_report_url }}" class="nav-link{% if request.path == generate_year_month_report_url %} active {% endif %}">
                <i class="nav-icon fas fa-chart-bar"></i>
                <p>Reports & Analytics</p>
              </a>
            </li>
            <li class="nav-item">
              {% url 'pemba_admin_resa_report' as resa_report_url %}
              <a href="{{ resa_report_url }}" class="nav-link{% if request.path == resa_report_url %} active {% endif %}">
                <i class="nav-icon fas fa-file-alt"></i>
                <p>Resa Reports</p>
              </a>
            </li>
          </ul>
        </li>

        <!-- Pharmacy Section -->
        <li class="nav-header text-uppercase text-xs text-muted mb-1 mt-3">Pharmacy</li>
        <li class="nav-item has-treeview">
          <a href="#" class="nav-link">
            <i class="nav-icon fas fa-pills text-success"></i>
            <p>Medicine Management</p>
            <i class="fas fa-angle-left right"></i>
          </a>
          <ul class="nav nav-treeview">
            <li class="nav-item">
              {% url 'pemba_admin_pembamedicine_list' as remotemedicine_list_url %}
              <a href="{{ remotemedicine_list_url }}" class="nav-link{% if request.path == remotemedicine_list_url %} active {% endif %}">                           
                <i class="nav-icon fas fa-capsules"></i>
                <p>All Medicines</p>
                <span class="badge badge-primary float-right" id="kahama-badge-all">0</span>
              </a>
            </li>
            <li class="nav-item">
              {% url 'pemba_admin_instock_medicine' as in_stock_medicines_url %}
              <a href="{{ in_stock_medicines_url }}" class="nav-link{% if request.path == in_stock_medicines_url %} active {% endif %}">
                <i class="nav-icon fas fa-check-circle text-success"></i>
                <p>In Stock Medicine</p> 
                <span class="badge badge-success float-right" id="kahama-badge-instock">0</span>
              </a>
            </li>
            <li class="nav-item">
              {% url 'pemba_admin_outofstock_medicine' as out_of_stock_medicines_url %}
              <a href="{{ out_of_stock_medicines_url }}" class="nav-link{% if request.path == out_of_stock_medicines_url %} active {% endif %}">
                <i class="nav-icon fas fa-exclamation-triangle text-warning"></i> 
                <p>Out of Stock</p>
                <span class="badge badge-warning float-right" id="kahama-badge-outofstock">0</span>
              </a>
            </li>
            <li class="nav-item">
              {% url 'pemba_admin_expired_medicine' as expired_medicine_url %}
              <a href="{{ expired_medicine_url }}" class="nav-link{% if request.path == expired_medicine_url %} active {% endif %}">
                <i class="nav-icon fas fa-calendar-times text-danger"></i> 
                <p>Expired Medicine</p>
                <span class="badge badge-danger float-right" id="kahama-badge-expired">0</span>
              </a>
            </li>
            <li class="nav-item">
              {% url 'pemba_admin_checklist_medicine' as checklist_medicine_url %}
              <a href="{{ checklist_medicine_url }}" class="nav-link{% if request.path == checklist_medicine_url %} active {% endif %}">
                <i class="nav-icon fas fa-list text-info"></i> 
                <p>Checklist Medicine</p>
                <span class="badge badge-info float-right" id="kahama-badge-checklist">0</span>
              </a>
            </li>
          </ul>
        </li>

        <!-- Clinical Services Section -->
        <li class="nav-header text-uppercase text-xs text-muted mb-1 mt-3">Clinical Services</li>
        <li class="nav-item has-treeview">
          <a href="#" class="nav-link">
            <i class="nav-icon fas fa-user-md text-info"></i>
            <p>Clinical Services</p>
            <i class="fas fa-angle-left right"></i>
          </a>
          <ul class="nav nav-treeview">
            <li class="nav-item">
              {% url 'pemba_admin_manage_prescription_list' as prescription_list_url %}
              <a href="{{ prescription_list_url }}" class="nav-link{% if request.path == prescription_list_url %} active {% endif %}">
                <i class="nav-icon fas fa-prescription-bottle-alt"></i>
                <p>Prescriptions</p>
                <span id="kahama-unread-prescription-badge" class="badge badge-danger float-right">0</span>
              </a>
            </li>
            <li class="nav-item">
              {% url 'pemba_admin_manage_consultation_notes' as consultation_notes_url %}
              <a href="{{ consultation_notes_url }}" class="nav-link{% if request.path == consultation_notes_url %} active {% endif %}">
                <i class="nav-icon fas fa-file-medical"></i>
                <p>Consultation Notes</p>
                <span id="kahama-unread-consultation-badge" class="badge badge-danger float-right">0</span>
              </a>
            </li>
            <li class="nav-item">
              {% url 'pemba_admin_patient_laboratory_view' as patient_laboratory_view_url %}
              <a href="{{ patient_laboratory_view_url }}" class="nav-link{% if request.path == patient_laboratory_view_url %} active {% endif %}">
                <i class="nav-icon fas fa-flask"></i>
                <p>Laboratory</p>
                <span id="kahama-unread-laboratory-badge" class="badge badge-danger float-right">0</span>
              </a>
            </li>
            <li class="nav-item">
              {% url 'pemba_admin_manage_procedure' as patient_procedure_view_url %}
              <a href="{{ patient_procedure_view_url }}" class="nav-link{% if request.path == patient_procedure_view_url %} active {% endif %}">
                <i class="nav-icon fas fa-procedures"></i>
                <p>Medical Procedures</p>
                <span id="kahama-unread-procedure-badge" class="badge badge-danger float-right">0</span>
              </a>
            </li>      
          </ul>
        </li>

        <!-- Clinic Inventory Section -->
        <li class="nav-header text-uppercase text-xs text-muted mb-1 mt-3">Clinic Inventory</li>
        <li class="nav-item has-treeview">
          <a href="#" class="nav-link">
            <i class="nav-icon fas fa-tools text-warning"></i>
            <p>Inventory Management</p>
            <i class="fas fa-angle-left right"></i>
          </a>
          <ul class="nav nav-treeview">
            <li class="nav-item">
              {% url 'pemba_admin_pemba_equipment_list' as remote_equipment_list_url %}
              <a href="{{ remote_equipment_list_url }}" class="nav-link{% if request.path == remote_equipment_list_url %} active {% endif %}">
                <i class="nav-icon fas fa-medkit"></i>
                <p>Clinic Equipment</p>
              </a>
            </li>
            <li class="nav-item">
              {% url 'pemba_admin_pemba_reagent_list' as reagent_list_url %}
              <a href="{{ reagent_list_url }}" class="nav-link{% if request.path == reagent_list_url %} active {% endif %}">
                <i class="nav-icon fas fa-flask"></i>
                <p>Clinic Reagents</p>
                <span id="kahama-notification-count-reagent" class="badge badge-danger float-right"></span>
              </a>
            </li>
          </ul>
        </li>

        <!-- System Settings Section -->
        <li class="nav-header text-uppercase text-xs text-muted mb-1 mt-3">System Configuration</li>
        <li class="nav-item has-treeview">
          <a href="#" class="nav-link">
            <i class="nav-icon fas fa-cog text-danger"></i>
            <p>System Settings</p>
            <i class="fas fa-angle-left right"></i>
          </a>
          <ul class="nav nav-treeview">          
            <li class="nav-item">
              {% url 'pemba_admin_manage_staff' as manage_staff_url %}
              <a href="{{ manage_staff_url }}" class="nav-link{% if request.path == manage_staff_url %} active {% endif %}">
                <i class="nav-icon fas fa-user-md"></i>
                <p>Staff Management</p>
              </a>
            </li>
            <li class="nav-item">
              {% url 'pemba_admin_manage_company' as manage_company_url %}
              <a href="{{ manage_company_url }}" class="nav-link{% if request.path == manage_company_url %} active {% endif %}">
                <i class="nav-icon fas fa-building"></i>
                <p>Patient Companies</p>
              </a>
            </li>
            <li class="nav-item">
              {% url 'pemba_admin_manage_diagnosis_list' as diagnosis_list_url %}
              <a href="{{ diagnosis_list_url }}" class="nav-link{% if request.path == diagnosis_list_url %} active {% endif %}">
                <i class="nav-icon fas fa-diagnoses"></i>
                <p>Diagnosis Codes</p>
              </a>
            </li>
            <li class="nav-item">
              {% url 'pemba_admin_healthrecord_list' as health_record_list_url %}
              <a href="{{ health_record_list_url }}" class="nav-link{% if request.path == health_record_list_url %} active {% endif %}">                     
                <i class="nav-icon fas fa-file-medical-alt"></i> 
                <p>Chief Complaints</p>
              </a>
            </li>
            <li class="nav-item">
              {% url 'pemba_admin_manage_disease' as manage_disease_url %}
              <a href="{{ manage_disease_url }}" class="nav-link{% if request.path == manage_disease_url %} active {% endif %}">
                <i class="nav-icon fas fa-viruses"></i>
                <p>Disease Registry</p>
              </a>
            </li>
            <li class="nav-item">
              {% url 'pemba_admin_manage_pathodology' as manage_pathodology_url %}
              <a href="{{ manage_pathodology_url }}" class="nav-link{% if request.path == manage_pathodology_url %} active {% endif %}">
                <i class="nav-icon fas fa-microscope"></i>
                <p>Pathology Records</p>
              </a>
            </li>
            <li class="nav-item">
              {% url 'pemba_admin_manage_country' as manage_country_url %}
              <a href="{{ manage_country_url }}" class="nav-link{% if request.path == manage_country_url %} active {% endif %}">
                <i class="nav-icon fas fa-globe"></i>
                <p>Country Management</p>
              </a>
            </li>
            <li class="nav-item">
              {% url 'pemba_admin_service_list' as remoteservice_list_url %}
              <a href="{{ remoteservice_list_url }}" class="nav-link{% if request.path == remoteservice_list_url %} active {% endif %}">
                <i class="nav-icon fas fa-hospital"></i>
                <p>Clinic Services</p>
              </a>
            </li>
          </ul>
        </li>
      </ul>
    </nav>
  </div>
</aside>

<!-- Add this CSS -->
<style>
  /* Add these styles for search functionality */
  .no-results {
    display: none;
    padding: 10px;
    text-align: center;
    color: #ff6b6b;
    font-size: 0.85rem;
    margin-top: 5px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
  }
  
  .search-highlight {
    background-color: rgba(255, 235, 59, 0.3);
    color: #fff;
    padding: 0 2px;
    border-radius: 3px;
  }
  
  .nav-item.search-hidden {
    display: none !important;
  }
  
  .nav-header.search-hidden {
    display: none !important;
  }
</style>
<style>
  /* Sidebar Styling */
  .main-sidebar {
    background: linear-gradient(to bottom, #1e3c72, #2a5298);
    box-shadow: 3px 0 15px rgba(0, 0, 0, 0.15);
  }
  
  .brand-link {
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding: 15px 20px;
    background: linear-gradient(135deg, #1a2980, #26d0ce);
  }
  
  .brand-container {
    display: flex;
    align-items: center;
  }
  
  .brand-text {
    font-size: 1.2rem;
    font-weight: 700;
    letter-spacing: 0.5px;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
  }
  
  .brand-subtext {
    font-size: 0.7rem;
    opacity: 0.8;
    letter-spacing: 0.5px;
  }
  
  .user-panel {
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding: 15px;
  }
  
  .user-status {
    font-size: 0.75rem;
    margin-top: 3px;
  }
  
  .user-role {
    font-size: 0.8rem;
    opacity: 0.8;
    margin-top: 2px;
  }
  
  .sidebar-search {
    margin-top: 10px;
  }
  
  .nav-header {
    padding: 8px 20px;
    font-size: 0.75rem;
    letter-spacing: 1px;
    margin-top: 10px;
  }
  
  .nav-link {
    padding: 12px 15px;
    margin: 3px 10px;
    border-radius: 8px;
    transition: all 0.3s ease;
  }
  
  .nav-link:hover:not(.active) {
    background: rgba(255, 255, 255, 0.1);
  }
  
  .nav-link.active {
    background: linear-gradient(135deg, #3494e6, #ec6ead);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
  }
  
  .nav-treeview .nav-link {
    padding: 10px 15px 10px 45px;
    margin: 2px 0;
    border-radius: 0;
    border-left: 3px solid transparent;
  }
  
  .nav-treeview .nav-link:hover {
    border-left: 3px solid #3498db;
    background: rgba(255, 255, 255, 0.05);
  }
  
  .nav-treeview .nav-link.active {
    border-left: 3px solid #3498db;
    background: rgba(52, 152, 219, 0.2);
  }
  
  .nav-icon {
    font-size: 1.1rem;
    margin-right: 10px;
    min-width: 25px;
    text-align: center;
  }
  
  .badge {
    font-weight: 500;
    padding: 4px 7px;
    font-size: 0.75rem;
  }
  
  /* Animation for nav items */
  .nav-item {
    transition: transform 0.3s ease;
  }
  
  .nav-item:hover {
    transform: translateX(5px);
  }
  
  /* Responsive adjustments */
  @media (max-width: 768px) {
    .brand-text {
      font-size: 1rem;
    }
    
    .brand-subtext {
      display: none;
    }
    
    .user-panel .info {
      display: none;
    }
  }
</style>

<script>
  // Function to update medicine counts
  function updateKahamaMedicineCounts() {
    $.ajax({
      url: "{% url 'pemba_admin_medicine_count_api' %}",
      type: "GET",
      success: function (data) {
        $('#kahama-badge-all').text(data.all || 0);
        $('#kahama-badge-expired').text(data.expired || 0);
        $('#kahama-badge-instock').text(data.instock || 0);
        $('#kahama-badge-checklist').text(data.checklist || 0);
        $('#kahama-badge-outofstock').text(data.outofstock || 0);
      },
      error: function () {
        console.error("Failed to load medicine counts.");
      }
    });
  }

  // Function to update reagent stock notification count
  function updateKahamaReagentOutNotificationCount() {
    $.ajax({
      url: '/api/out-of-stock-reagent-count/', // Replace with your API endpoint URL
      method: 'GET',
      dataType: 'json',
      success: function(data) {
        var count = data.count || 0;
        $('#kahama-notification-count-reagent').text(count);
      },
      error: function(xhr, status, error) {
        console.error('Error fetching notification count:', error);
      }
    });
  }  
  

  // Function to fetch laboratory order counts
  function fetchKahamaLaboratoryOrderCounts() {
    $.ajax({
      url: "{% url 'pemba_admin_fetch_laboratory_order_counts' %}",
      type: "GET",
      success: function(response) {
        $('#kahama-unread-laboratory-badge').text(response.unread_count || 0);
      },
      error: function(error) {
        console.log("Error fetching laboratory counts: ", error);
      }
    });
  }
  
  // Function to fetch procedure order counts
  function fetchKahamaProcedureOrderCounts() {
    $.ajax({
      url: "{% url 'pemba_admin_fetch_procedure_order_counts' %}",
      type: "GET",
      success: function(response) {
        $('#kahama-unread-procedure-badge').text(response.unread_count || 0);
      },
      error: function(error) {
        console.log("Error fetching procedure counts: ", error);
      }
    });
  }
  

  
  // Initialize counts on page load and set intervals
  $(document).ready(function() {   
    updateKahamaMedicineCounts();
    updateKahamaReagentOutNotificationCount();
    fetchKahamaLaboratoryOrderCounts();
    fetchKahamaProcedureOrderCounts();

    
    // Update counts periodically
    setInterval(updateKahamaMedicineCounts, 60000);
    setInterval(updateKahamaReagentOutNotificationCount, 60000);

    setInterval(fetchKahamaLaboratoryOrderCounts, 5000);
    setInterval(fetchKahamaProcedureOrderCounts, 5000);

    
    // Add sidebar toggle animation
    $('.nav-link > .fas.fa-angle-left').parent().on('click', function() {
      $(this).find('.fa-angle-left').toggleClass('fa-rotate-90');
    });
  });
</script>