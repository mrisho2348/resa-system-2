{% extends 'pembaadmin_template/base_template.html' %}

{% block title %}
   Premium Patient Management
{% endblock title %}

{% block breadcrumb %}
{% include "pembaadmin_template/modal_form.html" %}
  
{% endblock breadcrumb %}

{% load static %}
{% block main_content %}
<style>
    /* Premium Patient Management Styles - Unique to this template */
    .patient-prem-gradient {
        background: linear-gradient(120deg, #2C3E50, #4A235A);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 15px 35px rgba(44, 62, 80, 0.15);
        border: none;
    }
    
    .patient-prem-gradient .card-header {
        background: rgba(0,0,0,0.1);
        border-bottom: 1px solid rgba(255,255,255,0.2);
        padding: 1.2rem 1.5rem;
    }
    
    .patient-prem-table-container {
        border-radius: 10px;
        overflow: auto;
        box-shadow: 0 5px 15px rgba(0,0,0,0.06);
    }
    
    .patient-prem-table th {
        background: linear-gradient(120deg, #e8eaf6, #c5cae9);
        color: #303F9F;
        font-weight: 600;
        padding: 1rem 0.75rem;
        border: none;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .patient-prem-table td {
        padding: 1.1rem 0.75rem;
        vertical-align: middle;
        border-color: #e8eaf6;
    }
    
    .patient-prem-table tbody tr {
        transition: all 0.3s ease;
        background: white;
    }
    
    .patient-prem-table tbody tr:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(48, 63, 159, 0.1);
        background: #f5f6ff;
    }
    
    .btn-prem-patient {
        background: linear-gradient(120deg, #2C3E50, #4A235A);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 8px 16px;
        font-size: 0.85rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(44, 62, 80, 0.2);
    }
    
    .btn-prem-patient:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(44, 62, 80, 0.3);
        color: white;
    }
    
    .btn-prem-patient-add {
        background: linear-gradient(120deg, #00C853, #64DD17);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 20px;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(0, 200, 83, 0.2);
    }
    
    .btn-prem-patient-add:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(0, 200, 83, 0.3);
        color: white;
    }
    
    .btn-prem-patient-edit {
        background: linear-gradient(120deg, #FF9800, #FFC107);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 6px 12px;
        font-size: 0.8rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(255, 152, 0, 0.2);
    }
    
    .btn-prem-patient-edit:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(255, 152, 0, 0.3);
        color: white;
    }
    
    .btn-prem-patient-delete {
        background: linear-gradient(120deg, #F44336, #EF5350);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 6px 12px;
        font-size: 0.8rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(244, 67, 54, 0.2);
    }
    
    .btn-prem-patient-delete:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(244, 67, 54, 0.3);
        color: white;
    }
    
    .btn-prem-patient-view {
        background: linear-gradient(120deg, #2196F3, #03A9F4);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 6px 12px;
        font-size: 0.8rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(33, 150, 243, 0.2);
    }
    
    .btn-prem-patient-view:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(33, 150, 243, 0.3);
        color: white;
    }
    
    .patient-prem-modal-header {
        background: linear-gradient(120deg, #2C3E50, #4A235A);
        color: white;
        border-radius: 0;
        padding: 1.2rem 1.5rem;
    }
    
    .patient-prem-input-group {
        position: relative;
        margin-bottom: 1.5rem;
    }
    
    .patient-prem-input-group label {
        font-weight: 600;
        color: #303F9F;
        margin-bottom: 0.5rem;
        display: block;
    }
    
    .patient-prem-input-group .form-control {
        border: 1px solid #c5cae9;
        padding: 0.75rem 1rem;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    
    .patient-prem-input-group .form-control:focus {
        border-color: #303F9F;
        box-shadow: 0 0 0 0.2rem rgba(48, 63, 159, 0.25);
    }
    
    .patient-prem-summary-card {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        border: none;
        margin-bottom: 20px;
        transition: all 0.3s ease;
    }
    
    .patient-prem-summary-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    
    .patient-prem-summary-card .card-header {
        background: linear-gradient(120deg, #f5f6ff, #e8eaf6);
        color: #303F9F;
        font-weight: 600;
        padding: 1rem 1.2rem;
        border-bottom: 1px solid #c5cae9;
    }
    
    .patient-prem-summary-card .card-body {
        padding: 1.5rem;
    }
    
    .patient-prem-summary-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: #303F9F;
        margin-bottom: 0.5rem;
    }
    
    .patient-prem-summary-label {
        font-size: 0.9rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .patient-prem-modal-content {
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        border: none;
        overflow: hidden;
    }
    
    .patient-prem-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .patient-prem-badge-male {
        background: linear-gradient(120deg, #42A5F5, #90CAF9);
        color: white;
    }
    
    .patient-prem-badge-female {
        background: linear-gradient(120deg, #EC407A, #F48FB1);
        color: white;
    }
    
    .patient-prem-badge-other {
        background: linear-gradient(120deg, #9E9E9E, #E0E0E0);
        color: white;
    }
    
    .patient-prem-badge-company {
        background: linear-gradient(120deg, #66BB6A, #A5D6A7);
        color: white;
    }
    
    .patient-prem-badge-remote {
        background: linear-gradient(120deg, #FFA726, #FFCC80);
        color: white;
    }
    
    .patient-prem-filter-bar {
        background: linear-gradient(120deg, #f5f6ff, #e8eaf6);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    
    .patient-prem-status-filter {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .patient-prem-status-btn {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        border: none;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .patient-prem-status-btn.active {
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    /* Status button colors */
    .patient-prem-status-btn[data-category="all"] {
        background: linear-gradient(120deg, #2C3E50, #4A235A);
        color: white;
    }
    
    .patient-prem-status-btn[data-category="Male"] {
        background: linear-gradient(120deg, #42A5F5, #90CAF9);
        color: white;
    }
    
    .patient-prem-status-btn[data-category="Female"] {
        background: linear-gradient(120deg, #EC407A, #F48FB1);
        color: white;
    }
    
    .patient-prem-status-btn[data-category="Company"] {
        background: linear-gradient(120deg, #66BB6A, #A5D6A7);
        color: white;
    }
    
    .patient-prem-status-btn[data-category="Remote"] {
        background: linear-gradient(120deg, #FFA726, #FFCC80);
        color: white;
    }
    
    /* Animation for view switching */
    @keyframes patientPremFadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .patient-prem-animated {
        animation: patientPremFadeIn 0.5s ease forwards;
    }
    
    /* Flip card effect for premium feature */
    .patient-prem-flip-card {
        perspective: 1000px;
        height: 200px;
        margin-bottom: 20px;
    }
    
    .patient-prem-flip-card-inner {
        position: relative;
        width: 100%;
        height: 100%;
        text-align: center;
        transition: transform 0.8s;
        transform-style: preserve-3d;
    }
    
    .patient-prem-flip-card:hover .patient-prem-flip-card-inner {
        transform: rotateY(180deg);
    }
    
    .patient-prem-flip-card-front, .patient-prem-flip-card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        border-radius: 15px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .patient-prem-flip-card-front {
        background: linear-gradient(120deg, #2C3E50, #4A235A);
        color: white;
    }
    
    .patient-prem-flip-card-back {
        background: linear-gradient(120deg, #4A235A, #2C3E50);
        color: white;
        transform: rotateY(180deg);
    }
    
    .patient-prem-flip-icon {
        font-size: 3rem;
        margin-bottom: 15px;
    }
    
    /* Premium select2 styling */
    .select2-container--default .select2-selection--single {
        border: 1px solid #c5cae9;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        height: auto;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    
    .select2-container--default.select2-container--focus .select2-selection--single {
        border-color: #303F9F;
        box-shadow: 0 0 0 0.2rem rgba(48, 63, 159, 0.25);
    }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card patient-prem-gradient shadow-lg">
                <div class="card-header py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0 text-white"><i class="fas fa-user-injured mr-2"></i>Premium Patient Management</h5>                       
                    </div>
                </div>
                <div class="card-body">
                    <!-- Summary Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card patient-prem-summary-card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-users mr-2"></i>Total Patients</h6>
                                </div>
                                <div class="card-body text-center">
                                    <div class="patient-prem-summary-value" id="total-patients">{{ patients|length }}</div>
                                    <div class="patient-prem-summary-label">All Patients</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card patient-prem-summary-card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-male mr-2"></i>Male Patients</h6>
                                </div>
                                <div class="card-body text-center">
                                    <div class="patient-prem-summary-value" id="male-patients">0</div>
                                    <div class="patient-prem-summary-label">Male</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card patient-prem-summary-card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-female mr-2"></i>Female Patients</h6>
                                </div>
                                <div class="card-body text-center">
                                    <div class="patient-prem-summary-value" id="female-patients">0</div>
                                    <div class="patient-prem-summary-label">Female</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="patient-prem-flip-card">
                                <div class="patient-prem-flip-card-inner">
                                    <div class="patient-prem-flip-card-front">
                                        <div class="patient-prem-flip-icon">
                                            <i class="fas fa-crown"></i>
                                        </div>
                                        <h4>Patient Analytics</h4>
                                        <p>Hover to reveal</p>
                                    </div>
                                    <div class="patient-prem-flip-card-back">
                                        <div class="patient-prem-flip-icon">
                                            <i class="fas fa-chart-line"></i>
                                        </div>
                                        <h4>Patient Insights</h4>
                                        <p>Advanced patient tracking</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filter Bar -->
                    <div class="patient-prem-filter-bar">
                        <div class="d-flex justify-content-between align-items-center flex-wrap">
                            <div class="patient-prem-status-filter">
                                <button class="patient-prem-status-btn active" data-category="all">All Patients</button>
                                <button class="patient-prem-status-btn" data-category="Male">Male</button>
                                <button class="patient-prem-status-btn" data-category="Female">Female</button>
                                <button class="patient-prem-status-btn" data-category="Company">Company</button>
                                <button class="patient-prem-status-btn" data-category="Remote">Remote</button>
                            </div>
                        </div>
                        <div class="input-group mt-2">
                            <input type="text" class="form-control" placeholder="Search patients..." id="patientPremSearch">
                            <div class="input-group-append">
                                <button class="btn btn-prem-patient" type="button" id="searchButton">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Table View -->
                    <div class="table-responsive patient-prem-table-container">
                        <table class="table table-hover text-nowrap patient-prem-table" id="patientTable">
                            <thead>
                                <tr>
                                    <th><i class="fas fa-id-card mr-2"></i>MRN</th>
                                    <th><i class="fas fa-user mr-2"></i>Name</th>           
                                    <th><i class="fas fa-venus-mars mr-2"></i>Gender</th>
                                    <th><i class="fas fa-birthday-cake mr-2"></i>Age</th>
                                    <th><i class="fas fa-building mr-2"></i>Company</th>
                                    <th><i class="fas fa-flag mr-2"></i>Nationality</th>
                                    <th><i class="fas fa-phone mr-2"></i>Phone</th>
                                    <th><i class="fas fa-user-tag mr-2"></i>Patient Type</th>  
                                    <th><i class="fas fa-user-md mr-2"></i>Data Recorder</th>
                                    <th><i class="fas fa-calendar mr-2"></i>Created At</th>                                             
                                    <th class="text-center"><i class="fas fa-cogs mr-2"></i>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="student-table-body">
                                {% for patient in patients %}
                                <tr data-gender="{{ patient.gender }}" data-type="{{ patient.patient_type }}">
                                    <td>{{ patient.mrn }}</td>
                                    <td>{{ patient.first_name }} {{ patient.middle_name }}  {{ patient.last_name }}</td>                
                                    <td>
                                        <span class="patient-prem-badge patient-prem-badge-{{ patient.gender|lower }}">
                                            {{ patient.gender }}
                                        </span>
                                    </td>
                                    <td>DOB: {{ patient.dob|date:'d-m-Y' }} [ Age: {% if patient.dob %}
                                        <script>
                                            var dob = new Date("{{ patient.dob|date:'Y-m-d' }}");
                                            var now = new Date();
                                            var ageMilliseconds = now - dob;
                                            var ageSeconds = ageMilliseconds / 1000;
                                            var ageYears = Math.floor(ageSeconds / (365.25 * 24 * 60 * 60));
                                            document.write(ageYears + ' years');
                                        </script>
                                        {% else %}
                                        {{ patient.age }}
                                        {% endif %}]</td>
                                    <td>{{ patient.company }}</td>
                                    <td>{{ patient.nationality.name }}</td>
                                    <td>{{ patient.phone }}</td>                                                
                                    <td>
                                        <span class="patient-prem-badge {% if patient.patient_type == 'Company' %}patient-prem-badge-company{% else %}patient-prem-badge-remote{% endif %}">
                                            {{ patient.patient_type }}
                                        </span>
                                    </td>   
                                    <td>                                       
                                        <b style="color: blue;" class="text-capitalize">
                                            {% if patient.data_recorder.role == "doctor" %}Dr.{% else %}{{ patient.data_recorder.role }}{% endif %}
                                        </b> 
                                        <span class="text-muted">{{ patient.data_recorder }}</span>
                                    </td>  
                                    <td>{{ patient.created_at|date:"d-m-Y" }}</td>            
                                    <td class="text-center">
                                        <!-- Delete Button -->
                                        <button class="btn btn-prem-patient-delete" data-toggle="modal" data-target="#deleteRemotePatientModal{{ patient.id }}" data-toggle="tooltip" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>

                                        <!-- View Details Button -->
                                        <button class="btn btn-prem-patient-view" data-toggle="modal" data-target="#viewPatientDetailsModal{{ patient.id }}" data-toggle="tooltip" title="View Details">
                                            <i class="fas fa-user"></i>
                                        </button>

                                        <!-- Visit History Button -->
                                        <button class="btn btn-prem-patient" data-toggle="modal" data-target="#patientVisitsModal{{ patient.id }}" data-toggle="tooltip" title="Visit History">
                                            <i class="fas fa-history"></i>
                                        </button>
                                    </td>                               
                              
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>
</div>

{% for patient in patients %}
    <!-- Patient Details Modal -->
<div class="modal fade" id="viewPatientDetailsModal{{ patient.id }}" tabindex="-1" role="dialog" aria-labelledby="viewPatientDetailsModalLabel{{ patient.id }}" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
    <div class="modal-content patient-prem-modal-content">
      <div class="modal-header patient-prem-modal-header">
        <h5 class="modal-title text-white" id="viewPatientDetailsModalLabel{{ patient.id }}">
          <i class="fas fa-user-circle mr-2"></i>Patient Details: {{ patient.first_name }} {{ patient.middle_name }} {{ patient.last_name }}
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
      </div>

      <div class="modal-body">

        <!-- Demographic Information -->
        <div class="card mb-3 patient-prem-summary-card">
          <div class="card-header bg-info text-white"><i class="fas fa-id-card mr-2"></i>Demographics</div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4"><strong>MRN:</strong> {{ patient.mrn }}</div>
              <div class="col-md-4"><strong>Gender:</strong> {{ patient.gender }}</div>
              <div class="col-md-4"><strong>Age:</strong> {{ patient.age }}</div>
              <div class="col-md-4"><strong>Date of Birth:</strong> {{ patient.dob }}</div>
              <div class="col-md-4"><strong>Phone:</strong> {{ patient.phone }}</div>
              <div class="col-md-4"><strong>Nationality:</strong> {{ patient.nationality.name }}</div>
              <div class="col-md-4"><strong>Marital Status:</strong> {{ patient.marital_status }}</div>
              <div class="col-md-4"><strong>Occupation:</strong> {{ patient.occupation }}</div>
              <div class="col-md-4"><strong>Patient Type:</strong> {{ patient.patient_type }}</div>
              <div class="col-md-4"><strong>Company:</strong> {{ patient.company.name }}</div>
            </div>
          </div>
        </div>

        <!-- Insurance Information -->
        <div class="card mb-3 patient-prem-summary-card">
          <div class="card-header bg-warning"><i class="fas fa-shield-alt mr-2"></i>Insurance Info</div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4"><strong>Insurance Status:</strong> {{ patient.insurance }}</div>
              <div class="col-md-4"><strong>Insurance Company:</strong> {{ patient.insurance_company }}</div>
              <div class="col-md-4"><strong>Insurance Number:</strong> {{ patient.insurance_number }}</div>
            </div>
          </div>
        </div>

        <!-- Emergency Contact -->
        <div class="card mb-3 patient-prem-summary-card">
          <div class="card-header bg-danger text-white"><i class="fas fa-phone-alt mr-2"></i>Emergency Contact</div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4"><strong>Name:</strong> {{ patient.emergency_contact_name }}</div>
              <div class="col-md-4"><strong>Relation:</strong> {{ patient.emergency_contact_relation }}</div>
              <div class="col-md-4"><strong>Phone:</strong> {{ patient.emergency_contact_phone }}</div>
            </div>
          </div>
        </div>

        <!-- OSHA Certification -->
        <div class="card mb-3 patient-prem-summary-card">
          <div class="card-header bg-secondary text-white"><i class="fas fa-certificate mr-2"></i>OSHA Certification</div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6"><strong>OSHA Certified:</strong> {{ patient.osha_certificate|yesno:"Yes,No" }}</div>
              <div class="col-md-6"><strong>Certification Date:</strong> {{ patient.date_of_osha_certification }}</div>
            </div>
          </div>
        </div>

        <!-- Lifestyle -->
        <div class="card mb-3 patient-prem-summary-card">
          <div class="card-header bg-success text-white"><i class="fas fa-heartbeat mr-2"></i>Lifestyle & Behavior</div>
          <div class="card-body">
            {% with lifestyle=patient.patientlifestylebehavior %}
              <div class="row">
                <div class="col-md-4"><strong>Exercise (Weekly):</strong> {{ lifestyle.weekly_exercise_frequency }}</div>
                <div class="col-md-4"><strong>Smoking:</strong> {{ lifestyle.smoking }}</div>
                <div class="col-md-4"><strong>Alcohol:</strong> {{ lifestyle.alcohol_consumption }}</div>
                <div class="col-md-4"><strong>Healthy Diet:</strong> {{ lifestyle.healthy_diet }}</div>
                <div class="col-md-4"><strong>Stress Management:</strong> {{ lifestyle.stress_management }}</div>
                <div class="col-md-4"><strong>Sleep:</strong> {{ lifestyle.sufficient_sleep }}</div>
              </div>
            {% endwith %}
          </div>
        </div>

        <!-- Allergies -->
        <div class="card mb-3 patient-prem-summary-card">
          <div class="card-header bg-danger text-white"><i class="fas fa-allergies mr-2"></i>Medication Allergies</div>
          <div class="card-body">
            {% if patient.remote_medication_allergies.all %}
              <ul class="list-group">
                {% for allergy in patient.remote_medication_allergies.all %}
                  <li class="list-group-item">
                    <strong>{{ allergy.medicine_name.drug_name }}</strong>: {{ allergy.reaction }}
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted">No recorded allergies.</p>
            {% endif %}
          </div>
        </div>

        <!-- Surgery -->
        <div class="card mb-3 patient-prem-summary-card">
          <div class="card-header bg-dark text-white"><i class="fas fa-procedures mr-2"></i>Surgery History</div>
          <div class="card-body">
            {% if patient.remote_patient_surgery.all %}
              <ul class="list-group">
                {% for surgery in patient.remote_patient_surgery.all %}
                  <li class="list-group-item">
                    <strong>{{ surgery.surgery_name }}</strong> ({{ surgery.surgery_date }})
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted">No surgery history available.</p>
            {% endif %}
          </div>
        </div>

      </div>
    </div>
  </div>
</div>
{% endfor %}

{% for patient in patients %}
<!-- Delete Patient Modal -->
<div class="modal fade" id="deleteRemotePatientModal{{ patient.id }}" tabindex="-1" role="dialog" aria-labelledby="deleteRemotePatientModalLabel{{ patient.id }}" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content patient-prem-modal-content">

      <!-- Modal Header -->
      <div class="modal-header patient-prem-modal-header">
        <h5 class="modal-title text-white" id="deleteRemotePatientModalLabel{{ patient.id }}">
          <i class="fas fa-trash mr-2"></i>Delete Patient
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <p>Are you sure you want to delete this patient?</p>
        <p><strong>{{ patient.first_name }} {{ patient.middle_name }} {{ patient.last_name }}</strong></p>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-prem-patient-delete" onclick="deleteRemotePatient({{ patient.id }})">Delete</button>
      </div>

    </div>
  </div>
</div>
{% endfor %}

<!-- JavaScript Function (Place this at the bottom of your template) -->
<script>
  function deleteRemotePatient(patientId) {
    $.ajax({
      url: "{% url 'pemba_admin_delete_patient' %}",  // Named URL with no patientId
      type: "POST",
      data: {
        csrfmiddlewaretoken: '{{ csrf_token }}',
        patient_id: patientId
      },
      success: function (data) {
        if (data.status === 'success') {
          $('#deleteRemotePatientModal' + patientId).modal('hide');
          location.reload(true);
        } else {
          alert(data.message || 'Deletion failed.');
        }
      },
      error: function (xhr, status, error) {
        alert('An error occurred: ' + error);
      }
    });
  }
</script>

{% for patient in patients %}
      <!-- Modal: List of All Patient Visits -->
<div class="modal fade" id="patientVisitsModal{{ patient.id }}" tabindex="-1" role="dialog" aria-labelledby="patientVisitsModalLabel{{ patient.id }}" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
        <div class="modal-content patient-prem-modal-content">
        
        <!-- Modal Header -->
        <div class="modal-header patient-prem-modal-header">
            <h5 class="modal-title text-white" id="patientVisitsModalLabel{{ patient.id }}">
            <i class="fas fa-history mr-2"></i>Visit History for {{ patient.first_name }} {{ patient.last_name }}
            </h5>
            <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
            </button>
        </div>

        <!-- Modal Body -->
        <div class="modal-body">
            <table class="table table-striped table-bordered table-sm patient-prem-table">
            <thead class="thead-light">
                <tr>
                <th>Visit Number</th>
                <th>Visit Type</th>
                <th>Date</th>
                <th>Day</th>
                <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for visit in patient.remotepatientvisits_set.all %}
                <tr>
                    <td>{{ visit.vst }}</td>
                    <td>{{ visit.get_visit_type_display }}</td>
                    <td>{{ visit.created_at|date:"Y-m-d" }}</td>
                    <td>{{ visit.created_at|date:"l" }}</td>
                    <td>
                    <button type="button" class="btn btn-prem-patient-view" data-toggle="modal" data-target="#visitDetailModal_{{ visit.id }}">
                        Summary
                    </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center">No previous visits found.</td>
                </tr>
                {% endfor %}
            </tbody>
            </table>
        </div>
        
        </div>
    </div>
    </div>
{% endfor %}

{% for patient in patients %}
  {% for visit in patient.remotepatientvisits_set.all %}
    <div class="modal fade" id="visitDetailModal_{{ visit.id }}" tabindex="-1" role="dialog" aria-labelledby="visitDetailModalLabel_{{ visit.id }}" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
        <div class="modal-content patient-prem-modal-content">
          <div class="modal-header patient-prem-modal-header">
            <h5 class="modal-title text-white" id="visitDetailModalLabel_{{ visit.id }}">
                <a href="{% url 'divine_download_consultation_summary_pdf' patient.id visit.id %}" class="btn btn-prem-patient">
                    <i class="fas fa-download mr-2"></i>Download Consultation Summary PDF
                </a>
            </h5>
            <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
          </div>
          <div class="modal-body">
           <div class="card mb-4 patient-prem-summary-card">
                <div class="card-header bg-dark text-white">
                    <h6 class="mb-0"><i class="fas fa-user-injured mr-2"></i>Patient Details</h6>
                </div>
                <div class="card-body">
                    <table class="table table-bordered table-striped">
                        <tbody>
                            <tr>
                                <th>Patient:</th>
                                <td>{{ patient.full_name|default:"-" }}</td>
                                <th>MRN:</th>
                                <td>{{ patient.mrn|default:"-" }}</td>
                                <th>Visit Number:</th>
                                <td>{{ visit.vst|default:"-" }}</td>
                            </tr>
                            <tr>
                                <th>Age:</th>
                                <td>{{ patient.age|default:"-" }}</td>
                                <th>Gender:</th>
                                <td>{{ patient.gender|default:"-" }}</td>
                                <th>Company:</th>
                                <td>{{ patient.company|default:"-" }}</td>
                            </tr>
                            <tr>
                                <th>Phone:</th>
                                <td>{{ patient.phone|default:"-" }}</td>
                                <th>Visit Time:</th>
                                <td colspan="3">{{ visit.created_at|default:"-"|time:"H:i" }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        {% if visit.remotepatientvital_set.exists %}
                    <!-- ðŸ”¹ CARD: Vital Signs -->
            <div class="card mb-4 patient-prem-summary-card">
                <div class="card-header bg-dark text-white">
                    <h6 class="mb-0"><i class="fas fa-heartbeat mr-2"></i>Vital Signs/Assessment Data</h6>
                </div>
                <div class="card-body">
                    {% if visit.remotepatientvital_set.exists %}
                    <div class="table-responsive">
                        <table class="table table-hover text-nowrap table-bordered table-striped table-sm patient-prem-table">
                        <thead class="thead-dark">
                            <tr>                           
                            <th>Resp Rate</th>
                            <th>Pulse</th>
                            <th>BP</th>
                            <th>SBP</th>
                            <th>DBP</th>
                            <th>SPO2</th>
                            <th>Temp (Â°C)</th>
                            <th>GCS</th>
                            <th>AVPU</th>
                            <th>Weight</th>
                            <th>Recorded By</th>
                            <th>Recorded At</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vitals in visit.remotepatientvital_set.all %}
                            <tr>                          
                            <td>{{ vitals.respiratory_rate|default:"-" }}</td>
                            <td>{{ vitals.pulse_rate|default:"-" }}</td>
                            <td>{{ vitals.blood_pressure|default:"-" }}</td>
                            <td>{{ vitals.sbp|default:"-" }}</td>
                            <td>{{ vitals.dbp|default:"-" }}</td>
                            <td>{{ vitals.spo2|default:"-" }}%</td>
                            <td>{{ vitals.temperature|default:"-" }}</td>
                            <td>{{ vitals.gcs|default:"-" }}</td>
                            <td>{{ vitals.avpu|default:"-" }}</td>
                            <td>{{ vitals.weight|default:"-" }}</td>
                            <td>{{ vitals.recorded_by.get_full_name|default:"System" }}</td>
                            <td>{{ vitals.recorded_at|date:"d-m-Y" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p><em>No vitals recorded for this visit.</em></p>
                    {% endif %}
             </div>
            </div>
        {% endif %}
        {% with consultation_note=visit.remoteconsultationnotes_set.first diagnosis_record=visit.remotepatientdiagnosisrecord_set.first %}
        {% if consultation_note %}
            <div class="card clinical-notes-card mt-4 patient-prem-summary-card">
            <div class="card-header bg-dark text-white">
                <h2 class="card-title"><i class="fas fa-stethoscope mr-2"></i>Clinical Notes</h2>
            </div>
            <div class="card-body">
                <table class="table table-bordered">
                <tbody>

                    <tr>
                    <th>Chief Complaints:</th>
                    <td>
                        <ul>
                        {% for complaint in visit.chiefcomplaint_set.all %}
                            <li>{{ complaint.health_record }} - Duration: {{ complaint.duration }}</li>
                        {% endfor %}
                        </ul>
                    </td>
                    </tr>

                    <tr>
                    <th>History of Presenting Illness:</th>
                    <td>{{ consultation_note.history_of_presenting_illness }}</td>
                    </tr>

                    <tr>
                    <th>Review of Systems:</th>
                    <td>{{ consultation_note.review_of_systems }}</td>
                    </tr>

                    <tr>
                    <th>Physical Examination:</th>
                    <td>{{ consultation_note.physical_examination }}</td>
                    </tr>

                    <tr>
                    <th>Doctor's Plan:</th>
                    <td>{{ consultation_note.doctor_plan }}</td>
                    </tr>

                    <tr>
                    <th>Doctor's Plan Notes:</th>
                    <td>{{ consultation_note.doctor_plan_note }}</td>
                    </tr>

                    <tr>
                    <th>Allergy Summary:</th>
                    <td>{{ consultation_note.allergy_summary }}</td>
                    </tr>

                    <tr>
                    <th>Known Comorbidities:</th>
                    <td>{{ consultation_note.known_comorbidities_summary }}</td>
                    </tr>

                    {% if diagnosis_record %}
                    <tr>
                        <th>Provisional Diagnosis:</th>
                        <td>
                        <ul class="list-group">
                            {% for pdx in diagnosis_record.provisional_diagnosis.all %}
                            <li class="list-group-item">{{ pdx.diagnosis_name }}</li>
                            {% endfor %}
                        </ul>
                        </td>
                    </tr>

                    <tr>
                        <th>Final Diagnosis:</th>
                        <td>
                        <ul class="list-group">
                            {% for fdx in diagnosis_record.final_diagnosis.all %}
                            <li class="list-group-item">{{ fdx.diagnosis_name }}</li>
                            {% endfor %}
                        </ul>
                        </td>
                    </tr>
                    {% endif %}

                </tbody>
                </table>
            </div>
            </div>
        {% endif %}
        {% endwith %}

        {% if visit.remotelaboratoryorder_set.exists %}
                 <!-- ðŸ”¬ CARD: Laboratory Orders -->
            <div class="card mb-4 patient-prem-summary-card">
                <div class="card-header bg-danger text-white">
                    <h6 class="mb-0"><i class="fas fa-vial mr-2"></i>Lab Data</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped table-hover table-sm text-nowrap patient-prem-table">
                            <thead class="thead-dark">
                                <tr>                             
                                    <th>Lab No.</th>
                                    <th>Test</th>
                                    <th>Description</th>                                   
                                    <th>Done By</th>                                 
                                    <th>Result</th>                               
                                    <th>Created</th>
                                    <th>Updated</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for lab in visit.remotelaboratoryorder_set.all %}
                                <tr>                                    
                                    <td>{{ lab.lab_number }}</td>
                                    <td>{{ lab.name.name|default:"-" }}</td>
                                    <td>{{ lab.description|default:"-" }}</td>                            
                                    <td>{{ lab.data_recorder.get_full_name|default:"System" }}</td>                             
                                    <td>
                                        {% if lab.result %}
                                            <button class="btn btn-prem-patient-view" data-toggle="modal" data-target="#resultModal{{ lab.id }}">
                                                View Result
                                            </button>
                                        {% else %}
                                            <em>No result</em>
                                        {% endif %}
                                    </td>                                 
                                    <td>{{ lab.created_at|date:"d-m-Y" }}</td>
                                    <td>{{ lab.updated_at|date:"d-m-Y" }}</td>
                                </tr>

                              
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% endif %}


        {% if visit.remoteprocedure_set.exists %}
               <!-- ðŸ”¹ CARD: Procedures -->
            <div class="card mb-4 patient-prem-summary-card">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0"><i class="fas fa-procedures mr-2"></i>Procedure Records</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped table-hover table-sm text-nowrap patient-prem-table">
                            <thead class="thead-light">
                                <tr>                                 
                                    <th>Procedure</th>
                                    <th>Description</th>                                 
                                    <th>Ordered By</th>                              
                                    <th>Equipments Used</th>
                                    <th>Result</th>                               
                                    <th>Created</th>
                                    <th>Updated</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for procedure in visit.remoteprocedure_set.all %}
                                <tr>                                    
                                    <td>{{ procedure.name.name|default:"-" }}</td>
                                    <td>{{ procedure.description|default:"-" }}</td>                               
                                    <td>{{ procedure.data_recorder.get_full_name|default:"System" }}</td>                             
                                    <td>{{ procedure.equipments_used }}</td>
                                    <td>
                                        {% if procedure.result %}
                                            <button class="btn btn-prem-patient-view" data-toggle="modal" data-target="#procedureResultModal{{ procedure.id }}">
                                                View Result
                                            </button>
                                        {% else %}
                                            <em>No result</em>
                                        {% endif %}
                                    </td>                              
                                    <td>{{ procedure.created_at|date:"d-m-Y" }}</td>
                                    <td>{{ procedure.updated_at|date:"d-m-Y" }}</td>
                                </tr>
                               
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% endif %}


        {% if visit.remoteimagingrecord_set.exists %}
            <!-- ðŸ”¹ CARD: Imaging Records -->
            <div class="card mb-4 patient-prem-summary-card">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-x-ray mr-2"></i>Imaging Records</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped table-hover table-sm text-nowrap patient-prem-table">
                            <thead class="thead-light">
                                <tr>                               
                                    <th>Imaging</th>
                                    <th>Description</th>
                                    <th>Result</th>
                                    <th>Image</th>                                 
                                    <th>Done By</th>                                 
                                
                                    <th>Created At</th>
                                    <th>Updated At</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in visit.remoteimagingrecord_set.all %}
                                <tr>                                   
                                    <td>{{ record.imaging.name|default:"-" }}</td>
                                    <td>{{ record.description|default:"-" }}</td>
                                    <td>
                                        {% if record.result %}
                                            <button class="btn btn-prem-patient-view" data-toggle="modal" data-target="#imagingResultModal{{ record.id }}">
                                                View Result
                                            </button>
                                        {% else %}
                                            <em>No result</em>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if record.image %}
                                            <a href="{{ record.image.url }}" target="_blank">View Image</a>
                                        {% else %}
                                            <span class="text-muted">No Image</span>
                                        {% endif %}
                                    </td>                               
                                    <td>{{ record.data_recorder.get_full_name|default:"System" }}</td>                            
                                    <td>{{ record.created_at|date:"d-m-Y" }}</td>
                                    <td>{{ record.updated_at|date:"d-m-Y" }}</td>
                                </tr>
                              
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% endif %}


        {% if visit.remoteobservationrecord_set.exists %}
                <!-- ðŸ“ CARD: Observation Records -->
            <div class="card mb-4 patient-prem-summary-card">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="fas fa-clipboard-list mr-2"></i>Observation Records</h6>
            </div>
            <div class="card-body">
                {% if visit.remoteobservationrecord_set.exists %}
                <div class="table-responsive">
                    <table class="table table-bordered table-striped table-hover table-sm text-nowrap patient-prem-table">
                    <thead class="thead-light">
                        <tr>                      
                        <th>Observation Notes</th>
                        <th>Recorded By</th>
                        <th>Created At</th>
                        <th>Updated At</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for observation in visit.remoteobservationrecord_set.all %}
                        <tr>                     
                        <td>{{ observation.observation_notes|safe }}</td>
                        <td>{{ observation.data_recorder.get_full_name|default:"System" }}</td>
                        <td>{{ observation.created_at|date:"d-m-Y" }}</td>
                        <td>{{ observation.updated_at|date:"d-m-Y" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    </table>
                </div>
                {% else %}
                <p><em>No observations recorded for this visit.</em></p>
                {% endif %}
            </div>
            </div>
        {% endif %}

        {% if visit.remoteprescription_set.exists %}
                   <!-- ðŸ’Š CARD: Prescription Records -->
            <div class="card mb-4 patient-prem-summary-card">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="fas fa-prescription mr-2"></i>Prescription Records</h6>
            </div>
            <div class="card-body">
                {% if visit.remoteprescription_set.exists %}
                <div class="table-responsive">
                    <table class="table table-bordered table-striped table-hover table-sm text-nowrap patient-prem-table">
                    <thead class="thead-light">
                        <tr>
                        <th>#</th>
                        <th>Medicine</th>
                        <th>Dose</th>
                        <th>Frequency</th>
                        <th>Duration</th>
                        <th>Quantity Used</th>
                        <th>Total Price</th>
                        <th>Verified</th>
                        <th>Issued</th>
                        <th>Status</th>
                        <th>Entered By</th>
                        <th>Created At</th>
                        <th>Updated At</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for prescription in visit.remoteprescription_set.all %}
                        <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ prescription.medicine.name }}</td>
                        <td>{{ prescription.dose }}</td>
                        <td>{{ prescription.frequency }}</td>
                        <td>{{ prescription.duration }}</td>
                        <td>{{ prescription.quantity_used }}</td>
                        <td>{{ prescription.total_price|default:"-" }}</td>
                        <td>{{ prescription.get_verified_display }}</td>
                        <td>{{ prescription.get_issued_display }}</td>
                        <td>{{ prescription.status }}</td>
                        <td>{{ prescription.entered_by.get_full_name|default:"System" }}</td>
                        <td>{{ prescription.created_at|date:"d-m-Y" }}</td>
                        <td>{{ prescription.updated_at|date:"d-m-Y" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    </table>
                </div>
                {% else %}
                <p><em>No prescriptions recorded for this visit.</em></p>
                {% endif %}
            </div>
            </div>
        {% endif %}

        {% if visit.remotecounseling_set.exists %}
                    <!-- ðŸ’¬ CARD: Counseling Notes -->
            <div class="card mb-4 patient-prem-summary-card">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="fas fa-comments mr-2"></i>Counseling Notes</h6>
            </div>
            <div class="card-body">
                {% if visit.remotecounseling_set.exists %}
                <div class="table-responsive">
                    <table class="table table-bordered table-striped table-hover table-sm text-nowrap patient-prem-table">
                    <thead class="thead-light">
                        <tr>
                        <th>#</th>
                        <th>Recorder</th>
                        <th>Notes</th>
                        <th>Created</th>
                        <th>Updated</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for session in visit.remotecounseling_set.all %}
                        <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ session.data_recorder.get_full_name|default:"System" }}</td>
                        <td>
                            {% if session.counselling_notes %}
                            <div style="max-width: 400px; max-height: 200px; overflow:auto;">
                                {{ session.counselling_notes|safe }}
                            </div>
                            {% else %}
                            <em>No notes recorded.</em>
                            {% endif %}
                        </td>
                        <td>{{ session.created_at|date:"d-m-Y" }}</td>
                        <td>{{ session.updated_at|date:"d-m-Y" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    </table>
                </div>
                {% else %}
                <p><em>No counseling notes for this visit.</em></p>
                {% endif %}
            </div>
            </div>
        {% endif %}

        {% if visit.remotereferral_set.exists %}
                    <!-- ðŸ¥ CARD: Referral Details -->
            <div class="card mb-4 patient-prem-summary-card">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="fas fa-hospital-alt mr-2"></i>Referral Details</h6>
            </div>
            <div class="card-body">
                {% if visit.remotereferral_set.exists %}
                <div class="table-responsive">
                    <table class="table table-bordered table-striped table-hover table-sm text-nowrap patient-prem-table">
                    <thead class="thead-light">
                        <tr>                    
                        <th>Source Location</th>
                        <th>Destination Location</th>
                        <th>Nature of Referral</th>
                        <th>Transport Model</th>
                        <th>Notes</th>
                        <th>Status</th>
                        <th>Recorded By</th>
                        <th>Created At</th>
                        <th>Updated At</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for referral in visit.remotereferral_set.all %}
                        <tr>                        
                        <td>{{ referral.source_location|default:"-" }}</td>
                        <td>{{ referral.destination_location|default:"-" }}</td>
                        <td>{{ referral.get_nature_of_referral_display|default:"-" }}</td>
                        <td>{{ referral.get_transport_model_display|default:"-" }}</td>
                        <td>{{ referral.notes|safe|default:"-" }}</td>
                        <td>
                            <span class="badge badge-{{ referral.get_status_color }}">
                            {{ referral.get_status_display }}
                            </span>
                        </td>
                        <td>{{ referral.data_recorder.get_full_name|default:"System" }}</td>
                        <td>{{ referral.created_at|date:"d-m-Y" }}</td>
                        <td>{{ referral.updated_at|date:"d-m-Y" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    </table>
                </div>
                {% else %}
                <p><em>No referrals recorded for this visit.</em></p>
                {% endif %}
            </div>
            </div>
        {% endif %}

        {% if visit.remotedischargesnotes_set.exists %}
                    <!-- ðŸ¥ CARD: Discharge Notes -->
            <div class="card mb-4 patient-prem-summary-card">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0"><i class="fas fa-sign-out-alt mr-2"></i>Discharge Notes</h6>
            </div>
            <div class="card-body">
                {% if visit.remotedischargesnotes_set.exists %}
                <div class="table-responsive">
                    <table class="table table-bordered table-striped table-hover table-sm text-nowrap patient-prem-table">
                    <thead class="thead-light">
                        <tr>                       
                        <th>Discharge Condition</th>
                        <th>Discharge Notes</th>
                        <th>Recorded By</th>
                        <th>Discharge Date</th>
                        <th>Last Updated</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for discharge in visit.remotedischargesnotes_set.all %}
                        <tr>                        
                        <td>{{ discharge.discharge_condition|default:"-" }}</td>
                        <td>{{ discharge.discharge_notes|safe|default:"-" }}</td>
                        <td>{{ discharge.data_recorder.get_full_name|default:"System" }}</td>
                        <td>{{ discharge.discharge_date|date:"d-m-Y" }}</td>
                        <td>{{ discharge.updated_at|date:"d-m-Y" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    </table>
                </div>
                {% else %}
                <p><em>No discharge notes recorded for this visit.</em></p>
                {% endif %}
            </div>
            </div>
        {% endif %}

      </div>
    </div>
  </div>
</div>
{% endfor %}
{% endfor %}

{# =============================== #}
{# ðŸ§ª Lab Result Modals           #}
{# =============================== #}
{% for patient in patients %}
  {% for visit in patient.remotepatientvisits_set.all %}
    {% for lab in visit.remotelaboratoryorder_set.all %}
      {% if lab.result %}
        <div class="modal fade" id="resultModal{{ lab.id }}" tabindex="-1" role="dialog" aria-labelledby="resultModalLabel{{ lab.id }}" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
            <div class="modal-content patient-prem-modal-content">
              <div class="modal-header patient-prem-modal-header">
                <h5 class="modal-title text-white" id="resultModalLabel{{ lab.id }}">
                  Lab Result: {{ lab.name.name|default:"Test" }}
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                {{ lab.result|safe }}
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-prem-patient" data-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
      {% endif %}
    {% endfor %}
  {% endfor %}
{% endfor %}


{# =============================== #}
{# ðŸ©º Procedure Result Modals     #}
{# =============================== #}
{% for patient in patients %}
  {% for visit in patient.remotepatientvisits_set.all %}
    {% for procedure in visit.remoteprocedure_set.all %}
      {% if procedure.result %}
        <div class="modal fade" id="procedureResultModal{{ procedure.id }}" tabindex="-1" role="dialog" aria-labelledby="procedureResultModalLabel{{ procedure.id }}" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
            <div class="modal-content patient-prem-modal-content">
              <div class="modal-header patient-prem-modal-header">
                <h5 class="modal-title text-white" id="procedureResultModalLabel{{ procedure.id }}">
                  Procedure Result: {{ procedure.name.name|default:"Procedure" }}
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                {{ procedure.result|safe }}
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-prem-patient" data-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
      {% endif %}
    {% endfor %}
  {% endfor %}
{% endfor %}


{# =============================== #}
{# ðŸ–¼ï¸ Imaging Result Modals       #}
{# =============================== #}
{% for patient in patients %}
  {% for visit in patient.remotepatientvisits_set.all %}
    {% for record in visit.remoteimagingrecord_set.all %}
      {% if record.result %}
        <div class="modal fade" id="imagingResultModal{{ record.id }}" tabindex="-1" role="dialog" aria-labelledby="imagingResultModalLabel{{ record.id }}" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
            <div class="modal-content patient-prem-modal-content">
              <div class="modal-header patient-prem-modal-header">
                <h5 class="modal-title text-white" id="imagingResultModalLabel{{ record.id }}">
                  Imaging Result: {{ record.imaging.name|default:"Imaging" }}
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                {{ record.result|safe }}
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-prem-patient" data-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
      {% endif %}
    {% endfor %}
  {% endfor %}
{% endfor %}

<script>
    // Initialize DataTable
    new DataTable('#patientTable', {
        dom: 'Bfrtip',
        buttons: ['excel', 'pdf', 'print'],
        responsive: true,
        pageLength: 10,
        order: [[0, 'asc']],
        language: {
            search: "_INPUT_",
            searchPlaceholder: "Search patients...",
            lengthMenu: "Show _MENU_ entries"
        }
    });

    // Calculate summary statistics
    function calculatePatientSummaryStats() {
        let maleCount = 0;
        let femaleCount = 0;
        let companyCount = 0;
        let remoteCount = 0;
        
        document.querySelectorAll('#patientTable tbody tr').forEach(row => {
            const gender = row.getAttribute('data-gender');
            const type = row.getAttribute('data-type');
            
            // Count by gender
            if (gender === 'Male') {
                maleCount++;
            } else if (gender === 'Female') {
                femaleCount++;
            }
            
            // Count by type
            if (type === 'Company') {
                companyCount++;
            } else if (type === 'Remote') {
                remoteCount++;
            }
        });
        
        // Update summary cards
        document.getElementById('male-patients').textContent = maleCount;
        document.getElementById('female-patients').textContent = femaleCount;
    }
    
    // Initialize summary stats
    calculatePatientSummaryStats();

    // Category filter functionality
    document.querySelectorAll('.patient-prem-status-btn').forEach(button => {
        button.addEventListener('click', function() {
            // Toggle active class
            document.querySelectorAll('.patient-prem-status-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            this.classList.add('active');
            
            const category = this.getAttribute('data-category');
            filterPatients(category);
        });
    });

    // Filter patients by category
    function filterPatients(category) {
        const rows = document.querySelectorAll('#patientTable tbody tr');
        let visibleCount = 0;
        
        rows.forEach(row => {
            const rowGender = row.getAttribute('data-gender');
            const rowType = row.getAttribute('data-type');
            
            if (category === 'all' || rowGender === category || rowType === category) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Update total count
        document.getElementById('total-patients').textContent = visibleCount;
    }

    // Search functionality
    document.getElementById('patientPremSearch').addEventListener('keyup', function() {
        const searchText = this.value.toLowerCase();
        const activeCategory = document.querySelector('.patient-prem-status-btn.active').getAttribute('data-category');
        
        filterPatientsWithSearch(activeCategory, searchText);
    });
    
    document.getElementById('searchButton').addEventListener('click', function() {
        const searchText = document.getElementById('patientPremSearch').value.toLowerCase();
        const activeCategory = document.querySelector('.patient-prem-status-btn.active').getAttribute('data-category');
        
        filterPatientsWithSearch(activeCategory, searchText);
    });

    // Filter patients by both category and search text
    function filterPatientsWithSearch(category, searchText) {
        const rows = document.querySelectorAll('#patientTable tbody tr');
        let visibleCount = 0;
        
        rows.forEach(row => {
            const rowGender = row.getAttribute('data-gender');
            const rowType = row.getAttribute('data-type');
            const rowText = row.textContent.toLowerCase();
            
            const categoryMatch = category === 'all' || rowGender === category || rowType === category;
            const searchMatch = searchText === '' || rowText.includes(searchText);
            
            if (categoryMatch && searchMatch) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Update total count
        document.getElementById('total-patients').textContent = visibleCount;
    }
</script>

{% endblock main_content %}