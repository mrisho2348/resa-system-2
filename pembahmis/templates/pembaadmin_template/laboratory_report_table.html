{% load customfilter %}
<style>
    /* Premium Laboratory Report Styles - Unique to this template */
    .lab-prem-table-container {
        border-radius: 10px;
        overflow: auto;
        box-shadow: 0 5px 15px rgba(0,0,0,0.06);
        margin: 20px 0;
        background: white;
    }
    
    .lab-prem-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
    }
    
    .lab-prem-table th {
        background: linear-gradient(120deg, #00b09b, #96c93d);
        color: white;
        font-weight: 600;
        padding: 1rem 0.5rem;
        border: none;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        text-align: center;
        position: sticky;
        top: 0;
        z-index: 10;
        white-space: nowrap;
    }
    
    .lab-prem-table th:first-child {
        text-align: left;
        background: linear-gradient(120deg, #007991, #78ffd6);
    }
    
    .lab-prem-table td {
        padding: 0.8rem 0.5rem;
        vertical-align: middle;
        border-bottom: 1px solid #e8eaf6;
        transition: all 0.3s ease;
        text-align: center;
    }
    
    .lab-prem-table td:first-child {
        text-align: left;
        font-weight: 600;
        background-color: #f8f9fa;
    }
    
    .lab-prem-table tbody tr {
        transition: all 0.3s ease;
        background: white;
    }
    
    .lab-prem-table tbody tr:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(48, 63, 159, 0.1);
        background: #f5f6ff;
    }
    
    .lab-prem-table tbody tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    
    .lab-prem-table tbody tr:nth-child(even):hover {
        background-color: #f5f6ff;
    }
    
    .lab-prem-value {
        border-radius: 4px;
        padding: 4px 8px;
        display: inline-block;
        min-width: 30px;
        font-weight: 500;
    }
    
    .lab-prem-high-value {
        background: linear-gradient(120deg, #4CAF50, #81C784);
        color: white;
    }
    
    .lab-prem-medium-value {
        background: linear-gradient(120deg, #FF9800, #FFB74D);
        color: white;
    }
    
    .lab-prem-low-value {
        background: linear-gradient(120deg, #F44336, #EF5350);
        color: white;
    }
    
    .lab-prem-total-row {
        background: linear-gradient(120deg, #2c3e50, #34495e) !important;
        color: white;
        font-weight: 700;
    }
    
    .lab-prem-total-row td {
        font-weight: 700;
        border-top: 2px solid #00b09b;
    }
    
    .lab-prem-total-row td:first-child {
        background: transparent;
        color: white;
    }
    
    /* Animation for row appearance */
    @keyframes labPremFadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .lab-prem-animated-row {
        animation: labPremFadeIn 0.5s ease forwards;
    }
    
    /* Heatmap styling for values */
    .lab-prem-heatmap-0 { background-color: #f8f9fa; }
    .lab-prem-heatmap-1 { background-color: #e8f5e9; }
    .lab-prem-heatmap-2 { background-color: #c8e6c9; }
    .lab-prem-heatmap-3 { background-color: #a5d6a7; }
    .lab-prem-heatmap-4 { background-color: #81c784; }
    .lab-prem-heatmap-5 { background-color: #66bb6a; color: white; }
    .lab-prem-heatmap-6 { background-color: #4caf50; color: white; }
    .lab-prem-heatmap-7 { background-color: #43a047; color: white; }
    .lab-prem-heatmap-8 { background-color: #388e3c; color: white; }
    .lab-prem-heatmap-9 { background-color: #2e7d32; color: white; }
    .lab-prem-heatmap-10 { background-color: #1b5e20; color: white; }
    
    /* Sparkline container */
    .lab-prem-sparkline {
        height: 20px;
        width: 100%;
        margin-top: 5px;
    }
    
    /* Laboratory icon styling */
    .lab-prem-icon {
        width: 24px;
        height: 24px;
        margin-right: 8px;
        border-radius: 4px;
        object-fit: contain;
        vertical-align: middle;
        background: linear-gradient(120deg, #00b09b, #96c93d);
        padding: 3px;
    }
    
    /* Premium export buttons */
    .btn-premium-export {
        background: linear-gradient(120deg, #8E2DE2, #4A00E0);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 8px 16px;
        font-size: 0.85rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(142, 45, 226, 0.2);
        margin: 0 5px;
    }
    
    .btn-premium-export:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(142, 45, 226, 0.3);
        color: white;
    }
    
    /* Loading overlay for exports */
    .export-loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        color: white;
        font-size: 1.5rem;
    }
</style>

<div class="lab-prem-table-container">
    <table class="lab-prem-table" id="labReportTable">
        <thead>
            <tr>
                <th>Laboratory Tests</th>
                <th>January</th>
                <th>February</th>
                <th>March</th>
                <th>April</th>
                <th>May</th>
                <th>June</th>
                <th>July</th>
                <th>August</th>
                <th>September</th>
                <th>October</th>
                <th>November</th>
                <th>December</th>
                <th>Trend</th>
            </tr>
        </thead>
        <tbody>
            {% for laboratory, counts in laboratory_reports.items %}
                <tr class="lab-prem-animated-row">
                    <td>
                        <i class="fas fa-flask lab-prem-icon"></i>
                        {{ laboratory }}
                    </td>
                    {% for count in counts %}
                        <td class="lab-prem-heatmap-{{ count|heatmap_class }}">
                            <span class="lab-prem-value 
                                {% if count > 50 %}lab-prem-high-value
                                {% elif count > 20 %}lab-prem-medium-value
                                {% elif count > 0 %}lab-prem-low-value
                                {% endif %}">
                                {{ count }}
                            </span>
                        </td>
                    {% endfor %}
                    <!-- Ensure we have exactly 12 month columns -->
                    {% if counts|length < 12 %}
                        {% for i in counts|length|get_range:12 %}
                            <td class="lab-prem-heatmap-0">
                                <span class="lab-prem-value">0</span>
                            </td>
                        {% endfor %}
                    {% endif %}
                    <td>
                        <div class="lab-prem-sparkline" id="sparkline-{{ forloop.counter }}"></div>
                    </td>
                </tr>
            {% endfor %}
            <!-- Total row will be added by JavaScript -->
            <tr class="lab-prem-total-row">
                <td>Total</td>
                {% for total in monthly_totals %}
                    <td>{{ total }}</td>
                {% endfor %}
                <!-- Ensure we have exactly 12 month columns in total row -->
                {% if monthly_totals|length < 12 %}
                    {% for i in monthly_totals|length|get_range:12 %}
                        <td>0</td>
                    {% endfor %}
                {% endif %}
                <td></td>
            </tr>
        </tbody>          
    </table>
</div>

<!-- Loading overlay for exports -->
<div id="exportLoading" class="export-loading" style="display: none;">
    <div class="text-center">
        <i class="fas fa-spinner fa-spin fa-3x"></i>
        <p class="mt-3">Generating report, please wait...</p>
    </div>
</div>

<!-- Include required libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
{% include 'pembaadmin_template/datatable.html' %}
<script>
    $(document).ready(function() {
        // Initialize DataTable with explicit column definitions
        var table = $('#labReportTable').DataTable({
            dom: 'Bfrtip',
            buttons: [
                {
                    extend: 'colvis',
                    className: 'btn-premium-export',
                    text: '<i class="fas fa-columns mr-2"></i> Columns'
                }
            ],
            responsive: true,
            pageLength: 10,
            order: [[0, 'asc']],
            language: {
                search: "_INPUT_",
                searchPlaceholder: "Search tests...",
                lengthMenu: "Show _MENU_ entries"
            },
            columnDefs: [
                { targets: 0, width: '20%' }, // Test column
                { targets: '_all', width: '6%' } // All other columns
            ],
            initComplete: function() {
                // Add animation delay to rows for staggered effect
                $('#labReportTable tbody tr').each(function(index) {
                    $(this).css('animation-delay', (index * 0.05) + 's');
                });
                
                // Calculate and add monthly totals if not already provided
                if ($('#labReportTable tbody tr.lab-prem-total-row').length === 0) {
                    let monthlyTotals = Array(12).fill(0);
                    
                    $('#labReportTable tbody tr:not(.lab-prem-total-row)').each(function() {
                        $(this).find('td:not(:first, :last)').each(function(index) {
                            let count = parseInt($(this).text()) || 0;
                            monthlyTotals[index] += count;
                        });
                    });
                    
                    // Add total row
                    let totalRow = '<tr class="lab-prem-total-row"><td>Total</td>';
                    monthlyTotals.forEach(total => {
                        totalRow += `<td>${total}</td>`;
                    });
                    totalRow += '<td></td></tr>';
                    
                    $('#labReportTable tbody').append(totalRow);
                }
                
                // Add heatmap effect based on values
                $('#labReportTable tbody td:not(:first, :last)').each(function() {
                    let value = parseInt($(this).text()) || 0;
                    let heatmapClass = 'lab-prem-heatmap-' + Math.min(10, Math.floor(value / 5));
                    $(this).addClass(heatmapClass);
                });
                
                // Generate sparklines for trends
                generateSparklines();
                
                // Add custom export buttons
                addCustomExportButtons();
            },
            createdRow: function(row, data, dataIndex) {
                // Add animation class to new rows
                $(row).addClass('lab-prem-animated-row');
            }
        });
        
        // Function to generate sparklines
        function generateSparklines() {
            $('#labReportTable tbody tr:not(.lab-prem-total-row)').each(function(index) {
                let values = [];
                $(this).find('td:not(:first, :last)').each(function() {
                    values.push(parseInt($(this).text()) || 0);
                });
                
                // Create a simple SVG sparkline
                if (values.length > 0) {
                    const maxValue = Math.max(...values);
                    const minValue = Math.min(...values);
                    const range = maxValue - minValue;
                    const svgHeight = 20;
                    const svgWidth = 100;
                    
                    let sparklineSvg = `<svg width="${svgWidth}" height="${svgHeight}" class="lab-prem-sparkline">`;
                    
                    if (range > 0) {
                        // Draw line
                        sparklineSvg += '<polyline fill="none" stroke="#00b09b" stroke-width="2" points="';
                        values.forEach((value, i) => {
                            const x = (i / (values.length - 1)) * svgWidth;
                            const y = svgHeight - ((value - minValue) / range) * (svgHeight - 2);
                            sparklineSvg += `${x},${y} `;
                        });
                        sparklineSvg += '"/>';
                    }
                    
                    sparklineSvg += '</svg>';
                    
                    $(this).find('.lab-prem-sparkline').html(sparklineSvg);
                }
            });
        }
        
        // Function to add custom export buttons
        function addCustomExportButtons() {
            // Add custom buttons to the DataTable buttons container
            $('.dt-buttons').prepend(
                '<button class="btn-premium-export" id="exportPdf">' +
                    '<i class="fas fa-file-pdf mr-2"></i> Export PDF' +
                '</button>' +
                '<button class="btn-premium-export" id="exportExcel">' +
                    '<i class="fas fa-file-excel mr-2"></i> Export Excel' +
                '</button>'
            );
            
            // Add event handlers
            $('#exportPdf').on('click', function() {
                exportToPdf();
            });
            
            $('#exportExcel').on('click', function() {
                exportToExcel();
            });
            
            // Add chart button
            $('.dt-buttons').append(
                '<button class="btn-premium-export" id="generateLabChart">' +
                    '<i class="fas fa-chart-line mr-2"></i> Generate Chart' +
                '</button>'
            );
            
            $('#generateLabChart').on('click', function() {
                alert('Chart generation feature would be implemented here. This could open a modal with visual charts of the laboratory test data.');
            });
        }
        
        // Function to show loading overlay
        function showLoading() {
            $('#exportLoading').fadeIn();
        }
        
        // Function to hide loading overlay
        function hideLoading() {
            $('#exportLoading').fadeOut();
        }
        
        // Function to export to PDF using pdfmake
        function exportToPdf() {
            showLoading();
            
            try {
                // Get table data
                const table = document.getElementById('labReportTable');
                const headers = [];
                const data = [];
                
                // Get headers
                $(table).find('thead th').each(function() {
                    headers.push({
                        text: $(this).text().trim(),
                        style: 'tableHeader',
                        alignment: 'center'
                    });
                });
                
                // Get rows data
                $(table).find('tbody tr').each(function() {
                    const rowData = [];
                    $(this).find('td').each(function() {
                        // Remove any HTML tags and get text only
                        const text = $(this).text().trim();
                        rowData.push({
                            text: text,
                            alignment: 'center'
                        });
                    });
                    data.push(rowData);
                });
                
                // Create document definition
                const docDefinition = {
                    pageOrientation: 'landscape',
                    content: [
                        {
                            text: 'Laboratory Tests Report',
                            style: 'header',
                            alignment: 'center',
                            margin: [0, 0, 0, 20]
                        },
                        {
                            table: {
                                headerRows: 1,
                                widths: Array(headers.length).fill('*'),
                                body: [headers, ...data]
                            },
                            layout: {
                                fillColor: function(rowIndex) {
                                    if (rowIndex === 0) {
                                        return '#00b09b';
                                    }
                                    return (rowIndex % 2 === 0) ? '#f5f5f5' : null;
                                }
                            }
                        }
                    ],
                    styles: {
                        header: {
                            fontSize: 18,
                            bold: true,
                            color: '#00b09b'
                        },
                        tableHeader: {
                            bold: true,
                            fontSize: 12,
                            color: 'white',
                            fillColor: '#00b09b'
                        }
                    },
                    defaultStyle: {
                        fontSize: 10
                    }
                };
                
                // Generate PDF
                pdfMake.createPdf(docDefinition).download('Laboratory_Tests_Report.pdf');
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF. Please try again.');
            } finally {
                hideLoading();
            }
        }
        
        // Function to export to Excel using ExcelJS
        function exportToExcel() {
            showLoading();
            
            try {
                // Create workbook and worksheet
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('Laboratory Tests');
                
                // Get table data
                const table = document.getElementById('labReportTable');
                
                // Add title row
                worksheet.mergeCells('A1:N1');
                const titleRow = worksheet.getRow(1);
                titleRow.getCell(1).value = 'Laboratory Tests Report';
                titleRow.getCell(1).font = { bold: true, size: 16, color: { argb: 'FF00B09B' } };
                titleRow.getCell(1).alignment = { horizontal: 'center' };
                titleRow.height = 25;
                
                // Add headers
                const headerRow = worksheet.addRow([]);
                $(table).find('thead th').each(function(index) {
                    const cell = headerRow.getCell(index + 1);
                    cell.value = $(this).text().trim();
                    cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FF00B09B' }
                    };
                    cell.alignment = { horizontal: 'center' };
                    cell.border = {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    };
                });
                
                // Add data rows
                $(table).find('tbody tr').each(function() {
                    const rowData = [];
                    $(this).find('td').each(function() {
                        // Remove any HTML tags and get text only
                        const text = $(this).text().trim();
                        rowData.push(text);
                    });
                    
                    const row = worksheet.addRow(rowData);
                    row.eachCell({ includeEmpty: true }, function(cell, colNumber) {
                        cell.alignment = { horizontal: 'center' };
                        cell.border = {
                            top: { style: 'thin' },
                            left: { style: 'thin' },
                            bottom: { style: 'thin' },
                            right: { style: 'thin' }
                        };
                    });
                });
                
                // Style the worksheet
                worksheet.columns = worksheet.columns.map(function(column, i) {
                    if (i === 0) {
                        return { width: 30 }; // First column (test names) wider
                    }
                    return { width: 10 }; // Other columns
                });
                
                // Add conditional formatting for values (heatmap effect)
                for (let col = 2; col <= 13; col++) {
                    for (let row = 3; row <= worksheet.rowCount; row++) {
                        const cell = worksheet.getCell(row, col);
                        const value = parseInt(cell.value) || 0;
                        
                        if (value > 50) {
                            cell.fill = {
                                type: 'pattern',
                                pattern: 'solid',
                                fgColor: { argb: 'FF4CAF50' }
                            };
                            cell.font = { color: { argb: 'FFFFFFFF' } };
                        } else if (value > 20) {
                            cell.fill = {
                                type: 'pattern',
                                pattern: 'solid',
                                fgColor: { argb: 'FFFF9800' }
                            };
                            cell.font = { color: { argb: 'FFFFFFFF' } };
                        } else if (value > 0) {
                            cell.fill = {
                                type: 'pattern',
                                pattern: 'solid',
                                fgColor: { argb: 'FFF44336' }
                            };
                            cell.font = { color: { argb: 'FFFFFFFF' } };
                        }
                    }
                }
                
                // Generate Excel file
                workbook.xlsx.writeBuffer().then(function(buffer) {
                    saveAs(new Blob([buffer], { type: 'application/octet-stream' }), 'Laboratory_Tests_Report.xlsx');
                });
            } catch (error) {
                console.error('Error generating Excel:', error);
                alert('Error generating Excel. Please try again.');
            } finally {
                hideLoading();
            }
        }
        
        // Add category filter dropdown
        $('.dataTables_wrapper').prepend(
            '<div class="row mb-3">' +
                '<div class="col-md-3">' +
                    '<select id="categoryFilter" class="form-control form-control-sm">' +
                        '<option value="all">All Tests</option>' +
                        '<option value="Blood">Blood Tests</option>' +
                        '<option value="Urine">Urine Tests</option>' +
                        '<option value="Culture">Cultures</option>' +
                        '<option value="Biochemistry">Biochemistry</option>' +
                    '</select>' +
                '</div>' +
            '</div>'
        );
        
        $('#categoryFilter').on('change', function() {
            if (this.value === 'all') {
                $('#labReportTable').DataTable().search('').draw();
            } else {
                $('#labReportTable').DataTable().search(this.value).draw();
            }
        });
    });
</script>