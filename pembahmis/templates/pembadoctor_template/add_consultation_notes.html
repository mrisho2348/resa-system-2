{% extends 'pembadoctor_template/base_template.html' %}
{%  load static %}
{% block title %}
{{ patient.first_name }} {{ patient.middle_name }} {{ patient.last_name }}  Consultation notes
{% endblock title %}

{% block page_title %}
    <!-- Forward Button -->
                {% if final_provisional_diagnosis %}
                <a class="btn btn-primary breadcrumb-link" type="button" 
                    href="
                    {% if consultation_note.doctor_plan == 'Prescription' %}
                        {% url 'pemba_doctor_prescription_save' patient.id visit.id %}
                    {% elif consultation_note.doctor_plan == 'Laboratory' %}
                        {% url 'pemba_doctor_consultation_save_next' patient.id visit.id %}
                    {% elif consultation_note.doctor_plan == 'Referral' %}
                        {% url 'pemba_doctor_referral_save' patient.id visit.id %}
                    {% elif consultation_note.doctor_plan == 'Counselling' %}
                        {% url 'pemba_doctor_counseling_save' patient.id visit.id %}
                    {% elif consultation_note.doctor_plan == 'Procedure' %}
                        {% url 'pemba_doctor_procedure_save' patient.id visit.id %}
                    {% elif consultation_note.doctor_plan == 'Observation' %}
                        {% url 'pemba_doctor_save_observation' patient.id visit.id %}
                    {% elif consultation_note.doctor_plan == 'Discharge' %}
                        {% url 'pemba_doctor_discharge_save' patient.id visit.id %}
                    {% endif %}
                    ">
                    <i class="fas fa-arrow-left"></i> Back
                </a>       
            {% endif %}

    
      <a class="btn btn-primary breadcrumb-link" type="button"  href="{% url 'pemba_doctor_vitals_save' patient.id visit.id %}">
        <i class="fas fa-arrow-left"></i> Back to vitals
    </a>  

            {% if consultation_note %}
            <a class="btn btn-success breadcrumb-link" type="button" 
            href="
            {% if consultation_note.doctor_plan == 'Laboratory' %}
                {% url 'pemba_doctor_save_laboratory' patient.id visit.id %}
            {% else %}
                {% url 'pemba_doctor_consultation_save_next' patient.id visit.id %}
            {% endif %}
            ">
            <i class="fas fa-arrow-right"></i> Forward
        </a>
            {% endif %}

    
{% endblock page_title %}

{% block breadcrumb %}
    {% include "pembadoctor_template/modal_form.html" %}
Add  Consultation notes
     <!-- View All Visits Button -->
<button type="button" class="btn btn-outline-info btn-sm" data-toggle="modal" data-target="#patientVisitsModal">
    View result
</button>
{% endblock breadcrumb %}


{% block main_content %}

<style>
    /* Premium Chief Complaints Styles */
    .consult-prem-chief-complaints {
        background: linear-gradient(120deg, #f8fdff, #e0f7fa);
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.03);
        border: 1px solid #e0f7fa;
    }
    
    .consult-prem-cc-header {
        background: linear-gradient(120deg, #0F2027, #203A43);
        color: white;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        margin-bottom: 1rem;
    }
    
    .consult-prem-cc-list {
        list-style: none;
        padding: 0;
    }
    
    .consult-prem-cc-item {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        border-left: 4px solid #006064;
        transition: all 0.3s ease;
    }
    
    .consult-prem-cc-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .consult-prem-cc-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .consult-prem-cc-text {
        flex: 1;
    }
    
    .consult-prem-cc-complaint {
        font-weight: 600;
        color: #006064;
        margin-bottom: 0.25rem;
    }
    
    .consult-prem-cc-duration {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .consult-prem-cc-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .consult-prem-cc-btn {
        border-radius: 6px;
        padding: 0.35rem 0.75rem;
        font-size: 0.8rem;
        transition: all 0.2s ease;
    }
    
    .consult-prem-cc-form {
        background: white;
        border-radius: 8px;
        padding: 1.25rem;
        margin-top: 1rem;
        box-shadow: 0 3px 8px rgba(0,0,0,0.08);
    }
    
    .consult-prem-cc-form-title {
        color: #006064;
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e0f7fa;
    }
    
    .consult-prem-cc-toggle {
        background: linear-gradient(120deg, #0F2027, #203A43);
        color: white;
        border: none;
        border-radius: 6px;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        box-shadow: 0 3px 6px rgba(15, 32, 39, 0.2);
    }
    
    .consult-prem-cc-toggle:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 12px rgba(15, 32, 39, 0.3);
        color: white;
    }
    
    .consult-prem-cc-add-btn {
        background: linear-gradient(120deg, #0F2027, #203A43);
        color: white;
        border: none;
        border-radius: 6px;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        box-shadow: 0 3px 6px rgba(15, 32, 39, 0.2);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .consult-prem-cc-add-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 12px rgba(15, 32, 39, 0.3);
        color: white;
    }
    
    .consult-prem-cc-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }
    
    .consult-prem-cc-table th {
        background: linear-gradient(120deg, #0F2027, #203A43);
        color: white;
        padding: 0.75rem;
        text-align: left;
    }
    
    .consult-prem-cc-table td {
        padding: 0.75rem;
        border-bottom: 1px solid #e0f7fa;
        background: white;
    }
    
    .consult-prem-cc-table tr:last-child td {
        border-bottom: none;
    }
    
    .consult-prem-cc-input {
        border: 1px solid #b2ebf2;
        border-radius: 6px;
        padding: 0.5rem 0.75rem;
        width: 100%;
        transition: all 0.3s ease;
    }
    
    .consult-prem-cc-input:focus {
        border-color: #006064;
        box-shadow: 0 0 0 0.2rem rgba(0, 97, 100, 0.25);
        outline: none;
    }
    
    .consult-prem-cc-alert {
        border-radius: 8px;
        padding: 0.75rem 1rem;
        margin-bottom: 1rem;
        display: none;
    }
    
    .consult-prem-cc-alert-success {
        background: linear-gradient(120deg, #66BB6A, #A5D6A7);
        color: white;
    }
    
    .consult-prem-cc-alert-error {
        background: linear-gradient(120deg, #F44336, #EF5350);
        color: white;
    }
    
    @media (max-width: 768px) {
        .consult-prem-cc-content {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.75rem;
        }
        
        .consult-prem-cc-actions {
            align-self: flex-end;
        }
    }
</style>
<style>
    /* Premium Consultation Styles - Unique to this template */
    .consult-prem-gradient {
        background: linear-gradient(120deg, #0F2027, #203A43, #2C5364);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 15px 35px rgba(15, 32, 39, 0.15);
        border: none;
    }
    
    .consult-prem-gradient .card-header {
        background: rgba(0,0,0,0.1);
        border-bottom: 1px solid rgba(255,255,255,0.2);
        padding: 1.2rem 1.5rem;
    }
    
    .consult-prem-form-container {
        border-radius: 10px;
        overflow: auto;
        box-shadow: 0 5px 15px rgba(0,0,0,0.06);
        padding: 2rem;
        background: white;
    }
    
    .consult-prem-input-group {
        position: relative;
        margin-bottom: 1.5rem;
    }
    
    .consult-prem-input-group label {
        font-weight: 600;
        color: #006064;
        margin-bottom: 0.5rem;
        display: block;
    }
    
    .consult-prem-input-group .form-control {
        border: 1px solid #b2ebf2;
        padding: 0.75rem 1rem;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    
    .consult-prem-input-group .form-control:focus {
        border-color: #006064;
        box-shadow: 0 0 0 0.2rem rgba(0, 97, 100, 0.25);
    }
    
    .btn-prem-consult {
        background: linear-gradient(120deg, #0F2027, #203A43);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 25px;
        font-size: 1rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(15, 32, 39, 0.2);
        width: 100%;
    }
    
    .btn-prem-consult:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(15, 32, 39, 0.3);
        color: white;
    }
    
    .btn-prem-consult-nav {
        background: linear-gradient(120deg, #0F2027, #203A43);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 20px;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(15, 32, 39, 0.2);
        margin-right: 10px;
    }
    
    .btn-prem-consult-nav:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(15, 32, 39, 0.3);
        color: white;
    }
    
    .consult-prem-modal-header {
        background: linear-gradient(120deg, #0F2027, #203A43);
        color: white;
        border-radius: 0;
        padding: 1.2rem 1.5rem;
    }
    
    .consult-prem-summary-card {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        border: none;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        background: linear-gradient(120deg, #f1fcff, #e0f7fa);
    }
    
    .consult-prem-summary-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    
    .consult-prem-summary-card .card-header {
        background: linear-gradient(120deg, #0F2027, #203A43);
        color: white;
        font-weight: 600;
        padding: 1rem 1.2rem;
        border-bottom: 1px solid #b2ebf2;
    }
    
    .consult-prem-summary-card .card-body {
        padding: 1.5rem;
    }
    
    .consult-prem-summary-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: #006064;
        margin-bottom: 0.5rem;
    }
    
    .consult-prem-summary-label {
        font-size: 0.9rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .consult-prem-modal-content {
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        border: none;
        overflow: hidden;
    }
    
    .consult-prem-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .consult-prem-badge-required {
        background: linear-gradient(120deg, #F44336, #EF5350);
        color: white;
    }
    
    .consult-prem-section-title {
        color: #006064;
        font-weight: 600;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #b2ebf2;
    }
    
    /* Flip card effect for premium feature */
    .consult-prem-flip-card {
        perspective: 1000px;
        height: 200px;
        margin-bottom: 20px;
    }
    
    .consult-prem-flip-card-inner {
        position: relative;
        width: 100%;
        height: 100%;
        text-align: center;
        transition: transform 0.8s;
        transform-style: preserve-3d;
    }
    
    .consult-prem-flip-card:hover .consult-prem-flip-card-inner {
        transform: rotateY(180deg);
    }
    
    .consult-prem-flip-card-front, .consult-prem-flip-card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        border-radius: 15px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .consult-prem-flip-card-front {
        background: linear-gradient(120deg, #0F2027, #203A43);
        color: white;
    }
    
    .consult-prem-flip-card-back {
        background: linear-gradient(120deg, #203A43, #0F2027);
        color: white;
        transform: rotateY(180deg);
    }
    
    .consult-prem-flip-icon {
        font-size: 3rem;
        margin-bottom: 15px;
    }
    
    /* Animation for form sections */
    @keyframes consultPremFadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .consult-prem-animated {
        animation: consultPremFadeIn 0.5s ease forwards;
    }
    
    /* Premium select2 styling */
    .select2-container--default .select2-selection--single {
        border: 1px solid #b2ebf2;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        height: auto;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    
    .select2-container--default.select2-container--focus .select2-selection--single {
        border-color: #006064;
        box-shadow: 0 0 0 0.2rem rgba(0, 97, 100, 0.25);
    }
    
    .consult-prem-alert {
        border-radius: 10px;
        margin-bottom: 20px;
    }
    
    .consult-prem-alert-success {
        background: linear-gradient(120deg, #66BB6A, #A5D6A7);
        color: white;
        border: none;
    }
    
    .consult-prem-alert-error {
        background: linear-gradient(120deg, #F44336, #EF5350);
        color: white;
        border: none;
    }
    
    /* Form section styling */
    .consult-prem-form-section {
        background: #f8fdff;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.03);
        border: 1px solid #e0f7fa;
    }
    
    /* Patient info card styling */
    .consult-prem-patient-card {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        border: none;
        margin-bottom: 20px;
        background: linear-gradient(120deg, #f1fcff, #e0f7fa);
    }
    
    .consult-prem-patient-card .card-body {
        padding: 1.5rem;
    }
    
    .consult-prem-patient-info {
        font-size: 0.9rem;
        color: #006064;
        margin-bottom: 0.5rem;
    }
    
    .consult-prem-patient-info b {
        color: #0F2027;
    }
    
    /* Health record status indicators */
    .consult-prem-status-indicator {
        width: 15px;
        height: 15px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }
    
    .consult-prem-status-normal {
        background-color: #4CAF50;
    }
    
    .consult-prem-status-warning {
        background-color: #FFC107;
    }
    
    .consult-prem-status-danger {
        background-color: #F44336;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .consult-prem-form-container {
            padding: 1rem;
        }
        
        .btn-prem-consult-nav {
            margin-bottom: 10px;
            width: 100%;
        }
    }
    
    /* Consultation specific styles */
    .consult-prem-tab-container {
        background: #f8fdff;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.03);
        border: 1px solid #e0f7fa;
    }
    
    .consult-prem-symptom-button {
        background: linear-gradient(120deg, #e0f7fa, #b2ebf2);
        border: 1px solid #80deea;
        border-radius: 20px;
        padding: 8px 16px;
        margin: 5px;
        transition: all 0.3s ease;
        color: #006064;
        font-weight: 500;
    }
    
    .consult-prem-symptom-button:hover {
        background: linear-gradient(120deg, #b2ebf2, #80deea);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 97, 100, 0.2);
        color: #006064;
    }
    
    .consult-prem-health-record-card {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        border: none;
        margin-bottom: 20px;
        background: linear-gradient(120deg, #f1fcff, #e0f7fa);
        transition: all 0.3s ease;
    }
    
    .consult-prem-health-record-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    
    .consult-prem-health-record-card .card-header {
        background: linear-gradient(120deg, #0F2027, #203A43);
        color: white;
        font-weight: 600;
        padding: 1rem 1.2rem;
        border-bottom: 1px solid #b2ebf2;
    }

    /* Premium Vitals Table Styles */
    .vitals-prem-table {
        border-collapse: separate;
        border-spacing: 0;
        width: 100%;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .vitals-prem-table thead th {
        background: linear-gradient(120deg, #0F2027, #203A43);
        color: white;
        font-weight: 600;
        padding: 1rem;
        text-align: center;
        border: none;
    }
    
    .vitals-prem-table tbody td {
        padding: 0.75rem;
        text-align: center;
        border-bottom: 1px solid #e0f7fa;
        background: white;
        transition: all 0.3s ease;
    }
    
    .vitals-prem-table tbody tr:hover td {
        background: #f1fcff;
    }
    
    .vitals-prem-table tbody tr:last-child td {
        border-bottom: none;
    }
    
    .vital-value {
        font-weight: 600;
        color: #006064;
    }
    
    .vital-unit {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .vital-bmi-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 5px;
    }
    
    .bmi-underweight {
        background-color: #FFC107;
    }
    
    .bmi-normal {
        background-color: #4CAF50;
    }
    
    .bmi-overweight {
        background-color: #FF9800;
    }
    
    .bmi-obese {
        background-color: #F44336;
    }
    
    /* Premium Modal Styles */
    .vitals-prem-modal .modal-content {
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        border: none;
        overflow: hidden;
    }
    
    .vitals-prem-modal .modal-header {
        background: linear-gradient(120deg, #0F2027, #203A43);
        color: white;
        border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    
    .vitals-prem-modal .modal-body {
        padding: 1.5rem;
    }
    
    .vitals-prem-modal .form-group {
        margin-bottom: 1.5rem;
    }
    
    .vitals-prem-modal label {
        font-weight: 600;
        color: #006064;
        margin-bottom: 0.5rem;
    }
    
    .vitals-prem-modal .form-control {
        border: 1px solid #b2ebf2;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    
    .vitals-prem-modal .form-control:focus {
        border-color: #006064;
        box-shadow: 0 0 0 0.2rem rgba(0, 97, 100, 0.25);
    }
    
    .vitals-prem-modal .btn-prem-save {
        background: linear-gradient(120deg, #0F2027, #203A43);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 25px;
        font-size: 1rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(15, 32, 39, 0.2);
        width: 100%;
    }
    
    .vitals-prem-modal .btn-prem-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(15, 32, 39, 0.3);
        color: white;
    }
    
    .bmi-calculated {
        background-color: #e8f5e9;
        color: #2e7d32;
        font-weight: 600;
        padding: 0.5rem;
        border-radius: 6px;
        text-align: center;
        margin-top: 0.5rem;
    }
</style>
<!-- Premium Visit History Modal -->
<div class="modal fade consult-prem-modal" id="patientVisitsModal" tabindex="-1" role="dialog" aria-labelledby="patientVisitsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content consult-prem-modal-content">
            <!-- Modal Header -->
            <div class="modal-header consult-prem-modal-header">
                <h5 class="modal-title" id="patientVisitsModalLabel">
                    <i class="fas fa-history mr-2"></i>Visit History for {{ patient.first_name }} {{ patient.last_name }}
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table vitals-prem-table">
                        <thead>
                            <tr>
                                <th>Visit Number</th>
                                <th>Visit Type</th>
                                <th>Date</th>
                                <th>Day</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for visit in patient_visits %}
                            <tr>
                                <td><span class="vital-value">{{ visit.vst }}</span></td>
                                <td>{{ visit.get_visit_type_display }}</td>
                                <td>{{ visit.created_at|date:"d-m-Y" }}</td>
                                <td>{{ visit.created_at|date:"l" }}</td>
                                <td>
                                    <button type="button" class="btn btn-prem-consult-nav" data-toggle="modal" data-target="#visitDetailModal_{{ visit.id }}">
                                        <i class="fas fa-file-medical-alt mr-1"></i> Summary
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-4">
                                    <i class="fas fa-clipboard-list fa-2x text-muted mb-2"></i>
                                    <p class="text-muted">No previous visits found.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>





{% for visit in patient_visits %}
<div class="modal fade consult-prem-modal" id="visitDetailModal_{{ visit.id }}" tabindex="-1" role="dialog" aria-labelledby="visitDetailModalLabel_{{ visit.id }}" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
        <div class="modal-content consult-prem-modal-content">
            <!-- Modal Header -->
            <div class="modal-header consult-prem-modal-header">
                <h5 class="modal-title" id="visitDetailModalLabel_{{ visit.id }}">
                    <i class="fas fa-history mr-2"></i>Visit Details - {{ visit.created_at|date:"d-m-Y" }}
                </h5>
                <a href="{% url 'pemba_doctor_consultation_download_summary' patient.id visit.id %}" class="btn btn-prem-consult-nav">
                    <i class="fas fa-download mr-1"></i> Download Summary PDF
                </a>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
                <!-- Patient Details Card -->
                <div class="card consult-prem-patient-card mb-4">
                    <div class="card-header consult-prem-gradient">
                        <h6 class="card-title mb-0 text-center text-white">
                            <i class="fas fa-user-injured mr-2"></i>PATIENT DETAILS
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 consult-prem-patient-info">
                                <span class="text-muted consult-prem-summary-label">PATIENT</span>
                                <div class="consult-prem-summary-value" style="font-size: 1rem;">
                                    {{ patient.full_name|default:"-" }}
                                </div>
                            </div>
                            <div class="col-md-2 consult-prem-patient-info">
                                <span class="text-muted consult-prem-summary-label">MRN</span>
                                <div class="consult-prem-summary-value" style="font-size: 1rem;">
                                    {{ patient.mrn|default:"-" }}
                                </div>
                            </div>
                            <div class="col-md-2 consult-prem-patient-info">
                                <span class="text-muted consult-prem-summary-label">VISIT NO</span>
                                <div class="consult-prem-summary-value" style="font-size: 1rem;">
                                    {{ visit.vst|default:"-" }}
                                </div>
                            </div>
                            <div class="col-md-2 consult-prem-patient-info">
                                <span class="text-muted consult-prem-summary-label">AGE</span>
                                <div class="consult-prem-summary-value" style="font-size: 1rem;">
                                    {{ patient.age|default:"-" }}
                                </div>
                            </div>
                            <div class="col-md-2 consult-prem-patient-info">
                                <span class="text-muted consult-prem-summary-label">GENDER</span>
                                <div class="consult-prem-summary-value" style="font-size: 1rem;">
                                    {{ patient.gender|default:"-" }}
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-4 consult-prem-patient-info">
                                <span class="text-muted consult-prem-summary-label">COMPANY/INSURANCE</span>
                                <div class="consult-prem-summary-value" style="font-size: 1rem;">
                                    {% if patient.payment_form == "Insurance" %}
                                        {{ patient.payment_form|default:"-" }} - {{ patient.insurance_name|default:"-" }}
                                    {% else %}
                                        {{ patient.payment_form|default:"-" }}
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4 consult-prem-patient-info">
                                <span class="text-muted consult-prem-summary-label">PHONE</span>
                                <div class="consult-prem-summary-value" style="font-size: 1rem;">
                                    {{ patient.phone|default:"-" }}
                                </div>
                            </div>
                            <div class="col-md-4 consult-prem-patient-info">
                                <span class="text-muted consult-prem-summary-label">VISIT TIME</span>
                                <div class="consult-prem-summary-value" style="font-size: 1rem;">
                                    {{ visit.created_at|default:"-"|time:"H:i" }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vitals Section -->
                {% if visit.vitals.all %}
                <div class="card consult-prem-health-record-card mb-4">
                    <div class="card-header consult-prem-gradient">
                        <h6 class="card-title mb-0 text-center text-white">
                            <i class="fas fa-heartbeat mr-2"></i>VITAL SIGNS
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table vitals-prem-table text-nowrap">
                                <thead>
                                    <tr>
                                        <th>Resp Rate</th>
                                        <th>Pulse</th>
                                        <th>BP</th>
                                        <th>SPO2</th>
                                        <th>Temp (°C)</th>
                                        <th>GCS</th>
                                        <th>height</th>
                                        <th>weight</th>
                                        <th>bmi</th>
                                        <th>Recorded By</th>
                                        <th>Recorded At</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for vitals in visit.vitals.all %}
                                    <tr>
                                        <td><span class="vital-value">{{ vitals.respiratory_rate|default:"-" }}</span></td>
                                        <td><span class="vital-value">{{ vitals.pulse_rate|default:"-" }}</span></td>
                                        <td><span class="vital-value">{{ vitals.blood_pressure|default:"-" }}</span></td>
                                        <td><span class="vital-value">{{ vitals.spo2|default:"-" }}</span><span class="vital-unit">%</span></td>
                                        <td><span class="vital-value">{{ vitals.temperature|default:"-" }}</span><span class="vital-unit">°C</span></td>
                                        <td><span class="vital-value">{{ vitals.gcs|default:"-" }}</span></td>
                                        <td><span class="vital-value">{{ vitals.height|default:"-" }}</span></td>
                                        <td><span class="vital-value">{{ vitals.weight|default:"-" }}</span></td>
                                        <td><span class="vital-value">{{ vitals.bmi|default:"-" }}</span></td>
                                        <td>{{ vitals.recorded_by.get_full_name|default:"System" }}</td>
                                        <td>{{ vitals.recorded_at|date:"d-m-Y" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Clinical Notes Section -->
                {% with consultation_note=visit.consultation_notes.first diagnosis_record=visit.diagnosis_records.first %}
                {% if consultation_note %}
                <div class="card consult-prem-health-record-card mb-4">
                    <div class="card-header consult-prem-gradient">
                        <h6 class="card-title mb-0 text-center text-white">
                            <i class="fas fa-notes-medical mr-2"></i>CLINICAL NOTES
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="consult-prem-form-section">
                            <h6 class="consult-prem-section-title">Chief Complaints</h6>
                            <ul class="consult-prem-cc-list">
                                {% for complaint in visit.kahamachiefcomplaint_set.all %}
                                <li class="consult-prem-cc-item">
                                    <div class="consult-prem-cc-content">
                                        <div class="consult-prem-cc-text">
                                            <div class="consult-prem-cc-complaint">{{ complaint.health_record }}</div>
                                            <div class="consult-prem-cc-duration">Duration: {{ complaint.duration }}</div>
                                        </div>
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>

                        <div class="consult-prem-form-section">
                            <h6 class="consult-prem-section-title">History of Presenting Illness</h6>
                            <p>{{ consultation_note.history_of_presenting_illness }}</p>
                        </div>

                        {% if consultation_notes.pathology.all %}
                        <div class="consult-prem-form-section">
                            <h6 class="consult-prem-section-title">Pathology</h6>
                            <ul class="list-group">
                                {% for pathologies in consultation_notes.pathology.all %}
                                <li class="list-group-item">{{ pathologies.name }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        <div class="consult-prem-form-section">
                            <h6 class="consult-prem-section-title">Review of Systems</h6>
                            <p>{{ consultation_note.review_of_systems }}</p>
                        </div>

                        <div class="consult-prem-form-section">
                            <h6 class="consult-prem-section-title">Physical Examination</h6>
                            <p>{{ consultation_note.physical_examination }}</p>
                        </div>

                        <div class="consult-prem-form-section">
                            <h6 class="consult-prem-section-title">Doctor's Plan</h6>
                            <p><strong>{{ consultation_note.doctor_plan }}</strong>: {{ consultation_note.doctor_plan_note }}</p>
                        </div>
                        {% if diagnosis_record %}
                        <div class="consult-prem-form-section">
                            <h6 class="consult-prem-section-title">Provisional Diagnosis</h6>
                            <ul class="list-group">
                                {% for pdx in diagnosis_record.provisional_diagnosis.all %}
                                <li class="list-group-item">{{ pdx.diagnosis_name }}</li>
                                {% endfor %}
                            </ul>
                        </div>

                        <div class="consult-prem-form-section">
                            <h6 class="consult-prem-section-title">Final Diagnosis</h6>
                            <ul class="list-group">
                                {% for fdx in diagnosis_record.final_diagnosis.all %}
                                <li class="list-group-item">{{ fdx.diagnosis_name }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% endwith %}

                <!-- Laboratory Data Section -->
                {% if visit.laboratory_requests.all %}
                <div class="card consult-prem-health-record-card mb-4">
                    <div class="card-header consult-prem-gradient d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0 text-white">
                            <i class="fas fa-flask mr-2"></i>LABORATORY DATA
                        </h6>
                        <a href="{% url 'pemba_doctor_laboratory_download_all_results' patient.mrn visit.vst %}" class="btn btn-prem-consult-nav btn-sm">
                            <i class="fas fa-download mr-1"></i> Download PDF
                        </a>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table vitals-prem-table text-nowrap">
                                <thead>
                                    <tr>
                                        <th>Test</th>
                                        <th>Description</th>
                                        <th>Doctor</th>
                                        <th>Result</th>
                                        <th>Created</th>
                                        <th>Updated</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for lab in visit.laboratory_requests.all %}
                                    <tr>
                                        <td>{{ lab.name.name|default:"-" }}</td>
                                        <td>{{ lab.description|default:"-" }}</td>
                                        <td>{{ lab.doctor.get_full_name|default:"-" }}</td>
                                        <td>
                                            {% if lab.result %}
                                            <button class="btn btn-info btn-sm" data-toggle="modal" data-target="#resultModal{{ lab.id }}">
                                                View Result
                                            </button>
                                            {% else %}
                                            <em>No result</em>
                                            {% endif %}
                                        </td>
                                        <td>{{ lab.created_at|date:"d-m-Y" }}</td>
                                        <td>{{ lab.updated_at|date:"d-m-Y" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}


        <!-- Procedure Data Section -->
                {% if visit.procedures.all %}
                <div class="card consult-prem-health-record-card mb-4">
                    <div class="card-header consult-prem-gradient d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0 text-white">
                            <i class="fas fa-procedures mr-2"></i>PROCEDURE DATA
                        </h6>
                        <a href="{% url 'pemba_doctor_procedure_download_all' patient.mrn visit.vst %}" class="btn btn-prem-consult-nav btn-sm">
                            <i class="fas fa-download mr-1"></i> Download PDF
                        </a>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table vitals-prem-table text-nowrap">
                                <thead>
                                    <tr>
                                        <th>Procedure</th>
                                        <th>Description</th>
                                        <th>Doctor</th>
                                        <th>Equipments Used</th>
                                        <th>Image</th>
                                        <th>Result</th>
                                        <th>Created</th>
                                        <th>Updated</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for procedure in visit.procedures.all %}
                                    <tr>
                                        <td>{{ procedure.name.name|default:"-" }}</td>
                                        <td>{{ procedure.description|default:"-" }}</td>
                                        <td>{{ procedure.doctor.get_full_name|default:"-" }}</td>
                                        <td>{{ procedure.equipments_used|default:"-" }}</td>
                                        <td>
                                            {% if procedure.image %}
                                                <img src="{{ procedure.image.url }}" alt="Procedure Image" style="width: 100px; height: auto;">
                                            {% else %}
                                                <span>-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if procedure.result %}
                                                <button class="btn btn-info btn-sm" data-toggle="modal" data-target="#procedureResultModal{{ procedure.id }}">
                                                    View Result
                                                </button>
                                            {% else %}
                                                <em>No result</em>
                                            {% endif %}
                                        </td>
                                        <td>{{ procedure.created_at|date:"d-m-Y" }}</td>
                                        <td>{{ procedure.updated_at|date:"d-m-Y" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}

        <!-- Observation Data Section -->
                {% if visit.observation_records.all %}
                <div class="card consult-prem-health-record-card mb-4">
                    <div class="card-header consult-prem-gradient d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0 text-white">
                            <i class="fas fa-clipboard-list mr-2"></i>OBSERVATION RECORDS
                        </h6>
                        <a href="{% url 'pemba_doctor_observation_download_pdf' patient.id visit.id %}" class="btn btn-prem-consult-nav btn-sm">
                            <i class="fas fa-download mr-1"></i> Download PDF
                        </a>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table vitals-prem-table text-nowrap">
                                <thead>
                                    <tr>
                                        <th>Observation Notes</th>
                                        <th>Recorded By</th>
                                        <th>Created At</th>
                                        <th>Updated At</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for observation in visit.observation_records.all %}
                                    <tr>
                                        <td>{{ observation.observation_notes|safe }}</td>
                                        <td>{{ observation.data_recorder.get_full_name|default:"System" }}</td>
                                        <td>{{ observation.created_at|date:"d-m-Y" }}</td>
                                        <td>{{ observation.updated_at|date:"d-m-Y" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}

       <!-- Prescription Data Section -->
          {% if visit.prescriptions.all %}
          <div class="card consult-prem-health-record-card mb-4">
              <div class="card-header consult-prem-gradient d-flex justify-content-between align-items-center">
                  <h6 class="card-title mb-0 text-white">
                      <i class="fas fa-pills mr-2"></i>PRESCRIPTION DATA
                  </h6>
                  <a href="{% url 'pemba_doctor_prescription_download_notes' patient.id visit.id %}" class="btn btn-prem-consult-nav btn-sm">
                      <i class="fas fa-download mr-1"></i> Download PDF
                  </a>
              </div>
              <div class="card-body">
                  <div class="table-responsive">
                      <table class="table vitals-prem-table text-nowrap">
                          <thead>
                              <tr>
                                  <th>Medicine</th>
                                  <th>Dose</th>
                                  <th>Frequency</th>
                                  <th>Duration</th>
                                  <th>Quantity</th>
                                  <th>Entered By</th>
                                  <th>Created At</th>
                              </tr>
                          </thead>
                          <tbody>
                              {% for prescription in visit.prescriptions.all %}
                              <tr>
                                  <td>{{ prescription.medicine.drug_name }}</td>
                                  <td>{{ prescription.dose }}</td>
                                  <td>{{ prescription.frequency }}</td>
                                  <td>{{ prescription.duration }}</td>
                                  <td>{{ prescription.quantity_used }}</td>
                                  <td>{{ prescription.entered_by.get_full_name|default:"System" }}</td>
                                  <td>{{ prescription.created_at|date:"d-m-Y" }}</td>
                              </tr>
                              {% endfor %}
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>
          {% endif %}

        <!-- Counseling Data Section -->
                {% if visit.counselings.all %}
                <div class="card consult-prem-health-record-card mb-4">
                    <div class="card-header consult-prem-gradient d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0 text-white">
                            <i class="fas fa-comments mr-2"></i>COUNSELING NOTES
                        </h6>
                        <a href="{% url 'pemba_doctor_counseling_download_pdf' patient.id visit.id %}" class="btn btn-prem-consult-nav btn-sm">
                            <i class="fas fa-download mr-1"></i> Download PDF
                        </a>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table vitals-prem-table text-nowrap">
                                <thead>
                                    <tr>
                                        <th>Recorder</th>
                                        <th>Notes</th>
                                        <th>Created</th>
                                        <th>Updated</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for session in visit.counselings.all %}
                                    <tr>
                                        <td>{{ session.data_recorder.get_full_name|default:"System" }}</td>
                                        <td>
                                            {% if session.counselling_notes %}
                                            <div style="max-width: 400px; max-height: 200px; overflow:auto;">
                                                {{ session.counselling_notes|safe }}
                                            </div>
                                            {% else %}
                                            <em>No notes recorded.</em>
                                            {% endif %}
                                        </td>
                                        <td>{{ session.created_at|date:"d-m-Y" }}</td>
                                        <td>{{ session.updated_at|date:"d-m-Y" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}

        <!-- Referral Data Section -->
                {% if visit.referrals.all %}
                <div class="card consult-prem-health-record-card mb-4">
                    <div class="card-header consult-prem-gradient d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0 text-white">
                            <i class="fas fa-hospital-user mr-2"></i>REFERRAL DETAILS
                        </h6>
                        <a href="{% url 'pemba_doctor_referral_download' patient.id visit.id %}" class="btn btn-prem-consult-nav btn-sm">
                            <i class="fas fa-download mr-1"></i> Download PDF
                        </a>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table vitals-prem-table text-nowrap">
                                <thead>
                                    <tr>
                                        <th>Source Location</th>
                                        <th>Destination Location</th>
                                        <th>Nature of Referral</th>
                                        <th>Transport Model</th>
                                        <th>Notes</th>
                                        <th>Status</th>
                                        <th>Recorded By</th>
                                        <th>Created At</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for referral in visit.referrals.all %}
                                    <tr>
                                        <td>{{ referral.source_location|default:"-" }}</td>
                                        <td>{{ referral.destination_location|default:"-" }}</td>
                                        <td>{{ referral.get_nature_of_referral_display|default:"-" }}</td>
                                        <td>{{ referral.get_transport_model_display|default:"-" }}</td>
                                        <td>{{ referral.notes|safe|default:"-" }}</td>
                                        <td>
                                            <span class="badge badge-{{ referral.get_status_color }}">
                                                {{ referral.get_status_display }}
                                            </span>
                                        </td>
                                        <td>{{ referral.data_recorder.get_full_name|default:"System" }}</td>
                                        <td>{{ referral.created_at|date:"d-m-Y" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}

          <!-- Discharge Data Section -->
                {% if visit.discharge_notes.all %}
                <div class="card consult-prem-health-record-card mb-4">
                    <div class="card-header consult-prem-gradient d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0 text-white">
                            <i class="fas fa-sign-out-alt mr-2"></i>DISCHARGE NOTES
                        </h6>
                        <a href="{% url 'pemba_doctor_discharge_download_pdf' patient.id visit.id %}" class="btn btn-prem-consult-nav btn-sm">
                            <i class="fas fa-download mr-1"></i> Download PDF
                        </a>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table vitals-prem-table text-nowrap">
                                <thead>
                                    <tr>
                                        <th>Discharge Condition</th>
                                        <th>Discharge Notes</th>
                                        <th>Recorded By</th>
                                        <th>Discharge Date</th>
                                        <th>Last Updated</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for discharge in visit.discharge_notes.all %}
                                    <tr>
                                        <td>{{ discharge.discharge_condition|default:"-" }}</td>
                                        <td>{{ discharge.discharge_notes|safe|default:"-" }}</td>
                                        <td>{{ discharge.data_recorder.get_full_name|default:"System" }}</td>
                                        <td>{{ discharge.discharge_date|date:"d-m-Y" }}</td>
                                        <td>{{ discharge.updated_at|date:"d-m-Y" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}
      </div>
    </div>
  </div>
  </div>
{% endfor %}

<!-- Lab Result Modals -->
{% for visit in patient_visits %}
{% for lab in visit.laboratory_requests.all %}
{% if lab.result %}
<div class="modal fade consult-prem-modal" id="resultModal{{ lab.id }}" tabindex="-1" role="dialog" aria-labelledby="resultModalLabel{{ lab.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
        <div class="modal-content consult-prem-modal-content">
            <div class="modal-header consult-prem-modal-header">
                <div class="d-flex justify-content-between align-items-center w-100">
                    <h5 class="modal-title mb-0" id="resultModalLabel{{ lab.id }}">
                        <i class="fas fa-file-medical mr-2"></i>Lab Result: {{ lab.name.name|default:"Test" }}
                    </h5>
                    <a href="{% url 'pemba_doctor_laboratory_download_result' lab.id %}" class="btn btn-prem-consult-nav">
                        <i class="fas fa-download mr-1"></i> Download Result
                    </a>
                </div>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                {{ lab.result|safe }}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-prem-consult" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}
{% endfor %}

<!-- Procedure Result Modals -->
{% for visit in patient_visits %}
{% for procedure in visit.procedures.all %}
{% if procedure.result %}
<div class="modal fade consult-prem-modal" id="procedureResultModal{{ procedure.id }}" tabindex="-1" role="dialog" aria-labelledby="procedureResultModalLabel{{ procedure.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
        <div class="modal-content consult-prem-modal-content">
            <div class="modal-header consult-prem-modal-header">
                <div class="d-flex justify-content-between align-items-center w-100">
                    <h5 class="modal-title mb-0" id="procedureResultModalLabel{{ procedure.id }}">
                        <i class="fas fa-procedures mr-2"></i>Procedure Result: {{ procedure.name.name|default:"Procedure" }}
                    </h5>
                    <a href="{% url 'pemba_doctor_procedure_download_result' procedure.id %}" class="btn btn-prem-consult-nav">
                        <i class="fas fa-download mr-1"></i> Download Result
                    </a>
                </div>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                {{ procedure.result|safe }}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-prem-consult" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}
{% endfor %}




<div class="container-fluid">
<div class="row">
    <div class="col-md-12">
        <!-- Premium Patient Information Card -->
        <div class="card consult-prem-patient-card">
            <div class="card-header consult-prem-gradient">
                <h5 class="card-title text-center text-white mb-0">
                    <i class="fas fa-user-injured mr-2"></i>PATIENT INFORMATION
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Patient Name -->
                    <div class="col-md-3 consult-prem-patient-info">
                        <div class="d-flex align-items-center mb-3">
                            <span class="consult-prem-status-indicator consult-prem-status-normal mr-2"></span>
                            <div>
                                <span class="text-muted consult-prem-summary-label">PATIENT</span>
                                <div class="consult-prem-summary-value" style="font-size: 1.2rem;">
                                    {{ patient.first_name }} {{ patient.middle_name }} {{ patient.last_name }}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Date of Birth & Age -->
                    <div class="col-md-3 consult-prem-patient-info">
                        <div class="d-flex align-items-center mb-3">
                            <span class="consult-prem-status-indicator consult-prem-status-normal mr-2"></span>
                            <div>
                                <span class="text-muted consult-prem-summary-label">DOB & AGE</span>
                                <div class="consult-prem-summary-value" style="font-size: 1.2rem;">
                                    {{ patient.dob|date:'d-m-Y' }} 
                                    [{% if patient.dob %}
                                    <script>
                                        var dob = new Date("{{ patient.dob|date:'Y-m-d' }}");
                                        var now = new Date();
                                        var ageMilliseconds = now - dob;
                                        var ageSeconds = ageMilliseconds / 1000;
                                        var ageYears = Math.floor(ageSeconds / (365.25 * 24 * 60 * 60));
                                        document.write(ageYears + ' years');
                                    </script>
                                    {% else %}
                                    {{ patient.age }}
                                    {% endif %}]
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gender -->
                    <div class="col-md-3 consult-prem-patient-info">
                        <div class="d-flex align-items-center mb-3">
                            <span class="consult-prem-status-indicator consult-prem-status-normal mr-2"></span>
                            <div>
                                <span class="text-muted consult-prem-summary-label">GENDER</span>
                                <div class="consult-prem-summary-value" style="font-size: 1.2rem;">
                                    {{ patient.gender }}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Medical Record Number -->
                    <div class="col-md-3 consult-prem-patient-info">
                        <div class="d-flex align-items-center mb-3">
                            <span class="consult-prem-status-indicator consult-prem-status-normal mr-2"></span>
                            <div>
                                <span class="text-muted consult-prem-summary-label">FILE NO</span>
                                <div class="consult-prem-summary-value" style="font-size: 1.2rem;">
                                    {{ patient.mrn }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <!-- Company/Insurance -->
                    <div class="col-md-3 consult-prem-patient-info">
                        <div class="d-flex align-items-center">
                            <span class="consult-prem-status-indicator consult-prem-status-warning mr-2"></span>
                            <div>
                                <span class="text-muted consult-prem-summary-label">COMPANY/INSURANCE</span>
                                <div class="consult-prem-summary-value" style="font-size: 1.2rem;">
                                    {{ patient.company }}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Visit Number -->
                    <div class="col-md-3 consult-prem-patient-info">
                        <div class="d-flex align-items-center">
                            <span class="consult-prem-status-indicator consult-prem-status-normal mr-2"></span>
                            <div>
                                <span class="text-muted consult-prem-summary-label">VISIT NUMBER</span>
                                <div class="consult-prem-summary-value" style="font-size: 1.2rem;">
                                    {{ visit.vst }}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Visit Date -->
                    <div class="col-md-3 consult-prem-patient-info">
                        <div class="d-flex align-items-center">
                            <span class="consult-prem-status-indicator consult-prem-status-normal mr-2"></span>
                            <div>
                                <span class="text-muted consult-prem-summary-label">VISIT DATE</span>
                                <div class="consult-prem-summary-value" style="font-size: 1.2rem;">
                                    {{ visit.created_at|date:"d-m-Y" }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Premium Vitals Section -->
<div class="row">
    <div class="col-md-12">
        <div class="card consult-prem-health-record-card">
            <div class="card-header">
                <h5 class="card-title mb-0 text-center">
                    <i class="fas fa-heartbeat mr-2"></i>VITAL SIGNS
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table vitals-prem-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>BP</th>
                                <th>HR</th>
                                <th>RR</th>
                                <th>SPO2</th>
                                <th>TEMP</th>
                                <th>Height</th>
                                <th>Weight</th>
                                <th>BMI</th>
                                <th>GCS</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vital in patient_vitals %}
                                <tr>
                                    <td>{{ vital.updated_at|time:"H:i" }}</td>
                                    <td><span class="vital-value">{{ vital.blood_pressure }}</span> <span class="vital-unit">mmHg</span></td>
                                    <td><span class="vital-value">{{ vital.pulse_rate }}</span> <span class="vital-unit">bpm</span></td>
                                    <td><span class="vital-value">{{ vital.respiratory_rate }}</span> <span class="vital-unit">bpm</span></td>
                                    <td><span class="vital-value">{{ vital.spo2 }}</span> <span class="vital-unit">%</span></td>
                                    <td><span class="vital-value">{{ vital.temperature }}</span> <span class="vital-unit">°C</span></td>
                                    <td>
                                        {% if vital.height %}
                                            <span class="vital-value">{{ vital.height }}</span> <span class="vital-unit">cm</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if vital.weight %}
                                            <span class="vital-value">{{ vital.weight }}</span> <span class="vital-unit">kg</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if vital.bmi %}
                                            {% if vital.bmi < 18.5 %}
                                                <span class="vital-bmi-indicator bmi-underweight"></span>
                                            {% elif vital.bmi >= 18.5 and vital.bmi < 25 %}
                                                <span class="vital-bmi-indicator bmi-normal"></span>
                                            {% elif vital.bmi >= 25 and vital.bmi < 30 %}
                                                <span class="vital-bmi-indicator bmi-overweight"></span>
                                            {% else %}
                                                <span class="vital-bmi-indicator bmi-obese"></span>
                                            {% endif %}
                                            <span class="vital-value">{{ vital.bmi|floatformat:1 }}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td><span class="vital-value">{{ vital.gcs }}</span></td>
                                    <td>
                                        {% if vital.doctor == request.user.staff %}
                                        <a href="#" class="btn btn-info btn-xs btn-labeled" type="button" data-toggle="modal" data-target="#editPatientVitalModal{{ vital.id }}">
                                            <i class="fas fa-edit"></i> Edit
                                        </a>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="11" class="text-center">No vitals recorded yet</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="text-right mt-3">
                    <button class="btn btn-prem-consult" data-toggle="modal" data-target="#addPatientVitalModal">
                        <i class="fas fa-plus-circle mr-2"></i> Add New Vitals
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chief Complaints Section -->
<div class="row">
    <div class="col-md-12">
        <div class="card consult-prem-health-record-card">
            <div class="card-header">
                <h5 class="card-title mb-0 text-center">
                    <i class="fas fa-stethoscope mr-2"></i>CHIEF COMPLAINTS
                </h5>
            </div>
            <div class="card-body">
                <div class="consult-prem-chief-complaints">
                    <div class="consult-prem-cc-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-stethoscope mr-2"></i>CHIEF COMPLAINTS</h6>
                        <div>                         
                            <button id="toggleEditChiefComplaints" class="consult-prem-cc-toggle">
                                <i class="fas fa-edit mr-1"></i> <span id="toggleEditText">Edit</span>
                            </button>                         
                        </div>
                    </div>
                    
                    <!-- Alert container for messages -->
                    <div id="ccAlertContainer" class="consult-prem-cc-alert" style="display: none;"></div>
                    
                    <!-- Display Mode (View Only) -->
                    <div id="chiefComplaintsDisplay">
                        <ul id="chiefComplaintsList" class="consult-prem-cc-list">
                            <!-- Complaints will be populated here -->
                        </ul>
                        
                        <div class="text-center mt-3" id="ccEmptyState" style="display: none;">
                            <i class="fas fa-clipboard-list fa-3x text-muted mb-2"></i>
                            <p class="text-muted">No chief complaints recorded yet.</p>
                        
                            <button id="addFirstComplaintBtn" class="consult-prem-cc-add-btn">
                                <i class="fas fa-plus-circle mr-1"></i> Add First Complaint
                            </button>
                         
                        </div>
                    </div>
                    
                    <!-- Edit Mode -->
                    <div id="chiefComplaintsEdit" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="consult-prem-cc-form-title mb-0">Edit Chief Complaints</h6>
                            <button id="addNewComplaintBtn" class="consult-prem-cc-add-btn">
                                <i class="fas fa-plus-circle mr-1"></i> Add New
                            </button>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="consult-prem-cc-table">
                                <thead>
                                    <tr>
                                        <th width="45%">Chief Complaint</th>
                                        <th width="35%">Duration</th>
                                        <th width="20%">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="ccEditTableBody">
                                    <!-- Rows will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="d-flex justify-content-end gap-2 mt-3">
                            <button id="exitEditModeBtn" class="btn btn-secondary">
                                <i class="fas fa-times mr-1"></i> Exit Edit Mode
                            </button>
                        </div>
                    </div>
                    
                    <!-- Add New Complaint Form (initially hidden) -->
                    <div id="ccAddForm" class="consult-prem-cc-form" style="display: none;">
                        <h6 class="consult-prem-cc-form-title">Add New Chief Complaint</h6>
                        
                        <div class="row">
                            <div class="col-md-5">
                                <div class="form-group">
                                    <label for="ccComplaintSelect">Complaint</label>
                                    <select class="form-control select2bs4 consult-prem-cc-input" id="ccComplaintSelect" style="width: 100%;">
                                        <option value="">Select a complaint</option>
                                        {% for health_record in health_records %}
                                            <option value="{{ health_record.id }}">{{ health_record.name }}</option>
                                        {% endfor %}
                                        <option value="other">Other (specify)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="col-md-5">
                                <div class="form-group">
                                    <label for="ccDurationInput">Duration</label>
                                    <input type="text" class="form-control consult-prem-cc-input" id="ccDurationInput" placeholder="e.g., 3 days, 1 week">
                                </div>
                            </div>
                            
                            <div class="col-md-2 d-flex align-items-end">
                                <button id="saveNewComplaintBtn" class="btn btn-primary w-100">
                                    <i class="fas fa-plus mr-1"></i> Add
                                </button>
                            </div>
                        </div>
                        
                        <div id="ccOtherInputContainer" class="form-group mt-2" style="display: none;">
                            <label for="ccOtherInput">Other Complaint</label>
                            <input type="text" class="form-control consult-prem-cc-input" id="ccOtherInput" placeholder="Specify other complaint">
                        </div>
                        
                        <div class="d-flex justify-content-end gap-2 mt-3">
                            <button id="cancelAddComplaintBtn" class="btn btn-secondary">
                                <i class="fas fa-times mr-1"></i> Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>              
                     
      <div class="row">
            <div class="col-md-6">
                <!-- Premium Consultation Notes Card -->
                <div class="card consult-prem-gradient">
                    <div class="card-header">
                        <h5 class="card-title mb-0 text-center text-white">
                            <i class="fas fa-notes-medical mr-2"></i>ADD CONSULTATION NOTES
                        </h5>
                    </div>
                    <div class="card-body consult-prem-form-container">
                        <form id="addConsultationForm" action="{% url 'pemba_doctor_consultation_save' patient.id visit.id %}" method="post">
                            {% csrf_token %}
                            <div class="container-fluid">
                                <!-- Consultation Text Areas -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="consult-prem-input-group">
                                            <label for="hpi">History of Presenting Illness (HPI):</label>
                                            <textarea class="form-control" id="hpi" name="history_of_presenting_illness" rows="10">{{ consultation_note.history_of_presenting_illness }}</textarea>
                                            
                                            <!-- Tabs Navigation -->
                                            <ul class="nav nav-tabs mt-3" id="hpiTab" role="tablist">
                                                <li class="nav-item">
                                                    <a class="nav-link active" id="general-tab" data-toggle="tab" href="#general" role="tab">General</a>
                                                </li>
                                                <li class="nav-item">
                                                    <a class="nav-link" id="resp-tab" data-toggle="tab" href="#resp" role="tab">Respiratory</a>
                                                </li>
                                                <li class="nav-item">
                                                    <a class="nav-link" id="abd-tab" data-toggle="tab" href="#abd" role="tab">Abdomen & GI</a>
                                                </li>
                                                <li class="nav-item">
                                                    <a class="nav-link" id="uro-tab" data-toggle="tab" href="#uro" role="tab">Urogenital</a>
                                                </li>
                                                <li class="nav-item">
                                                    <a class="nav-link" id="msk-tab" data-toggle="tab" href="#msk" role="tab">Musculoskeletal</a>
                                                </li>
                                                <li class="nav-item">
                                                    <a class="nav-link" id="derma-tab" data-toggle="tab" href="#derma" role="tab">Dermatology</a>
                                                </li>
                                            </ul>
                                            
                                            <!-- Tabs Content -->
                                            <div class="tab-content border border-top-0 p-3" id="hpiTabContent">
                                                <!-- General -->
                                                <div class="tab-pane fade show active" id="general" role="tabpanel">
                                                    <button type="button" class="consult-prem-symptom-button" data-toggle="modal" data-target="#feverModal">Fever</button>
                                                    <button type="button" class="consult-prem-symptom-button" data-toggle="modal" data-target="#headacheModal">Headache</button>
                                                    <button type="button" class="consult-prem-symptom-button" data-toggle="modal" data-target="#gbmModal">Generalized Malaise</button>
                                                </div>
                                                
                                                <!-- Respiratory -->
                                                <div class="tab-pane fade" id="resp" role="tabpanel">
                                                    <button type="button" class="consult-prem-symptom-button" data-toggle="modal" data-target="#fluModal">Flu</button>
                                                    <button type="button" class="consult-prem-symptom-button" data-toggle="modal" data-target="#coughModal">Cough</button>
                                                    <button type="button" class="consult-prem-symptom-button" data-toggle="modal" data-target="#dibModal">Difficulty in Breathing</button>
                                                    <button type="button" class="consult-prem-symptom-button" data-toggle="modal" data-target="#chestPainModal">Chest Pain</button>
                                                </div>
                                                
                                                <!-- Abdomen & GI -->
                                                <div class="tab-pane fade" id="abd" role="tabpanel">
                                                    <button type="button" class="consult-prem-symptom-button" data-toggle="modal" data-target="#gaseousDiscomfortModal">Gaseous Discomfort</button>
                                                    <button type="button" class="consult-prem-symptom-button" data-toggle="modal" data-target="#abdominalPainModal">Abdominal Pain</button>
                                                    <button type="button" class="consult-prem-symptom-button" data-toggle="modal" data-target="#lowerAbdPainModal">Lower Abdominal Pain</button>
                                                    <button type="button" class="consult-prem-symptom-button" data-toggle="modal" data-target="#constipationModal">Constipation</button>
                                                </div>
                                                
                                                <!-- Urogenital -->
                                                <div class="tab-pane fade" id="uro" role="tabpanel">
                                                    <button type="button" class="consult-prem-symptom-button" data-toggle="modal" data-target="#pvDischargeModal">PV Discharge</button>
                                                    <button type="button" class="consult-prem-symptom-button" data-toggle="modal" data-target="#painfulMicturitionModal">Painful Micturition</button>
                                                </div>
                                                
                                                <!-- Musculoskeletal -->
                                                <div class="tab-pane fade" id="msk" role="tabpanel">
                                                    <button type="button" class="consult-prem-symptom-button" data-toggle="modal" data-target="#backPainModal">Back Pain</button>
                                                    <button type="button" class="consult-prem-symptom-button" data-toggle="modal" data-target="#jointPainModal">Joint Pain</button>
                                                </div>
                                                
                                                <!-- Dermatology -->
                                                <div class="tab-pane fade" id="derma" role="tabpanel">
                                                    <button type="button" class="consult-prem-symptom-button" data-toggle="modal" data-target="#rashesModal">Rashes</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- ROS -->
                                    <div class="col-md-6">
                                        <div class="consult-prem-input-group">
                                            <label for="ros">Review of Other Systems (ROS):</label>
                                            <textarea class="form-control" id="ros" name="review_of_systems" rows="10" required>{{ consultation_note.review_of_systems|default:'' }}</textarea>
                                            <button type="button" class="btn btn-prem-consult-nav mt-2" data-toggle="modal" data-target="#rosModal">Edit in Modal</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Physical Examination -->
                                <div class="consult-prem-form-section mt-4">
                                    <h6 class="consult-prem-section-title">Physical Examination</h6>
                                    <div class="consult-prem-input-group">
                                        <label for="physical_examination">Physical Examination Notes:</label>
                                        <textarea class="form-control" id="physical_examination" name="physical_examination" rows="10" required>{{ consultation_note.physical_examination|default:'' }}</textarea>
                                        <button type="button" class="btn btn-prem-consult-nav mt-2" data-toggle="modal" data-target="#physicalExamModal">Edit in Modal</button>
                                    </div>
                                </div>
                                
                                <!-- Provisional Diagnosis -->
                                <div class="consult-prem-form-section">
                                    <div class="consult-prem-input-group">
                                        <label for="provisional_diagnosis_{{ consultation_note.id }}">Provisional Diagnosis: <span class="consult-prem-badge consult-prem-badge-required">Required</span></label>
                                        <select class="form-control select2bs4" id="provisional_diagnosis_{{ consultation_note.id }}" name="provisional_diagnosis[]" multiple required>
                                            {% for diagnosis in provisional_diagnoses %}
                                                <option value="{{ diagnosis.id }}" {% if diagnosis.id in provisional_diagnosis_ids %}selected{% endif %}>{{ diagnosis }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Pathology -->
                                <div class="consult-prem-form-section">
                                    <div class="consult-prem-input-group">
                                        <label for="pathology{{ consultation_note.id }}">Pathology: <span class="consult-prem-badge consult-prem-badge-required">Required</span></label>
                                        <select class="form-control select2bs4" style="width: 100%;"
                                                id="pathology{{ consultation_note.id }}"
                                                name="pathology[]" required multiple>
                                            {% for record in pathology_records %}
                                                <option value="{{ record.id }}" {% if record in consultation_note.pathology.all %}selected{% endif %}>{{ record.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Doctor Plan Note -->
                                <div class="consult-prem-form-section">
                                    <div class="consult-prem-input-group">
                                        <label for="doctor_plan_note">Doctor Plan Note: <span class="consult-prem-badge consult-prem-badge-required">Required</span></label>
                                        <textarea class="form-control" id="doctor_plan_note" name="doctor_plan_note" rows="2" required>{{ consultation_note.doctor_plan_note|default:'' }}</textarea>
                                    </div>
                                </div>
                                
                                <!-- Doctor's Plan -->
                                <div class="consult-prem-form-section">
                                    <div class="consult-prem-input-group">
                                        <label for="doctor_plan">Doctor Plan: <span class="consult-prem-badge consult-prem-badge-required">Required</span></label>
                                        <select class="form-control select2bs4" style="width: 100%;" id="doctor_plan" name="doctor_plan" 
                                                {% if consultation_note.doctor_plan == 'Referral' and previous_referrals %} disabled 
                                                {% elif consultation_note.doctor_plan == 'Discharge' and previous_discharges %} disabled 
                                                {% endif %} required>
                                            <option value="">Select Doctor Plan</option>
                                            <option value="Prescription" {% if consultation_note.doctor_plan == 'Prescription' %} selected {% endif %}>Prescription</option>
                                            <option value="Laboratory" {% if consultation_note.doctor_plan == 'Laboratory' %} selected {% endif %}>Laboratory</option>
                                            <option value="Procedure" {% if consultation_note.doctor_plan == 'Procedure' %} selected {% endif %}>Procedure</option>
                                            <option value="Observation" {% if consultation_note.doctor_plan == 'Observation' %} selected {% endif %}>Observation</option>
                                            <option value="Referral" {% if consultation_note.doctor_plan == 'Referral' %} selected {% endif %}>Referral</option>
                                            <option value="Counselling" {% if consultation_note.doctor_plan == 'Counselling' %} selected {% endif %}>Counselling</option>
                                            <option value="Discharge" {% if consultation_note.doctor_plan == 'Discharge' %} selected {% endif %}>Discharge</option>
                                        </select>
                                        
                                        {% if consultation_note.doctor_plan == 'Referral' and previous_referrals %}
                                        <input type="hidden" name="doctor_plan" value="{{ consultation_note.doctor_plan }}">
                                        {% elif consultation_note.doctor_plan == 'Discharge' and previous_discharges %}
                                        <input type="hidden" name="doctor_plan" value="{{ consultation_note.doctor_plan }}">
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Submit Button -->
                                <div class="consult-prem-form-section">
                                    <button type="submit" class="btn btn-prem-consult">
                                        <i class="fas fa-save mr-2"></i>Save & Continue
                                    </button>
                                </div>
                                
                                <!-- Messages -->
                                <div class="consult-prem-form-section">
                                    {% if messages %}
                                    <div class="row">
                                        <div class="col-12">
                                            {% for message in messages %}
                                            {% if message.tags == 'error' %}
                                            <div class="alert alert-danger alert-message">{{ message }}</div>
                                            {% elif message.tags == 'success' %}
                                            <div class="alert alert-primary alert-message">{{ message }}</div>
                                            {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <!-- Premium Patient Health Records Card -->
                <div class="card consult-prem-health-record-card">
                    <div class="card-header consult-prem-gradient">
                        <h5 class="card-title text-center text-white mb-0">
                            <i class="fas fa-medkit mr-2"></i>PATIENT HEALTH RECORDS
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Health Condition -->
                        {% if health_conditions %}
                        <div class="card consult-prem-summary-card mb-3">
                            <div class="card-header">
                                <h6 class="header-title text-center mb-0 text-uppercase">
                                    <i class="fas fa-stethoscope mr-2"></i>Chronic Illness Conditions
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table vitals-prem-table">
                                        <thead>
                                            <tr>
                                                <th>Chronic Illness</th>
                                                <th>Details</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for health_condition in health_conditions %}
                                            <tr>
                                                <td><span class="vital-value">{{ health_condition.health_condition }}</span></td>
                                                <td>{{ health_condition.health_condition_notes }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Medication Allergies -->
                        {% if allergies %}
                        <div class="card consult-prem-summary-card mb-3">
                            <div class="card-header">
                                <h6 class="header-title text-center mb-0 text-uppercase">
                                    <i class="fas fa-allergies mr-2"></i>Medication Allergies
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table vitals-prem-table">
                                        <thead>
                                            <tr>
                                                <th>Drug Name</th>
                                                <th>Reaction Details</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for allergy in allergies %}
                                            <tr>
                                                <td><span class="vital-value">{{ allergy.medicine_name }}</span></td>
                                                <td>{{ allergy.reaction }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Family Medical History -->
                        {% if family_history %}
                        <div class="card consult-prem-summary-card mb-3">
                            <div class="card-header">
                                <h6 class="header-title text-center mb-0 text-uppercase">
                                    <i class="fas fa-users mr-2"></i>Family Medical History
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table vitals-prem-table">
                                        <thead>
                                            <tr>
                                                <th>Condition</th>
                                                <th>Relationship</th>
                                                <th>Comments</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for history in family_history %}
                                            <tr>
                                                <td><span class="vital-value">{{ history.condition }}</span></td>
                                                <td>{{ history.relationship }}</td>
                                                <td>{{ history.comments }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Patient Surgery Information -->
                        {% if patient_surgeries %}
                        <div class="card consult-prem-summary-card mb-3">
                            <div class="card-header">
                                <h6 class="header-title text-center mb-0 text-uppercase">
                                    <i class="fas fa-procedures mr-2"></i>Surgical History
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table vitals-prem-table">
                                        <thead>
                                            <tr>
                                                <th>Surgery Name</th>
                                                <th>Surgery Date</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for surgery in patient_surgeries %}
                                            <tr>
                                                <td><span class="vital-value">{{ surgery.surgery_name }}</span></td>
                                                <td>{{ surgery.surgery_date }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Lifestyle Behaviors -->
                        {% if "yes" in behaviors.weekly_exercise_frequency or "yes" in behaviors.alcohol_consumption or "yes" in behaviors.smoking or "yes" in behaviors.healthy_diet or "yes" in behaviors.stress_management or "yes" in behaviors.sufficient_sleep %}
                        <div class="card consult-prem-summary-card">
                            <div class="card-header">
                                <h6 class="header-title text-center mb-0 text-uppercase">
                                    <i class="fas fa-heartbeat mr-2"></i>Lifestyle Behaviors
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    {% if behaviors.weekly_exercise_frequency == "yes" %}
                                    <div class="col-md-6 mb-2">
                                        <div class="consult-prem-patient-info">
                                            <span class="consult-prem-status-indicator consult-prem-status-normal mr-2"></span>
                                            <span>Regular Exercise</span>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if behaviors.smoking == "yes" %}
                                    <div class="col-md-6 mb-2">
                                        <div class="consult-prem-patient-info">
                                            <span class="consult-prem-status-indicator consult-prem-status-danger mr-2"></span>
                                            <span>Smoking</span>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if behaviors.alcohol_consumption == "yes" %}
                                    <div class="col-md-6 mb-2">
                                        <div class="consult-prem-patient-info">
                                            <span class="consult-prem-status-indicator consult-prem-status-warning mr-2"></span>
                                            <span>Alcohol Consumption</span>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if behaviors.healthy_diet == "yes" %}
                                    <div class="col-md-6 mb-2">
                                        <div class="consult-prem-patient-info">
                                            <span class="consult-prem-status-indicator consult-prem-status-normal mr-2"></span>
                                            <span>Healthy Diet</span>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if behaviors.stress_management == "yes" %}
                                    <div class="col-md-6 mb-2">
                                        <div class="consult-prem-patient-info">
                                            <span class="consult-prem-status-indicator consult-prem-status-warning mr-2"></span>
                                            <span>Stress Management</span>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if behaviors.sufficient_sleep == "yes" %}
                                    <div class="col-md-6 mb-2">
                                        <div class="consult-prem-patient-info">
                                            <span class="consult-prem-status-indicator consult-prem-status-normal mr-2"></span>
                                            <span>Sufficient Sleep</span>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Empty State (if no records) -->
                        {% if not health_conditions and not allergies and not family_history and not patient_surgeries and not behaviors %}
                        <div class="text-center py-4">
                            <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No health records available for this patient.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
           
            </div>          
         
        </div>
    </div>

    <script>
    // Fade out alerts after 5 seconds (5000ms)
    setTimeout(function() {
        document.querySelectorAll('.alert-message').forEach(function(el) {
            el.style.transition = 'opacity 0.5s ease-out';
            el.style.opacity = '0';
            setTimeout(() => el.style.display = 'none', 500);
        });
    }, 5000);
</script>


<div class="modal fade" id="abdominalPainModal" tabindex="-1" role="dialog" aria-labelledby="abdominalPainModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content shadow-lg rounded">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="abdominalPainModalLabel">Abdominal Pain Details</h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <form id="abdominalPainForm">
          <div class="container-fluid">
            <div class="row g-3">
              <!-- Duration -->
              <div class="col-md-6">
                <label for="abdPainDuration" class="form-label">Duration (days):</label>
                <input type="number" class="form-control" id="abdPainDuration" placeholder="e.g. 4">
              </div>

              <!-- Pain Type -->
              <div class="col-md-6">
                <label for="painType" class="form-label">Pain Type:</label>
                <select class="form-control select2bs4" id="painType"  style="width: 100%;">
                  <option>dull</option>
                  <option>sharp</option>
                  <option>burning</option>
                </select>
              </div>

              <!-- Pain Timing -->
              <div class="col-md-6">
                <label for="painTiming" class="form-label">Pain Timing:</label>
                <select class="form-control select2bs4"  style="width: 100%;" id="painTiming">
                  <option value="none">No specific periodicity</option>
                  <option value="during">More during meals</option>
                  <option value="after">More after meals</option>
                  <option value="empty">More when on empty stomach</option>
                </select>
              </div>

              <!-- Pain Relief -->
              <div class="col-md-6">
                <label for="painRelief" class="form-label">Pain Relief:</label>
                <select class="form-control select2bs4"  style="width: 100%;" id="painRelief">
                  <option value="food">Relieved by food</option>
                  <option value="empty">Relieved on empty stomach</option>
                  <option value="both">Relieved by both food and empty stomach</option>
                  <option value="none">Not relieved</option>
                </select>
              </div>

              <!-- Diarrhoea Type -->
              <div class="col-md-6">
                <label for="diarrhoeaType" class="form-label">Diarrhoea Type:</label>
                <select class="form-control select2bs4"  style="width: 100%;" id="diarrhoeaType">
                  <option value="none">No diarrhoea</option>
                  <option value="mucoid">Mucoid</option>
                  <option value="watery">Watery</option>
                </select>
              </div>

              <!-- Diarrhoea Blood -->
              <div class="col-md-6">
                <label for="diarrhoeaBlood" class="form-label">Diarrhoea Associated with Blood?</label>
                <select class="form-control select2bs4"  style="width: 100%;" id="diarrhoeaBlood">
                  <option value="no">No</option>
                  <option value="yes">Yes</option>
                </select>
              </div>

              <!-- Constipation Associated -->
              <div class="col-md-6">
                <label for="constipationAssociated" class="form-label">Associated with Constipation?</label>
                <select class="form-control select2bs4"  style="width: 100%;" id="constipationAssociated">
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              </div>
            </div>

            <!-- Submit button -->
            <div class="row mt-4">
              <div class="col text-center">
                <button type="button" class="btn btn-success px-5" onclick="generateAbdPain()">Add to HPI</button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
function generateAbdPain() {
  const days = document.getElementById("abdPainDuration").value;
  const painType = document.getElementById("painType").value;
  const painTiming = document.getElementById("painTiming").value;
  const painRelief = document.getElementById("painRelief").value;
  const diarrhoeaType = document.getElementById("diarrhoeaType").value;
  const diarrhoeaBlood = document.getElementById("diarrhoeaBlood").value;
  const constipation = document.getElementById("constipationAssociated").value;

  let timingText = "";
  if (painTiming === "none") timingText = "has no specific periodicity";
  else if (painTiming === "during") timingText = "is more during meals";
  else if (painTiming === "after") timingText = "is more after meals";
  else if (painTiming === "empty") timingText = "is more when on empty stomach";

  let reliefText = "";
  if (painRelief === "food") reliefText = "The pain is relieved by intake of food.";
  else if (painRelief === "empty") reliefText = "The pain is relieved when on an empty stomach.";
  else if (painRelief === "both") reliefText = "The pain is relieved by both food intake and when on empty stomach.";
  else reliefText = "The pain is not relieved by either food or posture.";

  let diarrhoeaText = "";
  if (diarrhoeaType === "none") {
    diarrhoeaText = "There is no history of diarrhoea.";
  } else {
    const bloodText = diarrhoeaBlood === "yes" ? "and is associated with blood" : "and is not associated with blood";
    diarrhoeaText = `There is also history of diarrhoea that is nonspecific in periodicity and is ${diarrhoeaType} in nature ${bloodText}.`;
  }

  const constipationText = constipation === "yes"
    ? "The abdominal pain is associated with constipation."
    : "The abdominal pain is not associated with constipation.";

  const sentence = `The patient has had abdominal pain that has been there for ${days} days, and this has been more generalised and non-radiating. The pain is described as ${painType} in nature and ${timingText}. ${reliefText} ${diarrhoeaText} ${constipationText}`;

  appendToHPI(sentence);
  $('#abdominalPainModal').modal('hide');
}

function appendToHPI(text) {
  const hpiField = document.getElementById("hpi");
  hpiField.value += (hpiField.value ? "\n" : "") + text;
}
</script>

<div class="modal fade" id="lowerAbdPainModal" tabindex="-1" role="dialog" aria-labelledby="lowerAbdPainModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content shadow-lg rounded">
      <div class="modal-header bg-secondary text-white">
        <h5 class="modal-title" id="lowerAbdPainModalLabel">Lower Abdominal Pain Details</h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <form id="lowerAbdPainForm">
          <div class="container-fluid">
            <div class="row g-3">
              <!-- Duration -->
              <div class="col-md-6">
                <label for="lowerAbdDuration" class="form-label">Duration (days):</label>
                <input type="number" class="form-control" id="lowerAbdDuration" placeholder="e.g. 3">
              </div>

              <!-- Discharge -->
              <div class="col-md-6">
                <label for="dischargePresence" class="form-label">Discharge Present?</label>
                <select  class="form-control select2bs4"  style="width: 100%;"  id="dischargePresence">
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              </div>

              <!-- Foul Smell -->
              <div class="col-md-6">
                <label for="foulSmell" class="form-label">Foul Smell Present?</label>
                <select class="form-control select2bs4"  style="width: 100%;" id="foulSmell">
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              </div>

              <!-- Pessary -->
              <div class="col-md-6">
                <label for="pessaryUsed" class="form-label">Vaginal Pessary Used?</label>
                <select class="form-control select2bs4"  style="width: 100%;" id="pessaryUsed">
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              </div>

              <!-- Cream -->
              <div class="col-md-6">
                <label for="creamUsed" class="form-label">Vaginal Cream Used?</label>
                <select class="form-control select2bs4"  style="width: 100%;" id="creamUsed">
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              </div>

              <!-- Improvement -->
              <div class="col-md-6">
                <label for="improvement" class="form-label">Improvement Observed?</label>
                <select class="form-control select2bs4"  style="width: 100%;" id="improvement">
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              </div>
            </div>

            <!-- Submit button -->
            <div class="row mt-4">
              <div class="col text-center">
                <button type="button" class="btn btn-success px-5" onclick="generateLowerAbdPain()">Add to HPI</button>
              </div>
            </div>
          </div>
        </form>
      </div>

    </div>
  </div>
</div>


<script>
  function generateLowerAbdPain() {
  const days = document.getElementById("lowerAbdDuration").value;
  const discharge = document.getElementById("dischargePresence").value;
  const smell = document.getElementById("foulSmell").value;
  const pessary = document.getElementById("pessaryUsed").value;
  const cream = document.getElementById("creamUsed").value;
  const improvement = document.getElementById("improvement").value;

  let dischargeText = discharge === "yes"
    ? "She has also been experiencing discharge"
    : "She has not been experiencing discharge";

  let smellText = smell === "yes"
    ? "this has resulted in foul smell"
    : "there is no foul smell";

  let pessaryText = pessary === "yes"
    ? "She has used vaginal pessary"
    : "She has not used vaginal pessary";

  let creamText = cream === "yes"
    ? "and has also used vaginal cream"
    : "and has not used vaginal cream";

  let improvementText = improvement === "yes"
    ? "that has resulted in improvement."
    : "that has not resulted in improvement.";

  const sentence = `She has been experiencing lower abdominal pain that has been there for the past ${days} days, and this has resulted in pain at all times when moving and when not moving. ${dischargeText} and ${smellText}. ${pessaryText} ${creamText} ${improvementText}`;

  appendToHPI(sentence);
  $('#lowerAbdPainModal').modal('hide');
}

function appendToHPI(text) {
  const hpiField = document.getElementById("hpi");
  hpiField.value += (hpiField.value ? "\n" : "") + text;
}

</script>

<div class="modal fade" id="constipationModal" tabindex="-1" role="dialog" aria-labelledby="constipationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-md" role="document">
    <div class="modal-content shadow rounded">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title" id="constipationModalLabel">Constipation Details</h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <form id="constipationForm">
          <div class="container-fluid">
            <div class="row g-3">

              <!-- Duration -->
              <div class="col-md-12">
                <label for="constipationDuration" class="form-label">Duration (days):</label>
                <input type="number" class="form-control" id="constipationDuration" placeholder="e.g. 2">
              </div>

              <!-- Stool Consistency -->
              <div class="col-md-12">
                <label for="constipationStool" class="form-label">Stool Consistency:</label>
                <select class="form-control select2bs4"  style="width: 100%;" id="constipationStool">
                  <option value="very hard">Very Hard</option>
                  <option value="hard">Hard</option>
                  <option value="lumpy">Lumpy</option>
                </select>
              </div>

              <!-- History of Abdominal Pain -->
              <div class="col-md-12">
                <label for="constipationAbdominalPain" class="form-label">History of Abdominal Pain?</label>
                <select class="form-control select2bs4"  style="width: 100%;" id="constipationAbdominalPain">
                  <option value="no">No</option>
                  <option value="yes">Yes</option>
                </select>
              </div>

            </div>

            <!-- Submit Button -->
            <div class="row mt-4">
              <div class="col text-center">
                <button type="button" class="btn btn-success px-4" onclick="generateConstipation()">Add to HPI</button>
              </div>
            </div>

          </div>
        </form>
      </div>

    </div>
  </div>
</div>

<script>
  function generateConstipation() {
  const days = document.getElementById("constipationDuration").value;
  const stool = document.getElementById("constipationStool").value;
  const pain = document.getElementById("constipationAbdominalPain").value;

  let painText = pain === "yes" 
    ? "There is a history of abdominal pain." 
    : "There is no history of abdominal pain.";

  const sentence = `Patient has had constipation that has been there for the past ${days} days, and this is associated with ${stool} stool. ${painText}`;

  appendToHPI(sentence);
  $('#constipationModal').modal('hide');
}

function appendToHPI(text) {
  const hpiField = document.getElementById("hpi");
  hpiField.value += (hpiField.value ? "\n" : "") + text;
}

</script>
<div class="modal fade" id="pvDischargeModal" tabindex="-1" role="dialog" aria-labelledby="pvDischargeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content shadow-lg rounded">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="pvDischargeModalLabel">PV Discharge Details</h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <form id="pvDischargeForm">
          <div class="container-fluid">
            <div class="row g-3">

              <!-- Duration -->
              <div class="col-md-6">
                <label for="pvDuration" class="form-label">Duration (days):</label>
                <input type="number" class="form-control" id="pvDuration" placeholder="e.g. 5">
              </div>

              <!-- Nature of Discharge -->
              <div class="col-md-6">
                <label for="pvNature" class="form-label">Nature of Discharge:</label>
                <select class="form-control select2bs4"  style="width: 100%;" id="pvNature">
                  <option>Whitish</option>
                  <option>Yellowish</option>
                  <option>Greenish</option>
                </select>
              </div>

              <!-- Itching Duration -->
              <div class="col-md-6">
                <label for="pvItchingDuration" class="form-label">Itching Duration (days):</label>
                <input type="number" class="form-control" id="pvItchingDuration" placeholder="e.g. 2">
              </div>

              <!-- Associated with LAP -->
              <div class="col-md-6">
                <label for="pvLap" class="form-label">Associated with LAP:</label>
                <select class="form-control select2bs4"  style="width: 100%;" id="pvLap">
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              </div>

              <!-- Medication Used -->
              <div class="col-md-6">
                <label for="pvMedUsed" class="form-label">Topical Medication Used:</label>
                <select class="form-control select2bs4"  style="width: 100%;" id="pvMedUsed">
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              </div>

            </div>

            <!-- Submit Button -->
            <div class="row mt-4">
              <div class="col text-center">
                <button type="button" class="btn btn-success px-4" onclick="generatePVDischarge()">Generate</button>
              </div>
            </div>
          </div>
        </form>
      </div>

    </div>
  </div>
</div>


<script>
function generatePVDischarge() {
  const duration = document.getElementById("pvDuration").value;
  const nature = document.getElementById("pvNature").value;
  const itchingDays = document.getElementById("pvItchingDuration").value;
  const lap = document.getElementById("pvLap").value;
  const meds = document.getElementById("pvMedUsed").value;

  const lapText = lap === "yes" ? "associated with LAP" : "not associated with LAP";
  const medText = meds === "yes" ? "has been on topical medication" : "has not been on topical medication";

  const sentence = `She has been experiencing PV discharge that has been there for the past ${duration} days. The PV discharge is ${nature.toLowerCase()} in nature and also associated with PV itching for ${itchingDays} days. The PV itching is ${lapText} and not associated with severe scratching. She ${medText}, and has had no relief since the start of symptoms.`;

  appendToHPI(sentence);
  $('#pvDischargeModal').modal('hide');
}

</script>

<!-- Painful Micturition Modal -->
<div class="modal fade" id="painfulMicturitionModal" tabindex="-1" role="dialog" aria-labelledby="painfulMicturitionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-md" role="document">
    <div class="modal-content shadow-lg rounded">
      
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="painfulMicturitionModalLabel">Painful Micturition - HPI Builder</h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <form id="painfulMicturitionForm">
          <div class="container-fluid">
            <div class="row g-3">

              <!-- Duration -->
              <div class="col-md-12">
                <label for="micturitionDays" class="form-label">Duration (in days):</label>
                <input type="number" id="micturitionDays" class="form-control" min="1" placeholder="e.g., 3">
              </div>

              <!-- Blood in urine -->
              <div class="col-md-12">
                <label for="micturitionBlood" class="form-label">Presence of blood in urine:</label>
                <select id="micturitionBlood" class="form-control select2bs4"  style="width: 100%;" >
                  <option value="no history of blood in urine">No</option>
                  <option value="a history of blood in urine">Yes</option>
                </select>
              </div>

              <!-- Pus in urine -->
              <div class="col-md-12">
                <label for="micturitionPus" class="form-label">Presence of pus in urine:</label>
                <select id="micturitionPus" class="form-control select2bs4"  style="width: 100%;" >
                  <option value="no history of pus in urine">No</option>
                  <option value="a history of pus in urine">Yes</option>
                </select>
              </div>

              <!-- Fever -->
              <div class="col-md-12">
                <label for="micturitionFever" class="form-label">Fever associated?</label>
                <select id="micturitionFever" class="form-control select2bs4"  style="width: 100%;" >
                  <option value="no history of fever associated with the painful micturition">No</option>
                  <option value="a history of fever associated with the painful micturition">Yes</option>
                </select>
              </div>

            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer justify-content-between">
        <button class="btn btn-danger px-4" onclick="generateMicturitionHPI()">Generate & Insert</button>
        <button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>

    </div>
  </div>
</div>


<script>
  function generateMicturitionHPI() {
    const days = document.getElementById('micturitionDays').value.trim();
    const blood = document.getElementById('micturitionBlood').value;
    const pus = document.getElementById('micturitionPus').value;
    const fever = document.getElementById('micturitionFever').value;

    let sentence = `The patient has been experiencing painful micturition that has been there over the past ${days} day(s), and this is mostly when passing urine, and not relieved by posture. There is ${blood} and also ${pus}. The patient has ${fever}.`;

    const hpiTextarea = document.getElementById('hpi');
    hpiTextarea.value = hpiTextarea.value.trim()
      ? `${hpiTextarea.value.trim()}\n\n${sentence}`
      : sentence;

    $('#painfulMicturitionModal').modal('hide');
  }
</script>


<!-- Joint Pain Modal -->
<div class="modal fade" id="jointPainModal" tabindex="-1" role="dialog" aria-labelledby="jointPainModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content shadow rounded-3 border-0">
      
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="jointPainModalLabel">Joint Pain - HPI Builder</h5>
        <button type="button" class="btn-close btn-close-white" data-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <form id="jointPainForm">
          <div class="container-fluid">
            <div class="row g-3">

              <!-- Onset -->
              <div class="col-md-4">
                <label for="jointPainOnset" class="form-label">Onset</label>
                <select id="jointPainOnset" class="form-control select2bs4"  style="width: 100%;" >
                  <option value="suddenly">Suddenly</option>
                  <option value="gradually">Gradually</option>
                </select>
              </div>

              <!-- Distribution -->
              <div class="col-md-4">
                <label for="jointPainDistribution" class="form-label">Distribution</label>
                <select id="jointPainDistribution" class="form-control select2bs4"  style="width: 100%;"  onchange="toggleJointLocationInput()">
                  <option value="generalized">Generalized</option>
                  <option value="localized">Localized</option>
                </select>
              </div>

              <!-- Location -->
              <div class="col-md-4" id="jointPainLocationGroup" style="display: none;">
                <label for="jointPainLocation" class="form-label">Location</label>
                <input type="text" id="jointPainLocation" class="form-control" placeholder="e.g., knees, elbows">
              </div>

              <!-- Associated with movement -->
              <div class="col-md-4">
                <label for="jointPainMovement" class="form-label">Associated with movement?</label>
                <select id="jointPainMovement" class="form-control select2bs4"  style="width: 100%;" >
                  <option value="is associated with movement">Yes</option>
                  <option value="is not associated with movement">No</option>
                </select>
              </div>

              <!-- Relieved by rest -->
              <div class="col-md-4">
                <label for="jointPainRelief" class="form-label">Relieved by rest?</label>
                <select id="jointPainRelief" class="form-control select2bs4"  style="width: 100%;" >
                  <option value="is relieved with resting posture">Yes</option>
                  <option value="is not relieved with resting posture">No</option>
                </select>
              </div>

              <!-- Medication taken -->
              <div class="col-md-4">
                <label for="jointPainMedication" class="form-label">Medication taken?</label>
                <select id="jointPainMedication" class="form-control select2bs4"  style="width: 100%;" >
                  <option value="no history of taking medication">No</option>
                  <option value="history of taking medication">Yes</option>
                </select>
              </div>

              <!-- Topical medication result -->
              <div class="col-md-4">
                <label for="jointPainTopical" class="form-label">Topical medication result</label>
                <select id="jointPainTopical" class="form-control select2bs4"  style="width: 100%;" >
                  <option value="not successful with application of topical medications">Not successful</option>
                  <option value="some relief with application of topical medications">Some relief</option>
                </select>
              </div>

            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer justify-content-between">
        <button type="button" class="btn btn-info px-4" onclick="generateJointPainHPI()">Generate & Insert</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>

    </div>
  </div>
</div>

<script>
  function toggleJointLocationInput() {
    const dist = document.getElementById("jointPainDistribution").value;
    const locGroup = document.getElementById("jointPainLocationGroup");
    locGroup.style.display = dist === "localized" ? "block" : "none";
  }
</script>



<script>
  document.getElementById('jointPainDistribution').addEventListener('change', function () {
    document.getElementById('jointPainLocationGroup').style.display = this.value === 'localized' ? 'block' : 'none';
  });

  function generateJointPainHPI() {
    const onset = document.getElementById('jointPainOnset').value;
    const distribution = document.getElementById('jointPainDistribution').value;
    const location = document.getElementById('jointPainLocation').value.trim();
    const movement = document.getElementById('jointPainMovement').value;
    const relief = document.getElementById('jointPainRelief').value;
    const medication = document.getElementById('jointPainMedication').value;
    const topical = document.getElementById('jointPainTopical').value;

    let sentence = `The patient has joint pain that started ${onset} and is more ${distribution}`;
    if (distribution === 'localized' && location) {
      sentence += ` at the ${location}`;
    }
    sentence += `. The pain ${movement}, and ${relief}. There is ${medication} to relieve the pain, and this has been ${topical}.`;

    const hpiTextarea = document.getElementById('hpi');
    hpiTextarea.value = hpiTextarea.value.trim()
      ? `${hpiTextarea.value.trim()}\n\n${sentence}`
      : sentence;

    $('#jointPainModal').modal('hide');
  }
</script>

<!-- Back Pain Modal -->
<div class="modal fade" id="backPainModal" tabindex="-1" role="dialog" aria-labelledby="backPainModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content shadow rounded border-0">

      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="backPainModalLabel">Back Pain - HPI Builder</h5>
        <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <form id="backPainForm">
          <div class="container-fluid">
            <div class="row g-3">

              <!-- Onset -->
              <div class="col-md-4">
                <label for="backPainOnset" class="form-label">Onset</label>
                <select id="backPainOnset" class="form-control select2bs4" style="width: 100%;">
                  <option value="suddenly">Suddenly</option>
                  <option value="gradually">Gradually</option>
                </select>
              </div>

              <!-- Distribution -->
              <div class="col-md-4">
                <label for="backPainDistribution" class="form-label">Distribution</label>
                <select id="backPainDistribution" class="form-control select2bs4" style="width: 100%;" onchange="toggleBackLocationInput()">
                  <option value="generalized">Generalized</option>
                  <option value="localized">Localized</option>
                </select>
              </div>

              <!-- Location (conditional) -->
              <div class="col-md-4" id="backPainLocationGroup" style="display: none;">
                <label for="backPainLocation" class="form-label">Location (if localized)</label>
                <input type="text" id="backPainLocation" class="form-control" placeholder="e.g., lower back, lumbar region" />
              </div>

              <!-- Associated with movement -->
              <div class="col-md-4">
                <label for="backPainMovement" class="form-label">Associated with movement?</label>
                <select id="backPainMovement" class="form-control select2bs4" style="width: 100%;">
                  <option value="is associated with movement">Yes</option>
                  <option value="is not associated with movement">No</option>
                </select>
              </div>

              <!-- Relieved by rest -->
              <div class="col-md-4">
                <label for="backPainRelief" class="form-label">Relieved by rest?</label>
                <select id="backPainRelief" class="form-control select2bs4" style="width: 100%;">
                  <option value="is relieved with resting posture">Yes</option>
                  <option value="is not relieved with resting posture">No</option>
                </select>
              </div>

              <!-- Medication taken -->
              <div class="col-md-4">
                <label for="backPainMedication" class="form-label">Medication taken?</label>
                <select id="backPainMedication" class="form-control select2bs4" style="width: 100%;">
                  <option value="no history of taking medication">No</option>
                  <option value="history of taking medication">Yes</option>
                </select>
              </div>

              <!-- Topical medication result -->
              <div class="col-md-4">
                <label for="backPainTopical" class="form-label">Topical medication result</label>
                <select id="backPainTopical" class="form-control select2bs4" style="width: 100%;">
                  <option value="not successful with application of topical medications">Not successful</option>
                  <option value="some relief with application of topical medications">Some relief</option>
                </select>
              </div>

            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer justify-content-between">
        <button type="button" class="btn btn-warning px-4" onclick="generateBackPainHPI()">Generate & Insert</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>

    </div>
  </div>
</div>

<script>
  function toggleBackLocationInput() {
    const dist = document.getElementById("backPainDistribution").value;
    const locGroup = document.getElementById("backPainLocationGroup");
    locGroup.style.display = dist === "localized" ? "block" : "none";
  }
</script>

<script>
  document.getElementById('backPainDistribution').addEventListener('change', function () {
    document.getElementById('backPainLocationGroup').style.display = this.value === 'localized' ? 'block' : 'none';
  });

  function generateBackPainHPI() {
    const onset = document.getElementById('backPainOnset').value;
    const distribution = document.getElementById('backPainDistribution').value;
    const location = document.getElementById('backPainLocation').value.trim();
    const movement = document.getElementById('backPainMovement').value;
    const relief = document.getElementById('backPainRelief').value;
    const medication = document.getElementById('backPainMedication').value;
    const topical = document.getElementById('backPainTopical').value;

    let sentence = `The patient has back pain that started ${onset} and is more ${distribution}`;
    if (distribution === 'localized' && location) {
      sentence += ` at the ${location}`;
    }
    sentence += `. The back pain ${movement}, and ${relief}. There is ${medication} to relieve the pain, and this has been ${topical}.`;

    const hpiTextarea = document.getElementById('hpi');
    hpiTextarea.value = hpiTextarea.value.trim()
      ? `${hpiTextarea.value.trim()}\n\n${sentence}`
      : sentence;

    $('#backPainModal').modal('hide');
  }
</script>

<!-- Rashes Modal -->
<div class="modal fade" id="rashesModal" tabindex="-1" role="dialog" aria-labelledby="rashesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content shadow rounded border-0">

      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="rashesModalLabel">Rashes - HPI Builder</h5>
        <button type="button" class="close btn-close-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <form id="rashesForm">
          <div class="container-fluid">
            <div class="row g-3">

              <!-- Duration -->
              <div class="col-md-4">
                <label for="rashesDuration" class="form-label">Duration</label>
                <input type="text" id="rashesDuration" class="form-control" placeholder="e.g., 3 days, one week" />
              </div>

              <!-- Itching -->
              <div class="col-md-4">
                <label for="rashesItching" class="form-label">Itching</label>
                <select id="rashesItching" class="form-control select2bs4" style="width: 100%;">
                  <option value="has itching">Has itching</option>
                  <option value="no itching">No itching</option>
                </select>
              </div>

              <!-- Distribution -->
              <div class="col-md-4">
                <label for="rashesDistribution" class="form-label">Distribution</label>
                <select id="rashesDistribution" class="form-control select2bs4" style="width: 100%;" onchange="toggleRashLocationInput()">
                  <option value="more generalized">More generalized</option>
                  <option value="localized">Localized</option>
                </select>
              </div>

              <!-- Location (if localized) -->
              <div class="col-md-4" id="rashesLocationGroup" style="display: none;">
                <label for="rashesLocation" class="form-label">Location (if localized)</label>
                <input type="text" id="rashesLocation" class="form-control" placeholder="e.g., arms, legs, face" />
              </div>

              <!-- Medication History -->
              <div class="col-md-4">
                <label for="rashesMedication" class="form-label">Medication History</label>
                <select id="rashesMedication" class="form-control select2bs4" style="width: 100%;">
                  <option value="has been">Has been</option>
                  <option value="has not been">Has not been</option>
                </select>
              </div>

            </div>

            <!-- Buttons Row -->
            <div class="row mt-4">
              <div class="col text-center">
                <button type="button" class="btn btn-danger px-4" onclick="generateRashesHPI()">Generate & Insert</button>
              </div>
            </div>

          </div>
        </form>
      </div>

    </div>
  </div>
</div>


<script>
  function toggleRashLocationInput() {
    const dist = document.getElementById("rashesDistribution").value;
    const locGroup = document.getElementById("rashesLocationGroup");
    locGroup.style.display = dist === "localized" ? "block" : "none";
  }
</script>


<script>
  document.getElementById('rashesDistribution').addEventListener('change', function () {
    const locGroup = document.getElementById('rashesLocationGroup');
    locGroup.style.display = this.value === 'localized' ? 'block' : 'none';
  });

  function generateRashesHPI() {
    const duration = document.getElementById('rashesDuration').value.trim();
    const itching = document.getElementById('rashesItching').value;
    const distribution = document.getElementById('rashesDistribution').value;
    const location = document.getElementById('rashesLocation').value.trim();
    const medication = document.getElementById('rashesMedication').value;

    let sentence = `The patient has been having rashes that have been there for the past ${duration}, and this has resulted in discomfort. `;
    sentence += `The rashes ${itching} that has accompanied the rashes, and these are ${distribution}`;
    if (distribution === 'localized' && location) {
      sentence += ` in ${location}`;
    }
    sentence += `. The patient ${medication} on any medication lately and this has resulted in no improvement to the condition.`;

    const hpiTextarea = document.getElementById('hpi');
    hpiTextarea.value = hpiTextarea.value.trim()
      ? `${hpiTextarea.value.trim()}\n\n${sentence}`
      : sentence;

    $('#rashesModal').modal('hide');
  }
</script>


<!-- Generalized Malaise Modal -->
<div class="modal fade" id="gbmModal" tabindex="-1" role="dialog" aria-labelledby="gbmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content shadow rounded">

      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="gbmModalLabel">Generalized Malaise - HPI Builder</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <form id="gbmForm">
          <div class="container-fluid">
            <div class="row g-3">

              <!-- Onset -->
              <div class="col-md-4">
                <label for="gbmOnset" class="form-label">Onset</label>
                <select class="form-control select2bs4" style="width: 100%;" id="gbmOnset">
                  <option value="started gradually">Gradual</option>
                  <option value="started suddenly">Sudden</option>
                </select>
              </div>

              <!-- Associated Factors -->
              <div class="col-md-4">
                <label for="gbmAssociatedFactors" class="form-label">Associated Factors</label>
                <input type="text" class="form-control" id="gbmAssociatedFactors" placeholder="e.g., fever, weakness">
              </div>

              <!-- Relation to Rest/Work -->
              <div class="col-md-4">
                <label for="gbmRelation" class="form-label">Relation to Rest/Work</label>
                <select class="form-control select2bs4" style="width: 100%;" id="gbmRelation">
                  <option value="mostly not related to the resting situation and also not related to work activities">
                    Not related to rest or work
                  </option>
                  <option value="worsens with rest and improves with activity">Worsens with rest</option>
                  <option value="worsens with work and improves with rest">Worsens with work</option>
                </select>
              </div>

            </div>

            <!-- Buttons Row -->
            <div class="row mt-4">
              <div class="col text-center">
                <button type="button" class="btn btn-warning px-4" onclick="generateGBMHPI()">Generate & Insert</button>
              </div>
            </div>

          </div>
        </form>
      </div>

    </div>
  </div>
</div>


<script>
  function generateGBMHPI() {
    const onset = document.getElementById('gbmOnset').value;
    const relation = document.getElementById('gbmRelation').value;
    const associated = document.getElementById('gbmAssociatedFactors').value.trim();

    let sentence = `Patient has been having generalized malaise that ${onset} and has been ${relation}.`;
    if (associated) {
      sentence += ` The GBM has been associated with ${associated}.`;
    }

    const hpiTextarea = document.getElementById('hpi');
    hpiTextarea.value = hpiTextarea.value.trim()
      ? `${hpiTextarea.value.trim()}\n\n${sentence}`
      : sentence;

    $('#gbmModal').modal('hide');
  }
</script>


<!-- Gaseous Discomfort Modal -->
<div class="modal fade" id="gaseousDiscomfortModal" tabindex="-1" role="dialog" aria-labelledby="gaseousDiscomfortModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content shadow-lg rounded">

      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="gaseousDiscomfortModalLabel">Gaseous Discomfort - HPI Builder</h5>
        <button type="button" class="close btn-close-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <form id="gaseousDiscomfortForm">
          <div class="container-fluid">
            <div class="row g-3">

              <!-- Duration -->
              <div class="col-md-4">
                <label for="gaseousDiscomfortDays" class="form-label">Duration (days)</label>
                <input type="number" class="form-control" id="gaseousDiscomfortDays" min="0" placeholder="Enter number of days">
              </div>

              <!-- Medication Taken -->
              <div class="col-md-4">
                <label for="gaseousDiscomfortMedication" class="form-label">Medication Taken</label>
                <select class="form-control select2bs4" style="width: 100%;" id="gaseousDiscomfortMedication">
                  <option value="has not been on medication to relieve the current discomfort">No</option>
                  <option value="has been on medication to relieve the current discomfort">Yes</option>
                </select>
              </div>

              <!-- Blood in Stool -->
              <div class="col-md-4">
                <label for="gaseousDiscomfortBloodStool" class="form-label">Blood in Stool</label>
                <select class="form-control select2bs4" style="width: 100%;" id="gaseousDiscomfortBloodStool">
                  <option value="There is no history of blood in stool">No</option>
                  <option value="There is history of blood in stool">Yes</option>
                </select>
              </div>

              <!-- Diarrhea -->
              <div class="col-md-4">
                <label for="gaseousDiscomfortDiarrhea" class="form-label">Diarrhea</label>
                <select class="form-control select2bs4" style="width: 100%;" id="gaseousDiscomfortDiarrhea">
                  <option value="there is no history of diarrhea">No</option>
                  <option value="there is history of diarrhea">Yes</option>
                </select>
              </div>

            </div>

            <!-- Button Row -->
            <div class="row mt-4">
              <div class="col text-center">
                <button type="button" class="btn btn-success px-4" onclick="generateGaseousDiscomfortHPI()">Generate & Insert</button>
              </div>
            </div>

          </div>
        </form>
      </div>

    </div>
  </div>
</div>


    
<script>
  function generateGaseousDiscomfortHPI() {
    const days = document.getElementById('gaseousDiscomfortDays').value || 'several';
    const medication = document.getElementById('gaseousDiscomfortMedication').value;
    const bloodStool = document.getElementById('gaseousDiscomfortBloodStool').value;
    const diarrhea = document.getElementById('gaseousDiscomfortDiarrhea').value;

    const sentence = `Patient has been experiencing gaseous discomfort that started ${days} days ago and this has resulted in severe inability to consume enough food and also associated with inability to have a comfortable daily routine. The patient ${medication}. ${bloodStool}, and also ${diarrhea}.`;

    const hpiTextarea = document.getElementById('hpi');
    hpiTextarea.value = hpiTextarea.value.trim()
      ? `${hpiTextarea.value.trim()}\n\n${sentence}`
      : sentence;

    $('#gaseousDiscomfortModal').modal('hide');
  }
</script>


<!-- Chest Pain Modal -->
<div class="modal fade" id="chestPainModal" tabindex="-1" role="dialog" aria-labelledby="chestPainModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content shadow-lg rounded">

      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="chestPainModalLabel">Chest Pain - HPI Builder</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <form id="chestPainForm">
          <div class="container-fluid">
            <div class="row g-3">

              <!-- Duration -->
              <div class="col-md-4">
                <label for="chestPainDaysAgo" class="form-label">Duration (days)</label>
                <input type="number" class="form-control" id="chestPainDaysAgo" min="0" placeholder="Enter number of days">
              </div>

              <!-- Location -->
              <div class="col-md-4">
                <label for="chestPainLocation" class="form-label">Location</label>
                <select class="form-control select2bs4" style="width: 100%;" id="chestPainLocation">
                  <option value="central">Central</option>
                  <option value="generalized">Generalized</option>
                </select>
              </div>

              <!-- Radiation -->
              <div class="col-md-4">
                <label for="chestPainRadiation" class="form-label">Radiation</label>
                <select class="form-control select2bs4" style="width: 100%;" id="chestPainRadiation">
                  <option value="non-radiating">Non-radiating</option>
                  <option value="radiating">Radiating</option>
                </select>
              </div>

              <!-- Cough Association -->
              <div class="col-md-4">
                <label for="chestPainCough" class="form-label">Associated with Cough?</label>
                <select class="form-control select2bs4" style="width: 100%;" id="chestPainCough">
                  <option value="not associated with cough">No</option>
                  <option value="associated with cough">Yes</option>
                </select>
              </div>

              <!-- Fever Association -->
              <div class="col-md-4">
                <label for="chestPainFever" class="form-label">Associated with Fever?</label>
                <select class="form-control select2bs4" style="width: 100%;" id="chestPainFever">
                  <option value="not associated with fever">No</option>
                  <option value="associated with fever">Yes</option>
                </select>
              </div>

            </div>

            <!-- Button Row -->
            <div class="row mt-4">
              <div class="col text-center">
                <button type="button" class="btn btn-warning px-4" onclick="generateChestPainHPI()">Generate & Insert</button>
              </div>
            </div>

          </div>
        </form>
      </div>

    </div>
  </div>
</div>



<script>
  function generateChestPainHPI() {
    const days = document.getElementById('chestPainDaysAgo').value || 'a few';
    const location = document.getElementById('chestPainLocation').value;
    const radiation = document.getElementById('chestPainRadiation').value;
    const cough = document.getElementById('chestPainCough').value;
    const fever = document.getElementById('chestPainFever').value;

    const sentence = `Patient has chest pain that has been there for ${days} days and is mostly ${location} and is ${radiation} pain. Chest pain is ${cough}, and is ${fever}.`;

    const hpiTextarea = document.getElementById('hpi');
    hpiTextarea.value = hpiTextarea.value.trim()
      ? `${hpiTextarea.value.trim()}\n\n${sentence}`
      : sentence;

    $('#chestPainModal').modal('hide');
  }
</script>


<!-- Difficulty in Breathing Modal -->
<div class="modal fade" id="dibModal" tabindex="-1" role="dialog" aria-labelledby="dibModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content shadow-lg rounded">

      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="dibModalLabel">Difficulty in Breathing - HPI Builder</h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <form id="dibForm">
          <div class="container-fluid">
            <div class="row g-3">

              <!-- Duration -->
              <div class="col-md-4">
                <label for="dibDaysAgo" class="form-label">Duration (days)</label>
                <input type="number" class="form-control" id="dibDaysAgo" min="0" placeholder="Enter number of days">
              </div>

              <!-- Location -->
              <div class="col-md-4">
                <label for="dibLocation" class="form-label">Location</label>
                <select class="form-control select2bs4" style="width: 100%;" id="dibLocation">
                  <option value="central">Central</option>
                  <option value="generalized">Generalized</option>
                </select>
              </div>

              <!-- Radiation -->
              <div class="col-md-4">
                <label for="dibRadiation" class="form-label">Radiation</label>
                <select class="form-control select2bs4" style="width: 100%;" id="dibRadiation">
                  <option value="non-radiating">Non-radiating</option>
                  <option value="radiating">Radiating</option>
                </select>
              </div>

              <!-- Cough Association -->
              <div class="col-md-4">
                <label for="dibCough" class="form-label">Associated with Cough?</label>
                <select class="form-control select2bs4" style="width: 100%;" id="dibCough">
                  <option value="not associated with cough">No</option>
                  <option value="associated with cough">Yes</option>
                </select>
              </div>

              <!-- Fever Association -->
              <div class="col-md-4">
                <label for="dibFever" class="form-label">Associated with Fever?</label>
                <select class="form-control select2bs4" style="width: 100%;" id="dibFever">
                  <option value="not associated with fever">No</option>
                  <option value="associated with fever">Yes</option>
                </select>
              </div>

            </div>

            <!-- Button Row -->
            <div class="row mt-4">
              <div class="col text-center">
                <button type="button" class="btn btn-danger px-4" onclick="generateDibHPI()">Generate & Insert</button>
              </div>
            </div>

          </div>
        </form>
      </div>

    </div>
  </div>
</div>


<script>
  function generateDibHPI() {
    const days = document.getElementById('dibDaysAgo').value || 'a few';
    const location = document.getElementById('dibLocation').value;
    const radiation = document.getElementById('dibRadiation').value;
    const cough = document.getElementById('dibCough').value;
    const fever = document.getElementById('dibFever').value;

    const sentence = `Patient has difficulty in breathing that has been there for ${days} days and is mostly ${location} and is ${radiation} pain. DIB is ${cough}, and is ${fever}.`;

    const hpiTextarea = document.getElementById('hpi');
    hpiTextarea.value = hpiTextarea.value.trim()
      ? `${hpiTextarea.value.trim()}\n\n${sentence}`
      : sentence;

    $('#dibModal').modal('hide');
  }
</script>



<!-- Cough Modal -->
<div class="modal fade" id="coughModal" tabindex="-1" role="dialog" aria-labelledby="coughModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content shadow-lg rounded">

      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="coughModalLabel">Cough - HPI Builder</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <form id="coughForm">
          <div class="container-fluid">
            <div class="row g-3">

              <!-- Cough Start Days Ago -->
              <div class="col-md-4">
                <label for="coughDaysAgo" class="form-label">When did the cough start? (days ago)</label>
                <input type="number" class="form-control" id="coughDaysAgo" min="0" placeholder="e.g. 3">
              </div>

              <!-- Periodicity -->
              <div class="col-md-4">
                <label for="coughPeriodicity" class="form-label">Periodicity of Cough</label>
                <select class="form-control select2bs4" style="width: 100%;" id="coughPeriodicity">
                  <option value="non-specific">Non-specific</option>
                  <option value="mostly at day">Mostly at day</option>
                  <option value="mostly at night">Mostly at night</option>
                </select>
              </div>

              <!-- Sputum Nature -->
              <div class="col-md-4">
                <label for="coughSputum" class="form-label">Nature of Sputum</label>
                <select class="form-control select2bs4" style="width: 100%;" id="coughSputum">
                  <option value="non-productive">Non-productive</option>
                  <option value="productive with yellow sputum">Productive with yellow sputum</option>
                </select>
              </div>

              <!-- Blood Stained Sputum -->
              <div class="col-md-4">
                <label for="coughBlood" class="form-label">Is sputum blood stained?</label>
                <select class="form-control select2bs4" style="width: 100%;" id="coughBlood">
                  <option value="non-blood stained">No</option>
                  <option value="blood stained">Yes</option>
                </select>
              </div>

              <!-- Difficulty in Breathing -->
              <div class="col-md-4">
                <label for="coughBreathing" class="form-label">Associated with Difficulty in Breathing?</label>
                <select class="form-control select2bs4" style="width: 100%;" id="coughBreathing">
                  <option value="not associated with difficulty in breathing">No</option>
                  <option value="associated with difficulty in breathing">Yes</option>
                </select>
              </div>

              <!-- Chest Pain -->
              <div class="col-md-4">
                <label for="coughPain" class="form-label">Associated with Chest Pain?</label>
                <select class="form-control select2bs4" style="width: 100%;" id="coughPain">
                  <option value="not associated with chest pain">No</option>
                  <option value="associated with chest pain">Yes</option>
                </select>
              </div>

            </div>

            <!-- Button Row -->
            <div class="row mt-4">
              <div class="col text-center">
                <button type="button" class="btn btn-warning px-4" onclick="generateCoughHPI()">Generate & Insert</button>
              </div>
            </div>

          </div>
        </form>
      </div>

    </div>
  </div>
</div>



<script>
  function generateCoughHPI() {
    const days = document.getElementById('coughDaysAgo').value || 'a few';
    const periodicity = document.getElementById('coughPeriodicity').value;
    const sputum = document.getElementById('coughSputum').value;
    const blood = document.getElementById('coughBlood').value;
    const breathing = document.getElementById('coughBreathing').value;
    const pain = document.getElementById('coughPain').value;

    const sentence = `Patient has cough that started ${days} days ago and this is mostly ${periodicity} in periodicity. The cough is ${sputum} in nature, ${blood}. Cough is ${breathing}, and is ${pain}.`;

    const hpiTextarea = document.getElementById('hpi');
    hpiTextarea.value = hpiTextarea.value.trim()
      ? `${hpiTextarea.value.trim()}\n\n${sentence}`
      : sentence;

    $('#coughModal').modal('hide');
  }
</script>

<!-- Flu Modal -->
<div class="modal fade" id="fluModal" tabindex="-1" role="dialog" aria-labelledby="fluModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content shadow-lg rounded">

      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="fluModalLabel">Flu - HPI Builder</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <form id="fluForm">
          <div class="container-fluid">
            <div class="row g-3">

              <!-- Flu Start Days Ago -->
              <div class="col-md-4">
                <label for="fluDaysAgo" class="form-label">When did the flu start? (days ago)</label>
                <input type="number" class="form-control" id="fluDaysAgo" min="0" placeholder="e.g. 2">
              </div>

              <!-- Primary Symptom -->
              <div class="col-md-4">
                <label for="fluPrimarySymptom" class="form-label">Primary Symptom Caused</label>
                <select class="form-control select2bs4" style="width: 100%;" id="fluPrimarySymptom">
                  <option value="nose congestion">Nose Congestion</option>
                  <option value="nose dribbling">Nose Dribbling</option>
                </select>
              </div>

              <!-- Malaise Status -->
              <div class="col-md-4">
                <label for="fluMalaise" class="form-label">Malaise Status</label>
                <select class="form-control select2bs4" style="width: 100%;" id="fluMalaise">
                  <option value="generalized malaise which has been there since the same time">Yes</option>
                  <option value="no significant malaise">No</option>
                </select>
              </div>

              <!-- Feeling of Unease -->
              <div class="col-md-4">
                <label for="fluUnease" class="form-label">Feeling of Unease</label>
                <select class="form-control select2bs4" style="width: 100%;" id="fluUnease">
                  <option value="resulting in a feeling of unease">Yes</option>
                  <option value="no complaint of unease">No</option>
                </select>
              </div>

              <!-- Empty space to balance layout -->
              <div class="col-md-8"></div>

            </div>

            <!-- Submit Button Row -->
            <div class="row mt-4">
              <div class="col text-center">
                <button type="button" class="btn btn-info px-4" onclick="generateFluHPI()">Generate & Insert</button>
              </div>
            </div>

          </div>
        </form>
      </div>

    </div>
  </div>
</div>







<!-- Headache Modal -->
<div class="modal fade" id="headacheModal" tabindex="-1" role="dialog" aria-labelledby="headacheModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content shadow-lg rounded">

      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="headacheModalLabel">Headache - HPI Builder</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <form id="headacheForm">
          <div class="container-fluid">
            <div class="row g-3">

              <!-- Headache Location -->
              <div class="col-md-4">
                <label for="headacheLocation" class="form-label">Location</label>
                <select class="form-control select2bs4" style="width: 100%;" id="headacheLocation">
                  <option value="generalized and not localized on one site">Generalized</option>
                  <option value="localized to the frontal region">Frontal</option>
                  <option value="localized to the side">Side</option>
                  <option value="localized to the back of the head">Back</option>
                </select>
              </div>

              <!-- Severity -->
              <div class="col-md-4">
                <label for="headacheSeverity" class="form-label">Severity</label>
                <select class="form-control select2bs4" style="width: 100%;" id="headacheSeverity">
                  <option value="resulting in severe discomfort">Severe</option>
                  <option value="mild and manageable">Mild</option>
                </select>
              </div>

              <!-- Running Nose -->
              <div class="col-md-4">
                <label for="headacheRunningNose" class="form-label">Running Nose</label>
                <select class="form-control select2bs4" style="width: 100%;" id="headacheRunningNose">
                  <option value="not associated with running nose">Not Associated</option>
                  <option value="associated with running nose">Associated</option>
                </select>
              </div>

              <!-- Nose Congestion -->
              <div class="col-md-4">
                <label for="headacheNoseCongestion" class="form-label">Nose Congestion</label>
                <select class="form-control select2bs4" style="width: 100%;" id="headacheNoseCongestion">
                  <option value="not associated with nose congestion">Not Associated</option>
                  <option value="associated with nose congestion">Associated</option>
                </select>
              </div>

              <!-- Fever History -->
              <div class="col-md-4">
                <label for="headacheFeverHistory" class="form-label">History of Fever</label>
                <select class="form-control select2bs4" style="width: 100%;" id="headacheFeverHistory">
                  <option value="There is no history of fever">No</option>
                  <option value="There is history of fever">Yes</option>
                </select>
              </div>

              <!-- Injury History -->
              <div class="col-md-4">
                <label for="headacheInjury" class="form-label">History of Injury</label>
                <select class="form-control select2bs4" style="width: 100%;" id="headacheInjury">
                  <option value="There is no history of injury">No</option>
                  <option value="There is history of injury">Yes</option>
                </select>
              </div>

            </div>

            <!-- Submit Button -->
            <div class="row mt-4">
              <div class="col text-center">
                <button type="button" class="btn btn-warning px-4" onclick="generateHeadacheHPI()">Generate & Insert</button>
              </div>
            </div>

          </div>
        </form>
      </div>

    </div>
  </div>
</div>




<!-- Fever Modal -->
<div class="modal fade" id="feverModal" tabindex="-1" role="dialog" aria-labelledby="feverModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content shadow-lg rounded">

      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="feverModalLabel">Fever - History of Presenting Illness (HPI)</h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <form id="feverHPIForm">
          <div class="container-fluid">
            <div class="row g-3">

              <!-- Grade of Fever -->
              <div class="col-md-4">
                <label for="feverGrade" class="form-label">Grade of Fever</label>
                <select class="form-control select2bs4" style="width: 100%;" id="feverGrade">
                  <option value="">-- Select --</option>
                  <option value="low grade">Low Grade</option>
                  <option value="high grade">High Grade</option>
                </select>
              </div>

              <!-- Fever Pattern -->
              <div class="col-md-4">
                <label for="feverPattern" class="form-label">Fever Pattern</label>
                <select class="form-control select2bs4" style="width: 100%;" id="feverPattern">
                  <option value="">-- Select --</option>
                  <option value="non-specific">Non-specific</option>
                  <option value="mostly at day">Mostly at Day</option>
                  <option value="mostly at night">Mostly at Night</option>
                </select>
              </div>

              <!-- Onset Type -->
              <div class="col-md-4">
                <label for="feverOnset" class="form-label">Onset Type</label>
                <select class="form-control select2bs4" style="width: 100%;" id="feverOnset">
                  <option value="">-- Select --</option>
                  <option value="sudden">Sudden</option>
                  <option value="gradual">Gradual</option>
                </select>
              </div>

              <!-- Duration (days) -->
              <div class="col-md-4">
                <label for="feverDuration" class="form-label">Duration (in days)</label>
                <input type="number" min="0" class="form-control" id="feverDuration" placeholder="Enter number of days">
              </div>

              <!-- Medication Taken -->
              <div class="col-md-4">
                <label for="feverMed" class="form-label">Taken Medication?</label>
                <select class="form-control select2bs4" style="width: 100%;" id="feverMed">
                  <option value="">-- Select --</option>
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              </div>

              <!-- Empty col for alignment -->
              <div class="col-md-4"></div>

            </div>

            <!-- Submit Button -->
            <div class="row mt-4">
              <div class="col text-center">
                <button type="button" class="btn btn-success px-4" onclick="generateFeverHPI()">Generate HPI</button>
              </div>
            </div>
            
          </div>
        </form>
      </div>

    </div>
  </div>
</div>

<!-- ROS Modal -->
<div class="modal fade" id="rosModal" tabindex="-1" role="dialog" aria-labelledby="rosModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Review of Systems (ROS)</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span>&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <!-- Normal / Abnormal toggle -->
        <div class="form-group">
          <label><strong>ROS Status:</strong></label>
          <select class="form-control" id="rosStatus">
            <option value="">-- Select ROS status --</option>
            <option value="normal">Normal</option>
            <option value="abnormal">Abnormal</option>
          </select>
        </div>

        <!-- ROS Options -->
        <div id="rosOptionsSection" style="display: none;">
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="rosSelectAll">
            <label class="form-check-label font-weight-bold" for="rosSelectAll">Select All Systems</label>
          </div>

          <div class="container-fluid">
            <div class="row">
              <!-- Left Column -->
              <div class="col-md-6">
                <div class="form-group">
                  <input type="checkbox" class="form-check-input ros-option" data-label="General" id="rosGeneral">
                  <label class="form-check-label" for="rosGeneral">General</label>
                  <textarea class="form-control ros-note mt-1" data-label="General" rows="2" placeholder="Abnormal findings (optional)" disabled></textarea>
                </div>
                <div class="form-group">
                  <input type="checkbox" class="form-check-input ros-option" data-label="Skin" id="rosSkin">
                  <label class="form-check-label" for="rosSkin">Skin</label>
                  <textarea class="form-control ros-note mt-1" data-label="Skin" rows="2" placeholder="Abnormal findings (optional)" disabled></textarea>
                </div>
                <div class="form-group">
                  <input type="checkbox" class="form-check-input ros-option" data-label="HEENT" id="rosHEENT">
                  <label class="form-check-label" for="rosHEENT">HEENT</label>
                  <textarea class="form-control ros-note mt-1" data-label="HEENT" rows="2" placeholder="Abnormal findings (optional)" disabled></textarea>
                </div>
                <div class="form-group">
                  <input type="checkbox" class="form-check-input ros-option" data-label="Cardiovascular" id="rosCardio">
                  <label class="form-check-label" for="rosCardio">Cardiovascular</label>
                  <textarea class="form-control ros-note mt-1" data-label="Cardiovascular" rows="2" placeholder="Abnormal findings (optional)" disabled></textarea>
                </div>
                <div class="form-group">
                  <input type="checkbox" class="form-check-input ros-option" data-label="Respiratory" id="rosRespiratory">
                  <label class="form-check-label" for="rosRespiratory">Respiratory</label>
                  <textarea class="form-control ros-note mt-1" data-label="Respiratory" rows="2" placeholder="Abnormal findings (optional)" disabled></textarea>
                </div>
              </div>

              <!-- Right Column -->
              <div class="col-md-6">
                <div class="form-group">
                  <input type="checkbox" class="form-check-input ros-option" data-label="Gastrointestinal" id="rosGI">
                  <label class="form-check-label" for="rosGI">Gastrointestinal</label>
                  <textarea class="form-control ros-note mt-1" data-label="Gastrointestinal" rows="2" placeholder="Abnormal findings (optional)" disabled></textarea>
                </div>
                <div class="form-group">
                  <input type="checkbox" class="form-check-input ros-option" data-label="Genitourinary" id="rosGU">
                  <label class="form-check-label" for="rosGU">Genitourinary</label>
                  <textarea class="form-control ros-note mt-1" data-label="Genitourinary" rows="2" placeholder="Abnormal findings (optional)" disabled></textarea>
                </div>
                <div class="form-group">
                  <input type="checkbox" class="form-check-input ros-option" data-label="Musculoskeletal" id="rosMSK">
                  <label class="form-check-label" for="rosMSK">Musculoskeletal</label>
                  <textarea class="form-control ros-note mt-1" data-label="Musculoskeletal" rows="2" placeholder="Abnormal findings (optional)" disabled></textarea>
                </div>
                               <div class="form-group">
                  <input type="checkbox" class="form-check-input ros-option" data-label="Neurological" id="rosNeuro">
                  <label class="form-check-label" for="rosNeuro">Neurological</label>
                  <textarea class="form-control ros-note mt-1" data-label="Neurological" rows="2" placeholder="Abnormal findings (optional)" disabled></textarea>
                </div>
                <div class="form-group">
                  <input type="checkbox" class="form-check-input ros-option" data-label="Endocrine" id="rosEndocrine">
                  <label class="form-check-label" for="rosEndocrine">Endocrine</label>
                  <textarea class="form-control ros-note mt-1" data-label="Endocrine" rows="2" placeholder="Abnormal findings (optional)" disabled></textarea>
                </div>
                <div class="form-group">
                  <input type="checkbox" class="form-check-input ros-option" data-label="Hematological" id="rosHeme">
                  <label class="form-check-label" for="rosHeme">Hematological</label>
                  <textarea class="form-control ros-note mt-1" data-label="Hematological" rows="2" placeholder="Abnormal findings (optional)" disabled></textarea>
                </div>
              </div>
            </div>
          </div>
        </div> <!-- end #rosOptionsSection -->
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="generateRosSummary">Save</button>
      </div>
    </div>
  </div>
</div>


<!-- Physical Examination Modal -->
<div class="modal fade" id="physicalExamModal" tabindex="-1" role="dialog" aria-labelledby="physicalExamModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Physical Examination</h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p class="text-muted">Check abnormal systems and describe findings. Unchecked systems will be assumed normal.</p>
        <form id="physicalExamForm">
          <!-- Dynamic Fields -->
          <div class="form-check mb-2">
            <input class="form-check-input system-check" type="checkbox" id="chkHEENT" value="HEENT">
            <label class="form-check-label" for="chkHEENT">HEENT</label>
            <textarea class="form-control mt-1 system-detail d-none" id="txtHEENT" placeholder="Describe HEENT abnormal findings"></textarea>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input system-check" type="checkbox" id="chkCardiovascular" value="Cardiovascular">
            <label class="form-check-label" for="chkCardiovascular">Cardiovascular</label>
            <textarea class="form-control mt-1 system-detail d-none" id="txtCardiovascular" placeholder="Describe cardiovascular abnormal findings"></textarea>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input system-check" type="checkbox" id="chkRespiratory" value="Respiratory">
            <label class="form-check-label" for="chkRespiratory">Respiratory</label>
            <textarea class="form-control mt-1 system-detail d-none" id="txtRespiratory" placeholder="Describe respiratory abnormal findings"></textarea>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input system-check" type="checkbox" id="chkAbdomen" value="Abdomen">
            <label class="form-check-label" for="chkAbdomen">Abdomen (PA)</label>
            <textarea class="form-control mt-1 system-detail d-none" id="txtAbdomen" placeholder="Describe abdominal abnormal findings"></textarea>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input system-check" type="checkbox" id="chkMusculoskeletal" value="Musculoskeletal">
            <label class="form-check-label" for="chkMusculoskeletal">Musculoskeletal</label>
            <textarea class="form-control mt-1 system-detail d-none" id="txtMusculoskeletal" placeholder="Describe musculoskeletal abnormal findings"></textarea>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input system-check" type="checkbox" id="chkNeurological" value="Neurological">
            <label class="form-check-label" for="chkNeurological">Neurological</label>
            <textarea class="form-control mt-1 system-detail d-none" id="txtNeurological" placeholder="Describe neurological abnormal findings"></textarea>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input system-check" type="checkbox" id="chkSkin" value="Skin">
            <label class="form-check-label" for="chkSkin">Skin</label>
            <textarea class="form-control mt-1 system-detail d-none" id="txtSkin" placeholder="Describe skin abnormal findings"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" id="generatePhysicalExam">Save</button>
      </div>
    </div>
  </div>
</div>


<!-- Add Patient Vital Modal -->
<div class="modal fade vitals-prem-modal" id="addPatientVitalModal" tabindex="-1" role="dialog" aria-labelledby="addPatientVitalModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addPatientVitalModalLabel">Add Patient Vitals</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="card">
                    <div class="card-body">
                        <div id="VitalMessageContainer" class="alert" role="alert" style="display: none;"></div>
                        <form method="post" id="AddPatientVitalForm">
                            {% csrf_token %}
                            <input type="hidden" name="patient_id" id="patient_id" value="{{ patient.id }}">
                            <input type="hidden" name="visit_id" id="visit_id" value="{{ visit.id }}">
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="respiratory_rate">Respiratory Rate</label>
                                        <select class="form-control select2bs4" id="respiratoryRate" name="respiratory_rate" required>
                                            <option value="">Select</option>
                                            {% for rate in range_15 %}
                                                <option value="{{ rate }}">{{ rate }} bpm</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="pulse_rate">Pulse Rate</label>
                                        <select class="form-control select2bs4" id="pulseRate" name="pulse_rate" required>
                                            <option value="">Select</option>
                                            {% for rate in range_301 %}
                                                <option value="{{ rate }}">{{ rate }} bpm</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="sbp">Systolic BP</label>
                                        <select class="form-control select2bs4" id="sbp" name="sbp" required>
                                            <option value="">Select</option>
                                            {% for value in range_301 %}
                                                <option value="{{ value }}">{{ value }} mmHg</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="dbp">Diastolic BP</label>
                                        <select class="form-control select2bs4" id="dbp" name="dbp" required>
                                            <option value="">Select</option>
                                            {% for value in range_301 %}
                                                <option value="{{ value }}">{{ value }} mmHg</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="spo2">SPO2</label>
                                        <select class="form-control select2bs4" id="spo2" name="spo2" required>
                                            <option value="">Select</option>
                                            {% for percentage in range_101 %}
                                                <option value="{{ percentage }}">{{ percentage }}%</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="temperature">Temperature</label>
                                        <select class="form-control select2bs4" id="temperature" name="temperature" required>
                                            <option value="">Select</option>
                                            {% for temp in temps %}
                                                <option value="{{ temp }}">{{ temp }} °C</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="gcs">Glasgow Coma Scale</label>
                                        <select class="form-control select2bs4" id="gcs" name="gcs" required>
                                            <option value="">Select</option>
                                            {% for score in range_15 %}
                                                <option value="{{ score }}">{{ score }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="height">Height (cm)</label>
                                        <input type="number" class="form-control" id="height" name="height" min="50" max="250" step="0.1" placeholder="Enter height">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="weight">Weight (kg)</label>
                                        <input type="number" class="form-control" id="weight" name="weight" min="1" max="300" step="0.1" placeholder="Enter weight">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-12">
                                    <div id="bmiResult" class="bmi-calculated" style="display: none;">
                                        BMI: <span id="bmiValue"></span> (<span id="bmiCategory"></span>)
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row mt-3">
                                <div class="col-md-12">
                                    <button type="button" class="btn btn-prem-save" onclick="addRemotePatientVital()">
                                        <i class="fas fa-save mr-2"></i> Save Vitals
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Patient Vital Modals -->
{% for vital in patient_vitals %}
<div class="modal fade vitals-prem-modal" id="editPatientVitalModal{{ vital.id }}" tabindex="-1" aria-labelledby="editPatientVitalModalLabel{{ vital.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPatientVitalModalLabel{{ vital.id }}">Edit Patient Vitals</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="editVitalMessageContainer{{ vital.id }}" class="alert" role="alert" style="display: none;"></div>
                <form id="editPatientVitalForm{{ vital.id }}">
                    <input type="hidden" name="patient_id" value="{{ patient.id }}">
                    <input type="hidden" name="vital_id" value="{{ vital.id }}">
                    <input type="hidden" name="visit_id" value="{{ visit.id }}">
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="edit_respiratoryRate{{ vital.id }}">Respiratory Rate</label>
                                <select class="form-control select2bs4" id="edit_respiratoryRate{{ vital.id }}" name="respiratory_rate">
                                    {% for rate in range_51 %}
                                        <option value="{{ rate }}" {% if rate == vital.respiratory_rate %} selected {% endif %}>{{ rate }} bpm</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="edit_pulseRate{{ vital.id }}">Pulse Rate</label>
                                <select class="form-control select2bs4" id="edit_pulseRate{{ vital.id }}" name="pulse_rate">
                                    {% for rate in range_301 %}
                                        <option value="{{ rate }}" {% if rate == vital.pulse_rate %} selected {% endif %}>{{ rate }} bpm</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="edit_sbp{{ vital.id }}">Systolic BP</label>
                                <select class="form-control select2bs4" id="edit_sbp{{ vital.id }}" name="sbp" required>
                                    <option value="">Select</option>
                                    {% for sbp in range_301 %}
                                        <option value="{{ sbp }}" {% if sbp == vital.sbp %} selected {% endif %}>{{ sbp }} mmHg</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="edit_dbp{{ vital.id }}">Diastolic BP</label>
                                <select class="form-control select2bs4" id="edit_dbp{{ vital.id }}" name="dbp" required>
                                    <option value="">Select</option>
                                    {% for dbp in range_301 %}
                                        <option value="{{ dbp }}" {% if dbp == vital.dbp %} selected {% endif %}>{{ dbp }} mmHg</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="edit_spo2{{ vital.id }}">SPO2</label>
                                <select class="form-control select2bs4" id="edit_spo2{{ vital.id }}" name="spo2" required>
                                    {% for percentage in range_101 %}
                                        <option value="{{ percentage }}" {% if percentage == vital.spo2 %} selected {% endif %}>{{ percentage }}%</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="edit_temperature{{ vital.id }}">Temperature</label>
                                <select class="form-control select2bs4" id="edit_temperature{{ vital.id }}" name="temperature" required>
                                    {% for temp in temps %}
                                        <option value="{{ temp }}" {% if temp == vital.temperature %} selected {% endif %}>{{ temp }} °C</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="edit_gcs{{ vital.id }}">Glasgow Coma Scale</label>
                                <select class="form-control select2bs4" id="edit_gcs{{ vital.id }}" name="gcs" required>
                                    {% for score in range_15 %}
                                        <option value="{{ score }}" {% if score == vital.gcs %} selected {% endif %}>{{ score }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="edit_height{{ vital.id }}">Height (cm)</label>
                                <input type="number" class="form-control" id="edit_height{{ vital.id }}" name="height" min="50" max="250" step="0.1" value="{{ vital.height|default:'' }}" placeholder="Enter height">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="edit_weight{{ vital.id }}">Weight (kg)</label>
                                <input type="number" class="form-control" id="edit_weight{{ vital.id }}" name="weight" min="1" max="300" step="0.1" value="{{ vital.weight|default:'' }}" placeholder="Enter weight">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div id="edit_bmiResult{{ vital.id }}" class="bmi-calculated" style="display: none;">
                                BMI: <span id="edit_bmiValue{{ vital.id }}"></span> (<span id="edit_bmiCategory{{ vital.id }}"></span>)
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row mt-3">
                        <div class="col-md-12">
                            <button type="button" class="btn btn-prem-save" onclick="updateRemotePatientVital({{ vital.id }})">
                                <i class="fas fa-save mr-2"></i> Update Vitals
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}


    {% include 'pembadoctor_template/datatable.html' %}     
{% endblock main_content %}
{% block customer_js %}
<script>
// Function to calculate BMI
function calculateBMI(height, weight) {
    if (height && weight) {
        // Convert height from cm to meters
        const heightInMeters = height / 100;
        // Calculate BMI
        const bmi = weight / (heightInMeters * heightInMeters);
        return bmi;
    }
    return null;
}

// Function to get BMI category
function getBMICategory(bmi) {
    if (bmi < 18.5) return "Underweight";
    if (bmi >= 18.5 && bmi < 25) return "Normal";
    if (bmi >= 25 && bmi < 30) return "Overweight";
    return "Obese";
}

// Auto-calculate BMI when height or weight changes in add modal
$('#height, #weight').on('input', function() {
    const height = parseFloat($('#height').val());
    const weight = parseFloat($('#weight').val());
    
    if (height && weight) {
        const bmi = calculateBMI(height, weight);
        const category = getBMICategory(bmi);
        
        $('#bmiValue').text(bmi.toFixed(1));
        $('#bmiCategory').text(category);
        $('#bmiResult').show();
    } else {
        $('#bmiResult').hide();
    }
});

// Auto-calculate BMI when height or weight changes in edit modals
{% for vital in patient_vitals %}
$('#edit_height{{ vital.id }}, #edit_weight{{ vital.id }}').on('input', function() {
    const height = parseFloat($('#edit_height{{ vital.id }}').val());
    const weight = parseFloat($('#edit_weight{{ vital.id }}').val());
    
    if (height && weight) {
        const bmi = calculateBMI(height, weight);
        const category = getBMICategory(bmi);
        
        $('#edit_bmiValue{{ vital.id }}').text(bmi.toFixed(1));
        $('#edit_bmiCategory{{ vital.id }}').text(category);
        $('#edit_bmiResult{{ vital.id }}').show();
    } else {
        $('#edit_bmiResult{{ vital.id }}').hide();
    }
});
{% endfor %}

// Handle form submission using AJAX for adding vitals
function addRemotePatientVital() {
    // Validate form fields
    if (!validateForm()) {
        return false;
    }

    // Prevent default form submission
    event.preventDefault();

    // Perform AJAX request
    $.ajax({
        type: 'POST',
        url: '{% url "pemba_doctor_vitals_save_ajax" %}',
        data: $('#AddPatientVitalForm').serialize(),
        success: function (response) {
            // If the request is successful, display a success message
            if (response.status) {
                $('#VitalMessageContainer').html('<div class="alert alert-success">' + response.message + '</div>').show();
                setTimeout(function() {
                    location.reload(true);
                }, 1500);
            } else {
                $('#VitalMessageContainer').html('<div class="alert alert-danger">' + response.message + '</div>').show();
            }
        },
        error: function (xhr, error) {
            // If the request fails, display an error message
            $('#VitalMessageContainer').html('<div class="alert alert-danger">Error: ' + xhr.responseText + '</div>').show();
        }
    });
}

// Handle form submission using AJAX for updating vitals
function updateRemotePatientVital(vitalId) {
    $.ajax({
        type: 'POST',
        url: '{% url "pemba_doctor_vitals_save_ajax" %}',
        data: $('#editPatientVitalForm' + vitalId).serialize(),
        success: function (response) {
            // If the request is successful, display a success message
            if (response.status) {
                $('#editVitalMessageContainer' + vitalId).html('<div class="alert alert-success">' + response.message + '</div>').show();
                setTimeout(function() {
                    location.reload(true);
                }, 1500);
            } else {
                $('#editVitalMessageContainer' + vitalId).html('<div class="alert alert-danger">' + response.message + '</div>').show();
            }
        },
        error: function (xhr, error) {
            // If the request fails, display an error message
            $('#editVitalMessageContainer' + vitalId).html('<div class="alert alert-danger">Error: ' + xhr.responseText + '</div>').show();
        }
    });
}

// Validate form fields
function validateForm() {
    var isValid = true;
    $('#AddPatientVitalForm :required').each(function () {
        if ($(this).val() === '') {
            isValid = false;
            $(this).addClass('is-invalid');
        } else {
            $(this).removeClass('is-invalid');
        }
    });
    return isValid;
}

// Initialize Select2 for all select elements
$(document).ready(function() {
    $('.select2bs4').select2({
        theme: 'bootstrap4',
        width: '100%',
    });
});
</script>

<script>
  function generateFeverHPI() {
  const grade = document.getElementById('feverGrade').value;
  const pattern = document.getElementById('feverPattern').value;
  const onset = document.getElementById('feverOnset').value;
  const duration = document.getElementById('feverDuration').value;
  const med = document.getElementById('feverMed').value;

  if (!grade || !pattern || !onset || !duration || !med) {
    alert("Please fill all the fields to generate the HPI.");
    return;
  }

  const medText = med === 'yes'
    ? "The patient has been on medication related to relieving fever."
    : "The patient has not been on any medication related to relieving fever.";

  const feverHPI = `Patient presents with fever that is of ${grade} and is ${pattern}, started ${duration} day(s) ago and was ${onset} in onset. ${medText}`;

  const hpiTextarea = document.getElementById('hpi');
  hpiTextarea.value = hpiTextarea.value.trim()
    ? `${hpiTextarea.value.trim()}\n\n${feverHPI}`
    : feverHPI;

  $('#feverModal').modal('hide');
}

</script>

<script>
  const defaultFindings = {
    "HEENT": "Normocephalic, atraumatic head; neck supple; PERRL.",
    "Cardiovascular": "Regular rate and rhythm; no murmurs, rubs, or gallops.",
    "Respiratory": "Clear to auscultation bilaterally; no wheezes, rales, or crackles.",
    "Abdomen": "Soft, non-tender, non-distended; normal bowel sounds; no masses or organomegaly.",
    "Musculoskeletal": "No deformities or scoliosis; atraumatic extremities.",
    "Neurological": "Normal strength, tone, ROM and gait; no focal deficits.",
    "Skin": "Warm, well-perfused; no rashes or lesions."
  };

  const allSections = Object.keys(defaultFindings);

  $(document).ready(function () {
    // Show/hide textareas on checkbox toggle
    $('.system-check').on('change', function () {
      const system = $(this).val();
      const textarea = $('#txt' + system);
      if (this.checked) {
        textarea.removeClass('d-none');
      } else {
        textarea.addClass('d-none').val('');
      }
    });

    // Generate and fill summary on save
    $('#generatePhysicalExam').on('click', function () {
      let summary = 'Physical Examination:\n\n';
      allSections.forEach(system => {
        const isChecked = $('#chk' + system).is(':checked');
        const findings = $('#txt' + system).val().trim();
        if (isChecked && findings) {
          summary += `${system}: ${findings}\n`;
        } else if (!isChecked) {
          summary += `${system}: ${defaultFindings[system]}\n`;
        }
      });
      $('#physical_examination').val(summary.trim());
      $('#physicalExamModal').modal('hide');
    });
  });
</script>




<script>
    $(document).ready(function () {
        // HPI
        $('#hpiModal').on('show.bs.modal', function () {
            $('#modalHpiText').val($('#hpi').val());
        });
        $('#saveHpiModal').on('click', function () {
            $('#hpi').val($('#modalHpiText').val());
            $('#hpiModal').modal('hide');
        });

        // ROS
        $('#rosModal').on('show.bs.modal', function () {
            $('#modalRosText').val($('#ros').val());
        });
        $('#saveRosModal').on('click', function () {
            $('#ros').val($('#modalRosText').val());
            $('#rosModal').modal('hide');
        });

        // Physical Examination
        $('#physicalExamModal').on('show.bs.modal', function () {
            $('#modalPhysicalExamText').val($('#physical_examination').val());
        });
        $('#savePhysicalExamModal').on('click', function () {
            $('#physical_examination').val($('#modalPhysicalExamText').val());
            $('#physicalExamModal').modal('hide');
        });
    });
</script>



<script>
$(document).ready(function () {

  // Show/hide ROS options based on status
  $('#rosStatus').on('change', function () {
    const status = $(this).val();
    if (status === 'abnormal') {
      $('#rosOptionsSection').show();
    } else {
      $('#rosOptionsSection').hide();
    }
  });

  // Enable/disable textarea with checkbox
  $('.ros-option').on('change', function () {
    const label = $(this).data('label');
    $(`.ros-note[data-label="${label}"]`).prop('disabled', !this.checked);
  });

  // Select all toggle
  $('#rosSelectAll').on('change', function () {
    const checked = this.checked;
    $('.ros-option').prop('checked', checked).trigger('change');
  });

  // Generate ROS summary
  $('#generateRosSummary').on('click', function () {
    const status = $('#rosStatus').val();
    let summary = '';

    if (status === 'normal') {
      summary = `Review of systems is normal. The patient denies symptoms in all systems.`;
    } else if (status === 'abnormal') {
      let abnormal = [];
      let normal = [];

      $('.ros-option').each(function () {
        const label = $(this).data('label');
        const isChecked = $(this).is(':checked');
        const note = $(`.ros-note[data-label="${label}"]`).val().trim();

        if (isChecked) {
          if (note) {
            abnormal.push(`${label}: ${note}`);
          } else {
            abnormal.push(`${label}: abnormal findings noted`);
          }
        } else {
          normal.push(label);
        }
      });

      summary = '';

      if (abnormal.length > 0) {
        summary += "Review of systems reveals the following abnormalities:\n" + abnormal.join("\n") + "\n\n";
      }

      if (normal.length > 0) {
        summary += "Other systems reviewed and found normal: " + normal.join(", ") + ".";
      }

      if (summary.trim() === '') {
        summary = "Review of systems abnormal, but no details provided.";
      }
    } else {
      summary = '';
    }

    $('#ros').val(summary.trim());
    $('#rosModal').modal('hide');
  });

});
</script>
<script>
  function generateFluHPI() {
    const days = document.getElementById('fluDaysAgo').value || 'a few';
    const symptom = document.getElementById('fluPrimarySymptom').value;
    const malaise = document.getElementById('fluMalaise').value;
    const unease = document.getElementById('fluUnease').value;

    const sentence = `Patient has flu that started about ${days} days ago and this has resulted in ${symptom}, and ${malaise}, ${unease}.`;

    const hpiTextarea = document.getElementById('hpi');
    hpiTextarea.value = hpiTextarea.value.trim()
      ? `${hpiTextarea.value.trim()}\n\n${sentence}`
      : sentence;

    $('#fluModal').modal('hide');
  }
</script>

<script>
// Define healthRecords in JavaScript to avoid template syntax errors
var healthRecords = [
    {% for health_record in health_records %}
    {id: "{{ health_record.id }}", name: "{{ health_record.name|escapejs}}"},
    {% endfor %}
];

// Define isStaff variable
var isStaff = {% if request.user.staff %}true{% else %}false{% endif %};

// Get CSRF token for AJAX requests
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

$(document).ready(function () {
    const patientId = $('#patient_id').val();
    const visitId = $('#visit_id').val();
    
    // Initialize Select2
    function initializeSelect2(selector) {
        $(selector).select2({
            theme: 'bootstrap4',
            width: '100%',
        });
    }
    
    // Show alert message
    function showAlert(message, type) {
        const alertContainer = $('#ccAlertContainer');
        alertContainer.removeClass('consult-prem-cc-alert-success consult-prem-cc-alert-error')
                     .addClass(type === 'success' ? 'consult-prem-cc-alert-success' : 'consult-prem-cc-alert-error')
                     .html(message)
                     .fadeIn(300);
        
        // Auto hide after 5 seconds
        setTimeout(() => {
            alertContainer.fadeOut(300);
        }, 5000);
    }
    
    // Fetch and display chief complaints
    function fetchChiefComplaints() {
        const url = `{% url 'pemba_doctor_chief_complaint_fetch' %}`;
        
        $.getJSON(url, { patient_id: patientId, visit_id: visitId })
            .done(function (data) {
                renderComplaintsList(data);
                renderEditTable(data);
            })
            .fail(function () {
                showAlert('Error fetching chief complaints.', 'error');
            });
    }
    
    // Render complaints list (display mode - view only)
    function renderComplaintsList(data) {
        const listContainer = $('#chiefComplaintsList');
        const emptyState = $('#ccEmptyState');
        
        listContainer.empty();
        
        if (Array.isArray(data) && data.length > 0) {
            emptyState.hide();
            listContainer.show();
            
            data.forEach(item => {
                const complaintText = item.health_record || item.other_complaint || 'N/A';
                const durationText = item.duration || 'N/A';
                
                const listItem = `
                    <li class="consult-prem-cc-item">
                        <div class="consult-prem-cc-content">
                            <div class="consult-prem-cc-text">
                                <div class="consult-prem-cc-complaint">${complaintText}</div>
                                <div class="consult-prem-cc-duration">Duration: ${durationText}</div>
                            </div>
                        </div>
                    </li>`;
                
                listContainer.append(listItem);
            });
        } else {
            listContainer.hide();
            emptyState.show();
        }
    }
    
    // Render edit table (edit mode with actions)
    function renderEditTable(data) {
        const tableBody = $('#ccEditTableBody');
        tableBody.empty();
        
        if (Array.isArray(data) && data.length > 0) {
            data.forEach(item => {
                addEditTableRow(item);
            });
        } else {
            tableBody.append('<tr><td colspan="3" class="text-center py-3 text-muted">No complaints to edit</td></tr>');
        }
    }
    
    // Add a row to the edit table
    function addEditTableRow(item = null) {
        const isNew = item === null;
        const rowId = isNew ? 'new-' + Date.now() : item.id;
        
        // Get the selected complaint ID and other complaint text
        const complaintId = item ? (item.other_complaint ? 'other' : item.health_record_id) : '';
        const otherComplaint = item ? item.other_complaint : '';
        const complaintText = item ? (item.other_complaint || item.health_record) : '';
        
        // Generate complaint display text
        const displayText = complaintText || 'Select complaint';
        
        const rowHtml = `
            <tr id="cc-row-${rowId}" data-id="${rowId}" data-is-new="${isNew}">
                <td>
                    ${displayText}
                </td>
                <td>
                    <span class="duration-view">${item ? item.duration : ''}</span>
                    <input type="text" class="form-control consult-prem-cc-input duration-edit" 
                           value="${item ? item.duration : ''}" placeholder="Duration" style="display: none;">
                </td>
                <td>
                    <div class="btn-group view-mode-buttons">
                        <button class="btn btn-info btn-sm consult-prem-cc-btn edit-row-btn">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm consult-prem-cc-btn delete-row-btn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="btn-group edit-mode-buttons" style="display: none;">
                        <button class="btn btn-success btn-sm consult-prem-cc-btn save-row-btn">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="btn btn-secondary btn-sm consult-prem-cc-btn cancel-row-btn">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </td>
            </tr>`;
        
        $('#ccEditTableBody').append(rowHtml);
        
        // For new rows, store the complaint data
        if (isNew) {
            $(`#cc-row-${rowId}`).data('complaint-id', '');
            $(`#cc-row-${rowId}`).data('other-complaint', '');
        } else {
            $(`#cc-row-${rowId}`).data('complaint-id', complaintId);
            $(`#cc-row-${rowId}`).data('other-complaint', otherComplaint);
        }
        
        // Store original duration for cancel operation
        $(`#cc-row-${rowId}`).data('original-duration', item ? item.duration : '');
        
        // Bind event handlers
        $(`#cc-row-${rowId} .edit-row-btn`).on('click', function() {
            enterEditMode(rowId);
        });
        
        $(`#cc-row-${rowId} .delete-row-btn`).on('click', function() {
            deleteComplaint(rowId);
        });
        
        $(`#cc-row-${rowId} .save-row-btn`).on('click', function() {
            saveRowChanges(rowId);
        });
        
        $(`#cc-row-${rowId} .cancel-row-btn`).on('click', function() {
            cancelRowEdit(rowId);
        });
    }
    
    // Enter edit mode for a specific row
    function enterEditMode(rowId) {
        const row = $(`#cc-row-${rowId}`);
        row.find('.duration-view').hide();
        row.find('.duration-edit').show();
        row.find('.view-mode-buttons').hide();
        row.find('.edit-mode-buttons').show();
    }
    
    // Cancel editing for a specific row
    function cancelRowEdit(rowId) {
        const row = $(`#cc-row-${rowId}`);
        const originalDuration = row.data('original-duration') || '';
        
        row.find('.duration-edit').val(originalDuration);
        row.find('.duration-edit').hide();
        row.find('.duration-view').show();
        row.find('.edit-mode-buttons').hide();
        row.find('.view-mode-buttons').show();
    }
    
    // Save changes for a specific row
    function saveRowChanges(rowId) {
        const row = $(`#cc-row-${rowId}`);
        const isNew = row.data('is-new');
        const duration = row.find('.duration-edit').val().trim();
        
        if (!duration) {
            showAlert('Please enter a duration.', 'error');
            return;
        }
        
        if (isNew) {
            // This is a new row, create new complaint
            const complaintId = row.data('complaint-id');
            const otherComplaint = row.data('other-complaint');
            
            // Create FormData object for proper form submission
            const formData = new FormData();
            formData.append('patient_id', patientId);
            formData.append('visit_id', visitId);
            formData.append('chief_complain_name', complaintId);
            formData.append('chief_complain_duration', duration);
            
            if (complaintId === 'other') {
                formData.append('other_complaint', otherComplaint);
            }
            
            $.ajax({
                url: "{% url 'pemba_doctor_chief_complaint_save' %}",
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'X-CSRFToken': csrftoken,
                }
            }).done(function(response) {
                if (response.status) {
                    showAlert('Complaint added successfully!', 'success');
                    fetchChiefComplaints();
                } else {
                    showAlert(response.message || 'Failed to add complaint.', 'error');
                }
            }).fail(function() {
                showAlert('Error adding complaint.', 'error');
            });
        } else {
            // This is an existing row, update it
            const formData = {
                chief_complain_duration: duration
            };
            
            const url = "{% url 'pemba_doctor_chief_complaint_update' chief_complaint_id=0 %}".replace('0', rowId);
            
            $.ajax({
                url: url,
                method: 'POST',
                data: JSON.stringify(formData),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': csrftoken,
                }
            }).done(function(response) {
                if (response.status) {
                    showAlert('Complaint updated successfully!', 'success');
                    // Update the view mode display
                    row.find('.duration-view').text(duration);
                    row.find('.duration-edit').hide();
                    row.find('.duration-view').show();
                    row.find('.edit-mode-buttons').hide();
                    row.find('.view-mode-buttons').show();
                } else {
                    showAlert(response.message || 'Failed to update complaint.', 'error');
                }
            }).fail(function() {
                showAlert('Error updating complaint.', 'error');
            });
        }
    }
    
    // Delete a complaint
    function deleteComplaint(id) {
        if (!confirm('Are you sure you want to delete this complaint?')) return;
        
        const url = "{% url 'pemba_doctor_chief_complaint_delete' chief_complaint_id=0 %}".replace('0', id);
        
        $.ajax({
            url: url,
            type: 'POST',
            data: { _method: 'DELETE' },
            headers: {
                'X-CSRFToken': csrftoken,
            }
        }).done(function(response) {
            if (response.status) {
                showAlert('Complaint deleted successfully!', 'success');
                fetchChiefComplaints();
            } else {
                showAlert('Error deleting complaint: ' + response.message, 'error');
            }
        }).fail(function() {
            showAlert('Error deleting complaint.', 'error');
        });
    }
    
    // Toggle between display and edit modes
    $('#toggleEditChiefComplaints').on('click', function() {
        const isEditing = $('#chiefComplaintsEdit').is(':visible');
        
        if (isEditing) {
            // Switch to display mode
            $('#chiefComplaintsDisplay').show();
            $('#chiefComplaintsEdit').hide();
            $('#ccAddForm').hide();
            $('#toggleEditText').text('Edit');
        } else {
            // Switch to edit mode
            $('#chiefComplaintsDisplay').hide();
            $('#chiefComplaintsEdit').show();
            $('#toggleEditText').text('View');
            fetchChiefComplaints(); // Refresh data
        }
    });
    
    // Exit edit mode
    $('#exitEditModeBtn').on('click', function() {
        $('#toggleEditChiefComplaints').click();
    });
    
    // Show add form
    $('#addFirstComplaintBtn, #addNewComplaintBtn').on('click', function() {
        $('#ccAddForm').slideDown();
        initializeSelect2('#ccComplaintSelect');
    });
    
    // Hide add form
    $('#cancelAddComplaintBtn').on('click', function() {
        $('#ccAddForm').slideUp();
        $('#ccComplaintSelect').val('').trigger('change');
        $('#ccDurationInput').val('');
        $('#ccOtherInput').val('');
        $('#ccOtherInputContainer').hide();
    });
    
    // Toggle other input in add form
    $('#ccComplaintSelect').on('change', function() {
        const isOther = $(this).val() === 'other';
        $('#ccOtherInputContainer').toggle(isOther);
    });
    
    // Save new complaint from add form
    $('#saveNewComplaintBtn').on('click', function() {
        const complaintId = $('#ccComplaintSelect').val();
        const duration = $('#ccDurationInput').val();
        const otherComplaint = $('#ccOtherInput').val();
        
        if (!complaintId || !duration) {
            showAlert('Please select a complaint and enter duration.', 'error');
            return;
        }
        
        if (complaintId === 'other' && !otherComplaint) {
            showAlert('Please specify the other complaint.', 'error');
            return;
        }
        
        // Create FormData object for proper form submission
        const formData = new FormData();
        formData.append('patient_id', patientId);
        formData.append('visit_id', visitId);
        formData.append('chief_complain_name', complaintId);
        formData.append('chief_complain_duration', duration);
        
        if (complaintId === 'other') {
            formData.append('other_complaint', otherComplaint);
        }
        
        $.ajax({
            url: "{% url 'pemba_doctor_chief_complaint_save' %}",
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': csrftoken,
            }
        }).done(function(response) {
            if (response.status) {
                showAlert('Complaint added successfully!', 'success');
                fetchChiefComplaints();
                
                // Hide the add form
                $('#ccAddForm').slideUp();
                $('#ccComplaintSelect').val('').trigger('change');
                $('#ccDurationInput').val('');
                $('#ccOtherInput').val('');
                $('#ccOtherInputContainer').hide();
            } else {
                showAlert(response.message || 'Failed to add complaint.', 'error');
            }
        }).fail(function() {
            showAlert('Error adding complaint.', 'error');
        });
    });
    
    // Initial fetch of complaints
    fetchChiefComplaints();
});
</script>
            <script>
  function generateHeadacheHPI() {
    const location = document.getElementById('headacheLocation').value;
    const severity = document.getElementById('headacheSeverity').value;
    const runningNose = document.getElementById('headacheRunningNose').value;
    const congestion = document.getElementById('headacheNoseCongestion').value;
    const feverHistory = document.getElementById('headacheFeverHistory').value;
    const injury = document.getElementById('headacheInjury').value;

    const sentence = `Patient presents with headache that is ${location} and has been ${severity}. Headache is ${runningNose} and is also ${congestion}. ${feverHistory}. ${injury}.`;

    const hpiTextarea = document.getElementById('hpi');
    hpiTextarea.value = hpiTextarea.value.trim()
      ? `${hpiTextarea.value.trim()}\n\n${sentence}`
      : sentence;

    $('#headacheModal').modal('hide');
  }
</script>
{% endblock cu