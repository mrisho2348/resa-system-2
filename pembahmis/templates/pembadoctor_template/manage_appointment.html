{% extends 'pembadoctor_template/base_template.html' %}

{% block title %}
 Appointment Management
{% endblock title %}

{% block breadcrumb %}
{% include "pembadoctor_template/modal_form.html" %}
{% endblock breadcrumb %}

{% block main_content %}
<style>
    /*  Appointment Styles - Unique to this template */
    .appt-prem-gradient {
        background: linear-gradient(135deg, #2c3e50, #8e44ad);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 15px 35px rgba(44, 62, 80, 0.15);
        border: none;
    }
    
    .appt-prem-gradient .card-header {
        background: rgba(0,0,0,0.1);
        border-bottom: 1px solid rgba(255,255,255,0.2);
        padding: 1.2rem 1.5rem;
    }
    
    .appt-prem-table-container {
        border-radius: 10px;
        overflow: auto;
        box-shadow: 0 5px 15px rgba(0,0,0,0.06);
    }
    
    .appt-prem-table th {
        background: linear-gradient(135deg, #2c3e50, #8e44ad);
        color: white;
        font-weight: 600;
        padding: 1rem 0.75rem;
        border: none;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .appt-prem-table td {
        padding: 1.1rem 0.75rem;
        vertical-align: middle;
        border-color: #ecf0f1;
    }
    
    .appt-prem-table tbody tr {
        transition: all 0.3s ease;
        background: white;
    }
    
    .appt-prem-table tbody tr:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(44, 62, 80, 0.1);
        background: #f8fafc;
    }
    
    .btn-prem-appt {
        background: linear-gradient(135deg, #2c3e50, #8e44ad);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 8px 16px;
        font-size: 0.85rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(44, 62, 80, 0.2);
    }
    
    .btn-prem-appt:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(44, 62, 80, 0.3);
        color: white;
    }
    
    .btn-prem-appt-action {
        background: linear-gradient(135deg, #8e44ad, #2c3e50);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 6px 12px;
        font-size: 0.8rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(142, 68, 173, 0.2);
    }
    
    .btn-prem-appt-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(142, 68, 173, 0.3);
        color: white;
    }
    
    .appt-prem-modal-header {
        background: linear-gradient(135deg, #2c3e50, #8e44ad);
        color: white;
        border-radius: 0;
        padding: 1.2rem 1.5rem;
    }
    
    .appt-prem-summary-card {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        border: none;
        margin-bottom: 20px;
        transition: all 0.3s ease;
    }
    
    .appt-prem-summary-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    
    .appt-prem-summary-card .card-header {
        background: linear-gradient(135deg, #ecf0f1, #8e44ad);
        color: #2c3e50;
        font-weight: 600;
        padding: 1rem 1.2rem;
        border-bottom: 1px solid #8e44ad;
    }
    
    .appt-prem-summary-card .card-body {
        padding: 1.5rem;
    }
    
    .appt-prem-summary-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 0.5rem;
    }
    
    .appt-prem-summary-label {
        font-size: 0.9rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .appt-prem-modal-content {
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        border: none;
        overflow: hidden;
    }
    
    .appt-prem-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .appt-prem-filter-bar {
        background: linear-gradient(135deg, #ecf0f1, #8e44ad);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    
    .appt-prem-status-filter {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .appt-prem-status-btn {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        border: none;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .appt-prem-status-btn.active {
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    /* Status button colors */
    .appt-prem-status-btn[data-status="all"] {
        background: linear-gradient(135deg, #2c3e50, #8e44ad);
        color: white;
    }
    
    .appt-prem-status-btn[data-status="today"] {
        background: linear-gradient(135deg, #8e44ad, #2c3e50);
        color: white;
    }
    
    /* Status-specific badge colors */
    .badge-appt-pending {
        background: linear-gradient(135deg, #f39c12, #f5b041);
        color: white;
    }
    
    .badge-appt-completed {
        background: linear-gradient(135deg, #27ae60, #2ecc71);
        color: white;
    }
    
    .badge-appt-canceled {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
    }
    
    .badge-appt-rescheduled {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
    }
    
    .badge-appt-no-show {
        background: linear-gradient(135deg, #7f8c8d, #95a5a6);
        color: white;
    }
    
    .badge-appt-in-progress {
        background: linear-gradient(135deg, #9b59b6, #8e44ad);
        color: white;
    }
    
    .badge-appt-confirmed {
        background: linear-gradient(135deg, #2ecc71, #27ae60);
        color: white;
    }
    
    .badge-appt-arrived {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
    }
    
    /* Animation for view switching */
    @keyframes apptPremFadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .appt-prem-animated {
        animation: apptPremFadeIn 0.5s ease forwards;
    }
    
    /* Flip card effect for  feature */
    .appt-prem-flip-card {
        perspective: 1000px;
        height: 200px;
        margin-bottom: 20px;
    }
    
    .appt-prem-flip-card-inner {
        position: relative;
        width: 100%;
        height: 100%;
        text-align: center;
        transition: transform 0.8s;
        transform-style: preserve-3d;
    }
    
    .appt-prem-flip-card:hover .appt-prem-flip-card-inner {
        transform: rotateY(180deg);
    }
    
    .appt-prem-flip-card-front, .appt-prem-flip-card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        border-radius: 15px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .appt-prem-flip-card-front {
        background: linear-gradient(135deg, #2c3e50, #8e44ad);
        color: white;
    }
    
    .appt-prem-flip-card-back {
        background: linear-gradient(135deg, #8e44ad, #2c3e50);
        color: white;
        transform: rotateY(180deg);
    }
    
    .appt-prem-flip-icon {
        font-size: 3rem;
        margin-bottom: 15px;
    }
    
    /* Calendar view styling */
    .appt-prem-calendar {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .appt-prem-calendar-day {
        background: white;
        border-radius: 8px;
        padding: 10px;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
        min-height: 100px;
    }
    
    .appt-prem-calendar-day:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 10px rgba(0,0,0,0.1);
    }
    
    .appt-prem-calendar-day-header {
        font-weight: 600;
        margin-bottom: 5px;
        color: #2c3e50;
    }
    
    .appt-prem-calendar-appt {
        background: #8e44ad;
        color: white;
        border-radius: 4px;
        padding: 2px 5px;
        font-size: 0.7rem;
        margin-top: 5px;
        cursor: pointer;
    }
    
    /* Timeline styling */
    .appt-prem-timeline {
        position: relative;
        padding: 20px 0;
    }
    
    .appt-prem-timeline::before {
        content: '';
        position: absolute;
        top: 0;
        left: 50%;
        width: 2px;
        height: 100%;
        background: linear-gradient(to bottom, #2c3e50, #8e44ad);
        transform: translateX(-50%;
    }
    
    .appt-prem-timeline-item {
        position: relative;
        margin-bottom: 30px;
        width: 50%;
        padding: 0 40px;
        box-sizing: border-box;
    }
    
    .appt-prem-timeline-item:nth-child(odd) {
        left: 0;
        text-align: right;
    }
    
    .appt-prem-timeline-item:nth-child(even) {
        left: 50%;
    }
    
    .appt-prem-timeline-content {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        position: relative;
    }
    
    .appt-prem-timeline-content::after {
        content: '';
        position: absolute;
        width: 15px;
        height: 15px;
        background: #2c3e50;
        border-radius: 50%;
        top: 50%;
        transform: translateY(-50%);
    }
    
    .appt-prem-timeline-item:nth-child(odd) .appt-prem-timeline-content::after {
        right: -52.5px;
    }
    
    .appt-prem-timeline-item:nth-child(even) .appt-prem-timeline-content::after {
        left: -52.5px;
    }
    
    /* Custom modal styling */
    .appt-prem-modal-xl {
        max-width: 90%;
    }
    
    .appt-prem-modal-header-img {
        height: 120px;
        object-fit: cover;
        width: 100%;
    }
    
    /* Alert container styling */
    #addAppointmentAlertContainer {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        width: 350px;
    }
    
    .alert-slide-in {
        animation: slideInRight 0.5s forwards;
    }
    
    .alert-slide-out {
        animation: slideOutRight 0.5s forwards;
    }
    
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card appt-prem-gradient shadow-lg">
                <div class="card-header py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0 text-white"><i class="fas fa-calendar-check mr-2"></i> Appointment Management</h5>
                        <div>
                            <button class="btn btn-prem-appt mr-2" data-toggle="modal" data-target="#addAppointmentModal">
                                <i class="fas fa-plus mr-1"></i> Add Appointment
                            </button>
                            <button class="btn btn-prem-appt" data-toggle="modal" data-target="#apptAnalyticsModal">
                                <i class="fas fa-chart-line mr-1"></i> Analytics
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Alert Container for AJAX Responses -->
                    <div id="addAppointmentAlertContainer"></div>
                    
                    <!-- Summary Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card appt-prem-summary-card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-calendar mr-2"></i>Total Appointments</h6>
                                </div>
                                <div class="card-body text-center">
                                    <div class="appt-prem-summary-value" id="total-appointments">{{ appointments|length }}</div>
                                    <div class="appt-prem-summary-label">All Appointments</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card appt-prem-summary-card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-user-clock mr-2"></i>Upcoming</h6>
                                </div>
                                <div class="card-body text-center">
                                    <div class="appt-prem-summary-value" id="upcoming-appointments">0</div>
                                    <div class="appt-prem-summary-label">Next 7 Days</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card appt-prem-summary-card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-check-circle mr-2"></i>Completed</h6>
                                </div>
                                <div class="card-body text-center">
                                    <div class="appt-prem-summary-value" id="completed-appointments">0</div>
                                    <div class="appt-prem-summary-label">Successful Appointments</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="appt-prem-flip-card">
                                <div class="appt-prem-flip-card-inner">
                                    <div class="appt-prem-flip-card-front">
                                        <div class="appt-prem-flip-icon">
                                            <i class="fas fa-crown"></i>
                                        </div>
                                        <h4>Appointment Analytics</h4>
                                        <p>Hover to reveal</p>
                                    </div>
                                    <div class="appt-prem-flip-card-back">
                                        <div class="appt-prem-flip-icon">
                                            <i class="fas fa-chart-pie"></i>
                                        </div>
                                        <h4>Performance Metrics</h4>
                                        <p>Advanced tracking & insights</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filter Bar -->
                    <div class="appt-prem-filter-bar">
                        <div class="d-flex justify-content-between align-items-center flex-wrap">
                            <div class="appt-prem-status-filter">
                                <button class="appt-prem-status-btn active" data-status="all">All Appointments</button>
                                <button class="appt-prem-status-btn" data-status="today">Today</button>
                                <button class="appt-prem-status-btn" data-status="upcoming">Upcoming</button>
                                <button class="appt-prem-status-btn" data-status="completed">Completed</button>
                                <button class="appt-prem-status-btn" data-status="canceled">Canceled</button>
                            </div>
                            <div class="view-toggle">
                                <button class="btn btn-prem-appt" id="toggleView">
                                    <i class="fas fa-calendar-alt mr-1"></i> Calendar View
                                </button>
                            </div>
                        </div>
                        <div class="input-group mt-2">
                            <input type="text" class="form-control" placeholder="Search appointments..." id="apptPremSearch">
                            <div class="input-group-append">
                                <button class="btn btn-prem-appt" type="button" id="searchButton">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Calendar View (Initially Hidden) -->
                    <div class="row mb-4 d-none" id="calendarView">
                        <div class="col-md-12">
                            <div class="card appt-prem-summary-card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-calendar-alt mr-2"></i>Appointment Calendar</h6>
                                </div>
                                <div class="card-body">
                                    <div class="appt-prem-calendar" id="apptCalendar">
                                        <!-- Calendar will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Table View -->
                    <div class="table-responsive appt-prem-table-container" id="tableView">
                        <table class="table table-hover text-nowrap appt-prem-table" id="apptTable">
                            <thead>
                                <tr>
                                    <th><i class="fas fa-user-md mr-2"></i>Doctor</th>
                                    <th><i class="fas fa-user-injured mr-2"></i>Patient</th>
                                    <th><i class="fas fa-calendar mr-2"></i>Appointment Date</th>
                                    <th><i class="fas fa-clock mr-2"></i>Start Time</th>
                                    <th><i class="fas fa-clock mr-2"></i>End Time</th>
                                    <th><i class="fas fa-file-alt mr-2"></i>Description</th>
                                    <th><i class="fas fa-tag mr-2"></i>Status</th>
                                    <th class="text-center"><i class="fas fa-cogs mr-2"></i>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for appointment in appointments %}
                                    <tr data-date="{{ appointment.appointment_date|date:'Y-m-d' }}" data-status="{{ appointment.status }}">
                                        <td>{{ appointment.doctor.admin.first_name }} {{ appointment.doctor.middle_name }} {{ appointment.doctor.admin.last_name }}</td>
                                        <td>{{ appointment.patient }}</td>
                                        <td>{{ appointment.appointment_date|date:"d-m-Y" }}</td>
                                        <td>{{ appointment.start_time }}</td>
                                        <td>{{ appointment.end_time }}</td>
                                        <td>{{ appointment.description|truncatewords:5 }}</td>
                                        <td>
                                            {% if appointment.status == 0 %}
                                                <span class="appt-prem-badge badge-appt-pending">Pending</span>
                                            {% elif appointment.status == 1 %}
                                                <span class="appt-prem-badge badge-appt-completed">Completed</span>
                                            {% elif appointment.status == 2 %}
                                                <span class="appt-prem-badge badge-appt-canceled">Canceled</span>
                                            {% elif appointment.status == 3 %}
                                                <span class="appt-prem-badge badge-appt-rescheduled">Rescheduled</span>
                                            {% elif appointment.status == 4 %}
                                                <span class="appt-prem-badge badge-appt-no-show">No-show</span>
                                            {% elif appointment.status == 5 %}
                                                <span class="appt-prem-badge badge-appt-in-progress">In Progress</span>
                                            {% elif appointment.status == 6 %}
                                                <span class="appt-prem-badge badge-appt-confirmed">Confirmed</span>
                                            {% elif appointment.status == 7 %}
                                                <span class="appt-prem-badge badge-appt-arrived">Arrived</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">  
                                            {% if appointment.doctor == request.user.staff %}
                                                {% if not appointment.status or appointment.status == 0 %}
                                                <button class="btn btn-prem-appt-action" data-toggle="modal" data-target="#confirmMeetingModal{{ appointment.id }}">
                                                    Confirm Consultation
                                                </button>
                                                {% else %}
                                                <button class="btn btn-prem-appt-action" style="background: linear-gradient(135deg, #27ae60, #2ecc71);">
                                                    Confirmed
                                                </button>
                                                <button class="btn btn-prem-appt-action" data-toggle="modal" data-target="#editMeetingModal{{ appointment.id }}">
                                                    Edit Consultation
                                                </button>
                                                {% endif %}  
                                            {% endif %}                      
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Appointment Modal -->
<div class="modal fade" id="addAppointmentModal" tabindex="-1" role="dialog" aria-labelledby="addAppointmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content appt-prem-modal-content">
            <div class="modal-header appt-prem-modal-header">
                <h5 class="modal-title text-white" id="addAppointmentModalLabel">
                    <i class="fas fa-calendar-plus mr-2"></i>Create New Appointment
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="addAppointmentForm" method="post" action="{% url 'pemba_doctor_add_appointment' %}">
                <div class="modal-body">
                    <div id="formAlertContainer"></div>
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="patient">Patient</label>
                                <select class="form-control select2bs4" style="width: 100%;" name="patient" id="patientSelect" required>
                                    <option value="">Select Patient</option>
                                    {% for patient in patients %}
                                        <option value="{{ patient.id }}">{{ patient.full_name }} ({{ patient.mrn }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="doctor">Doctor</label>
                                <select class="form-control select2bs4" style="width: 100%;" name="doctor" id="doctorSelect" required>
                                    <option value="">Select Doctor</option>
                                    {% for doctor in doctors %}
                                        <option value="{{ doctor.id }}">Dr. {{ doctor.admin.first_name }} {{ doctor.admin.last_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="appointment_date">Appointment Date</label>
                                <input type="date" class="form-control" name="appointment_date" id="appointmentDate" required min="{{ today|date:'Y-m-d' }}">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="start_time">Start Time</label>
                                <input type="time" class="form-control" name="start_time" id="startTime" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="end_time">End Time</label>
                                <input type="time" class="form-control" name="end_time" id="endTime" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea class="form-control" name="description" id="description" rows="3" placeholder="Appointment notes..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select class="form-control select2bs4" style="width: 100%;" name="status" id="statusSelect">
                            <option value="0">Pending</option>
                            <option value="6">Confirmed</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-prem-appt" id="submitAppointmentBtn">
                        <span id="submitBtnText">Create Appointment</span>
                        <span id="submitBtnSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Analytics Modal -->
<div class="modal fade" id="apptAnalyticsModal" tabindex="-1" role="dialog" aria-labelledby="apptAnalyticsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content appt-prem-modal-content">
      <div class="modal-header appt-prem-modal-header">
        <h5 class="modal-title text-white" id="apptAnalyticsModalLabel"><i class="fas fa-chart-pie mr-2"></i>Appointment Analytics</h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <div class="card appt-prem-summary-card">
              <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-chart-bar mr-2"></i>Appointment Trends</h6>
              </div>
              <div class="card-body">
                <canvas id="apptTrendChart" height="200"></canvas>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card appt-prem-summary-card">
              <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-user-md mr-2"></i>Doctor Performance</h6>
              </div>
              <div class="card-body">
                <canvas id="doctorPerformanceChart" height="200"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-md-12">
            <div class="card appt-prem-summary-card">
              <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-calendar-check mr-2"></i>Appointment Status</h6>
              </div>
              <div class="card-body">
                <canvas id="apptStatusChart" height="150"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-prem-appt" id="exportApptAnalytics">
          <i class="fas fa-download mr-2"></i> Export Report
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Appointment Modals -->
{% for appointment in appointments %}
  <!-- Confirmation Modal for each appointment -->
  <div class="modal fade" id="confirmMeetingModal{{ appointment.id }}" tabindex="-1" role="dialog" aria-labelledby="confirmMeetingModalLabel{{ appointment.id }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content appt-prem-modal-content">
        <div class="modal-header appt-prem-modal-header">
          <h5 class="modal-title text-white" id="confirmMeetingModalLabel{{ appointment.id }}">Confirm Appointment</h5>
          <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p>Have you already met with <strong>{{ appointment.patient }}</strong>?</p>
          <!-- Add a form with a dropdown for selecting the status -->
          <form method="post" action="{% url 'pemba_doctor_appointment_confirm' appointment.id %}">
            {% csrf_token %}
            <div class="form-group">
              <label for="status">Appointment Status:</label>
              <select class="form-control select2bs4" style="width: 100%;" name="status" required>
                <option value="0">Pending</option>
                <option value="1">Completed</option>
                <option value="2">Canceled</option>
                <option value="3">Rescheduled</option>
                <option value="4">No-show</option>
                <option value="5">In Progress</option>
                <option value="6">Confirmed</option>
                <option value="7">Arrived</option>
              </select>
            </div>
            <button type="submit" class="btn btn-prem-appt btn-block">Confirm</button>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Meeting Modal -->
  <div class="modal fade" id="editMeetingModal{{ appointment.id }}" tabindex="-1" role="dialog" aria-labelledby="editMeetingModalLabel{{ appointment.id }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content appt-prem-modal-content">
        <div class="modal-header appt-prem-modal-header">
          <h5 class="modal-title text-white" id="editMeetingModalLabel{{ appointment.id }}">Edit Appointment Time</h5>
          <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p>Edit the appointment time for <strong>{{ appointment.patient }}</strong>.</p>
          <!-- Add a form with fields for start time and end time -->
          <form method="post" action="{% url 'pemba_doctor_appointment_edit' appointment.id %}">
            {% csrf_token %}
            <div class="form-group">
              <label for="start_time">Start Time:</label>
              <input type="time" class="form-control" name="start_time" id="start_time{{ appointment.id }}" value="{{ appointment.start_time|time:'H:i' }}" required>
            </div>
            <div class="form-group">
              <label for="end_time">End Time:</label>
              <input type="time" class="form-control" name="end_time" id="end_time{{ appointment.id }}" value="{{ appointment.end_time|time:'H:i' }}" required>
            </div>
            <button type="submit" class="btn btn-prem-appt btn-block">Update Appointment</button>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
{% endfor %}

{% include 'pembadoctor_template/datatable.html' %}

{% endblock main_content %}

{% block customer_js %}
<script>
    $(document).ready(function() {
        // Initialize DataTable
        new DataTable('#apptTable', {
            dom: 'Bfrtip',
            buttons: ['excel', 'pdf', 'print'],
            responsive: true,
            pageLength: 10,
            order: [[2, 'desc']],
            language: {
                search: "_INPUT_",
                searchPlaceholder: "Search appointments...",
                lengthMenu: "Show _MENU_ entries"
            }
        });

        // Calculate summary statistics
        function calculateApptSummaryStats() {
            let upcomingCount = 0;
            let completedCount = 0;
            const today = new Date();
            
            document.querySelectorAll('#apptTable tbody tr').forEach(row => {
                const status = row.getAttribute('data-status');
                const dateStr = row.getAttribute('data-date');
                const apptDate = new Date(dateStr);
                
                // Check if appointment is upcoming (within next 7 days)
                const diffTime = apptDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays >= 0 && diffDays <= 7) {
                    upcomingCount++;
                }
                
                // Count completed appointments
                if (status === '1') {
                    completedCount++;
                }
            });
            
            // Update summary cards
            document.getElementById('upcoming-appointments').textContent = upcomingCount;
            document.getElementById('completed-appointments').textContent = completedCount;
        }
        
        // Initialize summary stats
        calculateApptSummaryStats();

        // Status filter functionality
        document.querySelectorAll('.appt-prem-status-btn').forEach(button => {
            button.addEventListener('click', function() {
                // Toggle active class
                document.querySelectorAll('.appt-prem-status-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                
                const status = this.getAttribute('data-status');
                filterAppointments(status);
            });
        });

        // Filter appointments by status
        function filterAppointments(status) {
            const rows = document.querySelectorAll('#apptTable tbody tr');
            const today = new Date();
            let visibleCount = 0;
            
            rows.forEach(row => {
                const rowStatus = row.getAttribute('data-status');
                const dateStr = row.getAttribute('data-date');
                const rowDate = new Date(dateStr);
                const diffTime = Math.abs(today - rowDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                
                let shouldShow = false;
                
                if (status === 'all') {
                    shouldShow = true;
                } else if (status === 'today') {
                    shouldShow = diffDays === 0;
                } else if (status === 'upcoming') {
                    shouldShow = rowDate > today && diffDays <= 7;
                } else if (status === 'completed') {
                    shouldShow = rowStatus === '1';
                } else if (status === 'canceled') {
                    shouldShow = rowStatus === '2';
                }
                
                if (shouldShow) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Update total count
            document.getElementById('total-appointments').textContent = visibleCount;
        }

        // Search functionality
        document.getElementById('apptPremSearch').addEventListener('keyup', function() {
            const searchText = this.value.toLowerCase();
            const activeStatus = document.querySelector('.appt-prem-status-btn.active').getAttribute('data-status');
            
            filterAppointmentsWithSearch(activeStatus, searchText);
        });
        
        document.getElementById('searchButton').addEventListener('click', function() {
            const searchText = document.getElementById('apptPremSearch').value.toLowerCase();
            const activeStatus = document.querySelector('.appt-prem-status-btn.active').getAttribute('data-status');
            
            filterAppointmentsWithSearch(activeStatus, searchText);
        });

        // Filter appointments by both status and search text
        function filterAppointmentsWithSearch(status, searchText) {
            const rows = document.querySelectorAll('#apptTable tbody tr');
            const today = new Date();
            let visibleCount = 0;
            
            rows.forEach(row => {
                const rowStatus = row.getAttribute('data-status');
                const dateStr = row.getAttribute('data-date');
                const rowDate = new Date(dateStr);
                const diffTime = Math.abs(today - rowDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                
                const rowText = row.textContent.toLowerCase();
                
                let statusMatch = false;
                
                if (status === 'all') {
                    statusMatch = true;
                } else if (status === 'today') {
                    statusMatch = diffDays === 0;
                } else if (status === 'upcoming') {
                    statusMatch = rowDate > today && diffDays <= 7;
                } else if (status === 'completed') {
                    statusMatch = rowStatus === '1';
                } else if (status === 'canceled') {
                    statusMatch = rowStatus === '2';
                }
                
                const searchMatch = searchText === '' || rowText.includes(searchText);
                
                if (statusMatch && searchMatch) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Update total count
            document.getElementById('total-appointments').textContent = visibleCount;
        }

        // Toggle between table and calendar view
        document.getElementById('toggleView').addEventListener('click', function() {
            const tableView = document.getElementById('tableView');
            const calendarView = document.getElementById('calendarView');
            const toggleButton = document.getElementById('toggleView');
            
            if (tableView.classList.contains('d-none')) {
                // Switch to table view
                tableView.classList.remove('d-none');
                calendarView.classList.add('d-none');
                toggleButton.innerHTML = '<i class="fas fa-calendar-alt mr-1"></i> Calendar View';
            } else {
                // Switch to calendar view
                tableView.classList.add('d-none');
                calendarView.classList.remove('d-none');
                toggleButton.innerHTML = '<i class="fas fa-list mr-1"></i> Table View';
                renderCalendar();
            }
        });

        // Render calendar view
        function renderCalendar() {
            const calendarEl = document.getElementById('apptCalendar');
            calendarEl.innerHTML = '';
            
            // Create day headers
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = 'appt-prem-calendar-day-header';
                dayEl.textContent = day;
                calendarEl.appendChild(dayEl);
            });
            
            // Create calendar days
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            // Fill in empty days at the beginning
            for (let i = 0; i < firstDay.getDay(); i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'appt-prem-calendar-day';
                calendarEl.appendChild(emptyDay);
            }
            
            // Create days of the month
            for (let i = 1; i <= lastDay.getDate(); i++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'appt-prem-calendar-day';
                
                const dayHeader = document.createElement('div');
                dayHeader.className = 'appt-prem-calendar-day-header';
                dayHeader.textContent = i;
                dayEl.appendChild(dayHeader);
                
                // Add appointments for this day
                const currentDate = new Date(today.getFullYear(), today.getMonth(), i);
                const dateStr = currentDate.toISOString().split('T')[0];
                
                document.querySelectorAll('#apptTable tbody tr').forEach(row => {
                    const rowDate = row.getAttribute('data-date');
                    if (rowDate === dateStr) {
                        const apptEl = document.createElement('div');
                        apptEl.className = 'appt-prem-calendar-appt';
                        apptEl.textContent = row.cells[1].textContent.trim(); // Patient name
                        apptEl.setAttribute('data-toggle', 'tooltip');
                        apptEl.setAttribute('title', `${row.cells[5].textContent.trim()} - ${row.cells[3].textContent.trim()}`);
                        dayEl.appendChild(apptEl);
                    }
                });
                
                calendarEl.appendChild(dayEl);
            }
            
            // Initialize tooltips
            $('[data-toggle="tooltip"]').tooltip();
        }

        // Initialize analytics modal charts
        $('#apptAnalyticsModal').on('shown.bs.modal', function () {
            // Sample data for charts
            const trendData = {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'Appointments',
                    data: [120, 145, 138, 161, 156, 183],
                    backgroundColor: '#8e44ad',
                    borderColor: '#2c3e50',
                    borderWidth: 2
                }]
            };
            
            const doctorPerformanceData = {
                labels: ['Dr. Smith', 'Dr. Johnson', 'Dr. Williams', 'Dr. Brown'],
                datasets: [{
                    label: 'Appointments Handled',
                    data: [48, 52, 35, 28],
                    backgroundColor: ['#2c3e50', '#8e44ad', '#f39c12', '#27ae60']
                }]
            };
            
            const apptStatusData = {
                labels: ['Completed', 'Pending', 'Canceled', 'No-show'],
                datasets: [{
                    label: 'Appointment Status',
                    data: [65, 15, 10, 10],
                    backgroundColor: ['#27ae60', '#f39c12', '#e74c3c', '#7f8c8d']
                }]
            };
            
            // Create charts
            new Chart(document.getElementById('apptTrendChart'), {
                type: 'line',
                data: trendData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            new Chart(document.getElementById('doctorPerformanceChart'), {
                type: 'bar',
                data: doctorPerformanceData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            new Chart(document.getElementById('apptStatusChart'), {
                type: 'doughnut',
                data: apptStatusData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    legend: {
                        position: 'bottom'
                    }
                }
            });
        });

        // Initialize tooltips
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        });

        // Time validation for edit forms
        document.querySelectorAll('[id^="start_time"], [id^="end_time"]').forEach(input => {
            input.addEventListener('change', function() {
                const id = this.id;
                const appointmentId = id.replace('start_time', '').replace('end_time', '');
                const startTime = document.getElementById('start_time' + appointmentId).value;
                const endTime = document.getElementById('end_time' + appointmentId).value;
                
                if (startTime && endTime && startTime >= endTime) {
                    alert('End time must be greater than start time.');
                    this.value = '';
                }
            });
        });

        // Add Appointment Form AJAX Submission
        $('#addAppointmentForm').on('submit', function(e) {
            e.preventDefault();
            
            // Show loading state
            $('#submitBtnText').text('Creating...');
            $('#submitBtnSpinner').removeClass('d-none');
            $('#submitAppointmentBtn').prop('disabled', true);
            
            // Clear previous alerts
            $('#formAlertContainer').empty();
            
            // Validate form
            const appointmentDate = new Date($('#appointmentDate').val());
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (appointmentDate < today) {
                showFormAlert('Appointment date cannot be in the past.', 'danger');
                $('#submitBtnText').text('Create Appointment');
                $('#submitBtnSpinner').addClass('d-none');
                $('#submitAppointmentBtn').prop('disabled', false);
                return;
            }
            
            if ($('#startTime').val() >= $('#endTime').val()) {
                showFormAlert('Start time must be earlier than end time.', 'danger');
                $('#submitBtnText').text('Create Appointment');
                $('#submitBtnSpinner').addClass('d-none');
                $('#submitAppointmentBtn').prop('disabled', false);
                return;
            }
            
            // Prepare form data
            const formData = $(this).serialize();
            
            // Send AJAX request
            $.ajax({
                url: $(this).attr('action'),
                method: 'POST',
                data: formData,
                success: function(response) {
                    if (response.success) {
                        // Show success message
                        showAlert(response.message, 'success');
                        
                        // Close modal and reset form
                        $('#addAppointmentModal').modal('hide');
                        $('#addAppointmentForm')[0].reset();
                        
                        // Reload page after a short delay to see the alert
                        setTimeout(function() {
                            location.reload();
                        }, 2000);
                    } else {
                        // Show error message
                        showFormAlert(response.message, 'danger');
                        
                        // If there are field errors, display them
                        if (response.errors) {
                            for (const field in response.errors) {
                                showFormAlert(response.errors[field], 'danger');
                            }
                        }
                    }
                },
                error: function(xhr, status, error) {
                    let errorMessage = 'An error occurred while creating the appointment.';
                    
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    } else if (xhr.statusText) {
                        errorMessage = xhr.statusText;
                    }
                    
                    showFormAlert(errorMessage, 'danger');
                },
                complete: function() {
                    // Reset button state
                    $('#submitBtnText').text('Create Appointment');
                    $('#submitBtnSpinner').addClass('d-none');
                    $('#submitAppointmentBtn').prop('disabled', false);
                }
            });
        });
        
        // Show alert in form
        function showFormAlert(message, type) {
            const alertDiv = $('<div>').addClass(`alert alert-${type} alert-dismissible fade show`).attr('role', 'alert')
                .html(`
                    ${message}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                `);
            
            $('#formAlertContainer').append(alertDiv);
            
            // Auto dismiss after 5 seconds
            setTimeout(function() {
                alertDiv.alert('close');
            }, 5000);
        }
        
        // Show global alert
        function showAlert(message, type) {
            const alertId = 'alert-' + Date.now();
            const alertDiv = $('<div>').addClass(`alert alert-${type} alert-dismissible fade show alert-slide-in`).attr('role', 'alert').attr('id', alertId)
                .html(`
                    <strong>${type.charAt(0).toUpperCase() + type.slice(1)}!</strong> ${message}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                `);
            
            $('#addAppointmentAlertContainer').append(alertDiv);
            
            // Auto dismiss after 5 seconds
            setTimeout(function() {
                $(`#${alertId}`).addClass('alert-slide-out');
                setTimeout(function() {
                    $(`#${alertId}`).alert('close');
                }, 500);
            }, 5000);
        }
        
        // Reset form when modal is closed
        $('#addAppointmentModal').on('hidden.bs.modal', function() {
            $('#addAppointmentForm')[0].reset();
            $('#formAlertContainer').empty();
        });
    });
</script>
{% endblock customer_js %}