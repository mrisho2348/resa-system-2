{% extends 'pembadoctor_template/base_template.html' %}
{% block title %}
   Premium Consultation Management
{% endblock title %}
{% block breadcrumb %}
{% include "pembadoctor_template/modal_form.html" %} 
{% endblock breadcrumb %}
{% block main_content %}

<style>
    /* Premium Consultation Management Styles - Unique to this template */
    .kahama-prem-gradient {
        background: linear-gradient(120deg, #0c2461, #1e3799, #4a69bd);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 15px 35px rgba(12, 36, 97, 0.15);
        border: none;
    }
    
    .kahama-prem-gradient .card-header {
        background: rgba(0,0,0,0.1);
        border-bottom: 1px solid rgba(255,255,255,0.2);
        padding: 1.2rem 1.5rem;
    }
    
    .kahama-prem-table-container {
        border-radius: 10px;
        overflow: auto;
        box-shadow: 0 5px 15px rgba(0,0,0,0.06);
    }
    
    .kahama-prem-table th {
        background: linear-gradient(120deg, #e8eaf6, #c5cae9);
        color: #1a237e;
        font-weight: 600;
        padding: 1rem 0.75rem;
        border: none;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .kahama-prem-table td {
        padding: 1.1rem 0.75rem;
        vertical-align: middle;
        border-color: #e8eaf6;
    }
    
    .kahama-prem-table tbody tr {
        transition: all 0.3s ease;
        background: white;
    }
    
    .kahama-prem-table tbody tr:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(26, 35, 126, 0.1);
        background: #f5f6ff;
    }
    
    .btn-kahama-prem {
        background: linear-gradient(120deg, #0c2461, #1e3799);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 8px 16px;
        font-size: 0.85rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(12, 36, 97, 0.2);
    }
    
    .btn-kahama-prem:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(12, 36, 97, 0.3);
        color: white;
    }
    
    .btn-kahama-prem-view {
        background: linear-gradient(120deg, #0c2461, #1e3a8a);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 6px 12px;
        font-size: 0.8rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(12, 36, 97, 0.2);
    }
    
    .btn-kahama-prem-view:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(12, 36, 97, 0.3);
        color: white;
    }
    
    .kahama-prem-summary-card {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        border: none;
        margin-bottom: 20px;
        transition: all 0.3s ease;
    }
    
    .kahama-prem-summary-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    
    .kahama-prem-summary-card .card-header {
        background: linear-gradient(120deg, #f5f6ff, #e8eaf6);
        color: #1a237e;
        font-weight: 600;
        padding: 1rem 1.2rem;
        border-bottom: 1px solid #c5cae9;
    }
    
    .kahama-prem-summary-card .card-body {
        padding: 1.5rem;
    }
    
    .kahama-prem-summary-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: #1a237e;
        margin-bottom: 0.5rem;
    }
    
    .kahama-prem-summary-label {
        font-size: 0.9rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .kahama-prem-modal-content {
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        border: none;
        overflow: hidden;
    }
    
    .kahama-prem-modal-header {
        background: linear-gradient(120deg, #0c2461, #1e3799);
        color: white;
        border-radius: 0;
        padding: 1.2rem 1.5rem;
    }
    
    .kahama-prem-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .kahama-prem-badge-discharged {
        background: linear-gradient(120deg, #00C853, #64DD17);
        color: white;
    }
    
    .kahama-prem-badge-referral {
        background: linear-gradient(120deg, #FF9800, #FFC107);
        color: white;
    }
    
    .kahama-prem-badge-progress {
        background: linear-gradient(120deg, #42A5F5, #90CAF9);
        color: white;
    }
    
    .kahama-prem-filter-bar {
        background: linear-gradient(120deg, #f5f6ff, #e8eaf6);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    
    .kahama-prem-status-filter {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .kahama-prem-status-btn {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        border: none;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .kahama-prem-status-btn.active {
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    /* Status button colors */
    .kahama-prem-status-btn[data-status="all"] {
        background: linear-gradient(120deg, #0c2461, #1e3799);
        color: white;
    }
    
    .kahama-prem-status-btn[data-status="Discharged"] {
        background: linear-gradient(120deg, #00C853, #64DD17);
        color: white;
    }
    
    .kahama-prem-status-btn[data-status="Referral"] {
        background: linear-gradient(120deg, #FF9800, #FFC107);
        color: white;
    }
    
    .kahama-prem-status-btn[data-status="In Progress"] {
        background: linear-gradient(120deg, #42A5F5, #90CAF9);
        color: white;
    }
    
    /* Flip card effect for premium feature */
    .kahama-prem-flip-card {
        perspective: 1000px;
        height: 200px;
        margin-bottom: 20px;
    }
    
    .kahama-prem-flip-card-inner {
        position: relative;
        width: 100%;
        height: 100%;
        text-align: center;
        transition: transform 0.8s;
        transform-style: preserve-3d;
    }
    
    .kahama-prem-flip-card:hover .kahama-prem-flip-card-inner {
        transform: rotateY(180deg);
    }
    
    .kahama-prem-flip-card-front, .kahama-prem-flip-card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        border-radius: 15px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .kahama-prem-flip-card-front {
        background: linear-gradient(120deg, #0c2461, #1e3799);
        color: white;
    }
    
    .kahama-prem-flip-card-back {
        background: linear-gradient(120deg, #1e3799, #0c2461);
        color: white;
        transform: rotateY(180deg);
    }
    
    .kahama-prem-flip-icon {
        font-size: 3rem;
        margin-bottom: 15px;
    }
    
    /* Animation for view switching */
    @keyframes kahamaPremFadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .kahama-prem-animated {
        animation: kahamaPremFadeIn 0.5s ease forwards;
    }
    
    /* Premium timeline for visit history */
    .kahama-prem-timeline {
        position: relative;
        padding: 20px 0;
    }
    
    .kahama-prem-timeline::before {
        content: '';
        position: absolute;
        left: 50%;
        width: 2px;
        height: 100%;
        background: linear-gradient(to bottom, #0c2461, #1e3799, #4a69bd);
        transform: translateX(-50%);
    }
    
    .kahama-prem-timeline-item {
        position: relative;
        margin-bottom: 30px;
        width: 50%;
        padding: 0 40px;
        box-sizing: border-box;
    }
    
    .kahama-prem-timeline-item:nth-child(odd) {
        left: 0;
        padding-right: 0;
    }
    
    .kahama-prem-timeline-item:nth-child(even) {
        left: 50%;
        padding-left: 40px;
    }
    
    .kahama-prem-timeline-content {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    .kahama-prem-timeline-content:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    
    .kahama-prem-timeline-date {
        font-weight: 600;
        color: #0c2461;
        margin-bottom: 10px;
    }
    
    /* Premium accordion for visit details */
    .kahama-prem-accordion .card {
        border: none;
        border-radius: 10px;
        margin-bottom: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    
    .kahama-prem-accordion .card-header {
        background: linear-gradient(120deg, #f5f6ff, #e8eaf6);
        border: none;
        padding: 15px 20px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .kahama-prem-accordion .card-header:hover {
        background: linear-gradient(120deg, #e8eaf6, #c5cae9);
    }
    
    .kahama-prem-accordion .card-header h6 {
        margin: 0;
        color: #0c2461;
        font-weight: 600;
    }
    
    .kahama-prem-accordion .card-body {
        padding: 20px;
        background: white;
    }
    
    /* Premium table styling for details */
    .kahama-prem-detail-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .kahama-prem-detail-table th {
        background: linear-gradient(120deg, #f5f6ff, #e8eaf6);
        padding: 12px 15px;
        text-align: left;
        color: #0c2461;
        font-weight: 600;
    }
    
    .kahama-prem-detail-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #e8eaf6;
    }
    
    .kahama-prem-detail-table tr:last-child td {
        border-bottom: none;
    }
    
    /* Enhanced search input */
    .kahama-prem-search-input {
        border-radius: 25px;
        border: 1px solid #c5cae9;
        padding-left: 20px;
        transition: all 0.3s ease;
    }
    
    .kahama-prem-search-input:focus {
        box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
        border-color: #1a237e;
    }
    
    /* Premium loading animation */
    .kahama-prem-loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card kahama-prem-gradient shadow-lg">
                <div class="card-header py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0 text-white"><i class="fas fa-stethoscope mr-2"></i>Premium Consultation Management</h5>                       
                    </div>
                </div>
                <div class="card-body">
                    <!-- Summary Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card kahama-prem-summary-card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-users mr-2"></i>Total Consultations</h6>
                                </div>
                                <div class="card-body text-center">
                                    <div class="kahama-prem-summary-value" id="total-consultations">{{ patient_records|length }}</div>
                                    <div class="kahama-prem-summary-label">All Patients</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card kahama-prem-summary-card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-check-circle mr-2"></i>Discharged</h6>
                                </div>
                                <div class="card-body text-center">
                                    <div class="kahama-prem-summary-value" id="discharged-count">0</div>
                                    <div class="kahama-prem-summary-label">Discharged Patients</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card kahama-prem-summary-card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-exchange-alt mr-2"></i>Referrals</h6>
                                </div>
                                <div class="card-body text-center">
                                    <div class="kahama-prem-summary-value" id="referral-count">0</div>
                                    <div class="kahama-prem-summary-label">Referral Cases</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="kahama-prem-flip-card">
                                <div class="kahama-prem-flip-card-inner">
                                    <div class="kahama-prem-flip-card-front">
                                        <div class="kahama-prem-flip-icon">
                                            <i class="fas fa-crown"></i>
                                        </div>
                                        <h4>Premium Analytics</h4>
                                        <p>Hover to reveal</p>
                                    </div>
                                    <div class="kahama-prem-flip-card-back">
                                        <div class="kahama-prem-flip-icon">
                                            <i class="fas fa-chart-line"></i>
                                        </div>
                                        <h4>Consultation Insights</h4>
                                        <p>Advanced patient tracking</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filter Bar -->
                    <div class="kahama-prem-filter-bar">
                        <div class="d-flex justify-content-between align-items-center flex-wrap">
                            <div class="kahama-prem-status-filter">
                                <button class="kahama-prem-status-btn active" data-status="all">All Consultations</button>
                                <button class="kahama-prem-status-btn" data-status="Discharged">Discharged</button>
                                <button class="kahama-prem-status-btn" data-status="Referral">Referrals</button>
                                <button class="kahama-prem-status-btn" data-status="In Progress">In Progress</button>
                            </div>
                        </div>
                        <div class="input-group mt-2">
                            <input type="text" class="form-control kahama-prem-search-input" placeholder="Search patients..." id="kahamaPremSearch">
                            <div class="input-group-append">
                                <button class="btn btn-kahama-prem" type="button" id="searchButton">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Table View -->
                    <div class="table-responsive kahama-prem-table-container">
                        <table class="table table-hover text-nowrap kahama-prem-table" id="consultTable">
                            <thead>
                                <tr>
                                    <th><i class="fas fa-id-card mr-2"></i>MRN</th>
                                    <th><i class="fas fa-user mr-2"></i>Name</th>
                                    <th><i class="fas fa-birthday-cake mr-2"></i>Age</th>
                                    <th><i class="fas fa-venus-mars mr-2"></i>Gender</th>
                                    <th><i class="fas fa-building mr-2"></i>Company</th>
                                    <th><i class="fas fa-phone mr-2"></i>Phone</th>             
                                    <th><i class="fas fa-tasks mr-2"></i>Status</th>             
                                    <th><i class="fas fa-calendar-alt mr-2"></i>Added At</th>             
                                    <th class="text-center"><i class="fas fa-cogs mr-2"></i>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for patient in patient_records %}
                                    <tr data-status="{% if patient.consultationnotes.doctor_plan == 'Discharge' %}Discharged{% elif patient.consultationnotes.doctor_plan == 'Referral' %}Referral{% else %}In Progress{% endif %}">                                       
                                        <td>{{ patient.mrn }}</td>
                                        <td class="text-uppercase">{{ patient.first_name }} {{ patient.middle_name }}  {{ patient.last_name }}</td>   
                                        <td> 
                                            {% if patient.dob %}
                                                <script>
                                                    var dob = new Date("{{ patient.dob|date:'Y-m-d' }}");
                                                    var now = new Date();
                                                    var ageMilliseconds = now - dob;
                                                    var ageSeconds = ageMilliseconds / 1000;
                                                    var ageYears = Math.floor(ageSeconds / (365.25 * 24 * 60 * 60));
                                                    document.write(ageYears + ' years');
                                                </script>
                                            {% else %}
                                                {{ patient.age }}
                                            {% endif %}
                                        </td>
                                        <td>{{ patient.gender }}</td>
                                        <td>{{ patient.company }}</td> 
                                        <td>{{ patient.phone }}</td>                                   
                                        <td>
                                            {% if patient.consultationnotes.doctor_plan == "Discharge" %}
                                                <span class="kahama-prem-badge kahama-prem-badge-discharged">Discharged</span>
                                            {% elif patient.consultationnotes.doctor_plan == "Referral" %}
                                                <span class="kahama-prem-badge kahama-prem-badge-referral">Referral</span>
                                            {% else %}
                                                <span class="kahama-prem-badge kahama-prem-badge-progress">In Progress</span>
                                            {% endif %}
                                        </td>                                  
                                        <td>{{ patient.created_at|date:"d-m-Y" }}</td>                                   
                                        <td class="text-center">              
                                            <button type="button" class="btn btn-kahama-prem-view" data-toggle="modal" data-target="#patientVisitsModal{{ patient.id }}">
                                                <i class="fas fa-eye mr-1"></i> Profile
                                            </button>
                                            <!-- View All Visits Button -->
                                        <button type="button" class="btn btn-kahama-prem-view" data-toggle="modal" data-target="#patientDetailModal{{ patient.id }}">
                                            Process
                                        </button>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% for patient in patient_records %}
<div class="modal fade kahama-prem-modal" id="patientDetailModal{{ patient.id }}" tabindex="-1" role="dialog" aria-labelledby="patientDetailModalLabel{{ patient.id }}" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
    <div class="modal-content kahama-prem-modal-content">
      
      <!-- Modal Header -->
      <div class="modal-header kahama-prem-modal-header">
        <h5 class="modal-title text-white" id="patientDetailModalLabel{{ patient.id }}">
          <i class="fas fa-history mr-2"></i>Visit History for {{ patient.first_name }} {{ patient.last_name }}
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <div class="table-responsive kahama-prem-table-container">
          <table class="table table-hover kahama-prem-table">
            <thead>
              <tr>
                <th><i class="fas fa-hashtag mr-2"></i>Visit Number</th>
                <th><i class="fas fa-tag mr-2"></i>Visit Type</th>
                <th><i class="fas fa-calendar-day mr-2"></i>Date</th>
                <th><i class="fas fa-calendar-week mr-2"></i>Day</th>
                <th class="text-center"><i class="fas fa-cogs mr-2"></i>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for visit in patient.visits.all %}
                <tr>
                  <td><span class="referral-prem-highlight">{{ visit.vst }}</span></td>
                  <td>{{ visit.get_visit_type_display }}</td>
                  <td>{{ visit.created_at|date:"Y-m-d" }}</td>
                  <td>{{ visit.created_at|date:"l" }}</td>
                  <td class="text-center">
                     <a href="{% url 'pemba_doctor_consultation_save' visit.patient.id visit.id %}" class="btn btn-kahama-prem btn-sm">
                      <i class="fas fa-plus-square mr-1"></i> Consultation
                    </a> 
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="5" class="text-center py-4">
                    <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No previous visits found</h5>
                    <p class="text-muted">This patient has no recorded visit history</p>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Modal Footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endfor %}


<!-- Premium Modals for Patient Visits -->
{% for patient in patient_records %}
<div class="modal fade kahama-prem-modal" id="patientVisitsModal{{ patient.id }}" tabindex="-1" role="dialog" aria-labelledby="patientVisitsModalLabel{{ patient.id }}" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content kahama-prem-modal-content">
            <!-- Modal Header -->
            <div class="modal-header kahama-prem-modal-header">
                <h5 class="modal-title text-white" id="patientVisitsModalLabel{{ patient.id }}">
                    <i class="fas fa-history mr-2"></i>Visit History for {{ patient.first_name }} {{ patient.last_name }}
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
                {% if patient.visits.all %}
                <div class="kahama-prem-timeline">
                    {% for visit in patient.visits.all %}
                    <div class="kahama-prem-timeline-item">
                        <div class="kahama-prem-timeline-content">
                            <div class="kahama-prem-timeline-date">
                                <i class="fas fa-calendar-alt mr-2"></i>{{ visit.created_at|date:"F j, Y" }} ({{ visit.created_at|date:"l" }})
                            </div>
                            <h6>Visit #{{ visit.vst }} - {{ visit.get_visit_type_display }}</h6>
                            <p class="mb-2">Recorded at: {{ visit.created_at|time:"H:i" }}</p>
                            <button type="button" class="btn btn-kahama-prem btn-sm" data-toggle="modal" data-target="#visitDetailModal_{{ visit.id }}">
                                <i class="fas fa-file-medical-alt mr-1"></i> View Full Details
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No previous visits found</h5>
                    <p class="text-muted">This patient has no recorded visit history</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Premium Modals for Visit Details -->
{% for patient in patient_records %}
  {% for visit in patient.visits.all %}
    <div class="modal fade kahama-prem-modal" id="visitDetailModal_{{ visit.id }}" tabindex="-1" role="dialog" aria-labelledby="visitDetailModalLabel_{{ visit.id }}" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
        <div class="modal-content kahama-prem-modal-content">
          <div class="modal-header kahama-prem-modal-header">
            <h5 class="modal-title text-white" id="visitDetailModalLabel_{{ visit.id }}">
                <i class="fas fa-file-medical-alt mr-2"></i>Visit Details - {{ patient.first_name }} {{ patient.last_name }} (Visit #{{ visit.vst }})
            </h5>
            <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
          </div>
          <div class="modal-body">
            <!-- Download Button -->
            <div class="text-right mb-4">
                <a href="{% url 'pemba_doctor_consultation_download_summary' patient.id visit.id %}" class="btn btn-kahama-prem">
                    <i class="fas fa-download mr-2"></i> Download Consultation Summary PDF
                </a>
            </div>
            
            <!-- Patient Details Card -->
            <div class="card kahama-prem-summary-card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-user-injured mr-2"></i>Patient Details</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="kahama-prem-detail-table  text-nowrap">
                            <tbody>
                                <tr>
                                    <th width="15%">Patient Name:</th>
                                    <td width="35%">{{ patient.full_name|default:"-" }}</td>
                                    <th width="15%">MRN:</th>
                                    <td width="35%">{{ patient.mrn|default:"-" }}</td>
                                </tr>
                                <tr>
                                    <th>Age:</th>
                                    <td>
                                        {% if patient.dob %}
                                            <script>
                                                var dob = new Date("{{ patient.dob|date:'Y-m-d' }}");
                                                var now = new Date();
                                                var ageMilliseconds = now - dob;
                                                var ageSeconds = ageMilliseconds / 1000;
                                                var ageYears = Math.floor(ageSeconds / (365.25 * 24 * 60 * 60));
                                                document.write(ageYears + ' years');
                                            </script>
                                        {% else %}
                                            {{ patient.age|default:"-" }}
                                        {% endif %}
                                    </td>
                                    <th>Gender:</th>
                                    <td>{{ patient.gender|default:"-" }}</td>
                                </tr>
                                <tr>
                                    <th>Phone:</th>
                                    <td>{{ patient.phone|default:"-" }}</td>
                                    <th>Company:</th>
                                    <td>{{ patient.company|default:"-" }}</td>
                                </tr>
                                <tr>
                                    <th>Visit Date:</th>
                                    <td>{{ visit.created_at|date:"d-m-Y" }}</td>
                                    <th>Visit Time:</th>
                                    <td>{{ visit.created_at|time:"H:i" }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Accordion for Visit Details -->
            <div class="kahama-prem-accordion" id="visitAccordion{{ visit.id }}">
                <!-- Vitals Section -->
                {% if visit.vitals.all %}
                <div class="card">
                    <div class="card-header" id="vitalsHeading{{ visit.id }}" data-toggle="collapse" data-target="#vitalsCollapse{{ visit.id }}" aria-expanded="true" aria-controls="vitalsCollapse{{ visit.id }}">
                        <h6 class="mb-0">
                            <i class="fas fa-heartbeat mr-2"></i>Vital Signs/Assessment Data
                        </h6>
                    </div>
                    <div id="vitalsCollapse{{ visit.id }}" class="collapse show" aria-labelledby="vitalsHeading{{ visit.id }}" data-parent="#visitAccordion{{ visit.id }}">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="kahama-prem-detail-table  text-nowrap">
                                    <thead>
                                        <tr>
                                            <th>Resp Rate</th>
                                            <th>Pulse</th>
                                            <th>BP</th>
                                            <th>SPO2</th>
                                            <th>Temp (°C)</th>
                                            <th>GCS</th>
                                            <th>Height</th>
                                            <th>Weight</th>
                                            <th>Bmi</th>
                                            <th>Recorded By</th>
                                            <th>Recorded At</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for vitals in visit.vitals.all %}
                                        <tr>
                                            <td>{{ vitals.respiratory_rate|default:"-" }}</td>
                                            <td>{{ vitals.pulse_rate|default:"-" }}</td>
                                            <td>{{ vitals.blood_pressure|default:"-" }}</td>
                                            <td>{{ vitals.spo2|default:"-" }}%</td>
                                            <td>{{ vitals.temperature|default:"-" }}</td>
                                            <td>{{ vitals.gcs|default:"-" }}</td>
                                            <td>{{ vitals.height|default:"-" }}</td>
                                            <td>{{ vitals.weight|default:"-" }}</td>
                                            <td>{{ vitals.bmi|default:"-" }}</td>
                                            <td>{{ vitals.recorded_by.get_full_name|default:"System" }}</td>
                                            <td>{{ vitals.recorded_at|date:"d-m-Y" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Clinical Notes Section -->
                {% with consultation_note=visit.consultation_notes.first diagnosis_record=visit.diagnosis_records.first %}
                {% if consultation_note %}
                <div class="card">
                    <div class="card-header" id="clinicalHeading{{ visit.id }}" data-toggle="collapse" data-target="#clinicalCollapse{{ visit.id }}" aria-expanded="false" aria-controls="clinicalCollapse{{ visit.id }}">
                        <h6 class="mb-0">
                            <i class="fas fa-notes-medical mr-2"></i>Clinical Notes
                        </h6>
                    </div>
                    <div id="clinicalCollapse{{ visit.id }}" class="collapse" aria-labelledby="clinicalHeading{{ visit.id }}" data-parent="#visitAccordion{{ visit.id }}">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="kahama-prem-detail-table  text-nowrap">
                                <tbody>
                                    <tr>
                                        <th width="20%">Chief Complaints:</th>
                                        <td width="80%">
                                            <ul>
                                            {% for complaint in visit.kahamachiefcomplaint_set.all %}
                                                <li>{{ complaint.health_record }} - Duration: {{ complaint.duration }}</li>
                                            {% endfor %}
                                            </ul>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>History of Presenting Illness:</th>
                                        <td>{{ consultation_note.history_of_presenting_illness }}</td>
                                    </tr>
                                    <tr>
                                        <th>Review of Systems:</th>
                                        <td>{{ consultation_note.review_of_systems }}</td>
                                    </tr>
                                    <tr>
                                        <th>Physical Examination:</th>
                                        <td>{{ consultation_note.physical_examination }}</td>
                                    </tr>
                                    <tr>
                                        <th>Doctor's Plan:</th>
                                        <td>{{ consultation_note.doctor_plan }}</td>
                                    </tr>
                                    <tr>
                                        <th>Doctor's Plan Notes:</th>
                                        <td>{{ consultation_note.doctor_plan_note }}</td>
                                    </tr>
                                    
                                    {% if diagnosis_record %}
                                    <tr>
                                        <th>Provisional Diagnosis:</th>
                                        <td>
                                            <ul>
                                            {% for pdx in diagnosis_record.provisional_diagnosis.all %}
                                                <li>{{ pdx.diagnosis_name }}</li>
                                            {% endfor %}
                                            </ul>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Final Diagnosis:</th>
                                        <td>
                                            <ul>
                                            {% for fdx in diagnosis_record.final_diagnosis.all %}
                                                <li>{{ fdx.diagnosis_name }}</li>
                                            {% endfor %}
                                            </ul>
                                        </td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                            </div>                            
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endwith %}

                <!-- Laboratory Section -->
                {% if visit.laboratory_requests.all %}
                <div class="card">
                    <div class="card-header" id="labHeading{{ visit.id }}" data-toggle="collapse" data-target="#labCollapse{{ visit.id }}" aria-expanded="false" aria-controls="labCollapse{{ visit.id }}">
                        <h6 class="mb-0">
                            <i class="fas fa-vial mr-2"></i>Laboratory Data
                        </h6>
                    </div>
                    <div id="labCollapse{{ visit.id }}" class="collapse" aria-labelledby="labHeading{{ visit.id }}" data-parent="#visitAccordion{{ visit.id }}">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="kahama-prem-detail-table text-nowrap">
                                    <thead>
                                        <tr>
                                            <th>Test</th>
                                            <th>Description</th>
                                            <th>Done By</th>
                                            <th>Result</th>
                                            <th>Created</th>
                                            <th>Updated</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for lab in visit.laboratory_requests.all %}
                                        <tr>
                                            <td>{{ lab.name.name|default:"-" }}</td>
                                            <td>{{ lab.description|default:"-" }}</td>
                                            <td>{{ lab.data_recorder.get_full_name|default:"System" }}</td>
                                            <td>
                                                {% if lab.result %}
                                                    <button class="btn btn-kahama-prem btn-sm" data-toggle="modal" data-target="#resultModal{{ lab.id }}">
                                                        View Result
                                                    </button>
                                                {% else %}
                                                    <em>No result</em>
                                                {% endif %}
                                            </td>
                                            <td>{{ lab.created_at|date:"d-m-Y" }}</td>
                                            <td>{{ lab.updated_at|date:"d-m-Y" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Procedures Section -->
                {% if visit.procedures.all %}
                <div class="card">
                    <div class="card-header" id="procedureHeading{{ visit.id }}" data-toggle="collapse" data-target="#procedureCollapse{{ visit.id }}" aria-expanded="false" aria-controls="procedureCollapse{{ visit.id }}">
                        <h6 class="mb-0">
                            <i class="fas fa-procedures mr-2"></i>Procedure Records
                        </h6>
                    </div>
                    <div id="procedureCollapse{{ visit.id }}" class="collapse" aria-labelledby="procedureHeading{{ visit.id }}" data-parent="#visitAccordion{{ visit.id }}">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="kahama-prem-detail-table text-nowrap">
                                    <thead>
                                        <tr>
                                            <th>Procedure</th>
                                            <th>Description</th>
                                            <th>Done By</th>
                                            <th>Equipments Used</th>
                                            <th>Result</th>
                                            <th>Created</th>
                                            <th>Updated</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for procedure in visit.procedures.all %}
                                        <tr>
                                            <td>{{ procedure.name.name|default:"-" }}</td>
                                            <td>{{ procedure.description|default:"-" }}</td>
                                            <td>{{ procedure.data_recorder.get_full_name|default:"System" }}</td>
                                            <td>{{ procedure.equipments_used }}</td>
                                            <td>
                                                {% if procedure.result %}
                                                    <button class="btn btn-kahama-prem btn-sm" data-toggle="modal" data-target="#procedureResultModal{{ procedure.id }}">
                                                        View Result
                                                    </button>
                                                {% else %}
                                                    <em>No result</em>
                                                {% endif %}
                                            </td>
                                            <td>{{ procedure.created_at|date:"d-m-Y" }}</td>
                                            <td>{{ procedure.updated_at|date:"d-m-Y" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Observation Section -->
                {% if visit.observation_records.all %}
                <div class="card">
                    <div class="card-header" id="observationHeading{{ visit.id }}" data-toggle="collapse" data-target="#observationCollapse{{ visit.id }}" aria-expanded="false" aria-controls="observationCollapse{{ visit.id }}">
                        <h6 class="mb-0">
                            <i class="fas fa-clipboard-check mr-2"></i>Observation Records
                        </h6>
                    </div>
                    <div id="observationCollapse{{ visit.id }}" class="collapse" aria-labelledby="observationHeading{{ visit.id }}" data-parent="#visitAccordion{{ visit.id }}">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="kahama-prem-detail-table text-nowrap">
                                    <thead>
                                        <tr>
                                            <th>Observation Notes</th>
                                            <th>Done By</th>
                                            <th>Created At</th>
                                            <th>Updated At</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for observation in visit.observation_records.all %}
                                        <tr>
                                            <td>{{ observation.observation_notes|safe }}</td>
                                            <td>{{ observation.data_recorder.get_full_name|default:"System" }}</td>
                                            <td>{{ observation.created_at|date:"d-m-Y" }}</td>
                                            <td>{{ observation.updated_at|date:"d-m-Y" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Prescription Section -->
                {% if visit.prescriptions.all %}
                <div class="card">
                    <div class="card-header" id="prescriptionHeading{{ visit.id }}" data-toggle="collapse" data-target="#prescriptionCollapse{{ visit.id }}" aria-expanded="false" aria-controls="prescriptionCollapse{{ visit.id }}">
                        <h6 class="mb-0">
                            <i class="fas fa-prescription mr-2"></i>Prescription Records
                        </h6>
                    </div>
                    <div id="prescriptionCollapse{{ visit.id }}" class="collapse" aria-labelledby="prescriptionHeading{{ visit.id }}" data-parent="#visitAccordion{{ visit.id }}">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="kahama-prem-detail-table text-nowrap">
                                    <thead>
                                        <tr>
                                            <th>Medicine</th>
                                            <th>Dose</th>
                                            <th>Frequency</th>
                                            <th>Duration</th>
                                            <th>Quantity</th>
                                            <th>Entered By</th>
                                            <th>Created At</th>
                                            <th>Updated At</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for prescription in visit.prescriptions.all %}
                                        <tr>
                                            <td>{{ prescription.medicine.drug_name }}</td>
                                            <td>{{ prescription.dose }}</td>
                                            <td>{{ prescription.frequency }}</td>
                                            <td>{{ prescription.duration }}</td>
                                            <td>{{ prescription.quantity_used }}</td>
                                            <td>{{ prescription.entered_by.get_full_name|default:"System" }}</td>
                                            <td>{{ prescription.created_at|date:"d-m-Y" }}</td>
                                            <td>{{ prescription.updated_at|date:"d-m-Y" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Counseling Section -->
                {% if visit.counselings.all %}
                <div class="card">
                    <div class="card-header" id="counselingHeading{{ visit.id }}" data-toggle="collapse" data-target="#counselingCollapse{{ visit.id }}" aria-expanded="false" aria-controls="counselingCollapse{{ visit.id }}">
                        <h6 class="mb-0">
                            <i class="fas fa-comments mr-2"></i>Counseling Notes
                        </h6>
                    </div>
                    <div id="counselingCollapse{{ visit.id }}" class="collapse" aria-labelledby="counselingHeading{{ visit.id }}" data-parent="#visitAccordion{{ visit.id }}">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="kahama-prem-detail-table text-nowrap">
                                    <thead>
                                        <tr>
                                            <th>Recorder</th>
                                            <th>Notes</th>
                                            <th>Created</th>
                                            <th>Updated</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for session in visit.counselings.all %}
                                        <tr>
                                            <td>{{ session.data_recorder.get_full_name|default:"System" }}</td>
                                            <td>
                                                {% if session.counselling_notes %}
                                                <div style="max-width: 400px; max-height: 200px; overflow:auto;">
                                                    {{ session.counselling_notes|safe }}
                                                </div>
                                                {% else %}
                                                <em>No notes recorded.</em>
                                                {% endif %}
                                            </td>
                                            <td>{{ session.created_at|date:"d-m-Y" }}</td>
                                            <td>{{ session.updated_at|date:"d-m-Y" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Referral Section -->
                {% if visit.referrals.all %}
                <div class="card">
                    <div class="card-header" id="referralHeading{{ visit.id }}" data-toggle="collapse" data-target="#referralCollapse{{ visit.id }}" aria-expanded="false" aria-controls="referralCollapse{{ visit.id }}">
                        <h6 class="mb-0">
                            <i class="fas fa-exchange-alt mr-2"></i>Referral Details
                        </h6>
                    </div>
                    <div id="referralCollapse{{ visit.id }}" class="collapse" aria-labelledby="referralHeading{{ visit.id }}" data-parent="#visitAccordion{{ visit.id }}">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="kahama-prem-detail-table text-nowrap">
                                    <thead>
                                        <tr>
                                            <th>Source Location</th>
                                            <th>Destination Location</th>
                                            <th>Nature of Referral</th>
                                            <th>Transport Model</th>
                                            <th>Notes</th>
                                            <th>Status</th>
                                            <th>Recorded By</th>
                                            <th>Created At</th>
                                            <th>Updated At</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for referral in visit.referrals.all %}
                                        <tr>
                                            <td>{{ referral.source_location|default:"-" }}</td>
                                            <td>{{ referral.destination_location|default:"-" }}</td>
                                            <td>{{ referral.get_nature_of_referral_display|default:"-" }}</td>
                                            <td>{{ referral.get_transport_model_display|default:"-" }}</td>
                                            <td>{{ referral.notes|safe|default:"-" }}</td>
                                            <td>
                                                <span class="badge badge-{{ referral.get_status_color }}">
                                                {{ referral.get_status_display }}
                                                </span>
                                            </td>
                                            <td>{{ referral.data_recorder.get_full_name|default:"System" }}</td>
                                            <td>{{ referral.created_at|date:"d-m-Y" }}</td>
                                            <td>{{ referral.updated_at|date:"d-m-Y" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Discharge Section -->
                {% if visit.discharge_notes.all %}
                <div class="card">
                    <div class="card-header" id="dischargeHeading{{ visit.id }}" data-toggle="collapse" data-target="#dischargeCollapse{{ visit.id }}" aria-expanded="false" aria-controls="dischargeCollapse{{ visit.id }}">
                        <h6 class="mb-0">
                            <i class="fas fa-sign-out-alt mr-2"></i>Discharge Notes
                        </h6>
                    </div>
                    <div id="dischargeCollapse{{ visit.id }}" class="collapse" aria-labelledby="dischargeHeading{{ visit.id }}" data-parent="#visitAccordion{{ visit.id }}">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="kahama-prem-detail-table text-nowrap">
                                    <thead>
                                        <tr>
                                            <th>Discharge Condition</th>
                                            <th>Discharge Notes</th>
                                            <th>Recorded By</th>
                                            <th>Discharge Date</th>
                                            <th>Last Updated</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for discharge in visit.discharge_notes.all %}
                                        <tr>
                                            <td>{{ discharge.discharge_condition|default:"-" }}</td>
                                            <td>{{ discharge.discharge_notes|safe|default:"-" }}</td>
                                            <td>{{ discharge.data_recorder.get_full_name|default:"System" }}</td>
                                            <td>{{ discharge.discharge_date|date:"d-m-Y" }}</td>
                                            <td>{{ discharge.updated_at|date:"d-m-Y" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endfor %}
{% endfor %}

{# =============================== #}
{# 🧪 Lab Result Modals           #}
{# =============================== #}
{% for patient in patient_records %}
  {% for visit in patient.visits.all %}
    {% for lab in visit.laboratory_requests.all %}
      {% if lab.result %}
        <div class="modal fade kahama-prem-modal" id="resultModal{{ lab.id }}" tabindex="-1" role="dialog" aria-labelledby="resultModalLabel{{ lab.id }}" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
            <div class="modal-content kahama-prem-modal-content">
              <div class="modal-header kahama-prem-modal-header">
                <h5 class="modal-title text-white" id="resultModalLabel{{ lab.id }}">
                  <i class="fas fa-vial mr-2"></i>Lab Result: {{ lab.name.name|default:"Test" }}
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                {{ lab.result|safe }}
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-kahama-prem" data-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
      {% endif %}
    {% endfor %}
  {% endfor %}
{% endfor %}


{# =============================== #}
{# 🩺 Procedure Result Modals     #}
{# =============================== #}
{% for patient in patient_records %}
  {% for visit in patient.visits.all %}
    {% for procedure in visit.procedures.all %}
      {% if procedure.result %}
        <div class="modal fade kahama-prem-modal" id="procedureResultModal{{ procedure.id }}" tabindex="-1" role="dialog" aria-labelledby="procedureResultModalLabel{{ procedure.id }}" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
            <div class="modal-content kahama-prem-modal-content">
              <div class="modal-header kahama-prem-modal-header">
                <h5 class="modal-title text-white" id="procedureResultModalLabel{{ procedure.id }}">
                  <i class="fas fa-procedures mr-2"></i>Procedure Result: {{ procedure.name.name|default:"Procedure" }}
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                {{ procedure.result|safe }}
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-kahama-prem" data-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
      {% endif %}
    {% endfor %}
  {% endfor %}
{% endfor %}



{% include 'pembadoctor_template/datatable.html' %}
    
<script>
    // Initialize DataTable
    new DataTable('#consultTable', {
        dom: 'Bfrtip',
        buttons: ['excel', 'pdf', 'print'],
        responsive: true,
        pageLength: 10,
        order: [[0, 'asc']],
        language: {
            search: "_INPUT_",
            searchPlaceholder: "Search patients...",
            lengthMenu: "Show _MENU_ entries"
        }
    });

    // Calculate summary statistics
    function calculateSummaryStats() {
        let dischargedCount = 0;
        let referralCount = 0;
        let progressCount = 0;
        
        document.querySelectorAll('#consultTable tbody tr').forEach(row => {
            const status = row.getAttribute('data-status');
            
            // Count by status
            if (status === 'Discharged') {
                dischargedCount++;
            } else if (status === 'Referral') {
                referralCount++;
            } else if (status === 'In Progress') {
                progressCount++;
            }
        });
        
        // Update summary cards
        document.getElementById('discharged-count').textContent = dischargedCount;
        document.getElementById('referral-count').textContent = referralCount;
    }
    
    // Initialize summary stats
    calculateSummaryStats();

    // Status filter functionality
    document.querySelectorAll('.kahama-prem-status-btn').forEach(button => {
        button.addEventListener('click', function() {
            // Toggle active class
            document.querySelectorAll('.kahama-prem-status-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            this.classList.add('active');
            
            const status = this.getAttribute('data-status');
            filterConsultations(status);
        });
    });

    // Filter consultations by status
    function filterConsultations(status) {
        const rows = document.querySelectorAll('#consultTable tbody tr');
        let visibleCount = 0;
        
        rows.forEach(row => {
            const rowStatus = row.getAttribute('data-status');
            
            if (status === 'all' || rowStatus === status) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Update total count
        document.getElementById('total-consultations').textContent = visibleCount;
    }

    // Search functionality
    document.getElementById('kahamaPremSearch').addEventListener('keyup', function() {
        const searchText = this.value.toLowerCase();
        const activeStatus = document.querySelector('.kahama-prem-status-btn.active').getAttribute('data-status');
        
        filterConsultationsWithSearch(activeStatus, searchText);
    });
    
    document.getElementById('searchButton').addEventListener('click', function() {
        const searchText = document.getElementById('kahamaPremSearch').value.toLowerCase();
        const activeStatus = document.querySelector('.kahama-prem-status-btn.active').getAttribute('data-status');
        
        filterConsultationsWithSearch(activeStatus, searchText);
    });

    // Filter consultations by both status and search text
    function filterConsultationsWithSearch(status, searchText) {
        const rows = document.querySelectorAll('#consultTable tbody tr');
        let visibleCount = 0;
        
        rows.forEach(row => {
            const rowStatus = row.getAttribute('data-status');
            const rowText = row.textContent.toLowerCase();
            
            const statusMatch = status === 'all' || rowStatus === status;
            const searchMatch = searchText === '' || rowText.includes(searchText);
            
            if (statusMatch && searchMatch) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Update total count
        document.getElementById('total-consultations').textContent = visibleCount;
    }
</script>

{% endblock main_content %}